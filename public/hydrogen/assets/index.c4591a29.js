import{a as ts,b as $t,c as Fi,p as Ro,o as Br,d as $r,e as Eo,f as To,g as Ao}from"./vendor.94f7dd4a.js";function Mt(...n){const e={};for(const t of n)e[t]=t;return Object.freeze(e)}function Oi(n){try{return new URL(n).origin}catch{return new URL(`https://${n}`).origin}}async function Vo(n,e){const t={format:"json",timeout:3e4,method:"GET"};try{const s=`${n}/.well-known/matrix/client`;return await e(s,t).response()}catch(s){if(s.name==="ConnectionError")return null;throw s}}async function xo(n,e){var s;n=Oi(n);const t=await Vo(n,e);if(t&&t.status===200){const{body:i}=t,r=(s=i["m.homeserver"])==null?void 0:s.base_url;typeof r=="string"&&(n=Oi(r))}return n}class Fe{constructor(){this._handlersByName={}}emit(e,t){const s=this._handlersByName[e];s&&s.forEach(i=>i(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let s=this._handlersByName[e];s||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=s=new Set),s.add(t)}off(e,t){const s=this._handlersByName[e];s&&(s.delete(t),s.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}class jr extends Fe{constructor(e){super(),this._abortable=void 0;const t=i=>(this._abortable=i,i);this._progress=void 0;const s=i=>{this._progress=i,this.emit("change","progress")};this.result=e(t,s)}get progress(){return this._progress}abort(){var e;(e=this._abortable)==null||e.abort(),this._abortable=void 0}}class he extends Error{get name(){return"AbortError"}}class Us{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}}class we extends Us{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new Do(Promise.resolve(this.get())):new No(this,e)}flatMap(e){return new Po(this,e)}}class No{constructor(e,t){this._promise=new Promise((s,i)=>{this._reject=i,this._subscription=e.subscribe(r=>{t(r)&&(this._reject=null,s(r),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new he),this._reject=null)}}class Do{constructor(e){this.promise=e}dispose(){}}class Uo extends we{constructor(e,t){super(),this.value=e,this.eventName=t}onSubscribeFirst(){this.eventSubscription=this.value.disposableOn(this.eventName,()=>{this.emit(this.value)}),super.onSubscribeFirst()}onUnsubscribeLast(){this.eventSubscription(),super.onUnsubscribeLast()}get(){return this.value}}class Ee extends we{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class Po extends we{constructor(e,t){super(),this.source=e,this.mapper=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this.sourceSubscription=this.sourceSubscription(),this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}onSubscribeFirst(){super.onSubscribeFirst(),this.sourceSubscription=this.source.subscribe(()=>{this.updateTargetSubscription(),this.emit(this.get())}),this.updateTargetSubscription()}updateTargetSubscription(){const e=this.source.get();if(e){const t=this.mapper(e);if(t){this.targetSubscription||(this.targetSubscription=t.subscribe(()=>this.emit(this.get())));return}}this.targetSubscription&&(this.targetSubscription=this.targetSubscription())}get(){const e=this.source.get();if(!e)return;const t=this.mapper(e);return t==null?void 0:t.get()}}function Fo(n,e){return e<n}class Oo extends we{constructor(e,t=Fo){super(),this.map=e,this.pickKey=t}updateKey(e){return this.key===void 0||this.pickKey(this.key,e)?(this.key=e,!0):!1}onReset(){this.key=void 0,this.emit(this.get())}onAdd(e,t){this.updateKey(e)&&this.emit(this.get())}onUpdate(e,t,s){this.emit(this.get())}onRemove(e,t){if(e===this.key){this.key=void 0;for(const[s]of this.map)this.updateKey(s);this.emit(this.get())}}onSubscribeFirst(){this.mapSubscription=this.map.subscribe(this);for(const[e]of this.map)this.updateKey(e)}onUnsubscribeLast(){this.mapSubscription(),this.key=void 0}get(){if(this.key!==void 0)return this.map.get(this.key)}}class Wt extends Ee{constructor(e,t,s=()=>{}){super(e),this.freeCallback=t,this.startCallback=s}onSubscribeFirst(){this.startCallback()}onUnsubscribeLast(){super.onUnsubscribeLast(),this.freeCallback()}}class Ct extends Us{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t,this)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s,this)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t,this)}emitMove(e,t,s){for(let i of this._handlers)i.onMove(e,t,s,this)}}/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function Te(n,e,t){let s=0,i=n.length;for(;s<i;){let r=s+i>>>1,o=t(e,n[r]);o>0?s=r+1:o<0?i=r:s=i=r}return i}class ui extends Ct{constructor(e=[]){super(),this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let s of t)this.insert(e,s),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[s]=this._items.splice(e,1);this._items.splice(t,0,s),this.emitMove(e,t,s)}}update(e,t,s=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,s))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function qr(n,e,t,s){const i=e.findIndex(n);if(i!==-1){const r=e[i],o=s(r);return o!==!1&&t.emitUpdate(i,r,o),!0}return!1}class mi extends Ct{constructor(e){super(),this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return qr(e,this._items,this,t)}getAndUpdate(e,t,s=null){const i=this.indexOf(e);if(i!==-1){const r=this._items[i],o=t(r,e);this._items[i]=o,this.emitUpdate(i,o,s)}}update(e,t=null){const s=this.indexOf(e);s!==-1&&(this._items[s]=e,this.emitUpdate(s,e,t))}indexOf(e){const t=Te(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=Te(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const s=Te(this._items,e,this._comparator);s>=this._items.length||this._comparator(this._items[s],e)!==0?(this._items.splice(s,0,e),this.emitAdd(s,e)):(this._items[s]=e,this.emitUpdate(s,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new Ko(this)}}class Ko{constructor(e){this._consumed=!1,this._sortedArray=e,this._current=null}next(){return this._consumed?{value:void 0,done:!0}:(this._current=this._current?this._sortedArray._getNext(this._current):this._sortedArray.get(0),this._current||(this._consumed=!0),{value:this._current,done:this._consumed})}}class Lo extends Ct{constructor(e,t,s,i){super(),this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=s,this._removeCallback=i}findAndUpdate(e,t){return qr(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}function Bo(n,e,t){n._mappedValues.splice(e,0,t),n.emitAdd(e,t)}function $o(n,e,t,s){const i=n._mappedValues[e];n._updater&&n._updater(i,s,t),n.emitUpdate(e,i,s)}function jo(n,e){const t=n._mappedValues[e];n._mappedValues.splice(e,1),n._removeCallback&&n._removeCallback(t),n.emitRemove(e,t)}function qo(n,e,t){const s=n._mappedValues[e];n._mappedValues.splice(e,1),n._mappedValues.splice(t,0,s),n.emitMove(e,t,s)}function Ho(n){n._mappedValues=[],n.emitReset()}class Wo extends Lo{constructor(){super(...arguments),this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new Ki(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new Yo),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new Ki(e,t)),this._flush())}onUpdate(e,t,s){this._eventQueue&&(this._eventQueue.push(new Go(e,t,s)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new zo(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new Jo(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class Ki{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);Bo(e,this.index,t)}}class Go{constructor(e,t,s){this.index=e,this.value=t,this.params=s}async run(e){$o(e,this.index,this.value,this.params)}}class zo{constructor(e){this.index=e}async run(e){jo(e,this.index)}}class Jo{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){qo(e,this.fromIdx,this.toIdx)}}class Yo{async run(e){Ho(e)}}class Hr extends Ct{constructor(...e){super(),this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let s=0;for(let i=0;i<t;++i)s+=this._sourceLists[i].length;return s}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,s){this.emitAdd(this._offsetForSource(s)+e,t)}onUpdate(e,t,s,i){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(i)+e,t,s)}onRemove(e,t,s){this.emitRemove(this._offsetForSource(s)+e,t)}onMove(e,t,s,i){const r=this._offsetForSource(i);this.emitMove(r+e,r+t,s)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let s=t.next();for(;s.done;){if(e+=1,e>=this._sourceLists.length)return s;t=this._sourceLists[e][Symbol.iterator](),s=t.next()}return s}}}}class Qo extends Ct{constructor(e,t){super(),this._sourceMap=e,this._comparator=(s,i)=>t(s.value,i.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const s={key:e,value:t},i=Te(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,0,s),this.emitAdd(i,t)}onRemove(e,t){const s={key:e,value:t},i=Te(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,1),this.emitRemove(i,t)}onUpdate(e,t,s){if(!this._sortedPairs)return;const i=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(i,1);const r={key:e,value:t},o=Te(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(o,0,r),i!==o&&this.emitMove(i,o,t),this.emitUpdate(o,t,s)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,s]of this._sourceMap)this._sortedPairs[e]={key:t,value:s},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class Rt extends Us{constructor(){super()}emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t)}join(...e){return new ta([this].concat(e))}mapValues(e,t){return new ra(this,e,t)}sortValues(e){return new Qo(this,e)}filterValues(e){return new Zo(this,e)}observeSize(){return new oa(this)}}class Xo extends Rt{constructor(e,t){super(),this._source=e,this._apply=t}hasApply(){return!!this._apply}setApply(e){this._apply=e,this._apply&&this.applyOnce(this._apply)}applyOnce(e){for(const[t,s]of this._source)e(t,s)}onAdd(e,t){this._apply&&this._apply(e,t),this.emitAdd(e,t)}onRemove(e,t){this.emitRemove(e,t)}onUpdate(e,t,s){this._apply&&this._apply(e,t,s),this.emitUpdate(e,t,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._apply&&this.applyOnce(this._apply),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription&&(this._subscription=this._subscription())}onReset(){this._apply&&this.applyOnce(this._apply),this.emitReset()}[Symbol.iterator](){return this._source[Symbol.iterator]()}get size(){return this._source.size}get(e){return this._source.get(e)}}class Zo extends Rt{constructor(e,t){super(),this._source=e,this._filter=t}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){this._included=this._included||new Map;for(const[t,s]of this._source){const i=this._filter(s,t),r=this._included.get(t);if(this._included.set(t,i),!e){const o=r||!0;this._emitForUpdate(o,i,t,s)}}}else{if(this._included&&!e)for(const[t,s]of this._source)this._included.get(t)||this.emitAdd(t,s);this._included=void 0}}onAdd(e,t){if(this._filter)if(this._included){const s=this._filter(t,e);if(this._included.set(e,s),!s)return}else throw new Error("Internal logic error: FilteredMap._included used before initialized");this.emitAdd(e,t)}onRemove(e,t){var i;const s=!this._filter||((i=this._included)==null?void 0:i.get(e));if(this._included)this._included.delete(e),s&&this.emitRemove(e,t);else throw new Error("Internal logic error: FilteredMap._included used before initialized")}onUpdate(e,t,s){if(!!this._included)if(this._filter){const i=this._included.get(e),r=this._filter(t,e);this._included.set(e,r),this._emitForUpdate(i,r,e,t,s)}else this.emitUpdate(e,t,s)}_emitForUpdate(e,t,s,i,r=null){e&&!t?this.emitRemove(s,i):!e&&t?this.emitAdd(s,i):e&&t&&this.emitUpdate(s,i,r)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=void 0,this._subscription&&(this._subscription=this._subscription())}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new ea(this._source,this._included)}get size(){var t;let e=0;return(t=this._included)==null||t.forEach(s=>{s&&(e+=1)}),e}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class ea{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){var e;for(;;){const t=this._sourceIterator.next();if(t.done)return t;const s=t.value[0];if((e=this._included)!=null&&e.get(s))return t}}}class ta extends Rt{constructor(e){super(),this._sources=e}onAdd(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitRemove(t,i),this.emitAdd(t,s)}}onRemove(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,s);const i=this._getValueFromOccludedSources(e,t);i!==void 0&&this.emitAdd(t,i)}}onUpdate(e,t,s,i){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,s,i)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new ia(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const s=this._sources.indexOf(e);for(let i=0;i<s;i+=1)if(this._sources[i].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){const s=this._sources.indexOf(e);for(let i=s+1;i<this._sources.length;i+=1){const o=this._sources[i].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){if(super.onUnsubscribeLast(),this._subscriptions)for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new sa(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(const t of this._sources){const s=t.get(e);if(s)return s}}}class sa{constructor(e){this._sourceIndex=-1,this._encounteredKeys=new Set,this._sources=e}next(){var t;let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0,value:null};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const s=(t=this._currentIterator)==null?void 0:t.next();if(!s||s.done){this._currentIterator=void 0;continue}else{const i=s.value[0];this._encounteredKeys.has(i)||(this._encounteredKeys.add(i),e=s)}}return e}}class ia{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=void 0}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription&&(this._subscription=this._subscription())}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,s){this._joinedMap.onUpdate(this._source,e,t,s)}onReset(){this._joinedMap.onReset()}}class ra extends Rt{constructor(e,t,s){super(),this._source=e,this._mapper=t,this._updater=s,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const s=this._mappedValues.get(e);s&&this.emitUpdate(e,s,t)}onAdd(e,t){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i),this.emitAdd(e,i)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&t&&this.emitRemove(e,t)}onUpdate(e,t,s){var r;if(!this._mappedValues)return;const i=this._mappedValues.get(e);i!==void 0&&((r=this._updater)==null||r.call(this,s,i,t),this.emitUpdate(e,i,s))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription&&(this._subscription=this._subscription()),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class Ae extends Rt{constructor(e){super(),this._values=new Map(e)}update(e,t){const s=this._values.get(e);return s!==void 0?(this._values.set(e,s),this.emitUpdate(e,s,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e,void 0)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class na extends Rt{constructor(e,t){super(),this.key=e,this.observableValue=t}onSubscribeFirst(){this.subscription=this.observableValue.subscribe(e=>{this.emitUpdate(this.key,e,void 0)}),super.onSubscribeFirst()}onUnsubscribeLast(){this.subscription(),super.onUnsubscribeLast()}*[Symbol.iterator](){yield[this.key,this.observableValue.get()]}get size(){return 1}get(e){if(e==this.key)return this.observableValue.get()}}class oa extends we{constructor(e){super(),this.map=e}onSubscribeFirst(){this.subscription=this.map.subscribe({onAdd:(e,t)=>{this.emit(this.get())},onRemove:(e,t)=>{this.emit(this.get())},onUpdate:(e,t)=>{},onReset:()=>{this.emit(this.get())}})}onUnsubscribeLast(){var e;this.subscription=(e=this.subscription)==null?void 0:e.call(this)}get(){return this.map.size}}const aa={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},Li="application/octet-stream";class ot{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",aa[t]||(t=Li),new ot(new Blob([e],{type:t}),e)}static fromBlobUnsafe(e){return new ot(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise((s,i)=>{e.addEventListener("load",r=>s(r.target.result)),e.addEventListener("error",r=>i(r.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||Li}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}function Wr(n){return Object.entries(n||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function ca(n){if(n instanceof ot){const e=n;return{mimeType:e.mimeType,body:e}}else{if(n instanceof Map)return{mimeType:"multipart/form-data",body:n};if(typeof n=="object"){const e=JSON.stringify(n);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+n)}}class Gr extends Error{constructor(e,t){super(`${e}: ${t.message}`),this.cause=t}get name(){return"WrappedError"}}class zr extends Error{constructor(e,t,s,i){super(`${s?s.error:i} on ${e} ${t}`),this.errcode=s?s.errcode:null,this.retry_after_ms=s?s.retry_after_ms:0,this.statusCode=i}get name(){return"HomeServerError"}}class Ve extends Error{constructor(e,t){super(e||"ConnectionError"),this.isTimeout=t}get name(){return"ConnectionError"}}class ha{constructor(e,t,s,i){let r;if(i!=null&&i.log){const o=i==null?void 0:i.log;r=o.child({t:"network",url:t,method:e},o.level.Info)}this._log=r,this._sourceRequest=s,this._promise=s.response().then(o=>{var a,c;if(r==null||r.set("status",o.status),o.status>=200&&o.status<300||((a=i==null?void 0:i.allowedStatusCodes)==null?void 0:a.includes(o.status)))return r==null||r.finish(),o.body;if(o.status>=500){const h=new Ve("Internal Server Error");throw r==null||r.catch(h),h}else if(o.status>=400&&!((c=o.body)!=null&&c.errcode)){const h=new Ve(`HTTP error status ${o.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw r==null||r.catch(h),h}else{const h=new zr(e,t,o.body,o.status);throw r==null||r.set("errcode",h.errcode),r==null||r.catch(h),h}},o=>{if(o.name==="AbortError"&&this._sourceRequest){const a=new Ve("Service worker aborted, either updating or hit #187.");throw r==null||r.catch(a),a}else throw o.name==="ConnectionError"&&(r==null||r.set("timeout",o.isTimeout)),r==null||r.catch(o),o})}abort(){var e;this._sourceRequest&&((e=this._log)==null||e.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}async responseCode(){return(await this._sourceRequest.response()).status}}const os="/_matrix/client/r0",Bi="/_matrix/client/v3",Bs="/_matrix/client/unstable/org.matrix.msc2697.v2";class Xe{constructor({homeserver:e,accessToken:t,request:s,reconnector:i}){this._homeserver=e,this._accessToken=t,this._requestFn=s,this._reconnector=i}_url(e,t=os){return this._homeserver+t+e}_baseRequest(e,t,s,i,r,o){const a=Wr(s);t=`${t}?${a}`;let c;const h=new Map;if(o&&h.set("Authorization",`Bearer ${o}`),h.set("Accept","application/json"),i){const u=ca(i);h.set("Content-Type",u.mimeType),c=u.body}const l=this._requestFn(t,{method:e,headers:h,body:c,timeout:r==null?void 0:r.timeout,uploadProgress:r==null?void 0:r.uploadProgress,format:"json",cache:e!=="GET"}),d=new ha(e,t,l,r);return this._reconnector&&d.response().catch(u=>{u.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),d}_unauthedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r)}_authedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r,this._accessToken)}_post(e,t,s,i){return this._authedRequest("POST",this._url(e,(i==null?void 0:i.prefix)||os),t,s,i)}_put(e,t,s,i){return this._authedRequest("PUT",this._url(e,(i==null?void 0:i.prefix)||os),t,s,i)}_get(e,t,s,i){return this._authedRequest("GET",this._url(e,(i==null?void 0:i.prefix)||os),t,s,i)}updateAccessToken(e){this._accessToken=e}sync(e,t,s,i){return this._get("/sync",{since:e,timeout:s,filter:t},void 0,i)}context(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/context/${encodeURIComponent(t)}`,{filter:i,limit:s})}messages(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,s)}members(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,s)}send(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}redact(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}receipt(e,t,s,i){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},{},i)}state(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},void 0,i)}sendState(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}register(e,t,s,i,r=!1,o={}){o.allowedStatusCodes=[401];const a={auth:i,password:t,initial_device_displayname:s,inhibit_login:r};return e&&(a.username=e),this._unauthedRequest("POST",this._url("/register",Bi),void 0,a,o)}passwordLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:s},i)}tokenLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:s},i)}createFilter(e,t,s){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,s)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,s){let i="/keys/upload";return e&&(i=i+`/${encodeURIComponent(e)}`),this._post(i,{},t,s)}uploadSignatures(e,t){return this._post("/keys/signatures/upload",{},e,t)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,s,i){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(s)}`,{},t,i)}roomKeysVersion(e,t){let s="";return e&&(s=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${s}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,s,i){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{version:e},void 0,i)}uploadRoomKeysToBackup(e,t,s={}){return s.prefix=Bi,this._put("/room_keys/keys",{version:e},t,s)}uploadAttachment(e,t,s){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,s)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}invite(e,t,s,i){return this._post(`/rooms/${encodeURIComponent(e)}/invite`,{},{user_id:t,reason:s},i)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e={}){return e.prefix=Bs,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t={}){return t.prefix=Bs,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t={}){return t.prefix=Bs,this._post("/dehydrated_device/claim",{},{device_id:e},t)}profile(e,t){return this._get(`/profile/${encodeURIComponent(e)}`)}createRoom(e,t){return this._post("/createRoom",{},e,t)}setAccountData(e,t,s,i){return this._put(`/user/${encodeURIComponent(e)}/account_data/${encodeURIComponent(t)}`,{},s,i)}getTurnServer(e){return this._get("/voip/turnServer",void 0,void 0,e)}}class Jr{constructor(e){this._start=2e3,this._current=2e3;const t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof he))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var pt=(n=>(n[n.Waiting=0]="Waiting",n[n.Reconnecting=1]="Reconnecting",n[n.Online=2]="Online",n))(pt||{});class la{constructor({retryDelay:e,createMeasure:t,onlineStatus:s}){this._onlineStatus=s,this._retryDelay=e,this._createTimeMeasure=t,this._state=new Ee(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe(s=>{s&&this.tryNow()});try{await this._reconnectLoop(e)}catch(s){console.error(s)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}}async function da(n,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:s}=n,{base64:i}=n.encoding;var r=i.decode(t.iv),o=i.encode(i.decode(t.hashes.sha256));const a=await s.digest("SHA-256",e);if(i.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var c;return t.v=="v1"||t.v=="v2"?c=64:c=128,await s.aes.decryptCTR({jwkKey:t.key,iv:r,data:e,counterLength:c})}async function ua(n,e){const{crypto:t}=n,{base64:s}=n.encoding,i=await t.aes.generateIV(),r=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:r,iv:i,data:o}),c=await t.digest("SHA-256",a);return{blob:n.createBlob(a,"application/octet-stream"),info:{v:"v2",key:r,iv:s.encodeUnpadded(i),hashes:{sha256:s.encodeUnpadded(c)}}}}class ma{constructor(e){this.homeserver=e.homeserver,this.platform=e.platform,this.generateMediaUrl(e.serverVersions)}generateMediaUrl(e){const t="v1.11";e.includes(t)?this.mediaUrlPart="_matrix/client/v1/media":this.mediaUrlPart="_matrix/media/v3"}mxcUrlThumbnail(e,t,s,i){const r=this.parseMxcUrl(e);if(r){const[o,a]=r;return`${this.homeserver}/${this.mediaUrlPart}/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+Wr({width:Math.round(t),height:Math.round(s),method:i})}}mxcUrl(e){const t=this.parseMxcUrl(e);if(t){const[s,i]=t;return`${this.homeserver}/${this.mediaUrlPart}/download/${encodeURIComponent(s)}/${encodeURIComponent(i)}`}}parseMxcUrl(e){const t="mxc://";if(e.startsWith(t))return e.slice(t.length).split("/",2)}async downloadEncryptedFile(e,t=!1){const s=this.mxcUrl(e.url),{body:i}=await this.platform.request(s,{method:"GET",format:"buffer",cache:t}).response(),r=await da(this.platform,i,e);return this.platform.createBlob(r,e.mimetype)}async downloadPlaintextFile(e,t,s=!1){const i=this.mxcUrl(e),{body:r}=await this.platform.request(i,{method:"GET",format:"buffer",cache:s}).response();return this.platform.createBlob(r,t)}async downloadAttachment(e,t=!1){var s;return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,(s=e.info)==null?void 0:s.mimetype,t)}}class pa{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((s,i)=>{this.responseResolve=s,this.responseReject=i})}abort(){var e;this._requestResult?this._requestResult.abort():(this.responseReject(new he),(e=this.responseCodeReject)==null||e.call(this,new he))}response(){return this._responsePromise}responseCode(){return this.requestResult?this.requestResult.responseCode():(this._responseCodePromise||(this._responseCodePromise=new Promise((e,t)=>{this.responseCodeResolve=e,this.responseCodeReject=t})),this._responseCodePromise)}async setRequestResult(e){var i,r,o;this._requestResult=e;const t=await((i=this._requestResult)==null?void 0:i.response());this.responseResolve(t);const s=await((r=this._requestResult)==null?void 0:r.responseCode());(o=this.responseCodeResolve)==null||o.call(this,s)}get requestResult(){return this._requestResult}}class Yr{constructor(e){this._scheduler=e}}for(const n of Object.getOwnPropertyNames(Xe.prototype))n!=="constructor"&&!n.startsWith("_")&&(Yr.prototype[n]=function(...e){return this._scheduler._hsApiRequest(n,e)});class _a{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new Yr(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const s=new pa(e,t);return this._doSend(s),s}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const s=this._hsApi[e.methodName].apply(this._hsApi,e.args);await e.setRequestResult(s);return}catch(s){if(s instanceof zr&&s.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(s.retry_after_ms)?await this._clock.createTimeout(s.retry_after_ms).elapsed():(t||(t=new Jr(this._clock.createTimeout)),await t.waitForRetry());else{e.responseReject(s);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const ga=3e4,A=Mt("InitialSync","CatchupSync","Syncing","Stopped");function fa(n){var e;try{const t=(e=n==null?void 0:n.timeline)==null?void 0:e.events;return Array.isArray(t)&&t.length===0}catch{return!0}}class ya{constructor({hsApi:e,session:t,storage:s,logger:i}){this._hsApi=e,this._logger=i,this._session=t,this._storage=s,this._currentRequest=null,this._status=new Ee(A.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==A.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(A.CatchupSync):this._status.set(A.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==A.Stopped;){let t,s,i=this._status.get()===A.CatchupSync||this._status.get()===A.InitialSync;await this._logger.run("sync",async r=>{r.set("token",e),r.set("status",this._status.get());try{const o=this._status.get()===A.Syncing?ga:0,a=await this._syncRequest(e,o,r);e=a.syncToken,t=a.roomStates,s=a.sessionChanges,this._status.get()!==A.Syncing&&a.hadToDeviceMessages?this._status.set(A.CatchupSync):this._status.set(A.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(r.error=o,r.logLevel=r.level.Fatal),r.set("stopping",!0),this._status.set(A.Stopped)}this._status.get()!==A.Stopped&&await r.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(s,t,o))},this._logger.level.Info,(r,o)=>o.durationWithoutType("network")>=2e3||o.error||i?r.minLevel(o.level.Detail):r.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,s){const i=this._status.get()===A.CatchupSync,r=(async()=>{try{await s.wrap("session",a=>this._session.afterSyncCompleted(e,i,a))}catch{}})(),o=t.map(async a=>{try{await a.room.afterSyncCompleted(a.changes,s)}catch{}});await Promise.all(o.concat(r))}async _syncRequest(e,t,s){var p;let{syncFilterId:i}=this._session;typeof i!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:s}),i=(await this._currentRequest.response()).filter_id);const r=t+80*1e3;this._currentRequest=this._hsApi.sync(e,i,t,{timeout:r,log:s});const o=await this._currentRequest.response(),a=!e,c=new wa,h=this._parseInvites(o.rooms),{roomStates:l,archivedRoomStates:d}=await this._parseRoomsResponse(o.rooms,h,a,s);try{c.lock=await s.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(o)),await s.wrap("prepare",m=>this._prepareSync(c,l,o,m)),await s.wrap("afterPrepareSync",m=>Promise.all(l.map(_=>_.room.afterPrepareSync(_.preparation,m)))),await s.wrap("write",async m=>this._writeSync(c,h,l,d,o,i,a,m))}finally{c.dispose()}s.wrap("after",m=>this._afterSync(c,h,l,d,m));const u=(p=o.to_device)==null?void 0:p.events;return{syncToken:o.next_batch,roomStates:l,sessionChanges:c.changes,hadToDeviceMessages:Array.isArray(u)&&u.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.deviceKeys,e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,s,i){var a,c;const r=await this._openPrepareSyncTxn();e.preparation=await i.wrap("session",h=>this._session.prepareSync(s,e.lock,r,h));const o=(a=e.preparation)==null?void 0:a.newKeysByRoom;if(o){const{hasOwnProperty:h}=Object.prototype;for(const l of o.keys())if(!(((c=s.rooms)==null?void 0:c.join)&&h.call(s.rooms.join,l))){let u=this._session.rooms.get(l);u&&t.push(new $i(u,!1,{},u.membership))}}await Promise.all(t.map(async h=>{const l=o==null?void 0:o.get(h.room.id);h.preparation=await i.wrap("room",async d=>(h.isNewRoom&&await h.room.load(null,r,d),h.room.prepareSync(h.roomResponse,h.membership,l,r,d)),i.level.Detail)})),await r.complete()}async _writeSync(e,t,s,i,r,o,a,c){const h=await this._openSyncTxn();try{e.changes=await c.wrap("session",l=>this._session.writeSync(r,o,e.preparation,h,l)),await Promise.all(t.map(async l=>{l.changes=await c.wrap("invite",d=>l.invite.writeSync(l.membership,l.roomResponse,h,d))})),await Promise.all(s.map(async l=>{l.changes=await c.wrap("room",d=>l.room.writeSync(l.roomResponse,a,l.preparation,h,d))})),await Promise.all(i.map(async l=>{var u;const d=(u=l.roomState)==null?void 0:u.summaryChanges;l.changes=await c.wrap("archivedRoom",p=>l.archivedRoom.writeSync(d,l.roomResponse,l.membership,h,p))}))}catch(l){throw h.abort(c),h.getCause(l)}await h.complete(c)}_afterSync(e,t,s,i,r){r.wrap("session",o=>this._session.afterSync(e.changes,o),r.level.Detail);for(let o of i)r.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},r.level.Detail);for(let o of s)r.wrap("room",a=>o.room.afterSync(o.changes,a),r.level.Detail);for(let o of t)r.wrap("invite",a=>o.invite.afterSync(o.changes,a),r.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,s,i,r)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceKeys,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions,e.calls])}async _parseRoomsResponse(e,t,s,i){const r=[],o=[];if(e){const a=["join","leave"];for(const c of a){const h=e[c];if(h)for(const[l,d]of Object.entries(h)){if(s&&fa(d))continue;const u=this._session.invites.get(l);u&&t.push(new ji(u,!1,null,c));const p=this._createRoomSyncState(l,d,c,s);p&&r.push(p);const m=await this._createArchivedRoomSyncState(l,p,d,c,s,i);m&&o.push(m)}}}return{roomStates:r,archivedRoomStates:o}}_createRoomSyncState(e,t,s,i){let r=!1,o=this._session.rooms.get(e);if(!o&&(s==="join"||i&&s==="leave")&&(o=this._session.createJoinedRoom(e),r=!0),o)return new $i(o,r,t,s)}async _createArchivedRoomSyncState(e,t,s,i,r,o){let a;if((t==null?void 0:t.shouldAdd)&&!r?a=this._session.createOrGetArchivedRoomForSync(e):i==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new va(a,t,s,i)}_parseInvites(e){const t=[];if(e!=null&&e.invite)for(const[s,i]of Object.entries(e.invite)){let r=this._session.invites.get(s),o=!1;r||(r=this._session.createInvite(s),o=!0),t.push(new ji(r,o,i,"invite"))}return t}stop(){this._status.get()!==A.Stopped&&(this._status.set(A.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class wa{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){var e;(e=this.lock)==null||e.release()}}class $i{constructor(e,t,s,i){this.room=e,this.isNewRoom=t,this.roomResponse=s,this.membership=i,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){var e;return(e=this.changes)==null?void 0:e.summaryChanges}}class va{constructor(e,t,s,i,r){this.archivedRoom=e,this.roomState=t,this.roomResponse=s,this.membership=i,this.isInitialSync=r,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}}class ji{constructor(e,t,s,i){this.invite=e,this.isNewInvite=t,this.membership=i,this.roomResponse=s,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}}var $e=(n=>(n[n.Sync=0]="Sync",n[n.Timeline=1]="Timeline",n[n.Retry=2]="Retry",n))($e||{});const Y="e2ee:",pi="m.olm.v1.curve25519-aes-sha2",ye="m.megolm.v1.aes-sha2";class B extends Error{constructor(e,t,s){super(`Decryption error ${e}${s?": "+JSON.stringify(s):""}`),this.code=e,this.event=t,this.detailsObj=s}}const ba="ed25519";function tt(n){return n.keys[`ed25519:${n.device_id}`]}function _e(n){return n.keys[`curve25519:${n.device_id}`]}function Sa(n,e,t){var s,i;return(i=(s=n==null?void 0:n.signatures)==null?void 0:s[e])==null?void 0:i[`${ba}:${t}`]}var x=(n=>(n[n.Valid=0]="Valid",n[n.Invalid=1]="Invalid",n[n.NotSigned=2]="NotSigned",n))(x||{});function _i(n,e,t,s,i,r){const o=Sa(i,e,t);if(!o)return r==null||r.set("no_signature",!0),2;const a=Object.assign({},i);delete a.unsigned,delete a.signatures;const c=ts.stringify(a);try{return n.ed25519_verify(s,c,o),0}catch(h){if(r){const l=r.log({l:"Invalid signature, ignoring.",ed25519Key:s,canonicalJson:c,signature:o});l.error=h,l.logLevel=r.level.Warn}return 1}}function Ia(){return{type:"m.room.encryption",state_key:"",content:{algorithm:ye,rotation_period_ms:6048e5,rotation_period_msgs:100}}}function as(n,e){switch(e){case"world_readable":return!0;case"shared":return n!==void 0;case"joined":return n==="join";case"invited":return n==="invite"||n==="join";default:return!1}}function Js(n){var e;return((e=n.unsigned)==null?void 0:e.prev_content)||n.prev_content}const fe="m.room.redaction";function Ys(n){var e;return!!((e=n==null?void 0:n.unsigned)!=null&&e.redacted_because)}var V=(n=>(n[n.None=1]="None",n[n.BeingCreated=2]="BeingCreated",n[n.Invited=4]="Invited",n[n.Joined=8]="Joined",n[n.Replaced=16]="Replaced",n[n.Archived=32]="Archived",n))(V||{}),Z=(n=>(n[n.DirectMessage=0]="DirectMessage",n[n.Private=1]="Private",n[n.Public=2]="Public",n))(Z||{});function _t(n,e){var o,a;let t;const s=c=>{const h=e(c);h instanceof Promise&&(t=t!=null?t:[],t.push(h))},i=(o=n.state)==null?void 0:o.events;if(i)for(let c=0;c<i.length;c++)s(i[c]);let r=(a=n.timeline)==null?void 0:a.events;if(r)for(let c=0;c<r.length;c++){const h=r[c];typeof h.state_key=="string"&&s(h)}if(t)return Promise.all(t).then(()=>{})}function ka(n,e,t,s,i){return e.length&&(n=e.reduce((r,o)=>Ea(r,o,t,s,i),n)),n}function Ma(n,e,t,s){e.summary&&(n=Ta(n,e.summary)),t!==n.membership&&(n=n.cloneIfNeeded(),n.membership=t),e.account_data&&(n=e.account_data.events.reduce(Ra,n)),_t(e,r=>{n=Qr(n,r,s)});const i=e.unread_notifications;return i&&(n=Ca(n,i)),n}function Ca(n,e){const t=e.highlight_count||0;t!==n.highlightCount&&(n=n.cloneIfNeeded(),n.highlightCount=t);const s=e.notification_count;return s!==n.notificationCount&&(n=n.cloneIfNeeded(),n.notificationCount=s),n}function Ra(n,e){var t;if((e==null?void 0:e.type)==="m.tag"){let s=(t=e==null?void 0:e.content)==null?void 0:t.tags;(!s||Array.isArray(s)||typeof s!="object")&&(s=null),n=n.cloneIfNeeded(),n.tags=s}return n}function Qr(n,e,t){var s,i,r;if(e.type==="m.room.create")n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.origin_server_ts;else if(e.type==="m.room.encryption"){const o=(s=e.content)==null?void 0:s.algorithm;!n.encryption&&o===ye&&(n=n.cloneIfNeeded(),n.encryption=e.content)}else if(e.type==="m.room.name"){const o=(i=e.content)==null?void 0:i.name;o!==n.name&&(n=n.cloneIfNeeded(),n.name=o)}else if(e.type==="m.room.avatar"){const o=(r=e.content)==null?void 0:r.url;o!==n.avatarUrl&&(n=n.cloneIfNeeded(),n.avatarUrl=o)}else if(e.type==="m.room.canonical_alias"){const o=e.content;n=n.cloneIfNeeded(),n.canonicalAlias=o.alias}else if(e.type==="m.room.member"){const o=e.content;if(o.is_direct===!0&&o.membership==="invite"&&!n.isDirectMessage){let a;e.sender===t?a=e.state_key:e.state_key===t&&(a=e.sender),a&&(n=n.cloneIfNeeded(),n.isDirectMessage=!0,n.dmUserId=a)}else o.membership==="leave"&&n.isDirectMessage&&n.dmUserId===e.state_key&&(n=n.cloneIfNeeded(),n.isDirectMessage=!1,n.dmUserId=null)}return n}function Ea(n,e,t,s,i){return e.eventType==="m.room.message"&&((!n.lastMessageTimestamp||e.timestamp>n.lastMessageTimestamp)&&(n=n.cloneIfNeeded(),n.lastMessageTimestamp=e.timestamp),!t&&e.sender!==i&&s&&(n=n.cloneIfNeeded(),n.isUnread=!0)),n}function Ta(n,e){const t=e["m.heroes"],s=e["m.joined_member_count"],i=e["m.invited_member_count"];return t&&Array.isArray(t)&&(n=n.cloneIfNeeded(),n.heroes=t),Number.isInteger(i)&&(n=n.cloneIfNeeded(),n.inviteCount=i),Number.isInteger(s)&&(n=n.cloneIfNeeded(),n.joinCount=s),n}class ke{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}changedKeys(e){return Object.getOwnPropertyNames(this).filter(s=>s!=="cloned"&&this[s]!==e[s])}cloneIfNeeded(){return this.cloned?this:new ke(this)}serialize(){return Object.entries(this).reduce((e,[t,s])=>(t!=="cloned"&&s!==null&&(e[t]=s),e),{})}applyTimelineEntries(e,t,s,i){return ka(this,e,t,s,i)}applySyncResponse(e,t,s){return Ma(this,e,t,s)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}}class Aa{constructor(e){this._data=null,this.applyChanges(new ke(null,e))}get data(){return this._data}writeClearUnread(e){const t=new ke(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const s=new ke(this._data);return s.hasFetchedMembers=e,t.roomSummary.set(s.serialize()),s}writeIsTrackingMembers(e,t){const s=new ke(this._data);return s.isTrackingMembers=e,t.roomSummary.set(s.serialize()),s}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const s=await t.readWriteTxn([t.storeNames.roomSummary]);try{s.roomSummary.set(e.serialize())}catch(i){throw s.abort(),i}return await s.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new ke(e))}}var C=(n=>(n.session="session",n.roomState="roomState",n.roomSummary="roomSummary",n.archivedRoomSummary="archivedRoomSummary",n.invites="invites",n.roomMembers="roomMembers",n.timelineEvents="timelineEvents",n.timelineRelations="timelineRelations",n.timelineFragments="timelineFragments",n.pendingEvents="pendingEvents",n.userIdentities="userIdentities",n.deviceKeys="deviceKeys",n.olmSessions="olmSessions",n.inboundGroupSessions="inboundGroupSessions",n.outboundGroupSessions="outboundGroupSessions",n.groupSessionDecryptions="groupSessionDecryptions",n.operations="operations",n.accountData="accountData",n.calls="calls",n.crossSigningKeys="crossSigningKeys",n.sharedSecrets="sharedSecrets",n))(C||{});const Gt=Object.values(C);class xe extends Error{constructor(e,t=null){super(e),t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const U={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};class L{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new L(this.fragmentId+1,U.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new L(this.fragmentId,this.eventIndex-1)}nextKey(){return new L(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new L(U.maxStorageKey,U.maxStorageKey)}static get minKey(){return new L(U.minStorageKey,U.minStorageKey)}static get defaultLiveKey(){return L.defaultFragmentKey(U.minStorageKey)}static defaultFragmentKey(e){return new L(e,U.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===(e==null?void 0:e.fragmentId)&&this.eventIndex===(e==null?void 0:e.eventIndex)}}const Qs=Number.MAX_SAFE_INTEGER;class Xr{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===Qs?1:e.fragmentId===Qs?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new L(this.fragmentId,this.entryIndex)}}const Va="m.reaction",je="m.annotation",Zr="m.reference";function xa(n,e){return{"m.relates_to":{event_id:n,key:e,rel_type:je}}}function Na(n){return{"m.relates_to":{event_id:n,rel_type:Zr}}}function gi(n){var e;return n.event_id||((e=n["m.in_reply_to"])==null?void 0:e.event_id)}function en(n,e){n.event_id!==void 0?n.event_id=e:n["m.in_reply_to"]&&(n["m.in_reply_to"].event_id=e)}function tn(n){if(n.type===fe)return n.redacts;{const e=Ke(n);if(e)return gi(e)}return null}function He(n){return n==null?void 0:n["m.relates_to"]}function Ke(n){return He(n.content)}class Da{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce((t,s)=>!t||s.pendingEvent.queueIndex>t.pendingEvent.queueIndex?s:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}}function qi(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ua(n){switch(n){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function Pa(n){return n==="m.emote"?"* ":""}function Fa(n,e,t,s){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:s,"m.relates_to":{"m.in_reply_to":{event_id:n}}}}function Oa(n,e,t){const s=Ua(n.content.msgtype),i=Pa(n.content.msgtype),r=n.sender,o=n.displayName||r,a=s||n.content.formatted_body||n.content.body&&qi(n.content.body)||"",c=`<mx-reply><blockquote>In reply to ${i}<a href="https://matrix.to/#/${r}">${o}</a><br />${a}</blockquote></mx-reply>`,l=(s||n.content.body||"").split(`
`);l[0]=`> ${i}<${r}> ${l[0]}`;const u=l.join(`
> `)+`

`+t,p=c+qi(t);return Fa(n.id,e,u,p)}class sn extends Xr{constructor(e){super(e),this._pendingRedactions=null,this._pendingAnnotations=null,this._contextEntry=null,this._contextForEntries=null}get isReply(){var e;return!!((e=this.relation)!=null&&e["m.in_reply_to"])}get isReference(){var e;return((e=this.relation)==null?void 0:e.rel_type)===Zr}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===fe}get redactionReason(){var e;return this._pendingRedactions?(e=this._pendingRedactions[0].content)==null?void 0:e.reason:null}setContextEntry(e){this._contextEntry=e,e._setAsContextOf(this)}_setAsContextOf(e){this._contextForEntries||(this._contextForEntries=[]),this._contextForEntries.push(e)}get contextForEntries(){return this._contextForEntries}get contextEntry(){return this._contextEntry}addLocalRelation(e){if(e.eventType===fe&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===je&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){var t;if(e.eventType===fe&&e.isRelatedToId(this.id)&&this._pendingRedactions){const s=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(i=>i!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,s!==0))return"isRedacted"}else{const s=e.redactingEntry||e;if(s.isRelatedToId(this.id)&&((t=s.relation)==null?void 0:t.rel_type)===je&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s||(s=new Da,this._pendingAnnotations.set(t,s)),s.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s.remove(e)&&s.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return xa(this.id,e)}createReplyContent(e,t){return Oa(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){var r,o,a;const t=((o=(r=this.annotations)==null?void 0:r[e])==null?void 0:o.me)||!1,s=(a=this.pendingAnnotations)==null?void 0:a.get(e),i=(s==null?void 0:s.willAnnotate)||!1;return t&&(!s||i)||!t&&i}get relation(){return He(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class Ka extends sn{constructor({pendingEvent:e,member:t,clock:s,redactingEntry:i}){super(null),this._pendingEvent=e,this._member=t,this._timestamp=s.now()-(100-e.queueIndex),this._redactingEntry=i}get fragmentId(){return Qs}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){var e;return(e=this._member)==null?void 0:e.userId}get displayName(){var e;return(e=this._member)==null?void 0:e.name}get avatarUrl(){var e;return(e=this._member)==null?void 0:e.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}get contextEventId(){var e;return this.isReply?(e=this._pendingEvent.relatedEventId)!=null?e:this._pendingEvent.relatedTxnId:null}}class at{constructor(){let e,t;this.promise=new Promise((s,i)=>{e=s,t=i}),this.resolve=s=>{this._value=s,e(s)},this.reject=t}get value(){return this._value}}const E=Mt("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),Hi=["m.relates_to"];class La{constructor({data:e,remove:t,emitUpdate:s,attachments:i}){this._data=e,this._attachments=i,this._emitUpdate=s,this._removeFromQueueCallback=t,this._aborted=!1,this._status=E.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._deferred=new at,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((r,o)=>r+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=He(this.content);return e?gi(e):this._data.relatedEventId}setRelatedEventId(e){const t=He(this.content);t?en(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=E.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of Hi)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const s of Hi)t[s]!==void 0&&(e[s]=t[s])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=E.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=E.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===E.Sending||this._status===E.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=E.EncryptingAttachments,this._emitUpdate("status");for(const i of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",i.size),i.encrypt())),this.aborted)throw new he}this._status=E.UploadingAttachments,this._emitUpdate("status");const s=Object.entries(this._attachments);s.sort(([,i],[,r])=>i.size-r.size);for(const[i,r]of s)await t.wrap("upload",o=>(o.set("size",r.size),r.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),r.applyToContent(i,this.content);this._data.needsUpload=!1}async abort(){var e;if(!this._aborted){if(this._aborted=!0,this._attachments)for(const t of Object.values(this._attachments))t.abort();(e=this._sendRequest)==null||e.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=E.Sending,this._emitUpdate("status");const s=this._data.encryptedEventType||this._data.eventType,i=this._data.encryptedContent||this._data.content;s===fe?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,i,{log:t}):this._sendRequest=e.send(this.roomId,s,this.txnId,i,{log:t});const r=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=r.event_id,this._deferred.resolve(r.event_id),t.set("id",this._data.remoteId),this._status=E.Sent,this._emitUpdate("status")}getRemoteId(){return this._deferred.promise}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class re extends sn{constructor(e,t){super(t),this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new re(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&(this._decryptionError=e._decryptionError),this._contextForEntries=e.contextForEntries,this._contextEntry=e.contextEntry}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.content)||this._eventEntry.event.content}get prevContent(){return Js(this._eventEntry.event)}get eventType(){var e,t;return((t=(e=this._decryptionResult)==null?void 0:e.event)==null?void 0:t.type)||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){var e;return!!((e=this._decryptionResult)!=null&&e.event)}get isVerified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isVerified)}get isUnverified(){var e;return this.isEncrypted&&((e=this._decryptionResult)==null?void 0:e.isUnverified)}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return tn(this.event)}get isRedacted(){return super.isRedacted||Ys(this._eventEntry.event)}get redactionReason(){var t,s;const e=(t=this._eventEntry.event.unsigned)==null?void 0:t.redacted_because;return e?(s=e.content)==null?void 0:s.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&He(e)||He(this.content)}get contextEventId(){return this.isReply||this.isReference?this.relatedEventId:null}}function rn(n,e,t){return{fragmentId:n.fragmentId,eventIndex:n.eventIndex,roomId:e,event:t}}function jt(n,e,t){t.isForward?n.push(e):n.unshift(e)}function Ba(n,e,t){return t.isForward?n.concat(e):e.concat(n)}const ee="m.room.member";class R{constructor(e){this._data=e}static fromUserId(e,t,s){return new R({roomId:e,userId:t,membership:s})}static fromMemberEvent(e,t){const s=t==null?void 0:t.state_key;if(typeof s!="string")return;const i=t.content,r=Js(t),o=i==null?void 0:i.membership,a=(i==null?void 0:i.displayname)||(r==null?void 0:r.displayname),c=(i==null?void 0:i.avatar_url)||(r==null?void 0:r.avatar_url);return this._validateAndCreateMember(e,s,o,a,c)}static fromReplacingMemberEvent(e,t){const s=t&&t.state_key;if(typeof s!="string")return;const i=Js(t);return this._validateAndCreateMember(e,s,i==null?void 0:i.membership,i==null?void 0:i.displayname,i==null?void 0:i.avatar_url)}static _validateAndCreateMember(e,t,s,i,r){if(typeof s=="string")return new R({roomId:e,userId:t,membership:s,avatarUrl:r,displayName:i})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,s=e._data;return t.roomId===s.roomId&&t.userId===s.userId&&t.membership===s.membership&&t.displayName===s.displayName&&t.avatarUrl===s.avatarUrl}}class nn{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get wasInvited(){return this.previousMembership==="invite"&&this.membership!=="invite"}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}}function fi(n){return typeof n=="number"}const $a=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(n,e){return n[e]=1,n},{}),ja={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};function qa(n,e){for(const i of Object.keys(e))$a[i]||delete e[i];const{content:t}=e,s=ja[e.type];for(const i of Object.keys(t))s!=null&&s[i]||delete t[i];e.unsigned=e.unsigned||{},e.unsigned.redacted_because=n}function Ha(n,e){const t=[];for(;fi(n.previousId);){const s=e.get(n.previousId);if(!s)break;if(s.nextId!==n.id)throw new Error(`Previous fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.previousId),t.unshift(s),n=s}return t}function Wa(n,e){const t=[];for(;fi(n.nextId);){const s=e.get(n.nextId);if(!s)break;if(s.previousId!==n.id)throw new Error(`Next fragment ${s.id} doesn't point back to ${n.id}`);e.delete(n.nextId),t.push(s),n=s}return t}function Ga(n){const e=new Map;for(let s of n)e.set(s.id,s);const t=[];for(;e.size;){const s=e.values().next().value;e.delete(s.id);const i=Ha(s,e),r=Wa(s,e),o=i.concat(s,r);t.push(o)}return t.map(s=>new za(s))}class $s{constructor(e,t,s){this.id=e,this.previousId=t,this.nextId=s}}class za{constructor(e){this._idToSortIndex=new Map,e.forEach((t,s)=>{this._idToSortIndex.set(t.id,s)})}compare(e,t){const s=this._idToSortIndex.get(e);if(s===void 0)throw new Error(`first id ${e} isn't part of this island`);const i=this._idToSortIndex.get(t);if(i===void 0)throw new Error(`second id ${t} isn't part of this island`);return s-i}get fragmentIds(){return this._idToSortIndex.keys()}}class Wi extends Error{get name(){return"CompareError"}}class Ja{constructor(e){this._fragmentsById=e.reduce((t,s)=>(t.set(s.id,s),t),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(t===void 0)throw new Wi(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const s=this._getIsland(e),i=this._getIsland(t);if(s!==i)throw new Wi(`${e} and ${t} are on different islands, can't tell order`);return s.compare(e,t)}rebuild(e){const t=Ga(e);this._idToIsland=new Map;for(let s of t)for(let i of s.fragmentIds)this._idToIsland.set(i,s)}add(e){const t=new $s(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const s=new $s(e,t,null),i=this._fragmentsById.get(t);i&&(i.nextId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}prepend(e,t){const s=new $s(e,null,t),i=this._fragmentsById.get(t);i&&(i.previousId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}}(function(){const e=document.createElement("link").relList;return e&&e.supports&&e.supports("modulepreload")?"modulepreload":"preload"})();function Ya(n){return"objectStore"in n?`${n.objectStore.name}.${n.name}`:n.name}function Qa(n){var e,t,s,i,r;return"objectStore"in n?(s=(t=(e=n.objectStore)==null?void 0:e.transaction)==null?void 0:t.db)==null?void 0:s.name:(r=(i=n.transaction)==null?void 0:i.db)==null?void 0:r.name}class on extends xe{constructor(e,t,s=null){const i=t&&"source"in t?t.source:t,r=i?Ya(i):"",o=i?Qa(i):"";let a=`${e} on ${o}.${r}`;s&&(a+=": ",typeof s.name=="string"&&(a+=`(name: ${s.name}) `),typeof s.code=="number"&&(a+=`(code: ${s.code}) `)),s&&(a+=s.message),super(a,s),this.storeName=r,this.databaseName=o}}class yi extends on{constructor(e){const t=e.target,s=t.source,i=t.error;super("IDBRequest failed",s,i),this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class de extends on{constructor(e,t,s,i){super(`${e}(${i.map(r=>JSON.stringify(r)).join(", ")}) failed`,t,s)}}const Gi={done:!0},Ue={done:!1};function Ms(n){const e=n.toString(16);return"0".repeat(8-e.length)+e}function Xs(n){return parseInt(n,16)}function wi(n,e,t,s=window.indexedDB){const i=s.open(n,t);return i.onupgradeneeded=async r=>{const o=r.target,a=o.result,c=o.transaction,h=r.oldVersion;try{await e(a,c,h,t)}catch{try{c.abort()}catch{}}},H(i)}function H(n){return new Promise((e,t)=>{n.addEventListener("success",s=>{e(s.target.result)}),n.addEventListener("error",s=>{const i=new yi(s);t(i)})})}function zt(n){return new Promise((e,t)=>{n.addEventListener("complete",()=>{e()}),n.addEventListener("abort",s=>{t(new he)})})}function K(n,e){return new Promise((t,s)=>{n.onerror=i=>{s(new yi(i))},n.onsuccess=i=>{const r=i.target.result;if(!r){t(!1);return}const o=e(r.value,r.key,r),a=o==null?void 0:o.done,c=o==null?void 0:o.jumpTo;a?t(!0):c?r.continue(c):r.continue()}}).catch(t=>{throw new xe("iterateCursor failed",t)})}async function Xa(n,e){const t=[];return await K(n,s=>(t.push(s),{done:e(t)})),t}class zi{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}count(e){return H(this._target.count(e))}get(e){return H(this._target.get(e))}getKey(e){return this._target.supports("getKey")?H(this._target.getKey(e)):H(this._target.get(e)).then(t=>{if(t){let s=this._target.keyPath;return typeof s=="string"&&(s=[s]),s.reduce((i,r)=>i[r],t)}})}reduce(e,t,s){return this._reduce(e,t,s,"next")}reduceReverse(e,t,s){return this._reduce(e,t,s,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const s=this._openCursor(e,t),i=[];return await K(s,r=>(i.push(r),Ue)),i}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let s;return await K(t,(i,r)=>(s=r,Gi)),s}async iterateValues(e,t){const s=this._target.openCursor(e,"next");await K(s,(i,r,o)=>({done:t(i,r,o)}))}async iterateKeys(e,t){const s=this._target.openKeyCursor(e,"next");await K(s,(i,r,o)=>({done:t(r,o)}))}async findExistingKeys(e,t,s){const i=(d,u)=>t?-this.idbFactory.cmp(d,u):this.idbFactory.cmp(d,u),r=e.slice().sort(i),o=r[0],a=r[r.length-1],c=t?"prev":"next",h=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),c);let l=0;await K(h,(d,u,p)=>{for(;l<r.length&&i(r[l],u)<0;)l+=1;let m=!1;if(r[l]===u){const _=p.primaryKey;m=s(u,_),l+=1}return m||l>=r.length?Gi:{done:!1,jumpTo:r[l]}})}_reduce(e,t,s,i){let r=s;const o=this._openCursor(e,i);return K(o,a=>(r=t(r,a),Ue))}_selectLimit(e,t,s){return this._selectUntil(e,i=>i.length===t,s)}async _selectUntil(e,t,s){const i=this._openCursor(e,s),r=[];return await K(i,o=>(r.push(o),{done:t(r,o)})),r}async _selectWhile(e,t,s){const i=this._openCursor(e,s),r=[];return await K(i,o=>{const a=t(o);return a&&r.push(o),{done:!a}}),r}async iterateWhile(e,t){const s=this._openCursor(e,"next");await K(s,i=>({done:!t(i)}))}async _find(e,t,s){const i=this._openCursor(e,s);let r;if(await K(i,a=>{const c=t(a);return c&&(r=a),{done:c}}))return r}}const be=!1;function Se(n,e,t){var r,o;const s=t==null?void 0:t.name,i=(o=(r=t==null?void 0:t.transaction)==null?void 0:r.db)==null?void 0:o.name;console.info(`${i}.${s}.${n}(${e.map(a=>JSON.stringify(a)).join(", ")})`)}class Ji{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(be&&Se("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(be&&Se("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(s){throw new de("openKeyCursor",this._qt,s,[e,t])}}openCursor(e,t){try{return be&&Se("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(s){throw new de("openCursor",this._qt,s,[e,t])}}put(e,t){try{return be&&Se("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(s){throw new de("put",this._qt,s,[e,t])}}add(e,t){try{return be&&Se("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(s){throw new de("add",this._qt,s,[e,t])}}get(e){try{return be&&Se("get",[e],this._qt),this._qt.get(e)}catch(t){throw new de("get",this._qt,t,[e])}}getKey(e){try{return be&&Se("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new de("getKey",this._qt,t,[e])}}delete(e){try{return be&&Se("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new de("delete",this._qt,t,[e])}}clear(){try{return be&&Se("clear",[],this._qt),this._qtStore.clear()}catch(e){throw new de("delete",this._qt,e,[])}}count(e){try{return this._qt.count(e)}catch(t){throw new de("count",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new de("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class an extends zi{constructor(e,t){super(new Ji(e),t)}get _idbStore(){return this._target}index(e){return new zi(new Ji(this._idbStore.index(e)),this._transaction)}put(e,t){const s=this._idbStore.put(e);this._prepareErrorLog(s,t,"put",void 0,e)}add(e,t){const s=this._idbStore.add(e);this._prepareErrorLog(s,t,"add",void 0,e)}async tryAdd(e,t){try{return await H(this._idbStore.add(e)),!0}catch(s){if(s instanceof yi)return t.log({l:"could not write",id:this._getKeys(e),e:s},t.level.Warn),s.preventTransactionAbort(),!1;throw s}}delete(e,t){const s=this._idbStore.delete(e);this._prepareErrorLog(s,t,"delete",e,void 0)}clear(e){const t=this._idbStore.clear();this._prepareErrorLog(t,e,"delete",void 0,void 0)}_prepareErrorLog(e,t,s,i,r){t&&t.ensureRefId(),H(e).catch(o=>{let a;r?a=this._getKeys(r):i&&(a=[i]),this._transaction.addWriteError(o,t,s,a)})}_getKeys(e){const t=[],{keyPath:s}=this._idbStore;try{t.push(this._readKeyPath(e,s))}catch{console.warn("could not read keyPath",s)}for(const i of this._idbStore.indexNames)try{const r=this._idbStore.index(i);t.push(this._readKeyPath(e,r.keyPath))}catch{console.warn("could not read index",i)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let s=e;for(const i of t)if(typeof s=="object")s=s[i];else break;return s}else return e[t]}}function Za(n){return JSON.stringify(cn(n))}function ec(n){return hn(JSON.parse(n))}function cn(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(n.byteLength)return{_type:n.constructor.name,value:Array.from(n)};let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=cn(n[t]));return e}else return n}function hn(n){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){if(typeof n._type=="string")switch(n._type){case"Int8Array":return Int8Array.from(n.value);case"Uint8Array":return Uint8Array.from(n.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(n.value);case"Int16Array":return Int16Array.from(n.value);case"Uint16Array":return Uint16Array.from(n.value);case"Int32Array":return Int32Array.from(n.value);case"Uint32Array":return Uint32Array.from(n.value);case"Float32Array":return Float32Array.from(n.value);case"Float64Array":return Float64Array.from(n.value);case"BigInt64Array":return BigInt64Array.from(n.value);case"BigUint64Array":return BigUint64Array.from(n.value);default:return n.value}let e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=hn(n[t]));return e}else return n}function ln(n){return`${n}.session.`}function tc(n,e){const t=[];for(let s=0;s<n.length;s++){const i=n.key(s);i!=null&&i.startsWith(ln(e))&&t.push(i)}for(const s of t)n.removeItem(s)}class vi{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return ln(this._sessionStore.databaseName)}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const s=this._localStorageKeyPrefix+e,i=Za(t);this._localStorage.setItem(s,i)}catch(s){console.error("could not write to localStorage",s)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(Y)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const s=this._localStorageKeyPrefix,i=s+Y;for(let r=0;r<this._localStorage.length;r+=1){const o=this._localStorage.key(r);if(o.startsWith(i)){const a=ec(this._localStorage.getItem(o)),c=o.substr(s.length),h=await this._sessionStore.getKey(c)===c;e.set(c,!h),h||(this._sessionStore.put({key:c,value:a}),t=!0)}}return t}set(e,t){e.startsWith(Y)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(Y)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(Y)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class Yi{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){const t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}}class sc{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}var ie=(n=>(n[n.All=1]="All",n[n.Debug=2]="Debug",n[n.Detail=3]="Detail",n[n.Info=4]="Info",n[n.Warn=5]="Warn",n[n.Error=6]="Error",n[n.Fatal=7]="Fatal",n[n.Off=8]="Off",n))(ie||{});class Cs{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}function Rs(){}class ic{constructor(){this.item=new rc(this)}log(e){return this.item}addReporter(){}get reporters(){return[]}getOpenRootItems(){return[]}forceFinish(){}child(e){return this.item}run(e,t){return t(this.item)}wrapOrRun(e,t,s){return e?e.wrap(t,s):this.run(t,s)}runDetached(e,t){return new Promise(s=>s(t(this.item))).then(Rs,Rs),this.item}get level(){return ie}}class rc{constructor(e){this.logger=e}discard(){}wrap(e,t){return this.run(t)}run(e){return e(this)}log(e){return this}set(e){return this}runDetached(e,t){return new Promise(s=>s(t(this))).then(Rs,Rs),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return ie}get duration(){return 0}catch(e){return e}child(){return this}finish(){}forceFinish(){}serialize(){}}const nc=new ic;function oe(n,e,t){return`${n}|${Ms(e)}|${Ms(t)}`}function oc(n){const[e,t,s]=n.split("|");return{roomId:e,eventKey:new L(Xs(t),Xs(s))}}function cs(n,e){return`${n}|${e}`}function Qi(n){const[e,t]=n.split("|");return{roomId:e,eventId:t}}class hs{constructor(e,t,s,i,r=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=s,this._upper=i,this._lowerOpen=r,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(oe(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(oe(e,this._lower.fragmentId,this._lower.eventIndex),oe(e,this._lower.fragmentId,U.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(oe(e,this._upper.fragmentId,U.minStorageKey),oe(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(oe(e,this._lower.fragmentId,this._lower.eventIndex),oe(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new xe("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}}class ac{constructor(e){this._timelineStore=e}onlyRange(e){return new hs(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new hs(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new hs(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,s=!1,i=!1){return new hs(this._timelineStore.IDBKeyRange,void 0,e,t,s,i)}async lastEvents(e,t,s){const i=L.maxKey;return i.fragmentId=t,this.eventsBefore(e,i,s)}async firstEvents(e,t,s){const i=L.minKey;return i.fragmentId=t,this.eventsAfter(e,i,s)}eventsAfter(e,t,s){const i=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(i,s)}async eventsBefore(e,t,s){const i=this.upperBoundRange(t,!0).asIDBKeyRange(e),r=await this._timelineStore.selectLimitReverse(i,s);return r.reverse(),r}async getEventKeysForIds(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(o=>cs(e,o)),r=new Map;return await s.findExistingKeys(i,!1,(o,a)=>{const{eventId:c}=Qi(o),{eventKey:h}=oc(a);return r.set(c,h),!1}),r}async findFirstOccurringEventId(e,t){const s=this._timelineStore.index("byEventId"),i=t.map(c=>cs(e,c)),r=new Array(i.length);let o;function a(){for(let c=0;c<r.length;++c){if(r[c]===void 0)return;if(r[c]===!0)return i[c]}}return await s.findExistingKeys(i,!1,(c,h)=>{const l=i.indexOf(c);return r[l]=h,o=a(),!!o}),o&&Qi(o).eventId}tryInsert(e,t){return e.key=oe(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=cs(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(oe(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(cs(e,t))}removeAllForRoom(e){const t=oe(e,U.minStorageKey,U.minStorageKey),s=oe(e,U.maxStorageKey,U.maxStorageKey),i=this._timelineStore.IDBKeyRange.bound(t,s);this._timelineStore.delete(i)}}const P="\0",D="\u{10FFFF}";function ue(n,e,t,s){return`${n}|${e}|${t}|${s}`}function Xi(n){const[e,t,s,i]=n.split("|");return{roomId:e,targetEventId:t,relType:s,sourceEventId:i}}class cc{constructor(e){this._store=e}add(e,t,s,i){this._store.add({key:ue(e,t,s,i)})}remove(e,t,s,i){this._store.delete(ue(e,t,s,i))}removeAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ue(e,t,P,P),ue(e,t,D,D),!0,!0);this._store.delete(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ue(e,P,P,P),ue(e,D,D,D),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,s){const i=this._store.IDBKeyRange.bound(ue(e,t,s,P),ue(e,t,s,D),!0,!0);return(await this._store.selectAll(i)).map(o=>Xi(o.key))}async getAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ue(e,t,P,P),ue(e,t,D,D),!0,!0);return(await this._store.selectAll(s)).map(r=>Xi(r.key))}}function ls(n,e,t){return`${n}|${e}|${t}`}class hc{constructor(e){this._roomStateStore=e}get(e,t,s){const i=ls(e,t,s);return this._roomStateStore.get(i)}getAllForType(e,t){const s=this._roomStateStore.IDBKeyRange.bound(ls(e,t,""),ls(e,t,D),!1,!0);return this._roomStateStore.selectAll(s)}set(e,t){const s=ls(e,t.type,t.state_key),i={roomId:e,event:t,key:s};this._roomStateStore.put(i)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${D}`,!0,!0);this._roomStateStore.delete(t)}}function ds(n,e){return`${n}|${e}`}function lc(n){const[e,t]=n.split("|");return{roomId:e,userId:t}}class dn{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(ds(e,t))}set(e){e.key=ds(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(ds(e,""));return this._roomMembersStore.selectWhile(t,s=>s.roomId===e)}async getAllUserIds(e){const t=[],s=this._roomMembersStore.IDBKeyRange.lowerBound(ds(e,""));return await this._roomMembersStore.iterateKeys(s,i=>{const r=lc(i);return r.roomId===e?(t.push(r.userId),!1):!0}),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${D}`,!0,!0);this._roomMembersStore.delete(t)}}function us(n,e){return`${n}|${Ms(e)}`}class dc{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(us(e,U.minStorageKey),us(e,U.maxStorageKey))}catch(t){throw new xe(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=us(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(us(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function ze(n,e){return`${n}|${Ms(e)}`}function uc(n){const[e,t]=n.split("|"),s=Xs(t);return{roomId:e,queueIndex:s}}class mc{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(ze(e,U.minStorageKey),ze(e,U.maxStorageKey),!1,!1),s=await this._eventStore.findMaxKey(t);if(s)return uc(s).queueIndex}remove(e,t){const s=this._eventStore.IDBKeyRange.only(ze(e,t));this._eventStore.delete(s)}async exists(e,t){const s=this._eventStore.IDBKeyRange.only(ze(e,t));return!!await this._eventStore.getKey(s)}add(e){e.key=ze(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=ze(e,U.minStorageKey),s=ze(e,U.maxStorageKey),i=this._eventStore.IDBKeyRange.bound(t,s);this._eventStore.delete(i)}}class pc{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function Je(n,e){return`${n}|${e}`}function _c(n){const[e,t]=n.split("|");return{userId:e,deviceId:t}}class gc{constructor(e){this._store=e}async getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(Je(e,P));return(await this._store.selectWhile(t,i=>i.deviceKey.user_id===e)).map(i=>i.deviceKey)}async getAllDeviceIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(Je(e,P));return await this._store.iterateKeys(s,i=>{const r=_c(i);return r.userId===e?(t.push(r.deviceId),!1):!0}),t}async get(e,t){var s;return(s=await this._store.get(Je(e,t)))==null?void 0:s.deviceKey}set(e){this._store.put({key:Je(e.user_id,e.device_id),curve25519Key:_e(e),deviceKey:e})}async getByCurve25519Key(e){const t=await this._store.index("byCurve25519Key").get(e);return t==null?void 0:t.deviceKey}remove(e,t){this._store.delete(Je(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(Je(e,P),Je(e,D),!0,!0);this._store.delete(t)}}function At(n,e){return`${n}|${e}`}class fc{constructor(e){this._store=e}async get(e,t){var s;return(s=await this._store.get(At(e,t)))==null?void 0:s.crossSigningKey}set(e){this._store.put({key:At(e.user_id,e.usage[0]),crossSigningKey:e})}remove(e,t){this._store.delete(At(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(At(e,P),At(e,D),!0,!0);this._store.delete(t)}}function Vt(n,e){return`${n}|${e}`}function yc(n){const[e,t]=n.split("|");return{senderKey:e,sessionId:t}}class wc{constructor(e){this._store=e}async getSessionIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(Vt(e,""));return await this._store.iterateKeys(s,i=>{const r=yc(i);return r.senderKey===e?(t.push(r.sessionId),!1):!0}),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(Vt(e,""));return this._store.selectWhile(t,s=>s.senderKey===e)}get(e,t){return this._store.get(Vt(e,t))}set(e){e.key=Vt(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(Vt(e,t))}}var Ps=(n=>(n[n.NotBackedUp=0]="NotBackedUp",n[n.BackedUp=1]="BackedUp",n))(Ps||{}),ss=(n=>(n[n.DeviceMessage=1]="DeviceMessage",n[n.Backup=2]="Backup",n[n.Outbound=3]="Outbound",n))(ss||{});function lt(n,e,t){return`${n}|${e}|${t}`}class vc{constructor(e){this._store=e}async has(e,t,s){const i=lt(e,t,s),r=await this._store.getKey(i);return i===r}get(e,t,s){return this._store.get(lt(e,t,s))}set(e){const t=e;t.key=lt(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(lt(e,P,P),lt(e,D,D));this._store.delete(t)}countNonBackedUpSessions(){return this._store.index("byBackup").count(this._store.IDBKeyRange.only(0))}getFirstNonBackedUpSessions(e){return this._store.index("byBackup").selectLimit(this._store.IDBKeyRange.only(0),e)}async markAsBackedUp(e,t,s){const i=await this._store.get(lt(e,t,s));i&&(i.backup=1,this._store.put(i))}async markAllAsNotBackedUp(){const e=this._store.IDBKeyRange.only(1);let t=0;return await this._store.index("byBackup").iterateValues(e,(s,i,r)=>(s.backup=0,r.update(s),t+=1,!1)),t}}class bc{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function ms(n,e,t){return`${n}|${e}|${t}`}class Sc{constructor(e){this._store=e}get(e,t,s){return this._store.get(ms(e,t,s))}set(e,t,s,i){i.key=ms(e,t,s),this._store.put(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ms(e,P,P),ms(e,D,D));this._store.delete(t)}}function Ft(n,e){return`${n}|${e}`}class Ic{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const s=Ft(t,e),i=[];return await this._store.index("byScopeAndType").iterateWhile(s,r=>r.scopeTypeKey!==s?!1:(i.push(r),!0)),i}add(e){e.scopeTypeKey=Ft(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(Ft(e,P),Ft(e,D));await this._store.index("byScopeAndType").iterateValues(t,(i,r,o)=>(o.delete(),!0))}}class kc{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}async getAll(){return await this._store.selectAll()}}function dt(n,e,t){return`${n}|${e}|${t}`}function Zi(n){const[e,t,s]=n.key.split("|");return{intent:e,roomId:t,callId:s,timestamp:n.timestamp}}class Mc{constructor(e){this._callStore=e}async getByIntent(e){const t=this._callStore.IDBKeyRange.bound(dt(e,P,P),dt(e,D,D),!0,!0);return(await this._callStore.selectAll(t)).map(i=>Zi(i))}async getByIntentAndRoom(e,t){const s=this._callStore.IDBKeyRange.bound(dt(e,t,P),dt(e,t,D),!0,!0);return(await this._callStore.selectAll(s)).map(r=>Zi(r))}add(e){const t={key:dt(e.intent,e.roomId,e.callId),timestamp:e.timestamp};this._callStore.add(t)}remove(e,t,s){this._callStore.delete(dt(e,t,s))}}class Cc{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e,t){t.key=e,this._store.put(t)}remove(e){this._store.delete(e)}deleteAllSecrets(){this._store.clear()}}class Rc{constructor(e,t,s,i){this.error=e,this.refItem=t,this.operationName=s,this.keys=i}}class er{constructor(e,t,s){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=s,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new xe(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new an(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const s=this._idbStore(e);this._stores[e]=t(s)}return this._stores[e]}get session(){return this._store(C.session,e=>new vi(e,this._storage.localStorage))}get roomSummary(){return this._store(C.roomSummary,e=>new Yi(e))}get archivedRoomSummary(){return this._store(C.archivedRoomSummary,e=>new Yi(e))}get invites(){return this._store(C.invites,e=>new sc(e))}get timelineFragments(){return this._store(C.timelineFragments,e=>new dc(e))}get timelineEvents(){return this._store(C.timelineEvents,e=>new ac(e))}get timelineRelations(){return this._store(C.timelineRelations,e=>new cc(e))}get roomState(){return this._store(C.roomState,e=>new hc(e))}get roomMembers(){return this._store(C.roomMembers,e=>new dn(e))}get pendingEvents(){return this._store(C.pendingEvents,e=>new mc(e))}get userIdentities(){return this._store(C.userIdentities,e=>new pc(e))}get deviceKeys(){return this._store(C.deviceKeys,e=>new gc(e))}get crossSigningKeys(){return this._store(C.crossSigningKeys,e=>new fc(e))}get olmSessions(){return this._store(C.olmSessions,e=>new wc(e))}get inboundGroupSessions(){return this._store(C.inboundGroupSessions,e=>new vc(e))}get outboundGroupSessions(){return this._store(C.outboundGroupSessions,e=>new bc(e))}get groupSessionDecryptions(){return this._store(C.groupSessionDecryptions,e=>new Sc(e))}get operations(){return this._store(C.operations,e=>new Ic(e))}get accountData(){return this._store(C.accountData,e=>new kc(e))}get calls(){return this._store(C.calls,e=>new Mc(e))}get sharedSecrets(){return this._store(C.sharedSecrets,e=>new Cc(e))}async complete(e){try{await zt(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof xe&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e==null||e.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,s,i){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new Rc(e,t,s,i))}_logWriteErrors(e){const t=i=>{e||i.set("allowedStoreNames",this._allowedStoreNames);for(const r of this._writeErrors)i.wrap({l:r.operationName,id:r.keys},o=>{r.refItem&&o.refDetached(r.refItem),o.catch(r.error)})},s=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(s,t):this.logger.run(s,t)}}const tr="782rh281re38-boguskey";class Ec{constructor(e,t,s,i,r,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=s,this._hasWebkitEarlyCloseTxnBug=i,this.storeNames=C,this.localStorage=r,this.logger=o}_validateStoreNames(e){const t=e.findIndex(s=>!Gt.includes(s));if(t!==-1)throw new xe(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await H(t.objectStore(e[0]).get(tr)),new er(t,e,this)}catch(t){throw new xe("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await H(t.objectStore(e[0]).get(tr)),new er(t,e,this)}catch(t){throw new xe("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}}async function Tc(n){const e=n.transaction(Gt,"readonly"),t={};return await Promise.all(Gt.map(async s=>{const i=t[s]=[],r=e.objectStore(s);await K(r.openCursor(),o=>(i.push(o),Ue))})),t}async function Ac(n,e){const t=n.transaction(Gt,"readwrite");for(const s of Gt){const i=t.objectStore(s);for(const r of e[s])i.add(r)}await zt(t)}function Vc(n,e,t,s,i){let r=!1;if(t instanceof Uint8Array){const c=new n.PkSigning;i=c.init_with_seed(t),t=c,r=!0}const o=e.signatures||{};delete e.signatures;const a=e.unsigned;e.unsigned&&delete e.unsigned;try{const c=o[s]||{};return o[s]=c,c["ed25519:"+i]=t.sign(ts.stringify(e))}finally{e.signatures=o,a&&(e.unsigned=a),r&&t.free()}}class Oe{constructor(e){this.options=e,this.ourUserId=e.ourUserId,this.ourUserDeviceId=e.ourUserDeviceId,this.otherUserId=e.otherUserId,this.log=e.log,this.olmSAS=e.olmSas,this.olmUtil=e.olmUtil,this.channel=e.channel,this.e2eeAccount=e.e2eeAccount,this.deviceTracker=e.deviceTracker,this.hsApi=e.hsApi,this.eventEmitter=e.eventEmitter}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}get otherUserDeviceId(){const e=this.channel.otherUserDeviceId;if(!e)throw new Error("Accessed otherUserDeviceId before it was set in channel!");return e}}var w=(n=>(n.Request="m.key.verification.request",n.Ready="m.key.verification.ready",n.Start="m.key.verification.start",n.Accept="m.key.verification.accept",n.Key="m.key.verification.key",n.Cancel="m.key.verification.cancel",n.Mac="m.key.verification.mac",n.Done="m.key.verification.done",n))(w||{}),f=(n=>(n.UserCancelled="m.user",n.TimedOut="m.timeout",n.UnknownTransaction="m.unknown_transaction",n.UnknownMethod="m.unknown_method",n.UnexpectedMessage="m.unexpected_message",n.KeyMismatch="m.key_mismatch",n.UserMismatch="m.user_mismatch",n.InvalidMessage="m.invalid_message",n.OtherDeviceAccepted="m.accepted",n.MismatchedCommitment="m.mismatched_commitment",n.MismatchedSAS="m.mismatched_sas",n))(f||{});const un=["curve25519-hkdf-sha256","curve25519"],mn=["sha256"],pn=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],_n=["decimal","emoji"],xc=new Set(_n),Nc=[["\u{1F436}","dog"],["\u{1F431}","cat"],["\u{1F981}","lion"],["\u{1F40E}","horse"],["\u{1F984}","unicorn"],["\u{1F437}","pig"],["\u{1F418}","elephant"],["\u{1F430}","rabbit"],["\u{1F43C}","panda"],["\u{1F413}","rooster"],["\u{1F427}","penguin"],["\u{1F422}","turtle"],["\u{1F41F}","fish"],["\u{1F419}","octopus"],["\u{1F98B}","butterfly"],["\u{1F337}","flower"],["\u{1F333}","tree"],["\u{1F335}","cactus"],["\u{1F344}","mushroom"],["\u{1F30F}","globe"],["\u{1F319}","moon"],["\u2601\uFE0F","cloud"],["\u{1F525}","fire"],["\u{1F34C}","banana"],["\u{1F34E}","apple"],["\u{1F353}","strawberry"],["\u{1F33D}","corn"],["\u{1F355}","pizza"],["\u{1F382}","cake"],["\u2764\uFE0F","heart"],["\u{1F642}","smiley"],["\u{1F916}","robot"],["\u{1F3A9}","hat"],["\u{1F453}","glasses"],["\u{1F527}","spanner"],["\u{1F385}","santa"],["\u{1F44D}","thumbs up"],["\u2602\uFE0F","umbrella"],["\u231B","hourglass"],["\u23F0","clock"],["\u{1F381}","gift"],["\u{1F4A1}","light bulb"],["\u{1F4D5}","book"],["\u270F\uFE0F","pencil"],["\u{1F4CE}","paperclip"],["\u2702\uFE0F","scissors"],["\u{1F512}","lock"],["\u{1F511}","key"],["\u{1F528}","hammer"],["\u260E\uFE0F","telephone"],["\u{1F3C1}","flag"],["\u{1F682}","train"],["\u{1F6B2}","bicycle"],["\u2708\uFE0F","aeroplane"],["\u{1F680}","rocket"],["\u{1F3C6}","trophy"],["\u26BD","ball"],["\u{1F3B8}","guitar"],["\u{1F3BA}","trumpet"],["\u{1F514}","bell"],["\u2693\uFE0F","anchor"],["\u{1F3A7}","headphones"],["\u{1F4C1}","folder"],["\u{1F4CC}","pin"]];function Dc(n){return[n[0]>>2,(n[0]&3)<<4|n[1]>>4,(n[1]&15)<<2|n[2]>>6,n[2]&63,n[3]>>2,(n[3]&3)<<4|n[4]>>4,(n[4]&15)<<2|n[5]>>6].map(t=>Nc[t])}const Uc={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function gn(n,e){return function(t,s,i){return i.wrap({l:"calculate MAC",method:e},()=>n[Uc[e]](t,s))}}class Pc extends Oe{async completeStage(){await this.log.wrap("SendDoneStage.completeStage",async e=>{await this.channel.send(w.Done,{},e),await this.channel.waitForEvent(w.Done),this.eventEmitter.emit("VerificationCompleted",this.otherUserDeviceId)})}}class Fc extends Oe{async completeStage(){await this.log.wrap("VerifyMacStage.completeStage",async e=>{const s=this.channel.acceptMessage.content.message_authentication_code,i=gn(this.olmSAS,s);await this.checkMAC(i,e),this.setNextStage(new Pc(this.options))})}async checkMAC(e,t){const{content:s}=this.channel.getReceivedMessage(w.Mac),i="MATRIX_KEY_VERIFICATION_MAC"+this.otherUserId+this.otherUserDeviceId+this.ourUserId+this.ourUserDeviceId+this.channel.id,r=e(Object.keys(s.mac).sort().join(","),i+"KEY_IDS",t);if(s.keys!==r){t.log({l:"MAC verification failed for keys field",keys:s.keys,calculated:r}),this.channel.cancelVerification(f.KeyMismatch);return}await this.verifyKeys(s.mac,(o,a,c)=>{const h=e(a,i+o,t),l=c===h;return l||(t.log({l:"Mac verification failed for key",keyMac:c,calculatedMAC:h,keyId:o,key:a}),this.channel.cancelVerification(f.KeyMismatch)),l},t)}async verifyKeys(e,t,s){const i=this.otherUserId;for(const[r,o]of Object.entries(e)){const a=r.split(":",2)[1],c=await this.deviceTracker.deviceForId(i,a,this.hsApi,s);if(c){if(!t(r,tt(c),o))throw new Error(`MAC verification failed for key ${o}`)}else{const h=await this.deviceTracker.getCrossSigningKeyForUser(i,Ie.Master,this.hsApi,s);if(!h)throw s.log({l:"Fetching msk failed",userId:i}),new Error("Fetching MSK for user failed!");const l=gt(h);if(!(l&&t(r,l,o)))throw new Error(`MAC verification failed for key ${o}`)}}}}class Oc extends Oe{async completeStage(){await this.log.wrap("SendMacStage.completeStage",async e=>{const s=this.channel.acceptMessage.content.message_authentication_code,i=gn(this.olmSAS,s);await this.sendMAC(i,e),await this.channel.waitForEvent(w.Mac),this.setNextStage(new Fc(this.options))})}async sendMAC(e,t){const s={},i=[],r="MATRIX_KEY_VERIFICATION_MAC"+this.ourUserId+this.ourUserDeviceId+this.otherUserId+this.otherUserDeviceId+this.channel.id,o=`ed25519:${this.ourUserDeviceId}`,a=this.e2eeAccount.getUnsignedDeviceKey();s[o]=e(a.keys[o],r+o,t),i.push(o);const c=await this.deviceTracker.getCrossSigningKeyForUser(this.ourUserId,Ie.Master,this.hsApi,t);if(!c)throw t.log({l:"Fetching msk failed",userId:this.ourUserId}),new Error("Fetching MSK for user failed!");const h=gt(c);if(h){const d=`ed25519:${h}`;s[d]=e(h,r+d,t),i.push(d)}const l=e(i.sort().join(","),r+"KEY_IDS",t);await this.channel.send(w.Mac,{mac:s,keys:l},t)}}class ge extends Error{get name(){return"VerificationCancelledError"}get message(){return"Verification is cancelled!"}}const Kc={"curve25519-hkdf-sha256":function(n,e,t){const s=`${n.our.userId}|${n.our.deviceId}|${n.our.publicKey}|`,i=`${n.their.userId}|${n.their.deviceId}|${n.their.publicKey}|`,r="MATRIX_KEY_VERIFICATION_SAS|"+(n.initiatedByMe?s+i:i+s)+n.id;return e.generate_bytes(r,t)},curve25519:function(n,e,t){const s=`${n.our.userId}${n.our.deviceId}`,i=`${n.their.userId}${n.their.deviceId}`,r="MATRIX_KEY_VERIFICATION_SAS"+(n.initiatedByMe?s+i:i+s)+n.id;return e.generate_bytes(r,t)}};class Lc extends Oe{async completeStage(){await this.log.wrap("CalculateSASStage.completeStage",async e=>{if(this.channel.initiatedByUs&&!await this.verifyHashCommitment(e))return;const t=new Promise((r,o)=>{this.resolve=r,this.reject=o});this.olmSAS.set_their_key(this.theirKey);const s=this.generateSASBytes();this.emoji=Dc(Array.from(s)),this.eventEmitter.emit("EmojiGenerated",this);const i=this.channel.waitForEvent(w.Cancel);await Promise.race([t,i]),this.setNextStage(new Oc(this.options))})}async verifyHashCommitment(e){return await e.wrap("CalculateSASStage.verifyHashCommitment",async()=>{const t=this.channel.getReceivedMessage(w.Accept).content,i=this.channel.getReceivedMessage(w.Key).content.key+ts.stringify(this.channel.startMessage.content),r=t.commitment,o=this.olmUtil.sha256(i);return o!==r?(e.log({l:"Commitment mismatched!",received:r,calculated:o}),await this.channel.cancelVerification(f.MismatchedCommitment),!1):!0})}generateSASBytes(){const e=this.channel.acceptMessage.content.key_agreement_protocol,t=this.otherUserDeviceId;return Kc[e]({our:{userId:this.ourUserId,deviceId:this.ourUserDeviceId,publicKey:this.olmSAS.get_pubkey()},their:{userId:this.otherUserId,deviceId:t,publicKey:this.theirKey},id:this.channel.id,initiatedByMe:this.channel.initiatedByUs},this.olmSAS,6)}async setEmojiMatch(e){e?this.resolve():(await this.channel.cancelVerification(f.MismatchedSAS),this.reject(new ge))}get theirKey(){const{content:e}=this.channel.getReceivedMessage(w.Key);return e.key}}class fn extends Oe{async completeStage(){await this.log.wrap("SendKeyStage.completeStage",async e=>{const t=this.olmSAS.get_pubkey();await this.channel.send(w.Key,{key:t},e),await this.channel.waitForEvent(w.Key),this.setNextStage(new Lc(this.options))})}}function ps(n,e){return Array.isArray(n)?n.filter(t=>e.has(t)):[]}class Bc extends Oe{async completeStage(){await this.log.wrap("SendAcceptVerificationStage.completeStage",async e=>{const{content:t}=this.channel.startMessage,s=ps(un,new Set(t.key_agreement_protocols))[0],i=ps(mn,new Set(t.hashes))[0],r=ps(pn,new Set(t.message_authentication_codes))[0],o=ps(t.short_authentication_string,xc);if(!s||!i||!r||!o.length){await this.channel.cancelVerification(f.UnknownMethod);return}const c=this.olmSAS.get_pubkey()+ts.stringify(t),h={key_agreement_protocol:s,hash:i,message_authentication_code:r,short_authentication_string:o,commitment:this.olmUtil.sha256(c)};await this.channel.send(w.Accept,h,e),await this.channel.waitForEvent(w.Key),this.setNextStage(new fn(this.options))})}}class bi extends Oe{constructor(){super(...arguments),this.allowSelection=!0}async completeStage(){await this.log.wrap("SelectVerificationMethodStage.completeStage",async e=>{await this.findDeviceName(e),this.eventEmitter.emit("SelectVerificationStage",this);const t=this.channel.waitForEvent(w.Start),s=this.channel.waitForEvent(w.Accept),{content:i}=await Promise.race([t,s]);i.method?(this.allowSelection=!1,this.hasSentStartMessage?(await this.hasSentStartMessage,await this.resolveStartConflict(e)):this.channel.setStartMessage(this.channel.getReceivedMessage(w.Start))):this.channel.setStartMessage(this.channel.getSentMessage(w.Start)),this.channel.initiatedByUs?(await s,this.setNextStage(new fn(this.options))):this.setNextStage(new Bc(this.options))})}async resolveStartConflict(e){await e.wrap("resolveStartConflict",async()=>{const t=this.channel.getReceivedMessage(w.Start),s=this.channel.getSentMessage(w.Start);if(t.content.method!==s.content.method){e.log({l:"Methods don't match for the start messages",received:t.content.method,sent:s.content.method}),await this.channel.cancelVerification(f.UnexpectedMessage);return}const i=this.ourUserId===this.otherUserId?this.ourUserDeviceId:this.ourUserId,r=this.ourUserId===this.otherUserId?this.otherUserDeviceId:this.otherUserId,o=i<r?s:t;e.log({l:"Start message resolved",message:o,our:i,their:r}),this.channel.setStartMessage(o)})}async findDeviceName(e){await e.wrap("SelectVerificationMethodStage.findDeviceName",async()=>{var s;const t=await this.options.deviceTracker.deviceForId(this.otherUserId,this.otherUserDeviceId,this.options.hsApi,e);if(!t)throw e.log({l:"Cannot find device",userId:this.otherUserId,deviceId:this.otherUserDeviceId}),new Error("Cannot find device");this.otherDeviceName=(s=t.unsigned.device_display_name)!=null?s:t.device_id})}async selectEmojiMethod(e){if(!this.allowSelection)return;const t=new at;this.hasSentStartMessage=t.promise;const s={method:"m.sas.v1",from_device:this.ourUserDeviceId,key_agreement_protocols:un,hashes:mn,message_authentication_codes:pn,short_authentication_string:_n};await this.channel.send(w.Start,s,e),t.resolve()}}class $c extends Oe{async completeStage(){await this.log.wrap("SendRequestVerificationStage.completeStage",async e=>{const t={from_device:this.ourUserDeviceId,methods:["m.sas.v1"]};await this.channel.send(w.Request,t,e),this.setNextStage(new bi(this.options)),await this.channel.waitForEvent(w.Ready)})}}class jc extends Oe{async completeStage(){await this.log.wrap("SendReadyStage.completeStage",async e=>{const t={from_device:this.ourUserDeviceId,methods:["m.sas.v1"]};await this.channel.send(w.Ready,t,e),this.setNextStage(new bi(this.options))})}}class qc extends Fe{constructor(e){super(),this.finished=!1;const{olm:t,channel:s,clock:i}=e,r=new t.SAS;this.olmSas=r,this.channel=s,this.otherUserId=e.otherUserId,this.ourUserId=e.ourUserId,this.setupCancelAfterTimeout(i);const o={...e,olmSas:r,eventEmitter:this};s.getReceivedMessage(w.Start)?this.startStage=new bi(o):s.getReceivedMessage(w.Request)?this.startStage=new jc(o):this.startStage=new $c(o)}async setupCancelAfterTimeout(e){try{this.timeout=e.createTimeout(6e5),await this.timeout.elapsed(),await this.channel.cancelVerification(f.TimedOut)}catch{}}async abort(){await this.channel.cancelVerification(f.UserCancelled),this.finished=!0}async verify(){let e=!0;try{let t=this.startStage;do await t.completeStage(),t=t.nextStage;while(t)}catch(t){if(!(t instanceof ge))throw t;e=!1}finally{this.channel.isCancelled&&this.emit("VerificationCancelled",this.channel.cancellation),this.olmSas.free(),this.timeout.abort(),this.finished=!0}return e}get otherDeviceId(){return this.channel.otherUserDeviceId}get isCrossSigningAnotherUser(){return this.otherUserId!==this.ourUserId}}const Es={[f.UserCancelled]:"User declined",[f.InvalidMessage]:"Invalid Message.",[f.KeyMismatch]:"Key Mismatch.",[f.OtherDeviceAccepted]:"Another device has accepted this request.",[f.TimedOut]:"Timed Out",[f.UnexpectedMessage]:"Unexpected Message.",[f.UnknownMethod]:"Unknown method.",[f.UnknownTransaction]:"Unknown Transaction.",[f.UserMismatch]:"User Mismatch",[f.MismatchedCommitment]:"Hash commitment does not match.",[f.MismatchedSAS]:"Emoji/decimal does not match."};function vt(n,e){return Si(n,e,()=>[],(t,s)=>t.push(s))}function Si(n,e,t,s){return n.reduce((i,r)=>{const o=e(r);let a=i.get(o);return a||(a=t(),i.set(o,a)),s(a,r),i},new Map)}function sr(n,e){return n.reduce((t,s)=>{const i=e(s);return t[i]?t[i]+=1:t[i]=1,t},{})}function Q(){return Ts("t")}function Ts(n){const t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return n+"0".repeat(14-t.length)+t}function ir(n){return n.startsWith("t")&&n.length===15}function Jt(n){const e=vt(n,s=>s.device.user_id);return{messages:Array.from(e.entries()).reduce((s,[i,r])=>(s[i]=r.reduce((o,a)=>(o[a.device.device_id]=a.content,o),{}),s),{})}}function js(n){typeof n=="function"?n():n.dispose()}function Hc(n){return n&&(typeof n=="function"||typeof n.dispose=="function")}class Et{constructor(){this._disposables=[]}track(e){if(!Hc(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),js(e),e):(this._disposables.push(e),e)}untrack(e){if(!this._disposables)return;const t=this._disposables.indexOf(e);t>=0&&this._disposables.splice(t,1)}dispose(){if(this._disposables){for(const e of this._disposables)js(e);this._disposables=void 0}}get isDisposed(){return this._disposables===void 0}disposeTracked(e){if(e==null||this.isDisposed)return;const t=this._disposables.indexOf(e);if(t!==-1){const[s]=this._disposables.splice(t,1);js(s)}else console.warn("disposable not found, did it leak?",e)}}class Wc extends Et{constructor(e,t){super(),this.sentMessages=new Map,this.receivedMessages=new Map,this.waitMap=new Map,this.hsApi=e.hsApi,this.deviceTracker=e.deviceTracker,this.otherUserId=e.otherUserId,this.ourDeviceId=e.ourUserDeviceId,this.clock=e.clock,this.log=e.log,this.deviceMessageHandler=e.deviceMessageHandler,this.track(this.deviceMessageHandler.disposableOn("message",async({unencrypted:s})=>{!s||await this.handleDeviceMessage(s)})),this.track(()=>{this.waitMap.forEach(s=>{s.reject(new ge)})}),t&&(this.id=t.content.transaction_id,this.receivedMessages.set(t.type,t),this.otherUserDeviceId=t.content.from_device)}get cancellation(){return this._cancellation}get isCancelled(){return!!this._cancellation}async send(e,t,s){await s.wrap("ToDeviceChannel.send",async()=>{if(this.isCancelled)throw new ge;if(e===w.Request){await this.handleRequestEventSpecially(e,t,s);return}Object.assign(t,{transaction_id:this.id});const i={messages:{[this.otherUserId]:{[this.otherUserDeviceId]:t}}};await this.hsApi.sendToDevice(e,i,Q(),{log:s}).response(),this.sentMessages.set(e,{content:t})})}async handleRequestEventSpecially(e,t,s){await s.wrap("ToDeviceChannel.handleRequestEventSpecially",async()=>{const i=this.clock.now(),r=Q();this.id=r,Object.assign(t,{timestamp:i,transaction_id:r});const o={messages:{[this.otherUserId]:{"*":t}}};await this.hsApi.sendToDevice(e,o,Q(),{log:s}).response(),this.sentMessages.set(e,{content:t})})}getReceivedMessage(e){return this.receivedMessages.get(e)}getSentMessage(e){return this.sentMessages.get(e)}get acceptMessage(){var e;return(e=this.receivedMessages.get(w.Accept))!=null?e:this.sentMessages.get(w.Accept)}async handleDeviceMessage(e){await this.log.wrap("ToDeviceChannel.handleDeviceMessage",async t=>{if(!!e.type.startsWith("m.key.verification.")){if(e.content.transaction_id!==this.id){await this.cancelVerification(f.UnknownTransaction);return}if(this.resolveAnyWaits(e),this.receivedMessages.set(e.type,e),e.type===w.Ready){this.handleReadyMessage(e,t);return}if(e.type===w.Cancel){this._cancellation={code:e.content.code,cancelledByUs:!1},this.dispose();return}}})}async handleReadyMessage(e,t){const s=e.content.from_device;this.otherUserDeviceId=s;const r=(await this.deviceTracker.devicesForUsers([this.otherUserId],this.hsApi,t)).filter(h=>h.device_id!==s&&h.device_id!==this.ourDeviceId),o={code:f.OtherDeviceAccepted,reason:Es[f.OtherDeviceAccepted],transaction_id:this.id},a=r.reduce((h,l)=>(h[l.device_id]=o,h),{}),c={messages:{[this.otherUserId]:a}};await this.hsApi.sendToDevice(w.Cancel,c,Q(),{log:t}).response()}async cancelVerification(e){await this.log.wrap("Channel.cancelVerification",async t=>{var i;if(this.isCancelled)throw new ge;const s={messages:{[this.otherUserId]:{[(i=this.otherUserDeviceId)!=null?i:"*"]:{code:e,reason:Es[e],transaction_id:this.id}}}};await this.hsApi.sendToDevice(w.Cancel,s,Q(),{log:t}).response(),this._cancellation={code:e,cancelledByUs:!0},this.dispose()})}resolveAnyWaits(e){const{type:t}=e,s=this.waitMap.get(t);s&&(s.resolve(e),this.waitMap.delete(t))}waitForEvent(e){if(this.isCancelled)throw new ge;const t=this.receivedMessages.get(e);if(t)return Promise.resolve(t);const s=this.waitMap.get(e);if(s)return s.promise;const i=new at;return this.waitMap.set(e,i),i.promise}setStartMessage(e){this.startMessage=e,this._initiatedByUs=e.content.from_device===this.ourDeviceId}get initiatedByUs(){return this._initiatedByUs}}class Gc extends Et{constructor(e,t){var s,i;if(super(),this.sentMessages=new Map,this.receivedMessages=new Map,this.waitMap=new Map,this.otherUserId=e.otherUserId,this.ourUserId=e.ourUserId,this.ourDeviceId=e.ourUserDeviceId,this.log=e.log,this.room=e.room,this.subscribeToTimeline(),this.track(()=>{this.waitMap.forEach(r=>{r.reject(new ge)})}),t){this.id=t.id;const r=(i=(s=t.content)==null?void 0:s.msgtype)!=null?i:t.eventType;this.receivedMessages.set(r,t),this.otherUserDeviceId=t.content.from_device}}async subscribeToTimeline(){const e=await this.room.openTimeline();this.track(()=>e.release()),this.track(e.entries.subscribe({onAdd:async(t,s)=>{this.handleRoomMessage(s)},onRemove:()=>{},onUpdate:()=>{}}))}get cancellation(){return this._cancellation}get isCancelled(){return!!this._cancellation}async send(e,t,s){await s.wrap("RoomChannel.send",async i=>{if(this.isCancelled)throw new ge;if(e===w.Request){await this.handleRequestEventSpecially(e,t,s);return}!this.id||(await this.room.ensureMessageKeyIsShared(i),Object.assign(t,Na(this.id)),await this.room.sendEvent(e,t,void 0,s),this.sentMessages.set(e,{content:t}))})}async handleRequestEventSpecially(e,t,s){await s.wrap("RoomChannel.handleRequestEventSpecially",async()=>{Object.assign(t,{body:`${this.otherUserId} is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.`,msgtype:w.Request,to:this.otherUserId});const i=await this.room.sendEvent("m.room.message",t,void 0,s);this.id=await i.getRemoteId(),this.sentMessages.set(e,{content:t})})}getReceivedMessage(e){return this.receivedMessages.get(e)}getSentMessage(e){return this.sentMessages.get(e)}get acceptMessage(){var e;return(e=this.receivedMessages.get(w.Accept))!=null?e:this.sentMessages.get(w.Accept)}async handleRoomMessage(e){var s,i;const t=(i=(s=e.content)==null?void 0:s.msgtype)!=null?i:e.eventType;!(t!=null&&t.startsWith("m.key.verification"))||e.sender===this.ourUserId||e.isLoadedFromStorage||await this.log.wrap("RoomChannel.handleRoomMessage",async r=>{if(!this.id)throw new Error("Couldn't find event-id of request message!");if(tn(e.event)!==this.id){await this.cancelVerification(f.UnknownTransaction);return}if(this.resolveAnyWaits(e),this.receivedMessages.set(e.eventType,e),e.eventType===w.Ready){const o=e.content.from_device;this.otherUserDeviceId=o;return}if(e.eventType===w.Cancel){this._cancellation={code:e.content.code,cancelledByUs:!1},this.dispose();return}})}async cancelVerification(e){await this.log.wrap("RoomChannel.cancelVerification",async t=>{if(t.log({reason:Es[e]}),this.isCancelled)throw new ge;const s={code:e,reason:Es[e]};await this.send(w.Cancel,s,t),this._cancellation={code:e,cancelledByUs:!0},this.dispose()})}resolveAnyWaits(e){const{eventType:t}=e,s=this.waitMap.get(t);s&&(s.resolve(e),this.waitMap.delete(t))}waitForEvent(e){if(this.isCancelled)throw new ge;const t=this.receivedMessages.get(e);if(t)return Promise.resolve(t);const s=this.waitMap.get(e);if(s)return s.promise;const i=new at;return this.waitMap.set(e,i),i.promise}setStartMessage(e){if(e.content["m.relates_to"])this.startMessage=e;else{const t=e.clone();t.content["m.relates_to"]=t.event.content["m.relates_to"],this.startMessage=t}this._initiatedByUs=e.content.from_device===this.ourDeviceId}get initiatedByUs(){return this._initiatedByUs}}class vs{constructor(e){this.startingMessage=e}get deviceId(){return this.startingMessage.content.from_device}get sender(){return this.startingMessage.sender}get id(){var e;return(e=this.startingMessage.content.transaction_id)!=null?e:this.startingMessage.eventId}async reject(e,t,s){const i=e.startVerification(this,t,s);await(i==null?void 0:i.abort())}}var Ie=(n=>(n.Master="master",n.SelfSigning="self_signing",n.UserSigning="user_signing",n))(Ie||{}),ne=(n=>(n[n.Trusted=1]="Trusted",n[n.UserNotSigned=2]="UserNotSigned",n[n.UserSignatureMismatch=3]="UserSignatureMismatch",n[n.UserDeviceNotSigned=4]="UserDeviceNotSigned",n[n.UserDeviceSignatureMismatch=5]="UserDeviceSignatureMismatch",n[n.UserSetupError=6]="UserSetupError",n[n.OwnSetupError=7]="OwnSetupError",n))(ne||{});class zc{constructor(e){this._isMasterKeyTrusted=!1,this.observedUsers=new Map,this.receivedSASVerifications=new Ae,this.storage=e.storage,this.secretFetcher=e.secretFetcher,this.platform=e.platform,this.deviceTracker=e.deviceTracker,this.olm=e.olm,this.olmUtil=e.olmUtil,this.hsApi=e.hsApi,this.ownUserId=e.ownUserId,this.deviceId=e.deviceId,this.e2eeAccount=e.e2eeAccount,this.deviceMessageHandler=e.deviceMessageHandler,this.handleSASDeviceMessage=this.handleSASDeviceMessage.bind(this),this.deviceMessageHandler.on("message",this.handleSASDeviceMessage)}async load(e){return await this.verifyMSKFrom4S(!1,e)!==0}async start(e){this.isMasterKeyTrusted||await this.verifyMSKFrom4S(!0,e)}async verifyMSKFrom4S(e,t){return await t.wrap("CrossSigning.verifyMSKFrom4S",async s=>{const i=await this.getSigningKey("master");if(!i)return s.set("failure","no_priv_msk"),0;const r=new this.olm.PkSigning;let o;try{o=r.init_with_seed(i)}finally{r.free()}const a=await this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"master",e?this.hsApi:void 0,s);if(!a)return s.set("failure","no_pub_msk"),1;const c=a&&gt(a);return s.set({publishedMasterKey:c,derivedPublicKey:o}),this._isMasterKeyTrusted=!!c&&c===o,this._isMasterKeyTrusted?3:(s.set("failure","mismatch"),2)})}get isMasterKeyTrusted(){return this._isMasterKeyTrusted}startVerification(e,t,s){const i=s!=null?s:t;if(this.sasVerificationInProgress&&!this.sasVerificationInProgress.finished){i.log({sasVerificationAlreadyInProgress:!0});return}const r=e instanceof vs?e.sender:e,o=e instanceof vs?e.startingMessage:void 0;let a;return r===this.ownUserId?a=new Wc({deviceTracker:this.deviceTracker,hsApi:this.hsApi,otherUserId:r,clock:this.platform.clock,deviceMessageHandler:this.deviceMessageHandler,ourUserDeviceId:this.deviceId,log:i},o):a=new Gc({room:t,otherUserId:r,ourUserId:this.ownUserId,ourUserDeviceId:this.deviceId,log:i},o),this.sasVerificationInProgress=new qc({olm:this.olm,olmUtil:this.olmUtil,ourUserId:this.ownUserId,ourUserDeviceId:this.deviceId,otherUserId:r,log:i,channel:a,e2eeAccount:this.e2eeAccount,deviceTracker:this.deviceTracker,hsApi:this.hsApi,clock:this.platform.clock}),this.sasVerificationInProgress}async handleSASDeviceMessage({unencrypted:e}){!e||e.type!==w.Request&&e.type!==w.Start||await this.platform.logger.run("CrossSigning.handleSASDeviceMessage",async t=>{var a;const s=e.content.transaction_id,i=e.content.from_device,r=e.sender;if(!i||r!==this.ownUserId)return;if(!await this.areWeVerified(t)){const c=await this.deviceTracker.deviceForId(this.ownUserId,i,this.hsApi,t);if(!c||!await this.isOurUserDeviceTrusted(c,t))return}if(((a=this.sasVerificationInProgress)==null?void 0:a.channel.id)!==s)switch(e.type){case w.Cancel:this.receivedSASVerifications.remove(s);return;case w.Request:case w.Start:this.platform.logger.run("Create SASRequest",()=>{this.receivedSASVerifications.set(s,new vs(e))});return;default:return}})}async signOwnDevice(e){return e.wrap("CrossSigning.signOwnDevice",async t=>{if(!this._isMasterKeyTrusted){t.set("mskNotTrusted",!0);return}const s=this.e2eeAccount.getUnsignedDeviceKey();return this.signDeviceKey(s,t)})}async signDevice(e,t){return t.wrap("CrossSigning.signDevice",async s=>{this._isMasterKeyTrusted||s.set("mskNotTrusted",!0);const i=await e.verify()&&this._isMasterKeyTrusted;if(s.set("shouldSign",i),!i)return;const r=e.otherDeviceId;s.set("id",r);const o=await this.deviceTracker.deviceForId(this.ownUserId,r,this.hsApi,s);if(!!o)return delete o.signatures,this.signDeviceKey(o,s)})}async signUser(e,t){return t.wrap("CrossSigning.signUser",async s=>{const i=e.otherUserId;if(s.set("id",i),!this._isMasterKeyTrusted){s.set("mskNotTrusted",!0);return}if(i===this.ownUserId)return;const r=await e.verify();if(s.set("shouldSign",r),!r)return;const o=await this.deviceTracker.getCrossSigningKeyForUser(i,"master",this.hsApi,s);if(!o)return;const a=await this.getSigningKey("user_signing");if(!a)return;delete o.signatures,this.signKey(o,a);const c={[o.user_id]:{[gt(o)]:o}};return await this.hsApi.uploadSignatures(c,{log:s}).response(),await this.deviceTracker.invalidateUserKeys(i),this.emitUserTrustUpdate(i,s),o})}async isOurUserDeviceTrusted(e,t){return await this.platform.logger.wrapOrRun(t,"CrossSigning.isOurUserDeviceTrusted",async s=>{const i=await this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"self_signing",this.hsApi,s);return i?this.hasValidSignatureFrom(e,i,s)===x.Valid:!1})}areWeVerified(e){return this.platform.logger.wrapOrRun(e,"CrossSigning.areWeVerified",async t=>{const s=await this.deviceTracker.deviceForId(this.ownUserId,this.deviceId,this.hsApi,t);return this.isOurUserDeviceTrusted(s,e)})}getUserTrust(e,t){return t.wrap("CrossSigning.getUserTrust",async s=>{s.set("id",e);const i=m=>(s.set("result",m),m);if(!this.isMasterKeyTrusted)return i(7);const r=await s.wrap("get our msk",m=>this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"master",this.hsApi,m));if(!r)return i(7);const o=await s.wrap("get our usk",m=>this.deviceTracker.getCrossSigningKeyForUser(this.ownUserId,"user_signing",this.hsApi,m));if(!o||s.wrap("verify our usk",m=>this.hasValidSignatureFrom(o,r,m))!==x.Valid)return i(7);const c=await s.wrap("get their msk",m=>this.deviceTracker.getCrossSigningKeyForUser(e,"master",this.hsApi,m));if(!c)return i(2);const h=s.wrap("verify their msk",m=>this.hasValidSignatureFrom(c,o,m));if(h!==x.Valid)return h===x.NotSigned?i(2):i(3);const l=await s.wrap("get their ssk",m=>this.deviceTracker.getCrossSigningKeyForUser(e,"self_signing",this.hsApi,m));if(!l||s.wrap("verify their ssk",m=>this.hasValidSignatureFrom(l,c,m))!==x.Valid)return i(6);const p=(await s.wrap("get their devices",m=>this.deviceTracker.devicesForUsers([e],this.hsApi,m))).reduce((m,_)=>s.wrap({l:"verify device",id:_.device_id},y=>{const M=this.hasValidSignatureFrom(_,l,y);return m===x.Invalid||M===x.Invalid?x.Invalid:m===x.NotSigned||M===x.NotSigned?x.NotSigned:m===x.Valid||M===x.Valid?x.Valid:x.Invalid}),x.Valid);return p!==x.Valid?p===x.NotSigned?i(4):i(5):i(1)})}dispose(){this.deviceMessageHandler.off("message",this.handleSASDeviceMessage)}observeUserTrust(e,t){const s=this.observedUsers.get(e);if(s)return s;const i=new Wt(void 0,()=>{this.observedUsers.delete(e)});return this.observedUsers.set(e,i),t.wrapDetached("get user trust",async r=>{i.get()===void 0&&i.set(await this.getUserTrust(e,r))}),i}async signDeviceKey(e,t){const s=await this.getSigningKey("self_signing");if(!s)return;this.signKey(e,s);const i={[e.user_id]:{[e.device_id]:e}};return await this.hsApi.uploadSignatures(i,{log:t}).response(),await this.deviceTracker.invalidateUserKeys(this.ownUserId),this.emitUserTrustUpdate(this.ownUserId,t),e}async getSigningKey(e){const t=await this.secretFetcher.getSecret(`m.cross_signing.${e}`);if(t)return new Uint8Array(this.platform.encoding.base64.decode(t))}signKey(e,t){Vc(this.olm,e,t,this.ownUserId,"")}hasValidSignatureFrom(e,t,s){const i=gt(t);return i?_i(this.olmUtil,t.user_id,i,i,e,s):x.NotSigned}emitUserTrustUpdate(e,t){const s=this.observedUsers.get(e);s&&s.get()!==void 0&&(s.set(void 0),t.wrapDetached("update user trust",async i=>{s.set(await this.getUserTrust(e,i))}))}}function Jc(n){if(!Array.isArray(n.usage)||n.usage.length!==1)return;const e=n.usage[0];if(!(e!=="master"&&e!=="self_signing"&&e!=="user_signing"))return e}const Yc="ed25519",Qc=`${Yc}:`;function gt(n){const e=Object.keys(n.keys).filter(i=>i.startsWith(Qc));if(e.length!==1)return;const t=e[0];return n.keys[t]}function rr(n){return n.user_id}var yn=(n=>(n[n.Outdated=0]="Outdated",n[n.UpToDate=1]="UpToDate",n))(yn||{});function wn(n,e){return{userId:n,roomIds:e?[e]:[],keysTrackingStatus:0}}function Xc(n,e,t){if(n){if(!n.roomIds.includes(t))return n.roomIds.push(t),n}else return n=wn(e,t),n}class Zc{constructor(e){this._storage=e.storage,this._getSyncToken=e.getSyncToken,this._olmUtil=e.olmUtil,this._ownUserId=e.ownUserId,this._ownDeviceId=e.ownDeviceId}async writeDeviceChanges(e,t,s){const{userIdentities:i}=t;s.set("changed",e.length),await Promise.all(e.map(async r=>{const o=await i.get(r);o&&(s.log({l:"outdated",id:r}),o.keysTrackingStatus=0,i.set(o))}))}async writeMemberChanges(e,t,s,i){const r=[],o=[];return await Promise.all(Array.from(t.values()).map(async a=>{if(as(a.membership,s))await this._addRoomToUserIdentity(a.roomId,a.userId,i)&&r.push(a.userId);else if(as(a.previousMembership,s)){const{roomId:c}=a;if(a.userId===this._ownUserId){const h=await i.roomMembers.getAllUserIds(c);await Promise.all(h.map(l=>this._removeRoomFromUserIdentity(c,l,i)))}else await this._removeRoomFromUserIdentity(c,a.userId,i);o.push(a.userId)}})),{added:r,removed:o}}async trackRoom(e,t,s){if(e.isTrackingMembers||!e.isEncrypted)return;const i=await e.loadMemberList(void 0,s),r=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities,this._storage.storeNames.deviceKeys]);try{let o;try{o=e.writeIsTrackingMembers(!0,r);const a=Array.from(i.members.values());s.set("members",a.length),await Promise.all(a.map(async c=>{as(c.membership,t)?await this._addRoomToUserIdentity(c.roomId,c.userId,r):await this._removeRoomFromUserIdentity(c.roomId,c.userId,r)}))}catch(a){throw r.abort(),a}await r.complete(),e.applyIsTrackingMembersChanges(o)}finally{i.release()}}async invalidateUserKeys(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities]),s=await t.userIdentities.get(e);s&&(s.keysTrackingStatus=0,t.userIdentities.set(s)),await t.complete()}async getCrossSigningKeyForUser(e,t,s,i){return await i.wrap({l:"DeviceTracker.getCrossSigningKeyForUser",id:e,usage:t},async r=>{const o=await this._storage.readTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.crossSigningKeys]),a=await o.userIdentities.get(e);if(a&&a.keysTrackingStatus!==0)return await o.crossSigningKeys.get(e,t);if(!s)return;const c=await this._queryKeys([e],s,r);switch(t){case Ie.Master:return c.masterKeys.get(e);case Ie.SelfSigning:return c.selfSigningKeys.get(e);case Ie.UserSigning:return c.userSigningKeys.get(e)}})}async writeHistoryVisibility(e,t,s,i){const r=[],o=[];return e.isTrackingMembers&&e.isEncrypted&&await i.wrap("rewriting userIdentities",async a=>{const c=await e.loadMemberList(s,a);try{const h=Array.from(c.members.values());a.set("members",h.length),await Promise.all(h.map(async l=>{as(l.membership,t)?await this._addRoomToUserIdentity(l.roomId,l.userId,s)&&r.push(l.userId):await this._removeRoomFromUserIdentity(l.roomId,l.userId,s)&&o.push(l.userId)}))}finally{c.release()}}),{added:r,removed:o}}async _addRoomToUserIdentity(e,t,s){const{userIdentities:i}=s,r=await i.get(t),o=Xc(r,t,e);return o?(i.set(o),!0):!1}async _removeRoomFromUserIdentity(e,t,s){const{userIdentities:i,deviceKeys:r}=s,o=await i.get(t);return o?(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(i.remove(t),r.removeAllForUser(t)):i.set(o),!0):!1}async _queryKeys(e,t,s){const i=await t.queryKeys({timeout:1e4,device_keys:e.reduce((l,d)=>(l[d]=[],l),{}),token:this._getSyncToken()},{log:s}).response(),r=s.wrap("master keys",l=>this._filterVerifiedCrossSigningKeys(i.master_keys,Ie.Master,l)),o=s.wrap("self-signing keys",l=>this._filterVerifiedCrossSigningKeys(i.self_signing_keys,Ie.SelfSigning,l)),a=s.wrap("user-signing keys",l=>this._filterVerifiedCrossSigningKeys(i.user_signing_keys,Ie.UserSigning,l)),c=s.wrap("device keys",l=>this._filterVerifiedDeviceKeys(i.device_keys,l)),h=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceKeys,this._storage.storeNames.crossSigningKeys]);try{for(const d of r.values())h.crossSigningKeys.set(d);for(const d of o.values())h.crossSigningKeys.set(d);for(const d of a.values())h.crossSigningKeys.set(d);let l=0;await Promise.all(Array.from(c.keys()).map(async d=>{let u=c.get(d);l+=u.length,u=await this._storeQueriedDevicesForUserId(d,u,h),c.set(d,u)})),s.set("devices",l)}catch(l){throw h.abort(),l}return await h.complete(),{deviceKeys:c,masterKeys:r,selfSigningKeys:o,userSigningKeys:a}}async _storeQueriedDevicesForUserId(e,t,s){const i=await s.deviceKeys.getAllDeviceIds(e);for(const c of i)t.every(h=>h.device_id!==c)&&s.deviceKeys.remove(e,c);const r=[],o=[];await Promise.all(t.map(async c=>{if(i.includes(c.device_id)){const h=await s.deviceKeys.get(c.user_id,c.device_id);if(h&&tt(h)!==tt(c)){r.push(h);return}}r.push(c),o.push(c)}));for(const c of o)s.deviceKeys.set(c);let a=await s.userIdentities.get(e);return a||(a=wn(e)),a.keysTrackingStatus=1,s.userIdentities.set(a),r}_filterVerifiedCrossSigningKeys(e,t,s){const i=new Map;if(!e)return i;for(const[r,o]of Object.entries(e))s.wrap({l:r},a=>{this._validateCrossSigningKey(r,o,t,a)&&i.set(rr(o),o)});return i}_validateCrossSigningKey(e,t,s,i){return rr(t)!==e?(i.log({l:"user_id mismatch",userId:t.user_id}),!1):Jc(t)!==s?(i.log({l:"usage mismatch",usage:t.usage}),!1):gt(t)?!0:(i.log({l:"no ed25519 key",keys:t.keys}),!1)}_filterVerifiedDeviceKeys(e,t){const s=new Set,i=new Map;if(!e)return i;for(const[r,o]of Object.entries(e))t.wrap(r,a=>{const h=Object.entries(o).filter(([l,d])=>a.wrap(l,u=>{if(this._validateDeviceKey(r,l,d,u)){const p=_e(d);return s.has(p)?(t.log({l:"ignore device with duplicate curve25519 key",keys:d},t.level.Warn),!1):(s.add(p),!0)}else return!1})).map(([,l])=>l);i.set(r,h)});return i}_validateDeviceKey(e,t,s,i){const r=s.device_id,o=s.user_id;if(o!==e)return i.log("user_id mismatch"),!1;if(r!==t)return i.log("device_id mismatch"),!1;const a=tt(s),c=_e(s);if(typeof a!="string"||typeof c!="string")return i.log("ed25519 and/or curve25519 key invalid").set({deviceKey:s}),!1;const h=_i(this._olmUtil,o,r,a,s,i)===x.Valid;return h||i.log({l:"ignore device with invalid signature",keys:s},i.level.Warn),h}async devicesForTrackedRoom(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),r=await i.roomMembers.getAllUserIds(e);return await this._devicesForUserIdsInTrackedRoom(e,r,i,t,s)}async devicesForRoomMembers(e,t,s,i){const r=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIdsInTrackedRoom(e,t,r,s,i)}async devicesForUsers(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.userIdentities]),r=[],o=[];return await Promise.all(e.map(async a=>{const c=await i.userIdentities.get(a);c&&c.keysTrackingStatus===1?r.push(c):(!c||c.keysTrackingStatus===0)&&o.push(a)})),this._devicesForUserIdentities(r,o,t,s)}async deviceForId(e,t,s,i){var h;const o=await(await this._storage.readTxn([this._storage.storeNames.userIdentities])).userIdentities.get(e);if((o==null?void 0:o.keysTrackingStatus)!==1){const{deviceKeys:l}=await this._queryKeys([e],s,i);return l.get(e).find(p=>p.device_id===t)}let c=await(await this._storage.readTxn([this._storage.storeNames.deviceKeys])).deviceKeys.get(e,t);if(c)i.set("existingDevice",!0);else{const l=await s.queryKeys({timeout:1e4,device_keys:{[e]:[t]},token:this._getSyncToken()},{log:i}).response(),u=(h=i.wrap("verify",_=>this._filterVerifiedDeviceKeys(l.device_keys,_)).get(e))==null?void 0:h.find(_=>_.device_id===t);if(!u)return;const p=await this._storage.readWriteTxn([this._storage.storeNames.deviceKeys]),m=await p.deviceKeys.get(e,t);if(m)c=m,i.set("existingDeviceAfterFetch",!0);else{try{p.deviceKeys.set(u),c=u,i.set("newDevice",!0)}catch(_){throw p.abort(),_}await p.complete()}}return c}async deviceForCurveKey(e,t,s,i){const r=await this._storage.readTxn([this._storage.storeNames.deviceKeys,this._storage.storeNames.userIdentities]),o=await r.userIdentities.get(e);if((o==null?void 0:o.keysTrackingStatus)!==1){const{deviceKeys:c}=await this._queryKeys([e],s,i);return c.get(e).find(d=>_e(d)===t)}return await r.deviceKeys.getByCurve25519Key(t)}async _devicesForUserIdsInTrackedRoom(e,t,s,i,r){const a=(await Promise.all(t.map(d=>s.userIdentities.get(d)))).filter(d=>d&&d.roomIds.includes(e)),c=a.filter(d=>d.keysTrackingStatus===1),h=a.filter(d=>d.keysTrackingStatus===0).map(d=>d.userId);let l=await this._devicesForUserIdentities(c,h,i,r);return l=l.filter(d=>!(d.user_id===this._ownUserId&&d.device_id===this._ownDeviceId)),l}async _devicesForUserIdentities(e,t,s,i){i.set("uptodate",e.length),i.set("outdated",t.length);let r;if(t.length){const{deviceKeys:h}=await this._queryKeys(t,s,i);r=h}const o=await this._storage.readTxn([this._storage.storeNames.deviceKeys]);let c=(await Promise.all(e.map(h=>o.deviceKeys.getAllForUserId(h.userId)))).reduce((h,l)=>h.concat(l),[]);if(r&&r.size)for(const h of r.values())c=c.concat(h);return c}async getDeviceByCurve25519Key(e,t){return await t.deviceKeys.getByCurve25519Key(e)}get ownDeviceId(){return this._ownDeviceId}}const vn=[th,sh,ih,rh,nh,oh,ah,ch,hh,lh,dh,uh,mh,ph,_h,gh,fh,yh,wh];function eh(n){return{databaseName:n.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}}}function th(n){n.createObjectStore("session",{keyPath:"key"}),n.createObjectStore("roomSummary",{keyPath:"roomId"}),n.createObjectStore("timelineFragments",{keyPath:"key"}),n.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),n.createObjectStore("roomState",{keyPath:"key"}),n.createObjectStore("pendingEvents",{keyPath:"key"})}async function sh(n,e){const t=new dn(n.createObjectStore("roomMembers",{keyPath:"key"})),s=e.objectStore("roomState");await K(s.openCursor(),i=>{if(i.event.type===ee){s.delete(i.key);const r=R.fromMemberEvent(i.roomId,i.event);r&&t.set(r.serialize())}return Ue})}async function ih(n,e,t){const s=e.objectStore("session");try{const r=await H(s.get(1));if(r){s.delete(1);const{syncToken:o,syncFilterId:a,serverVersions:c}=r.value,h=new vi(s,t);h.set("sync",{token:o,filterId:a}),h.set("serverVersions",c)}}catch(i){e.abort(),console.error("could not migrate session",i.stack)}}function rh(n){n.createObjectStore("userIdentities",{keyPath:"userId"}),n.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),n.createObjectStore("olmSessions",{keyPath:"key"}),n.createObjectStore("inboundGroupSessions",{keyPath:"key"}),n.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),n.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),n.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function nh(n,e){var r;const t=e.objectStore("roomSummary"),s=e.objectStore("roomState"),i=[];await K(t.openCursor(),o=>(i.push(o),Ue));for(const o of i){const a=await H(s.get(`${o.roomId}|m.room.encryption|`));a&&(o.encryption=(r=a==null?void 0:a.event)==null?void 0:r.content,delete o.isEncrypted,t.put(o))}}function oh(n){n.createObjectStore("accountData",{keyPath:"type"})}function ah(n){n.createObjectStore("invites",{keyPath:"roomId"})}function ch(n){n.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function hh(n,e){try{const t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await K(t.openCursor(),(s,i,r)=>{const{typeScopeKey:o}=s;delete s.typeScopeKey;const[a,c]=o.split("|");return s.scopeTypeKey=Ft(c,a),r.update(s),Ue}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function lh(n){n.createObjectStore("timelineRelations",{keyPath:"key"})}function dh(){}async function uh(n,e){const t=e.objectStore("session"),s=await H(t.get("ssssKey"));s&&t.put({key:`${Y}ssssKey`,value:s.value})}async function mh(n,e,t,s){const i=e.objectStore("session"),r=new vi(new an(i,eh(n)),t);r.writeE2EEIdentityToLocalStorage();const o=await r.tryRestoreE2EEIdentityFromLocalStorage(s);s.set("restored",o)}async function ph(n,e){for(const t of n.objectStoreNames){const s=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await K(s.openCursor(),(i,r,o)=>(r.startsWith(Y)||o.delete(),Ue));break}default:{s.clear();break}}}}async function _h(n,e,t,s){e.objectStore("inboundGroupSessions").createIndex("byBackup","backup",{unique:!1})}async function gh(n,e,t,s){const i=e.objectStore("inboundGroupSessions");let r=0,o=0;await K(i.openCursor(),(a,c,h)=>(a.session?(a.backup=Ps.NotBackedUp,a.source=ss.DeviceMessage,h.update(a),r+=1):o+=1,Ue)),s.set("countWithoutSession",o),s.set("countWithSession",r)}function fh(n){n.createObjectStore("calls",{keyPath:"key"})}async function yh(n,e,t,s){n.createObjectStore("crossSigningKeys",{keyPath:"key"}),n.deleteObjectStore("deviceIdentities"),n.createObjectStore("deviceKeys",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0});const r=e.objectStore("userIdentities");let o=0;await K(r.openCursor(),(a,c,h)=>(delete a.deviceTrackingStatus,delete a.crossSigningKeys,a.keysTrackingStatus=yn.Outdated,h.update(a),o+=1,Ue)),s.set("marked_outdated",o)}function wh(n){n.createObjectStore("sharedSecrets",{keyPath:"key"})}async function vh(n){const e="hydrogen_webkit_test_inactive_txn_bug";try{const t=await wi(e,r=>{r.createObjectStore("test",{keyPath:"key"})},1,n),s=t.transaction(["test"],"readonly");await H(s.objectStore("test").get("somekey")),await new Promise(r=>setTimeout(r,0));const i=t.transaction(["test"],"readwrite");await Promise.resolve(),i.objectStore("test").add({key:"somekey",value:"foo"}),await zt(i),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}const bn=n=>`hydrogen_session_${n}`,qs=function(n,e,t,s){const i=(r,o,a,c)=>Ih(r,o,a,c,t,s);return wi(bn(n),i,vn.length,e)};async function bh(){var e,t;const n=this;if((t=(e=n==null?void 0:n.navigator)==null?void 0:e.storage)!=null&&t.persist)return await n.navigator.storage.persist();if(n!=null&&n.document.requestStorageAccess)try{return await n.document.requestStorageAccess(),!0}catch(s){return console.warn("requestStorageAccess threw an error:",s),!1}else return!1}class Sh{constructor(e,t=window.indexedDB,s=window.IDBKeyRange,i=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=s,this._localStorage=i}async create(e,t){var r;await((r=this._serviceWorkerHandler)==null?void 0:r.preventConcurrentSessionAccess(e)),bh().then(o=>{o||t.log("no persisted storage, database can be evicted by browser",t.level.Warn)});const s=await vh(this._idbFactory),i=await qs(e,this._idbFactory,this._localStorage,t);return new Ec(i,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}async delete(e){const t=bn(e);try{tc(this._localStorage,t)}catch{}try{const s=this._idbFactory.deleteDatabase(t);await H(s)}catch{}}async export(e,t){const s=await qs(e,this._idbFactory,this._localStorage,t);return await Tc(s)}async import(e,t,s){const i=await qs(e,this._idbFactory,this._localStorage,s);return await Ac(i,t)}}async function Ih(n,e,t,s,i,r){const o=t||0;return r.wrap({l:"storage migration",oldVersion:t,version:s},async a=>{for(let c=o;c<s;++c){const h=vn[c];await a.wrap(`v${c+1}`,l=>h(n,e,i,l))}})}class Sn{constructor({roomId:e,ownUserId:t,fragmentIdComparer:s}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=s}async writeRelation(e,t,s){const{relatedEventId:i}=e;if(i){const r=Ke(e.event);r&&r.rel_type&&t.timelineRelations.add(this._roomId,r.event_id,r.rel_type,e.id);const o=await t.timelineEvents.getByEventId(this._roomId,i);if(o){const a=await this._applyRelation(e,o,t,s);if(a)return a.map(c=>(t.timelineEvents.update(c),new re(c,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,s,i){const r=new re(e,this._fragmentIdComparer),o=await this.writeRelation(r,s,i);if(t.isBackward&&!Ys(e.event)){const a=await s.timelineRelations.getAllForTarget(this._roomId,r.id);if(a.length)for(const c of a){const h=await s.timelineEvents.getByEventId(this._roomId,c.sourceEventId);if(h){const l=new re(h,this._fragmentIdComparer);await this._applyRelation(l,e,s,i)}}}return o}async _applyRelation(e,t,s,i){if(e.eventType===fe)return i.wrap("redact",async r=>{const o=t.event,a=Ke(o);if(this._applyRedaction(e.event,t,s,r)){const h=[t];if(a){const l=await this._reaggregateRelation(o,a,s,r);l&&h.push(l)}return h}return null});{const r=Ke(e.event);if(r&&!Ys(t.event)&&r.rel_type===je&&i.wrap("react",c=>this._aggregateAnnotation(e.event,t,c)))return[t]}return null}_applyRedaction(e,t,s,i){const r=t.event;i.set("redactionId",e.event_id),i.set("id",r.event_id);const o=Ke(r);return o&&o.rel_type&&s.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,r.event_id),s.timelineRelations.removeAllForTarget(this._roomId,r.event_id),qa(e,r),delete t.annotations,!0}_aggregateAnnotation(e,t){const s=Ke(e);if(!s)return!1;let{annotations:i}=t;i||(t.annotations=i={});let r=i[s.key];r||(i[s.key]=r={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const o=e.sender===this._ownUserId;return r.me=r.me||o,r.count+=1,r.firstTimestamp=Math.min(r.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,s,i){return t.rel_type===je?i.wrap("reaggregate annotations",r=>this._reaggregateAnnotation(t.event_id,t.key,s,r)):null}async _reaggregateAnnotation(e,t,s,i){const r=await s.timelineEvents.getByEventId(this._roomId,e);if(!r||!r.annotations)return null;i.set("id",e);const o=await s.timelineRelations.getForTargetAndType(this._roomId,e,je);return i.set("relations",o.length),delete r.annotations[t],kh(r.annotations)&&delete r.annotations,await Promise.all(o.map(async a=>{const c=await s.timelineEvents.getByEventId(this._roomId,a.sourceEventId);c||i.log({l:"missing annotation",id:a.sourceEventId}),Ke(c.event).key===t&&this._aggregateAnnotation(c.event,r,i)})),r}}function kh(n){for(const e in n)if(n.hasOwnProperty(e))return!1;return!0}class Pe{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?Pe.Backward:Pe.Forward}static get Forward(){return Mh}static get Backward(){return Ch}}const Mh=new Pe(!0),Ch=new Pe(!1);class ce extends Xr{constructor(e,t,s){super(s),this._fragment=e,this._isFragmentStart=t}static start(e,t){return new ce(e,!0,t)}static end(e,t){return new ce(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?U.minStorageKey:U.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return fi(this.linkedFragmentId)}get direction(){return this.started?Pe.Backward:Pe.Forward}withUpdatedFragment(e){return new ce(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new ce(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}function Rh(n){const e=new Set;return n.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}class Eh{constructor({roomId:e,fragmentIdComparer:t,memberWriter:s,relationWriter:i}){this._roomId=e,this._memberWriter=s,this._relationWriter=i,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s){const[i]=await e.timelineEvents.lastEvents(this._roomId,s.id,1),r=i?i.eventIndex:L.defaultLiveKey.eventIndex;this._lastLiveKey=new L(s.id,r)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s)return s;{t||(t=null);const i={roomId:this._roomId,id:L.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(i),this._fragmentIdComparer.add(i),i}}async _replaceLiveFragment(e,t,s,i){const r=await i.timelineFragments.get(this._roomId,e);if(!r)throw new Error(`old live fragment doesn't exist: ${e}`);r.nextId=t,i.timelineFragments.update(r);const o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:s,nextToken:null};return i.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:r,newFragment:o}}async _ensureLiveFragment(e,t,s,i,r){if(e){if(s.limited){const o=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:a,newFragment:c}=await this._replaceLiveFragment(o,e.fragmentId,s.prev_batch,i);t.push(ce.end(a,this._fragmentIdComparer)),t.push(ce.start(c,this._fragmentIdComparer)),r.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(i,s.prev_batch);e=new L(o.id,L.defaultLiveKey.eventIndex),t.push(ce.start(o,this._fragmentIdComparer)),r.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,s){let i=0;for(const r of e)r.type!==ee&&(t.roomState.set(this._roomId,r),i+=1);s.set("stateEvents",i)}async _writeTimeline(e,t,s,i,r,o){const a=[],c=[];if(e!=null&&e.length){i=await this._ensureLiveFragment(i,a,t,r,o),o.set("timelineEvents",e.length);let h=0;for(const l of e){i=i.nextKey();const d=rn(i,this._roomId,l);let u=await s.lookupMemberAtEvent(l.sender,l,r);if(u&&(d.displayName=u.displayName,d.avatarUrl=u.avatarUrl),!await r.timelineEvents.tryInsert(d,o))continue;const m=new re(d,this._fragmentIdComparer);a.push(m);const _=await this._relationWriter.writeRelation(m,r,o);_&&c.push(..._),typeof l.state_key=="string"&&l.type!==ee&&(h+=1,r.roomState.set(this._roomId,l))}o.set("timelineStateEventCount",h)}return{currentKey:i,entries:a,updatedEntries:c}}async _handleRejoinOverlap(e,t,s){if(this._lastLiveKey){const{fragmentId:i}=this._lastLiveKey,[r]=await t.timelineEvents.lastEvents(this._roomId,i,1);if(r){const o=r.event.event_id,{events:a}=e,c=a.findIndex(h=>h.event_id===o);if(c!==-1)return s.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(c+1)})}}return e.limited?e:(s.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,s,i,r){let{timeline:o}=e;r.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,i,r));let a;Array.isArray(o==null?void 0:o.events)&&(a=Rh(o.events));const{state:c}=e;let h;Array.isArray(c==null?void 0:c.events)&&(h=c.events);const l=this._memberWriter.prepareMemberSync(h,a,s);h&&await this._writeStateEvents(h,i,r);const{currentKey:d,entries:u,updatedEntries:p}=await this._writeTimeline(a,o,l,this._lastLiveKey,i,r),m=await l.write(i);return{entries:u,updatedEntries:p,newLiveKey:d,memberChanges:m,memberSync:l}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class In{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let s=t?this._entries.findIndex(t):-1;this._entries.unshift(e),s===-1?this._entries.length>this.limit&&(s=this._entries.length-1):s+=1,s!==-1&&(this.onEvictEntry(this._entries[s]),this._entries.splice(s,1))}onEvictEntry(e){}}class kn extends In{constructor(e,t){super(e),this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){const t=this._keyFn(e);this._set(e,s=>this._keyFn(s)===t)}}class Th{constructor(e){this._roomId=e,this._cache=new kn(5,t=>t.userId)}prepareMemberSync(e,t,s){return new Ah(this,e,t,s)}async _writeMember(e,t){let s=this._cache.get(e.userId);if(!s){const i=await t.roomMembers.get(this._roomId,e.userId);i&&(s=new R(i))}if(!s||!s.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new nn(e,s==null?void 0:s.membership)}async lookupMember(e,t){let s=this._cache.get(e);if(!s){const i=await t.roomMembers.get(this._roomId,e);i&&(s=new R(i),this._cache.set(s))}return s}}class Ah{constructor(e,t,s,i){this._memberWriter=e,this._timelineEvents=s,this._hasFetchedMembers=i,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const s of e)if(s.type===ee){const i=R.fromMemberEvent(this._roomId,s);i&&(t||(t=new Map),t.set(i.userId,i))}return t}_timelineEventsToMembers(e){let t;for(let s=e.length-1;s>=0;s--){const i=e[s],r=i.state_key;if(i.type===ee&&!(t!=null&&t.has(r))){const o=R.fromMemberEvent(this._roomId,i);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,s){var r;let i;return this._timelineEvents&&(i=this._findPrecedingMemberEventInTimeline(e,t),i)||(i=(r=this._newStateMembers)==null?void 0:r.get(e),i)?i:await this._memberWriter.lookupMember(e,s)}async write(e){const t=new Map;let s;if(this._timelineEvents&&(s=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(const i of this._newStateMembers.values())if(!(s!=null&&s.has(i.userId))){const r=await this._memberWriter._writeMember(i,e);r&&(!this._hasFetchedMembers&&!r.previousMembership&&(r.previousMembership=i.membership),t.set(r.userId,r))}}if(s)for(const i of s.values()){const r=await this._memberWriter._writeMember(i,e);r&&t.set(r.userId,r)}return t}_findPrecedingMemberEventInTimeline(e,t){let s=-1;for(let i=this._timelineEvents.length-1;i>=0;i--)if(this._timelineEvents[i].event_id===t.event_id){s=i;break}for(let i=s-1;i>=0;i--){const r=this._timelineEvents[i];if(r.type===ee&&r.state_key===e){const o=R.fromMemberEvent(this._roomId,r);if(o)return o}}}}class Vh{constructor({roomId:e,storage:t,fragmentIdComparer:s,relationWriter:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._relationWriter=i}async _findOverlappingEvents(e,t,s,i){const r=t.map(h=>h.event_id),o=await s.timelineEvents.getEventKeysForIds(this._roomId,r);i.set("existingEvents",o.size);const a=t.filter(h=>!o.has(h.event_id));i.set("nonOverlappingEvents",a.length);let c;if(e.hasLinkedFragment){i.set("linkedFragmentId",e.linkedFragmentId);for(const h of o.values())if(h.fragmentId===e.linkedFragmentId){i.set("foundLinkedFragment",!0);const l=await s.timelineFragments.get(this._roomId,e.linkedFragmentId);c=e.createNeighbourEntry(l);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:c}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:s,direction:i}=e,r=await this._findFragmentEdgeEvent(s,i,t);return r?new L(r.fragmentId,r.eventIndex):L.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,s){if(t.isBackward){const[i]=await s.timelineEvents.firstEvents(this._roomId,e,1);return i}else{const[i]=await s.timelineEvents.lastEvents(this._roomId,e,1);return i}}async _storeEvents(e,t,s,i,r,o){const a=[],c=[];let h=t;for(let l=0;l<e.length;++l){const d=e[l];h=h.nextKeyForDirection(s);const u=rn(h,this._roomId,d),p=this._findMember(d.sender,i,e,l,s);p&&(u.displayName=p.displayName,u.avatarUrl=p.avatarUrl);const m=await this._relationWriter.writeGapRelation(u,s,r,o);if(m&&c.push(...m),await r.timelineEvents.tryInsert(u,o)){const _=new re(u,this._fragmentIdComparer);jt(a,_,s)}}return{entries:a,updatedEntries:c}}_findMember(e,t,s,i,r){function o(h){return h.type===ee&&h.state_key===e}const a=r.isBackward?1:-1;for(let h=i+a;h>=0&&h<s.length;h+=a){const l=s[h];if(o(l))return R.fromMemberEvent(this._roomId,l)}for(let h=i;h>=0&&h<s.length;h-=a){const l=s[h];if(o(l))return R.fromReplacingMemberEvent(this._roomId,l)}const c=t==null?void 0:t.find(o);if(c)return R.fromMemberEvent(this._roomId,c)}async _updateFragments(e,t,s,i,r,o){const{direction:a}=e,c=[];return jt(i,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,r.timelineFragments.update(t.fragment),jt(i,t,a),c.push(e.fragment),c.push(t.fragment)):e.token=s,r.timelineFragments.update(e.fragment),c}async writeFragmentFill(e,t,s,i,r){const{fragmentId:o,direction:a}=e,{chunk:c,state:h}=t;let{end:l}=t;if(!Array.isArray(c))throw new Error("Invalid chunk in response");if(typeof l!="string"&&typeof l!="undefined")throw new Error("Invalid end token in response");const d=await i.timelineFragments.get(this._roomId,o);if(!d)throw new Error(`Unknown fragment: ${o}`);if(e=e.withUpdatedFragment(d),e.token!==s)throw new Error("The pagination token has changed locally while fetching messages.");if(c.length===0)return e.edgeReached=!0,await i.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let u=await this._findFragmentEdgeEventKey(e,i);r.set("lastKey",u.toString());const{nonOverlappingEvents:p,neighbourFragmentEntry:m}=await this._findOverlappingEvents(e,c,i,r),{entries:_,updatedEntries:y}=await this._storeEvents(p,u,a,h,i,r),M=await this._updateFragments(e,m,l,_,i,r);return{entries:_,updatedEntries:y,fragments:M}}}class nr{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}async function xh(n,e,t,s,i,r){let o=[];const a=r.timelineEvents,c=r.timelineFragments;for(;o.length<s&&e;){let h;t.isForward?h=await a.eventsAfter(n,e,s):h=await a.eventsBefore(n,e,s);let l=h.map(d=>new re(d,i));if(o=Ba(o,l,t),o.length<s){const d=await c.get(n,e.fragmentId);let u=new ce(d,t.isBackward,i);if(jt(o,u,t),!u.token&&u.hasLinkedFragment){const p=await c.get(n,u.linkedFragmentId);i.add(p);const m=new ce(p,t.isForward,i);jt(o,m,t),e=m.asEventKey()}else e=null}}return o}class Mn{constructor({roomId:e,storage:t,fragmentIdComparer:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,s,i){return new nr(async(r,o)=>{const a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,s,r,a,o)},i)}readFromEnd(e,t=null,s){return new nr(async(i,r)=>{const o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId);let c;if(!a)c=[];else{this._fragmentIdComparer.add(a);const h=ce.end(a,this._fragmentIdComparer),l=h.asEventKey();c=await this._readFrom(l,Pe.Backward,e,i,o,r),c.unshift(h)}return c},s)}async readById(e,t){let s=[this._storage.storeNames.timelineEvents];this._decryptEntries&&s.push(this._storage.storeNames.inboundGroupSessions);const i=await this._storage.readTxn(s),r=await i.timelineEvents.getByEventId(this._roomId,e);if(r){const o=new re(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o],i,t).complete(),o}}async _readFrom(e,t,s,i,r,o){const a=await xh(this._roomId,e,t,s,this._fragmentIdComparer,r);if(this._decryptEntries){i.decryptRequest=this._decryptEntries(a,r,o);try{await i.decryptRequest.complete()}finally{i.decryptRequest=null}}return a}}class Nh extends re{get fragmentId(){throw new Error("Cannot access fragmentId for non-persisted EventEntry")}get entryIndex(){throw new Error("Cannot access entryIndex for non-persisted EventEntry")}get isNonPersisted(){return!0}get isRedacting(){return!1}get isRedacted(){return super.isRedacting}}class Cn{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}}class Dh{constructor(e){this._userId=e}get id(){return this._userId}}class As extends Cn{constructor({roomId:e,storage:t,closeCallback:s,fragmentIdComparer:i,pendingEvents:r,clock:o,powerLevelsObservable:a,hsApi:c}){super(()=>{this.dispose()}),this._roomId=e,this._storage=t,this._closeCallback=s,this._fragmentIdComparer=i,this._disposables=new Et,this._pendingEvents=r,this._clock=o,this._remoteEntries=new mi((h,l)=>h.compare(l)),this._ownMember=null,this._timelineReader=new Mn({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this._contextEntriesNotInTimeline=new Map,this._decryptEntries=null,this._hsApi=c,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,s){const i=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),r=await i.roomMembers.get(this._roomId,e.id);r?this._ownMember=new R(r):this._ownMember=R.fromUserId(this._roomId,e.id,t);const o=this._disposables.track(this._timelineReader.readFromEnd(20,i,s));try{const a=await o.complete();this._loadContextEntriesWhereNeeded(a),this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new Wo(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,s)=>{t.notifyUpdate(s)},t=>this._applyAndEmitLocalRelationChange(t,s=>s.removeLocalRelation(t))):this._localEntries=new ui,this._allEntries=new Hr(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===fe&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const s=new Ka({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._loadContextEntriesWhereNeeded([s]),this._applyAndEmitLocalRelationChange(s,i=>i.addLocalRelation(s)),s}_applyAndEmitLocalRelationChange(e,t){var i,r;const s=o=>{const a=t(o);return a||!1};if(this._findAndUpdateEntryById(e.pendingEvent.relatedTxnId,e.relatedEventId,s),e.redactingEntry){const o=(i=e.redactingEntry.pendingEvent)==null?void 0:i.relatedTxnId;this._findAndUpdateEntryById(o,e.redactingEntry.relatedEventId,s),(r=e.redactingEntry.contextForEntries)==null||r.forEach(a=>this._emitUpdateForEntry(a,"contextEntry"))}}_findAndUpdateEntryById(e,t,s){let i=!1;e&&(i=this._localEntries.findAndUpdate(r=>r.id===e,s)),!i&&t&&this._remoteEntries.findAndUpdate(r=>r.id===t,s)}async getOwnAnnotationEntry(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),i=await s.timelineRelations.getForTargetAndType(this._roomId,e,je);for(const r of i){const o=await s.timelineEvents.getByEventId(this._roomId,r.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&Ke(o.event).key===t){const a=new re(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){var t;if(!!((t=this._localEntries)!=null&&t.hasSubscriptions))for(const s of this._localEntries){if(s.relatedEventId){const i=e.find(r=>r.id===s.relatedEventId);i==null||i.addLocalRelation(s)}if(s.redactingEntry){const i=s.redactingEntry.relatedEventId,r=e.find(o=>o.id===i);r==null||r.addLocalRelation(s)}}}static _entryUpdater(e,t){var s;return(s=e.contextForEntries)==null||s.forEach(i=>i.setContextEntry(t)),t.updateFrom(e),t}replaceEntries(e){var t;this._addLocalRelationsToNewRemoteEntries(e);for(const s of e)try{this._remoteEntries.getAndUpdate(s,As._entryUpdater);const i=this._contextEntriesNotInTimeline.get(s.id);i&&(As._entryUpdater(i,s),this._contextEntriesNotInTimeline.set(s.id,s)),(t=s.contextForEntries)==null||t.forEach(r=>this._emitUpdateForEntry(r,"contextEntry"))}catch(i){if(i.name==="CompareError")continue;throw i}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._updateEntriesFetchedFromHomeserver(e),this._moveEntryToRemoteEntries(e),this._loadContextEntriesWhereNeeded(e),this._remoteEntries.setManySorted(e)}_updateEntriesFetchedFromHomeserver(e){var t;for(const s of e){const i=this._contextEntriesNotInTimeline.get(s.relatedEventId);(i==null?void 0:i.isNonPersisted)&&(i==null?void 0:i.addLocalRelation(s))&&((t=i.contextForEntries)==null||t.forEach(r=>this._emitUpdateForEntry(r,"contextEntry")))}}_moveEntryToRemoteEntries(e){for(const t of e){const s=this._contextEntriesNotInTimeline.get(t.id);s&&(s.contextForEntries.forEach(i=>{i.setContextEntry(t),this._emitUpdateForEntry(i,"contextEntry")}),this._contextEntriesNotInTimeline.delete(t.id))}}_emitUpdateForEntry(e,t){const s=e.isPending?e.id:null,i=e.isPending?null:e.id;this._findAndUpdateEntryById(s,i,()=>t)}async _loadContextEntriesWhereNeeded(e){for(const t of e){if(!t.contextEventId)continue;const s=t.contextEventId;let i=e.find(r=>r.id===s);i||(i=this._findLoadedEventById(s)),i?(t.setContextEntry(i),this._emitUpdateForEntry(i,"context-added")):this._loadContextEntryNotInTimeline(t)}}async _loadContextEntryNotInTimeline(e){const t=e.contextEventId;let s=await this._getEventFromStorage(t);s||(s=await this._getEventFromHomeserver(t)),s&&(this._contextEntriesNotInTimeline.set(t,s),e.setContextEntry(s),this._emitUpdateForEntry(e,"contextEntry"))}_findLoadedEventById(e){var t;return(t=this.getByEventId(e))!=null?t:this._contextEntriesNotInTimeline.get(e)}async _getEventFromStorage(e){return await this._timelineReader.readById(e)}async _getEventFromHomeserver(e){const t=await this._hsApi.context(this._roomId,e,0).response(),s=t.event.sender,i=t.state.find(a=>a.type===ee&&a.user_id===s),r={event:t.event,displayName:i.content.displayname,avatarUrl:i.content.avatar_url},o=new Nh(r,this._fragmentIdComparer);return this._decryptEntries&&await this._decryptEntries([o]).complete(),o}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find(i=>!!i.eventType);if(!t)return!0;const s=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),Pe.Backward,e));try{const i=await s.complete();return this.addEntries(i),i.length<e}finally{this._disposables.disposeTracked(s)}}async _getOrLoadEntry(e,t){var s;if(e){for(const i of this._localEntries)if(i.id===e)return i}return t?(s=this.getByEventId(t))!=null?s:await this._getEventFromStorage(t):null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const s=this._remoteEntries.get(t);if(s.id===e)return s}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._decryptEntries=e,this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function Uh({roomId:n,storage:e,txn:t}){return t||(t=await e.readTxn([e.storeNames.roomMembers])),(await t.roomMembers.getAll(n)).map(i=>new R(i))}async function Ph({summary:n,syncToken:e,roomId:t,hsApi:s,storage:i,setChangedMembersMap:r},o){const a=new Map;r(a);const c=await s.members(t,{at:e},{log:o}).response(),h=await i.readWriteTxn([i.storeNames.roomSummary,i.storeNames.roomMembers]);let l,d;try{l=n.writeHasFetchedMembers(!0,h);const{roomMembers:u}=h,p=c.chunk;if(!Array.isArray(p))throw new Error("malformed");o.set("members",p.length),d=await Promise.all(p.map(async m=>{const _=m==null?void 0:m.state_key;if(!_)throw new Error("malformed");const y=a.get(_);if(y)return y;{const M=R.fromMemberEvent(t,m);return M&&u.set(M.serialize()),M}}))}catch(u){throw h.abort(),u}finally{r(null)}return await h.complete(),n.applyChanges(l),d}async function Fh(n,e){const{summary:t}=n;return t.data.hasFetchedMembers?Uh(n):e.wrapOrRun(n.log,"fetchMembers",s=>Ph(n,s))}async function Oh(n,e){const t=await Kh(n),{summary:s}=n;return!s.data.hasFetchedMembers&&!t?e.wrapOrRun(n.log,"fetchMember",i=>Lh(n,i)):t}async function Kh({roomId:n,userId:e,storage:t}){const i=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(n,e);return i?new R(i):null}async function Lh({roomId:n,userId:e,hsApi:t,storage:s},i){let r;try{r=await t.state(n,"m.room.member",e,{log:i}).response()}catch(c){if(c.name==="HomeServerError"&&c.errcode==="M_NOT_FOUND")return null;throw c}const o=new R({roomId:n,userId:e,membership:r.membership,avatarUrl:r.avatar_url,displayName:r.displayname}),a=await s.readWriteTxn([s.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(c){throw a.abort(),c}return await a.complete(),o}class Bh extends Cn{constructor({members:e,closeCallback:t}){super(t),this._members=new Ae;for(const s of e)this._members.add(s.userId,s)}afterSync(e){for(const[t,s]of e.entries())this._members.set(t,s.member)}get members(){return this._members}}function Zs(n,e,t){const s=e.joinCount+e.inviteCount-1;if(n.length>=s)if(n.length>1){const i=n[n.length-1];return n.slice(0,n.length-1).map(o=>o.name).join(", ")+" and "+i.name}else{const i=n[0];return i?i.name:(t.log({l:"could get get other member name",length:n.length,otherMember:!!i,otherMemberMembership:i==null?void 0:i.membership}),"Unknown DM Name")}else return n.length<s?n.map(i=>i.name).join(", ")+` and ${s} others`:null}class Ii{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,s){const i=new Map,r=[];for(const o of this._members.keys())e.indexOf(o)===-1&&r.push(o);for(const[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&i.set(o,a.member);for(const o of e)if(!this._members.has(o)&&!i.has(o)){const a=await s.roomMembers.get(this._roomId,o);if(a){const c=new R(a);i.set(c.userId,c)}}return{updatedHeroMembers:i.values(),removedUserIds:r}}applyChanges({updatedHeroMembers:e,removedUserIds:t},s,i){for(const o of t)this._members.delete(o);for(const o of e)t.includes(o.userId)||this._members.set(o.userId,o);const r=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=Zs(r,s,i)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(const e of this._members.keys())return e;return null}}class $h{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let s=this._map.get(e);return s||(s=new jh(this,t,e),this._map.set(e,s)),s}updateEvents(e){for(let t=0;t<e.length;t+=1){const s=e[t],i=this._map.get(s.id);i==null||i.update(s)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}}class jh extends we{constructor(e,t,s){super(),this._eventMap=e,this._entry=t,this._id=s,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}function qh(n){return n||nc.item}const Hh="m.room.power_levels",Wh=50;class bs{constructor({powerLevelEvent:e,createEvent:t,ownUserId:s,membership:i}){this._plEvent=e,this._createEvent=t,this._ownUserId=s,this._membership=i}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){var t,s,i,r;if(this._plEvent){let o=(s=(t=this._plEvent.content)==null?void 0:t.users)==null?void 0:s[e];if(typeof o!="number"&&(o=(i=this._plEvent.content)==null?void 0:i.users_default),typeof o=="number")return o}else if(this._createEvent&&e===((r=this._createEvent.content)==null?void 0:r.creator))return 100;return 0}_getActionLevel(e){var s,i;const t=(i=(s=this._plEvent)==null?void 0:s.content)==null?void 0:i[e];return typeof t=="number"?t:Wh}_getEventTypeLevel(e){var s,i,r,o,a;const t=(r=(i=(s=this._plEvent)==null?void 0:s.content)==null?void 0:i.events)==null?void 0:r[e];if(typeof t=="number")return t;{const c=(a=(o=this._plEvent)==null?void 0:o.content)==null?void 0:a.events_default;return typeof c=="number"?c:0}}}class Gh extends Ae{constructor(e){super(),this.type=e}async load(e,t){const s=await t.roomState.getAllForType(e,this.type);for(let i=0;i<s.length;++i){const{event:r}=s[i];this.add(r.state_key,r)}}handleStateEvent(e){e.type===this.type&&this.set(e.state_key,e)}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){var e;(e=this.removeCallback)==null||e.call(this)}}class zh extends we{constructor(e,t){super(),this.type=e,this.stateKey=t}async load(e,t){var s;this.event=(s=await t.roomState.get(e,this.type,this.stateKey))==null?void 0:s.event}handleStateEvent(e){e.type===this.type&&e.state_key===this.stateKey&&(this.event=e,this.emit(this.get()))}get(){return this.event}setRemoveCallback(e){this.removeCallback=e}onUnsubscribeLast(){var e;(e=this.removeCallback)==null||e.call(this)}}const Jh="m.room.encrypted";class Rn extends Fe{constructor({roomId:e,storage:t,hsApi:s,mediaRepository:i,emitCollectionChange:r,user:o,createRoomEncryption:a,getSyncToken:c,platform:h}){super(),this._roomId=e,this._storage=t,this._hsApi=s,this._mediaRepository=i,this._summary=new Aa(e),this._fragmentIdComparer=new Ja([]),this._emitCollectionChange=r,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=c,this._platform=h,this._observedEvents=null,this._roomStateObservers=new Set,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null,this._timelineLoadPromise=null}async observeStateType(e,t=void 0){const s=new Gh(e);return await this._addStateObserver(s,t),s}async observeStateTypeAndKey(e,t,s=void 0){const i=new zh(e,t);return await this._addStateObserver(i,s),i}async _addStateObserver(e,t){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState])),await e.load(this.id,t),this._roomStateObservers.add(e),e.setRemoveCallback(()=>{this._roomStateObservers.delete(e)})}async _eventIdsToEntries(e,t){const s=[];return await Promise.all(e.map(async i=>{const r=await t.timelineEvents.getByEventId(this._roomId,i);r&&s.push(new re(r,this._fragmentIdComparer))})),s}_getAdditionalTimelineRetryEntries(e,t){let s=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const i=e.reduce((r,o)=>(r.add(o.id),r),new Set);return s=s.filter(r=>!i.has(r.id)),s}async notifyRoomKey(e,t,s){var o;if(!this._roomEncryption)return;const i=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let r=await this._eventIdsToEntries(t,i);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(r,[e]);r=r.concat(a)}if(r.length){await this._decryptEntries($e.Retry,r,i,s).complete(),(o=this._timeline)==null||o.replaceEntries(r);const c=this._summary.data.applyTimelineEntries(r,!1,!1);await this._summary.writeAndApplyData(c,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,$e.Timeline)),!0):!1}_decryptEntries(e,t,s,i=null){return new Yh(async(o,a)=>{if(s||(s=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;const c=t.filter(m=>m.eventType===Jh).map(m=>m.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(c,null,e,s),o.cancelled)return;const h=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;const l=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&l.push(this._storage.storeNames.deviceKeys);const u=await this._storage.readWriteTxn(l);let p;try{p=await h.write(u,a),d&&await p.verifyKnownSenders(u)}catch(m){throw u.abort(),m}await u.complete(),p.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t),d&&p.hasUnverifiedSenders&&a.wrapDetached("fetch unknown senders keys",async m=>{var M,N;const _=await p.fetchAndVerifyRemainingSenders(this._hsApi,m),y=[];_.applyToEntries(t,z=>y.push(z)),(M=this._timeline)==null||M.replaceEntries(y),(N=this._observedEvents)==null||N.updateEvents(y)})},qh(i))}async _getSyncRetryDecryptEntries(e,t,s){let r=(await Promise.all(e.map(async o=>{const a=await t.getEventIdsForMissingKey(o,s);if(a)return this._eventIdsToEntries(a,s)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){const a=this._getAdditionalTimelineRetryEntries(r,e).map(c=>c.clone());r=r.concat(a)}return r}async load(e,t,s){s.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const i=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(i)}if(this._summary.data.needsHeroes){this._heroes=new Ii(this._roomId);const i=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(i,this._summary.data,s)}}catch(i){throw new Gr(`Could not load room ${this._roomId}`,i)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const s=await Oh({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!s)return null;const i=new Wt(s,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,i),i}async loadMemberList(e=void 0,t=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const s=await Fh({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,txn:e,syncToken:this._getSyncToken(),setChangedMembersMap:i=>this._changedMembersDuringSync=i,log:t},this._platform.logger);return this._memberList=new Bh({members:s,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,s=null){return this._platform.logger.wrapOrRun(s,"fillGap",async i=>{if(i.set("id",this.id),i.set("fragment",e.fragmentId),i.set("dir",e.direction.asApiString()),e.edgeReached){i.set("edgeReached",!0);return}const r=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:i}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let a,c;try{a=await this._writeGapFill(r.chunk,o,i);const h=new Sn({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});c=await new Vh({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:h}).writeFragmentFill(e,r,e.token,o,i)}catch(h){throw o.abort(),h}await o.complete(),this._roomEncryption&&await this._decryptEntries($e.Timeline,c.entries,null,i).complete();for(const h of c.fragments)this._fragmentIdComparer.add(h);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(c.updatedEntries),this._timeline.addEntries(c.entries))})}async _writeGapFill(e,t,s){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}get user(){return this._user}isDirectMessageForUserId(e){if(this._summary.data.dmUserId===e)return!0;{const{heroes:t,joinCount:s,inviteCount:i}=this._summary.data;if(t&&t.includes(e)&&s+i===2)return!0}return!1}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new bs({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const s=await e.roomState.get(this._roomId,"m.room.create","");if(s)return new bs({createEvent:s.event,ownUserId:this._user.id,membership:this.membership});{const i=this.membership;return new bs({ownUserId:this._user.id,membership:i})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new Wt(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableKeyBackup(e){var t;(t=this._roomEncryption)==null||t.enableKeyBackup(e),this._timeline&&e&&this._platform.logger.run("enableKeyBackup",s=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,s))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}async openTimeline(e=null){return await this._platform.logger.wrapOrRun(e,"open timeline",async t=>{this._timelineLoadPromise&&await this._timelineLoadPromise;let s;if(this._timelineLoadPromise=new Promise(i=>{s=()=>{this._timelineLoadPromise=null,i()}}),t.set("id",this.id),this._timeline)return t.log({l:"Returning existing timeline"}),s(),this._timeline.retain(),this._timeline;this._timeline=new As({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels(),hsApi:this._hsApi});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,$e.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(i){throw this._timeline.dispose(),i}finally{s()}return this._timeline.retain(),this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new $h(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const s=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(i=>{s.update(i)}).catch(i=>{console.warn(`could not load event ${e} from storage`,i)}),s}async _readEventById(e){return await new Mn({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}).readById(e)}dispose(){var e;(e=this._roomEncryption)==null||e.dispose()}}class Yh{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",s=>e(this,s))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}class Qh{constructor({roomId:e,storage:t,hsApi:s,pendingEvents:i}){i=i||[],this._roomId=e,this._storage=t,this._hsApi=s,this._pendingEvents=new mi((r,o)=>r.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(i.map(r=>this._createPendingEvent(r))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const s=new La({data:e,remove:()=>this._removeEvent(s),emitUpdate:i=>this._pendingEvents.update(s,i),attachments:t});return s}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(const s of this._pendingEvents)await t.wrap("send event",async i=>{i.set("queueIndex",s.queueIndex);try{this._currentQueueIndex=s.queueIndex,await this._sendEvent(s,i)}catch(r){r instanceof Ve?(this._offline=!0,i.set("offline",!0),s.setWaiting()):(i.catch(r),r.name==="HomeServerError"&&(r.statusCode===400||r.statusCode===403||r.statusCode===404)?(i.set("remove",!0),await s.abort()):s.setError(r))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",s=>e.uploadAttachments(this._hsApi,s)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const s=e.contentForEncryption,{type:i,content:r}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,s,this._hsApi,o));e.setEncrypted(i,r),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,s),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,s)}catch(i){throw s.abort(),i}await s.complete()}}async _resolveRemoteIdInPendingRelations(e,t,s){const i=this._pendingEvents.array.filter(r=>r.relatedTxnId===e&&r.relatedEventId!==t);for(const r of i)r.setRelatedEventId(t),await this._tryUpdateEventWithTxn(r,s);return i}async removeRemoteEchos(e,t,s){const i=[];for(const r of e){const o=r.unsigned&&r.unsigned.transaction_id;let a;if(o?a=this._pendingEvents.array.findIndex(c=>c.txnId===o):a=this._pendingEvents.array.findIndex(c=>c.remoteId===r.event_id),a!==-1){const c=this._pendingEvents.get(a),h=r.event_id;s.log({l:"removeRemoteEcho",queueIndex:c.queueIndex,remoteId:h,txnId:o}),t.pendingEvents.remove(c.roomId,c.queueIndex),i.push(c),await this._resolveRemoteIdInPendingRelations(o,h,t)}}return i}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{s.pendingEvents.remove(e.roomId,e.queueIndex)}catch{s.abort()}await s.complete();const i=this._pendingEvents.array.indexOf(e);i!==-1&&this._pendingEvents.remove(i)}e.dispose()}emitRemovals(e){for(const t of e){const s=this._pendingEvents.array.indexOf(t);s!==-1&&this._pendingEvents.remove(s),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,s,i){const r=He(t);let o=null;if(r){const a=gi(r);if(ir(a)&&(o=a,en(r,null)),r.rel_type===je&&this._pendingEvents.array.some(h=>{const l=He(h.content);return h.eventType===e&&l&&l.key===r.key&&(h.relatedTxnId===o||l.event_id===r.event_id)})){i.set("already_annotating",!0);return}}return await this._enqueueEvent(e,t,s,o,null,i)}async _enqueueEvent(e,t,s,i,r,o){const a=await this._createAndStoreEvent(e,t,i,r,s);return this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem),a}async enqueueRedaction(e,t,s){if(this._pendingEvents.array.some(a=>a.eventType===fe&&(a.relatedTxnId===e||a.relatedEventId===e))){s.set("already_redacting",!0);return}let r,o;if(ir(e)){r=e;const a=e,c=this._pendingEvents.array.find(h=>h.txnId===a);if(c&&!c.remoteId&&c.status!==E.Sending){s.set("remove",r),await c.abort();return}else if(c)o=c.remoteId;else return}else{o=e;const a=this._pendingEvents.array.find(c=>c.remoteId===o);a&&(r=a.txnId)}s.set("relatedTxnId",r),s.set("relatedEventId",o),await this._enqueueEvent(fe,{reason:t},null,r,o,s)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(s){throw t.abort(),s}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,s,i,r){const o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let a;try{const c=o.pendingEvents,h=await c.getMaxQueueIndex(this._roomId)||0,d=Math.max(h,this._currentQueueIndex)+1,u=e!==fe&&e!==Va&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:s,relatedEventId:i,txnId:Q(),needsEncryption:u,needsUpload:!!r},r),c.add(a.data)}catch(c){throw o.abort(),c}return await o.complete(),a}dispose(){for(const e of this._pendingEvents)e.dispose()}}class En{constructor({filename:e,blob:t,platform:s}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=s,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){var e;(e=this._uploadRequest)==null||e.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await ua(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,s){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:r=>{this._sentBytes=r,t()},log:s});const{content_uri:i}=await this._uploadRequest.response();this._mxcUrl=i}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let s=e.substr(0,e.lastIndexOf("url"));_s(`${s}info.size`,t,this._transferredBlob.size),_s(`${s}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?_s(`${s}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):_s(`${s}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function _s(n,e,t){const s=n.split(".");let i=e;for(let o=0;o<s.length-1;o+=1){const a=s[o];i[a]||(i[a]={}),i=i[a]}const r=s[s.length-1];i[r]=t}const Xh="m.room.encrypted";class Zh extends Rn{constructor(e){super(e),this._roomStateHandler=e.roomStateHandler;const{pendingEvents:t}=e,s=new Sn({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new Eh({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:s,memberWriter:new Th(this.id)}),this._sendQueue=new Qh({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,s,i,r){var l;r.set("id",this.id),s&&r.set("newKeys",s.length);let o=this._summary.data.applySyncResponse(e,t,this._user.id),a=this._roomEncryption;!a&&o.encryption&&(r.set("enableEncryption",!0),a=this._createRoomEncryption(this,o.encryption));let c,h;if(a){let d=((l=e==null?void 0:e.timeline)==null?void 0:l.events)||[];s&&(c=await this._getSyncRetryDecryptEntries(s,a,i),c.length&&(r.set("retry",c.length),d=d.concat(c.map(u=>u.event)))),d=d.filter(u=>(u==null?void 0:u.type)===Xh),d.length&&(h=await a.prepareDecryptAll(d,s,$e.Sync,i))}return{roomEncryption:a,summaryChanges:o,decryptPreparation:h,decryptChanges:null,retryEntries:c}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async s=>{s.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:s,decryptChanges:i,roomEncryption:r,retryEntries:o},a,c){var rs;c.set("id",this.id);const h=s.isNewJoin(this._summary.data);h&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));const{entries:l,updatedEntries:d,newLiveKey:u,memberChanges:p,memberSync:m}=await c.wrap("syncWriter",ns=>this._syncWriter.writeSync(e,h,s.hasFetchedMembers,a,ns),c.level.Detail);let _;i&&(_=await c.wrap("decryptChanges",ns=>i.write(a,ns)),c.set("decryptionResults",_.results.size),c.set("decryptionErrors",_.errors.size),this._isTimelineOpen&&await _.verifyKnownSenders(a),_.applyToEntries(l),o!=null&&o.length&&(_.applyToEntries(o),d.push(...o))),c.set("newEntries",l.length),c.set("updatedEntries",d.length);let y;r&&(y=await r.writeSync(e,p,a,c),c.set("shouldFlushKeyShares",y.shouldFlush));const M=l.concat(d);s=s.applyTimelineEntries(M,t,!this._isTimelineOpen,this._user.id),s.membership!=="join"?a.roomSummary.remove(this.id):s=this._summary.writeData(s,a),s&&c.set("summaryChanges",s.changedKeys(this._summary.data));let N;s!=null&&s.needsHeroes&&(this._heroes||(this._heroes=new Ii(this._roomId)),N=await this._heroes.calculateChanges(s.heroes,p,a));let z;Array.isArray((rs=e.timeline)==null?void 0:rs.events)&&(z=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,c));const Ls=this._getPowerLevelsEvent(e);return await this._runRoomStateHandlers(e,m,a,c),{roomResponse:e,summaryChanges:s,roomEncryption:r,newEntries:l,updatedEntries:d,newLiveKey:u,removedPendingEvents:z,memberChanges:p,heroChanges:N,powerLevelsEvent:Ls,encryptionChanges:y,decryption:_}}afterSync(e,t){const{summaryChanges:s,newEntries:i,updatedEntries:r,newLiveKey:o,removedPendingEvents:a,memberChanges:c,powerLevelsEvent:h,heroChanges:l,roomEncryption:d,roomResponse:u,encryptionChanges:p}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),this._roomEncryption&&this._roomEncryption.afterSync(p),c.size){if(this._changedMembersDuringSync)for(const[_,y]of c.entries())this._changedMembersDuringSync.set(_,y.member);if(this._memberList&&this._memberList.afterSync(c),this._roomStateHandler.updateRoomMembers(this,c),this._observedMembers&&this._updateObservedMembers(c),this._timeline){for(const[_,y]of c.entries())if(_===this._user.id){this._timeline.updateOwnMember(y.member);break}}}let m=!1;if(s&&(this._summary.applyChanges(s),this._summary.data.needsHeroes||(this._heroes=null),m=!0),this._heroes&&l){const _=this.name;this._heroes.applyChanges(l,this._summary.data,t),_!==this.name&&(m=!0)}h&&this._updatePowerLevels(h),m&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(r),this._timeline.addEntries(i)),this._observedEvents&&(this._observedEvents.updateEvents(r),this._observedEvents.updateEvents(i)),a&&this._sendQueue.emitRemovals(a),this._emitSyncRoomState(u)}_updateObservedMembers(e){for(const[t,s]of e){const i=this._observedMembers.get(t);i&&i.set(s.member)}}_getPowerLevelsEvent(e){let t;return _t(e,s=>{s.state_key===""&&s.type===Hh&&(t=s)}),t}_updatePowerLevels(e){if(this._powerLevels){const t=new bs({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}async afterSyncCompleted({encryptionChanges:e,decryption:t,newEntries:s,updatedEntries:i},r){const o=e==null?void 0:e.shouldFlush,a=this._isTimelineOpen&&(t==null?void 0:t.hasUnverifiedSenders);(o||a)&&await r.wrap({l:"room",id:this.id},async c=>{const h=[];if(o&&h.push(this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,c)),a){const l=c.wrap("verify senders",async d=>{var _,y;const u=await t.fetchAndVerifyRemainingSenders(this._hsApi,d),p=[],m=M=>p.push(M);u.applyToEntries(s,m),u.applyToEntries(i,m),d.set("verifiedEntries",p.length),(_=this._timeline)==null||_.replaceEntries(p),(y=this._observedEvents)==null||y.updateEvents(p)});h.push(l)}await Promise.all(h)})}start(e,t){if(this._roomEncryption){const s=e==null?void 0:e.get("share_room_key");s&&t.wrapDetached("flush room keys",i=>(i.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,s,i)))}this._sendQueue.resumeSending(t)}async load(e,t,s){try{await super.load(e,t,s),await this._syncWriter.load(t,s)}catch(i){throw new Gr(`Could not load room ${this._roomId}`,i)}}async _writeGapFill(e,t,s){return await this._sendQueue.removeRemoteEchos(e,t,s)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,s,i=null){return this._platform.logger.wrapOrRun(i,"send",r=>(r.set("id",this.id),this._sendQueue.enqueueEvent(e,t,s,r)))}sendRedaction(e,t,s=null){return this._platform.logger.wrapOrRun(s,"redact",i=>(i.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,i)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){var e;return((e=this._heroes)==null?void 0:e.roomAvatarColorId)||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){var t;const e=this._syncWriter.lastMessageKey;if(e){const i=await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,e);return(t=i==null?void 0:i.event)==null?void 0:t.event_id}}async clearUnread(e=null,t=!0){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async s=>{s.set("id",this.id);const i=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let r;try{r=this._summary.writeClearUnread(i)}catch(o){throw i.abort(),o}await i.complete(),this._summary.applyChanges(r),this._emitUpdate();try{const o=t&&await this._getLastEventId();o&&await this._hsApi.receipt(this._roomId,"m.read",o)}catch(o){if(o.name!=="ConnectionError")throw o}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}async inviteUser(e,t){if(!e)throw new Error("userId is null/undefined");await this._hsApi.invite(this.id,e,t).response()}_getPendingEvents(){return this._sendQueue.pendingEvents}_runRoomStateHandlers(e,t,s,i){const r=[];return _t(e,o=>{r.push(this._roomStateHandler.handleRoomState(this,o,t,s,i))}),Promise.all(r)}_emitSyncRoomState(e){_t(e,t=>{for(const s of this._roomStateObservers)s.handleStateEvent(t)})}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new En({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class el extends Rn{constructor(e){super(e),this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){const s=await t.roomMembers.get(this.id,e);return s?new R(s):R.fromUserId(this.id,e,"join")}async load(e,t,s){const{summary:i,kickDetails:r}=e;return this._kickDetails=r,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(i,t,s)}async writeSync(e,t,s,i,r){if(r.set("id",this.id),s==="leave"){const o=tl(t,this._user.id);if(o||e){const a=o||this._kickDetails;let c;o&&(c=await this._getKickAuthor(o.sender,i));const h=e||this._summary.data;return i.archivedRoomSummary.set({summary:h.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:c,summaryData:h}}}else s==="join"&&i.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:s},i){i.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),s&&(this._kickedBy=s),this._emitUpdate()}get isKicked(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="leave"}get isBanned(){var e;return((e=this._kickDetails)==null?void 0:e.membership)==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){var e;return(e=this._kickDetails)==null?void 0:e.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();const s=this._storage.storeNames,i=await this._storage.readWriteTxn([s.roomState,s.archivedRoomSummary,s.roomMembers,s.timelineEvents,s.timelineFragments,s.timelineRelations,s.pendingEvents,s.inboundGroupSessions,s.groupSessionDecryptions,s.operations]);i.roomState.removeAllForRoom(this.id),i.archivedRoomSummary.remove(this.id),i.roomMembers.removeAllForRoom(this.id),i.timelineEvents.removeAllForRoom(this.id),i.timelineFragments.removeAllForRoom(this.id),i.timelineRelations.removeAllForRoom(this.id),i.pendingEvents.removeAllForRoom(this.id),i.inboundGroupSessions.removeAllForRoom(this.id),i.groupSessionDecryptions.removeAllForRoom(this.id),await i.operations.removeAllForScope(this.id),await i.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}}function tl(n,e){var s,i;let t;if(_t(n,r=>{r.type===ee&&r.state_key===e&&r.sender!==r.state_key&&(t=r)}),t)return{membership:(s=t.content)==null?void 0:s.membership,reason:(i=t.content)==null?void 0:i.reason,sender:t.sender}}async function sl(n,e,t){const s=await Promise.all(n.map(async i=>{const r=await e.profile(i,{log:t}).response();return new il(i,r.displayname,r.avatar_url)}));return s.sort((i,r)=>i.name.localeCompare(r.name)),s}class il{constructor(e,t,s){this.userId=e,this.displayName=t,this.avatarUrl=s}get name(){return this.displayName||this.userId}}class rl{constructor(e){this.userId=e}get displayName(){}get name(){return this.userId}get avatarUrl(){}}function nl(n){switch(n){case Z.DirectMessage:case Z.Private:return!0;case Z.Public:return!1}}function ol(n){switch(n){case Z.DirectMessage:return"trusted_private_chat";case Z.Private:return"private_chat";case Z.Public:return"public_chat"}}class al extends Fe{constructor(e,t,s,i,r,o){var a;if(super(),this.id=e,this.options=t,this.updateCallback=s,this.mediaRepository=i,this.platform=r,this.profiles=[],this._isCancelled=!1,this.isEncrypted=t.isEncrypted===void 0?nl(t.type):t.isEncrypted,t.name)this._calculatedName=t.name;else{const c={joinCount:1,inviteCount:((a=t.invites)==null?void 0:a.length)||0},h=(t.invites||[]).map(l=>new rl(l));this._calculatedName=Zs(h,c,o)}}async create(e,t){try{let s;if(this.options.avatar){const{avatar:o}=this.options,a=new En({filename:o.name,blob:o.blob,platform:this.platform});await a.upload(e,()=>{},t),s={info:o.info},a.applyToContent("url",s)}const i={is_direct:this.options.type===Z.DirectMessage,preset:ol(this.options.type),initial_state:[]};this.options.name&&(i.name=this.options.name),this.options.topic&&(i.topic=this.options.topic),this.options.invites&&(i.invite=this.options.invites),this.options.alias&&(i.room_alias_name=this.options.alias),this.options.isFederationDisabled===!0&&(i.creation_content={"m.federate":!1}),this.options.powerLevelContentOverride&&(i.power_level_content_override=this.options.powerLevelContentOverride),this.isEncrypted&&i.initial_state.push(Ia()),s&&i.initial_state.push({type:"m.room.avatar",state_key:"",content:s});const r=await e.createRoom(i,{log:t}).response();this._roomId=r.room_id}catch(s){this._error=s}this.emitChange()}async loadProfiles(e,t){try{if(!this.options.name&&this.options.invites){this.profiles=await sl(this.options.invites,e,t);const s={joinCount:1,inviteCount:this.options.invites.length};this._calculatedName=Zs(this.profiles,s,t),this.emitChange()}}catch{}}emitChange(e){this.updateCallback(this,e),this.emit("change")}get avatarColorId(){var e,t,s;return(s=(t=(e=this.options.invites)==null?void 0:e[0])!=null?t:this._roomId)!=null?s:this.id}get avatarUrl(){var e,t;return(t=(e=this.profiles)==null?void 0:e[0])==null?void 0:t.avatarUrl}get avatarBlobUrl(){var e,t;return(t=(e=this.options.avatar)==null?void 0:e.blob)==null?void 0:t.url}get roomId(){return this._roomId}get name(){return this._calculatedName}get isBeingCreated(){return!0}get error(){return this._error}cancel(){this._isCancelled||(this.dispose(),this._isCancelled=!0,this.emitChange("isCancelled"))}get isCancelled(){return this._isCancelled}dispose(){this.options.avatar&&this.options.avatar.blob.dispose()}async adjustDirectMessageMapIfNeeded(e,t,s,i){if(!this.options.invites||this.options.type!==Z.DirectMessage)return;const r=this.options.invites[0],o="m.direct";await i.wrap("set "+o,async a=>{try{const c=await t.readWriteTxn([t.storeNames.accountData]);let h;try{h=await c.accountData.get(o),h||(h={type:o,content:{}});const l=h.content;let d=l[r];d||(l[r]=d=[]),d.push(this._roomId),c.accountData.set(h),await c.complete()}catch(l){throw c.abort(),l}await s.setAccountData(e.id,o,h.content,{log:a}).response()}catch(c){a.catch(c)}})}}class cl extends Fe{constructor({roomId:e,user:t,hsApi:s,mediaRepository:i,emitCollectionRemove:r,emitCollectionUpdate:o,platform:a}){super(),this._roomId=e,this._user=t,this._hsApi=s,this._emitCollectionRemove=r,this._emitCollectionUpdate=o,this._mediaRepository=i,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}isDirectMessageForUserId(e){return this.isDirectMessage&&this._inviter.userId===e}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new R(e.inviter):null}async writeSync(e,t,s,i){var r;if(e==="invite"){i.set("id",this.id),i.set("add",!0);const o=(r=t.invite_state)==null?void 0:r.events;if(!Array.isArray(o))return null;const a=this._createSummaryData(o);let c;!a.name&&!a.canonicalAlias&&(c=await this._createHeroes(o,i));const h=this._getMyInvite(o);if(!h)return null;const l=this._getInviter(h,o),d=this._createData(o,h,l,a,c);return s.invites.set(d),{inviteData:d,inviter:l}}else return i.set("id",this.id),i.set("membership",e),s.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,s,i,r){const o=r?r.roomName:i.name,a=r?r.roomAvatarUrl:i.avatarUrl,c=(r==null?void 0:r.roomAvatarColorId)||this.id;return{roomId:this.id,isEncrypted:!!i.encryption,isDirectMessage:i.isDirectMessage,name:o,avatarUrl:a,avatarColorId:c,canonicalAlias:i.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:s==null?void 0:s.serialize()}}_createSummaryData(e){return e.reduce((t,s)=>Qr(t,s,this._user.id),new ke(null,this.id))}async _createHeroes(e,t){const s=e.filter(l=>l.type===ee),i=s.filter(l=>l.state_key!==this._user.id),r=i.reduce((l,d)=>{const u=R.fromMemberEvent(this.id,d);return l.set(u.userId,new nn(u,null)),l},new Map),o=i.map(l=>l.state_key),a=new Ii(this.id),c=await a.calculateChanges(o,r,null),h=new ke(null,this.id);return h.joinCount=s.reduce((l,d)=>{var u;return l+(((u=d.content)==null?void 0:u.membership)==="join"?1:0)},0),h.inviteCount=s.reduce((l,d)=>{var u;return l+(((u=d.content)==null?void 0:u.membership)==="invite"?1:0)},0),a.applyChanges(c,h,t),a}_getMyInvite(e){return e.find(t=>t.type===ee&&t.state_key===this._user.id)}_getInviter(e,t){const s=t.find(i=>i.type===ee&&i.state_key===e.sender);if(s)return R.fromMemberEvent(this.id,s)}_getJoinRule(e){var s;const t=e.find(i=>i.type==="m.room.join_rules");return t?(s=t.content)==null?void 0:s.join_rule:null}}class Ze{constructor(e){this._description=e}static httpPusher(e,t,s,i){return new Ze({kind:"http",append:!0,data:Object.assign({},i,{url:e+"/_matrix/push/v1/notify"}),pushkey:s,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const s=Object.assign({},this._description,{kind:null});await e.setPusher(s,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}}class hl extends Fe{constructor({storage:e,callHandler:t}){super(),this._storage=e,this._olmDecryption=null,this._megolmDecryption=null,this._callHandler=t,this._senderDeviceCache=new kn(10,s=>s.curve25519Key)}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){var t;return(t=this._olmDecryption)==null?void 0:t.obtainDecryptionLock(e)}async prepareSync(e,t,s,i){i.set("messageTypes",sr(e,a=>a.type));const r=e.filter(a=>a.type==="m.room.encrypted");if(this._emitUnencryptedEvents(e),!this._olmDecryption){i.log("can't decrypt, encryption not enabled",i.level.Warn);return}const o=r.filter(a=>{var c;return((c=a.content)==null?void 0:c.algorithm)===pi});if(o.length){const a=await this._olmDecryption.decryptAll(o,t,s);i.set("decryptedTypes",sr(a.results,h=>{var l;return(l=h.event)==null?void 0:l.type}));for(const h of a.errors)i.child("decrypt_error").catch(h);const c=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,i);return new ll(a,c)}}async writeSync(e,t){return e.olmDecryptChanges.write(t),{hasNewRoomKeys:(await Promise.all(e.newRoomKeys.map(r=>this._megolmDecryption.writeRoomKey(r,t)))).some(r=>!!r),decryptionResults:e.olmDecryptChanges.results}}async afterSyncCompleted(e,t,s,i){if(await i.wrap("Verifying fingerprint of encrypted toDevice messages",async r=>{for(const o of e){const a=o.event.sender,c=await t.deviceForCurveKey(a,o.senderCurve25519Key,s,r);o.setDevice(c),o.isVerified?this.emit("message",{encrypted:o}):r.log({l:"could not verify olm fingerprint key matches, ignoring",ed25519Key:o.device.ed25519Key,claimedEd25519Key:o.claimedEd25519Key,deviceId:c.deviceId,userId:c.userId})}}),this._callHandler){const r=e.filter(o=>{var a;return this._callHandler.handlesDeviceMessageEventType((a=o.event)==null?void 0:a.type)});r.length&&await i.wrap("process call signalling messages",async o=>{for(const a of r){const c=await t.deviceForId(a.event.sender,a.event.content.device_id,s,o);a.setDevice(c),a.isVerified?this._callHandler.handleDeviceMessage(a.event,a.userId,a.deviceId,o):o.log({l:"could not verify olm fingerprint key matches, ignoring",ed25519Key:a.device.ed25519Key,claimedEd25519Key:a.claimedEd25519Key,deviceId:c.deviceId,userId:c.userId})}})}}_emitUnencryptedEvents(e){const t=e.filter(s=>s.type!=="m.room.encrypted");for(const s of t)this.emit("message",{unencrypted:s})}}class ll{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=vt(t,s=>s.roomId)}}const Ot=Y+"olmAccount",ei=Y+"areDeviceKeysUploaded",Ss=Y+"serverOTKCount";async function or(n,e,t,s,i){const r=n.pickle(e),o=await i.readWriteTxn([i.storeNames.session]);try{o.session.add(Ot,r),o.session.add(ei,t),o.session.add(Ss,s)}catch(a){throw o.abort(),a}await o.complete()}class st{static async load({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,txn:a}){const c=await a.session.get(Ot);if(c){const h=new e.Account,l=await a.session.get(ei);h.unpickle(t,c);const d=await a.session.get(Ss);return new st({pickleKey:t,hsApi:s,account:h,userId:i,deviceId:r,areDeviceKeysUploaded:l,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:s,hsApi:i,userId:r,olmWorker:o,storage:a}){const c=t.adoptUnpickledOlmAccount(),h=JSON.parse(c.one_time_keys()),d=Object.entries(h.curve25519).length,u=!0;return await or(c,s,u,d,a),new st({pickleKey:s,hsApi:i,account:c,userId:r,deviceId:t.deviceId,areDeviceKeysUploaded:u,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:o,storage:a}){const c=new e.Account;o?await o.createAccountAndOTKs(c,c.max_number_of_one_time_keys()):(c.create(),c.generate_one_time_keys(c.max_number_of_one_time_keys()));const h=!1,l=0;return a&&await or(c,t,h,l,a),new st({pickleKey:t,hsApi:s,account:c,userId:i,deviceId:r,areDeviceKeysUploaded:h,serverOTKCount:l,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:s,userId:i,deviceId:r,areDeviceKeysUploaded:o,serverOTKCount:a,olm:c,olmWorker:h}){this._olm=c,this._pickleKey=e,this._hsApi=t,this._account=s,this._userId=i,this._deviceId=r,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=h,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,s){var o;const i=JSON.parse(this._account.one_time_keys()),r=Object.entries(i.curve25519);if(r.length||!this._areDeviceKeysUploaded){const a={};if(!this._areDeviceKeysUploaded){s.set("identity",!0);const l=JSON.parse(this._account.identity_keys());a.device_keys=this._deviceKeysPayload(l)}r.length&&(s.set("otks",!0),a.one_time_keys=this._oneTimeKeysPayload(r));const c=t?this._deviceId:void 0,h=await this._hsApi.uploadKeys(c,a,{log:s}).response();this._serverOTKCount=(o=h==null?void 0:h.one_time_key_counts)==null?void 0:o.signed_curve25519,s.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,l=>{r.length&&(this._account.mark_keys_as_published(),l==null||l.set(Ot,this._account.pickle(this._pickleKey)),l==null||l.set(Ss,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,l==null||l.set(ei,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){const s=this._account.max_number_of_one_time_keys(),i=Math.floor(s/2);if(this._serverOTKCount<i){const r=JSON.parse(this._account.one_time_keys()),a=Object.entries(r.curve25519).length,c=i-a-this._serverOTKCount;return c>0&&await t.wrap("generate otks",h=>{h.set("max",s),h.set("server",this._serverOTKCount),h.set("unpublished",a),h.set("new",c),h.set("limit",i),this._account.generate_one_time_keys(c),this._updateSessionStorage(e,l=>{l.set(Ot,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){const s=new this._olm.Session;try{return s.create_inbound_from(this._account,e,t),s}catch(i){throw s.free(),i}}async createOutboundOlmSession(e,t){const s=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,s,e,t):s.create_outbound(this._account,e,t),s}catch(i){throw s.free(),i}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(Ot,this._account.pickle(this._pickleKey))}writeSync(e,t,s){const i=e.signed_curve25519;if(Number.isSafeInteger(i)&&i!==this._serverOTKCount)return t.session.set(Ss,i),s.set("otkCount",i),i}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_keysAsSignableObject(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[pi,ye],keys:{}};for(const[s,i]of Object.entries(e))t.keys[`${s}:${this._deviceId}`]=i;return t}getUnsignedDeviceKey(){const e=JSON.parse(this._account.identity_keys());return this._keysAsSignableObject(e)}_deviceKeysPayload(e){const t=this._keysAsSignableObject(e);return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[s,i]of e){const r={key:i};this.signObject(r),t[`signed_curve25519:${s}`]=r}return t}async _updateSessionStorage(e,t){if(e){const s=await e.readWriteTxn([e.storeNames.session]);try{await t(s.session)}catch(i){throw s.abort(),i}await s.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(ts.stringify(e)),e.signatures=t,s!==void 0&&(e.unsigned=s)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}class ki{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){var e;return(e=this._keyDescription)==null?void 0:e.passphrase}get algorithm(){var e;return(e=this._keyDescription)==null?void 0:e.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){const s=this._keyDescription;if(s.mac){const i=await dl(e.binaryKey,s.iv,t);return s.mac===i}else if(s.passphrase){const i=e.description._keyDescription;return i.passphrase?s.passphrase.algorithm===i.passphrase.algorithm&&s.passphrase.iterations===i.passphrase.iterations&&s.passphrase.salt===i.passphrase.salt:!1}}return!1}}class is{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new is(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}async function dl(n,e,t){const{crypto:s,encoding:i}=t,{utf8:r,base64:o}=i,{derive:a,aes:c,hmac:h}=s,l=o.decode(e),d=new Uint8Array(8),u="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",p=r.encode(""),m=await a.hkdf(n,d,p,"SHA-256",512),_=m.slice(0,32),y=m.slice(32),M=await c.encryptCTR({key:_,iv:l,data:r.encode(u)}),N=await h.compute(y,M,"SHA-256");return o.encode(N)}const ul=5e5,ml=256;async function pl(n,e,t){const{passphraseParams:s}=n;if(!s)throw new Error("not a passphrase key");if(s.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${s.algorithm}`);const{utf8:i}=t.encoding,r=await t.crypto.derive.pbkdf2(i.encode(e),s.iterations||ul,i.encode(s.salt),"SHA-512",s.bits||ml);return new is(n,r)}const xt=[139,1];function _l(n,e,t,s){const i=s.encoding.base58.decode(e.replace(/ /g,""));let r=0;for(const a of i)r^=a;if(r!==0)throw new Error("Incorrect parity");for(let a=0;a<xt.length;++a)if(i[a]!==xt[a])throw new Error("Incorrect prefix");if(i.length!==xt.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(i.slice(xt.length,xt.length+t.PRIVATE_KEY_LENGTH));return new is(n,o)}class gl{async getSecret(e){var t,s,i;return(i=await((t=this.secretStorage)==null?void 0:t.readSecret(e)))!=null?i:await((s=this.secretSharing)==null?void 0:s.getLocallyStoredSecret(e))}setSecretStorage(e){this.secretStorage=e}setSecretSharing(e){this.secretSharing=e,this.secretSharing.setSecretFetcher(this)}}const Nt="secretRequestIds";class fl{constructor(e){this.waitMap=new Map,this.hsApi=e.hsApi,this.storage=e.storage,this.deviceMessageHandler=e.deviceMessageHandler,this.deviceTracker=e.deviceTracker,this.ourUserId=e.ourUserId,this.olmEncryption=e.olmEncryption,this.encoding=e.encoding,this.crossSigning=e.crossSigning,this.logger=e.logger,this.aesEncryption=new wl(this.storage,e.crypto,this.encoding)}async load(){this.deviceMessageHandler.on("message",async({encrypted:e})=>{switch(e==null?void 0:e.event.type){case"m.secret.request":{await this._respondToRequest(e);break}case"m.secret.send":{const{secret:s}=e.event.content,i=await this.shouldAcceptSecret(e);i&&this.writeSecretToStorage(i,s);break}}}),await this.aesEncryption.load()}async _respondToRequest(e){await this.logger.run("SharedSecret.respondToRequest",async t=>{if(!await this.shouldRespondToRequest(e,t))return;const s=e.event.content,i=s.request_id,r=s.requesting_device_id,o=s.name,a=await this.secretFetcher.getSecret(o);if(!a){t.log({l:"Secret not available to share"});return}const c={secret:a,request_id:i},h=await this.deviceTracker.deviceForId(this.ourUserId,r,this.hsApi,t);if(!h){t.log({l:"Cannot find device",deviceId:r});return}const l=await t.wrap("olm encrypt",u=>this.olmEncryption.encrypt("m.secret.send",c,[h],this.hsApi,u)),d=Jt(l);await this.hsApi.sendToDevice("m.room.encrypted",d,Q(),{log:t}).response()})}async shouldRespondToRequest(e,t){return t.wrap("SecretSharing.shouldRespondToRequest",async()=>{if(e.event.content.requesting_device_id===this.deviceTracker.ownDeviceId)return!1;const s=this.crossSigning.get();if(!s)return t.log({crossSigningNotAvailable:!0}),!1;const i=e.event.content;if(e.event.sender!==this.ourUserId||!(i.name&&i.action&&i.requesting_device_id&&i.request_id)||i.action==="request_cancellation")return!1;const r=i.requesting_device_id,o=await this.deviceTracker.deviceForId(this.ourUserId,r,this.hsApi,t);return o?await s.isOurUserDeviceTrusted(o,t)?!0:(t.log({l:"Device not trusted, returning"}),!1):(t.log({l:"Device could not be acquired",deviceId:r}),!1)})}async shouldAcceptSecret(e){const t=this.crossSigning.get();if(!t)return;const s=e.device;if(!s||!await t.isOurUserDeviceTrusted(s))return;const r=e.event.content.request_id,o=this.waitMap.get(r);if(o){const{name:l,deferred:d}=o;return d.resolve(e),this.waitMap.delete(r),await this.removeStoredRequestId(r),l}const c=await(await this.storage.readTxn([this.storage.storeNames.session])).session.get(Nt),h=c==null?void 0:c[r];if(h)return await this.removeStoredRequestId(r),h}async removeStoredRequestId(e){const t=await this.storage.readWriteTxn([this.storage.storeNames.session]),s=await t.session.get(Nt);s&&(delete s[e],t.session.set(Nt,s))}async checkSecretValidity(e){const t=this.crossSigning.get();!await(t==null?void 0:t.areWeVerified(e))&&(await this.storage.readWriteTxn([this.storage.storeNames.sharedSecrets])).sharedSecrets.deleteAllSecrets()}async getLocallyStoredSecret(e){const s=await(await this.storage.readTxn([this.storage.storeNames.sharedSecrets])).sharedSecrets.get(e);if(s)return await this.aesEncryption.decrypt(s.encrypted)}requestSecret(e,t){return t.wrap("SharedSecret.requestSecret",async s=>{const i=Q(),r=this.trackSecretRequest(i,e);return await this.sendRequestForSecret(e,i,s),await this.writeRequestIdToStorage(i,e),new yl(r)})}async writeRequestIdToStorage(e,t){var r;const s=await this.storage.readWriteTxn([this.storage.storeNames.session]),i=(r=await s.session.get(Nt))!=null?r:{};i[e]=t,s.session.set(Nt,i)}async writeSecretToStorage(e,t){const s=await this.aesEncryption.encrypt(t);(await this.storage.readWriteTxn([C.sharedSecrets])).sharedSecrets.set(e,{encrypted:s})}trackSecretRequest(e,t){const s=new at;return this.waitMap.set(e,{deferred:s,name:t}),s.promise}async sendRequestForSecret(e,t,s){const i={action:"request",name:e,request_id:t,requesting_device_id:this.deviceTracker.ownDeviceId};let r=await this.deviceTracker.devicesForUsers([this.ourUserId],this.hsApi,s);r=r.filter(c=>c.device_id!==this.deviceTracker.ownDeviceId);const o=await s.wrap("olm encrypt",c=>this.olmEncryption.encrypt("m.secret.request",i,r,this.hsApi,c)),a=Jt(o);await this.hsApi.sendToDevice("m.room.encrypted",a,Q(),{log:s}).response()}setSecretFetcher(e){this.secretFetcher=e}}class yl{constructor(e){this.receivedSecretPromise=e}async waitForResponse(e=30){const t=new Promise((i,r)=>{setTimeout(r,e*1e3)});return(await Promise.race([this.receivedSecretPromise,t])).event.content.secret}}class wl{constructor(e,t,s){this.storage=e,this.crypto=t,this.encoding=s}async load(){var r;const e=`${Y}localAESKey`,t=await this.storage.readTxn([C.session]);let{key:s,iv:i}=(r=await t.session.get(e))!=null?r:{};s||(s=await this.crypto.aes.generateKey("jwk"),i=await this.crypto.aes.generateIV(),(await this.storage.readWriteTxn([C.session])).session.set(e,{key:s,iv:i})),this.key=s,this.iv=i}async encrypt(e){const t=this.encoding.utf8.encode(e);return await this.crypto.aes.encryptCTR({jwkKey:this.key,iv:this.iv,data:t})}async decrypt(e){const t=await this.crypto.aes.decryptCTR({jwkKey:this.key,iv:this.iv,data:e});return this.encoding.utf8.decode(t)}}class gs extends Error{constructor(e,t){super(e),this.reason=t}}class vl{constructor({key:e,platform:t,storage:s}){this._key=e,this._platform=t,this._storage=s}async hasValidKeyForAnyAccountData(){const t=await(await this._storage.readTxn([this._storage.storeNames.accountData])).accountData.getAll();for(const s of t)try{const i=await this._decryptAccountData(s);return!0}catch(i){if(i instanceof gs&&i.reason!==0)throw i;continue}return!1}async readSecret(e){const s=await(await this._storage.readTxn([this._storage.storeNames.accountData])).accountData.get(e);if(!!s)return await this._decryptAccountData(s)}async _decryptAccountData(e){var s,i;const t=(i=(s=e==null?void 0:e.content)==null?void 0:s.encrypted)==null?void 0:i[this._key.id];if(!t)throw new gs(`Secret ${e.type} is not encrypted for key ${this._key.id}`,0);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(e.type,t);throw new gs(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`,2)}async _decryptAESSecret(e,t){const{base64:s,utf8:i}=this._platform.encoding,r=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,i.encode(e),"SHA-256",512),o=r.slice(0,32),a=r.slice(32),c=s.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,s.decode(t.mac),c,"SHA-256"))throw new gs("Bad MAC",1);const l=await this._platform.crypto.aes.decryptCTR({key:o,iv:s.decode(t.iv),data:c});return i.decode(l)}}const Mi=`${Y}ssssKey`,ar=`${Y}keyBackupVersion`;var pe=(n=>(n[n.RecoveryKey=0]="RecoveryKey",n[n.Passphrase=1]="Passphrase",n))(pe||{});async function Tn(n){var r;const e=await n.readTxn([n.storeNames.accountData]),t=await e.accountData.get("m.secret_storage.default_key"),s=(r=t==null?void 0:t.content)==null?void 0:r.key;if(!s)return;const i=await e.accountData.get(`m.secret_storage.key.${s}`);if(!!i)return new ki(s,i.content)}async function bl(n,e,t){const s=await t.session.get(ar);return t.session.set(ar,e),t.session.set(Mi,{id:n.id,binaryKey:n.binaryKey}),s}async function Sl(n){const e=await n.session.get(Mi);if(!e)return;const t=await n.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new is(new ki(e.id,t.content),e.binaryKey)}async function Il(n){n.session.remove(Mi)}async function kl(n,e,t,s,i){const r=await Tn(t);if(!r)throw new Error("Could not find a default secret storage key in account data");return await An(n,e,r,s,i)}async function An(n,e,t,s,i){let r;if(n===1)r=await pl(t,e,s);else if(n===0)r=_l(t,e,i,s);else throw new Error(`Invalid type: ${n}`);return r}async function Ml(n,e,t){const s=await Tn(e);if(await(s==null?void 0:s.isCompatible(n,t)))return n.withDescription(s)}const Vn="org.matrix.msc2697.v1.olm.libolm_pickle";async function Cl(n,e,t,s){try{const i=await n.getDehydratedDevice({log:s}).response();if(i.device_data.algorithm===Vn)return new El(i,e,t)}catch(i){i.name!=="HomeServerError"&&(s.error=i);return}}async function Rl(n,e,t,s,i){var a;const o=(await e.createDehydratedDevice({device_data:{algorithm:Vn,account:n.pickleWithKey(t.binaryKey.slice()),passphrase:((a=t.description)==null?void 0:a.passphraseParams)||{}},initial_device_display_name:s}).response()).device_id;return n.setDeviceId(o),await n.uploadKeys(void 0,!0,i),o}class El{constructor(e,t,s){this._dehydratedDevice=e,this._olm=t,this._platform=s}async decrypt(e,t){const s=new ki("dehydrated_device",this._dehydratedDevice.device_data.passphrase),i=await An(e,t,s,this._platform,this._olm),r=new this._olm.Account;try{const o=this._dehydratedDevice.device_data.account;return r.unpickle(i.binaryKey.slice(),o),new Tl(this._dehydratedDevice,r,i)}catch(o){if(r.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}}class Tl{constructor(e,t,s){this._dehydratedDevice=e,this._account=t,this._key=s}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){var e;(e=this._account)==null||e.free(),this._account=void 0}}class xn{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class Nn{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function Dn(n,e,t,s){return{session:n.pickle(s),sessionId:n.session_id(),senderKey:e,lastUsed:t}}class Vs{constructor(e,t,s,i=!1){this.data=e,this.pickleKey=t,this.olm=s,this.isNew=i,this.isModified=i}static create(e,t,s,i,r){const o=Dn(t,e,r,i);return new Vs(o,i,s,!0)}get id(){return this.data.sessionId}load(){const e=new this.olm.Session;return e.unpickle(this.pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this.pickleKey),this.isModified=!0}}class Un{constructor(e,t,s,i){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=s,this.encryptedEvent=i}setDevice(e){this.device=e}get isVerified(){return this.device?tt(this.device)===this.claimedEd25519Key:!1}get isUnverified(){return this.device?!this.isVerified:!0}get userId(){var e;return(e=this.device)==null?void 0:e.user_id}get deviceId(){var e;return(e=this.device)==null?void 0:e.device_id}get isVerificationUnknown(){return!this.device}}var xs=(n=>(n[n.PreKey=0]="PreKey",n[n.Normal=1]="Normal",n))(xs||{});const cr=4;function Pn(n){n.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}class Al{constructor(e,t,s,i,r,o){this.account=e,this.pickleKey=t,this.now=s,this.ownUserId=i,this.olm=r,this.senderKeyLock=o}async obtainDecryptionLock(e){var i;const t=new Set;for(const r of e){const o=(i=r.content)==null?void 0:i.sender_key;o&&t.add(o)}const s=await Promise.all(Array.from(t).map(r=>this.senderKeyLock.takeLock(r)));return new Nn(s)}async decryptAll(e,t,s){try{const i=vt(e,l=>{var d;return(d=l.content)==null?void 0:d.sender_key}),r=this.now(),o=await Promise.all(Array.from(i.entries()).map(([l,d])=>this._decryptAllForSenderKey(l,d,r,s))),a=o.reduce((l,d)=>l.concat(d.results),[]),c=o.reduce((l,d)=>l.concat(d.errors),[]),h=o.map(l=>l.senderKeyDecryption);return new xl(h,a,c,this.account,t)}catch(i){throw t.release(),i}}async _decryptAllForSenderKey(e,t,s,i){const r=await this._getSessions(e,i),o=new Vl(e,r,s),a=[],c=[];for(const h of t)try{const l=this._decryptForSenderKey(o,h,s);a.push(l)}catch(l){c.push(l)}return{results:a,errors:c,senderKeyDecryption:o}}_decryptForSenderKey(e,t,s){const i=e.senderKey,r=this._getMessageAndValidateEvent(t);let o;try{o=e.decrypt(r)}catch(a){throw new B("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:i,error:a.message})}if(typeof o!="string"&&r.type===xs.PreKey){let a;try{a=this._createSessionAndDecrypt(i,r,s)}catch(c){throw new B(`Could not create inbound olm session: ${c.message}`,t,{senderKey:i,error:c})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(c){throw new B("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:c})}return this._validatePayload(a,t),new Un(a,i,a.keys.ed25519)}else throw new B("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,s){let i;const r=this.account.createInboundOlmSession(e,t.body);try{i=r.decrypt(t.type,t.body);const o=Vs.create(e,r,this.olm,this.pickleKey,s);return o.unload(r),{session:o,plaintext:i}}catch(o){throw r.free(),o}}_getMessageAndValidateEvent(e){var i;const t=(i=e.content)==null?void 0:i.ciphertext;if(!t)throw new B("OLM_MISSING_CIPHERTEXT",e);const s=t==null?void 0:t[this.account.identityKeys.curve25519];if(!s)throw new B("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){const i=(await t.olmSessions.getAll(e)).map(r=>new Vs(r,this.pickleKey,this.olm));return Pn(i),i}_validatePayload(e,t){var s,i,r;if(e.sender!==t.sender)throw new B("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this.ownUserId)throw new B("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(((s=e.recipient_keys)==null?void 0:s.ed25519)!==this.account.identityKeys.ed25519)throw new B("OLM_BAD_RECIPIENT_KEY",t,{key:(i=e.recipient_keys)==null?void 0:i.ed25519});if(!e.type)throw new B("missing type on payload",t,{payload:e});if(typeof((r=e.keys)==null?void 0:r.ed25519)!="string")throw new B("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class Vl{constructor(e,t,s){this.senderKey=e,this.sessions=t,this.timestamp=s}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const s=this.decryptWithSession(t,e);if(typeof s=="string")return Pn(this.sessions),s}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}decryptWithSession(e,t){if(t.type===void 0||t.body===void 0)throw new Error("Invalid message without type or body");const s=e.load();try{if(t.type===xs.PreKey&&!s.matches_inbound(t.body))return;try{const i=s.decrypt(t.type,t.body);return e.save(s),e.data.lastUsed=this.timestamp,i}catch(i){if(t.type===xs.PreKey)throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${i.message}`);return}}finally{e.unload(s)}}}class xl{constructor(e,t,s,i,r){this.senderKeyDecryptions=e,this.results=t,this.errors=s,this.account=i,this.lock=r}get hasNewSessions(){return this.senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(const t of this.senderKeyDecryptions){for(const s of t.getModifiedSessions())if(e.olmSessions.set(s.data),s.isNew){const i=s.load();try{this.account.writeRemoveOneTimeKey(i,e)}finally{s.unload(i)}}if(t.sessions.length>cr){const{senderKey:s,sessions:i}=t;for(let r=i.length-1;r>=cr;r-=1){const o=i[r];e.olmSessions.remove(s,o.id)}}}}finally{this.lock.release()}}}function Nl(n){return n.reduce((e,t)=>!e||t<e?t:e,null)}const hr="signed_curve25519",fs=20;class Dl{constructor(e,t,s,i,r,o,a,c){this.account=e,this.pickleKey=t,this.olm=s,this.storage=i,this.now=r,this.ownUserId=o,this.olmUtil=a,this.senderKeyLock=c,this._batchLocks=new Array(fs);for(let h=0;h<fs;h+=1)this._batchLocks[h]=new xn}async _takeBatchLock(e){const t=this._batchLocks.filter(s=>!s.isTaken).slice(0,e);if(t.length<e){const s=this._batchLocks.filter(i=>i.isTaken).slice(0,e-t.length);t.push(...s)}return await Promise.all(t.map(s=>s.take())),new Nn(t)}async encrypt(e,t,s,i,r){let o=[];for(let a=0;a<s.length;a+=fs){const c=s.slice(a,a+fs),h=await this._takeBatchLock(c.length);try{const l=await this._encryptForMaxDevices(e,t,c,i,r);o=o.concat(l)}finally{h.release()}}return o}async _encryptForMaxDevices(e,t,s,i,r){const o=await Promise.all(s.map(a=>this.senderKeyLock.takeLock(_e(a))));try{const{devicesWithoutSession:a,existingEncryptionTargets:c}=await this._findExistingSessions(s),h=this.now();let l=[];try{if(a.length){const p=await r.wrap("create sessions",m=>this._createNewSessions(a,i,h,m));l=l.concat(p)}await this._loadSessions(c),l=l.concat(c);const d={l:"encrypt",targets:l.length},u=r.wrap(d,()=>l.map(p=>{const m=this._encryptForDevice(e,t,p);return new Ul(m,p.device)}));return await this._storeSessions(l,h),u}finally{for(const d of l)d.dispose()}}finally{for(const a of o)a.release()}}async _findExistingSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]),s=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(_e(o)))),i=e.filter((o,a)=>{const c=s[a];return!(c!=null&&c.length)}),r=e.map((o,a)=>{const c=s[a];if((c==null?void 0:c.length)>0){const h=Nl(c);return Yt.fromSessionId(o,h)}}).filter(o=>!!o);return{devicesWithoutSession:i,existingEncryptionTargets:r}}_encryptForDevice(e,t,s){const{session:i,device:r}=s,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,r)),a=i.encrypt(o);return{algorithm:pi,sender_key:this.account.identityKeys.curve25519,ciphertext:{[_e(r)]:a}}}_buildPlainTextMessageForDevice(e,t,s){return{keys:{ed25519:this.account.identityKeys.ed25519},recipient_keys:{ed25519:tt(s)},recipient:s.user_id,sender:this.ownUserId,content:t,type:e}}async _createNewSessions(e,t,s,i){const r=await i.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(const o of r){const{device:a,oneTimeKey:c}=o;o.session=await this.account.createOutboundOlmSession(_e(a),c)}await this._storeSessions(r,s)}catch(o){for(const a of r)a.dispose();throw o}return r}async _claimOneTimeKeys(e,t,s){const i=Si(t,c=>c.user_id,()=>new Map,(c,h)=>c.set(h.device_id,h)),r=Array.from(i.entries()).reduce((c,[h,l])=>(c[h]=Array.from(l.values()).reduce((d,u)=>(d[u.device_id]=hr,d),{}),c),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:r},{log:s}).response();Object.keys(o.failures).length&&s.log({l:"failures",servers:Object.keys(o.failures)},s.level.Warn);const a=o==null?void 0:o.one_time_keys;return this._verifyAndCreateOTKTargets(a,i,s)}_verifyAndCreateOTKTargets(e,t,s){var r;const i=[];for(const[o,a]of Object.entries(e))for(const[c,h]of Object.entries(a)){const[l,d]=Object.entries(h)[0],[u]=l.split(":");if(u===hr){const p=(r=t.get(o))==null?void 0:r.get(c);if(p&&_i(this.olmUtil,o,c,tt(p),d,s)===x.Valid){const _=Yt.fromOTK(p,d.key);i.push(_)}}}return i}async _loadSessions(e){const t=await this.storage.readTxn([this.storage.storeNames.olmSessions]);let s=!1;try{await Promise.all(e.map(async i=>{const r=await t.olmSessions.get(_e(i.device),i.sessionId);if(r&&!s){const o=new this.olm.Session;o.unpickle(this.pickleKey,r.session),i.session=o}}))}catch(i){s=!0;for(const r of e)r.dispose();throw i}}async _storeSessions(e,t){const s=await this.storage.readWriteTxn([this.storage.storeNames.olmSessions]);try{for(const i of e){const r=Dn(i.session,_e(i.device),t,this.pickleKey);s.olmSessions.set(r)}}catch(i){throw s.abort(),i}await s.complete()}}class Yt{constructor(e,t,s){this.device=e,this.oneTimeKey=t,this.sessionId=s,this.session=null}static fromOTK(e,t){return new Yt(e,t,null)}static fromSessionId(e,t){return new Yt(e,null,t)}dispose(){this.session&&this.session.free()}}class Ul{constructor(e,t){this.content=e,this.device=t}}class Pl{constructor(e,t,s,i){this._roomId=e,this._results=t,this._errors=s,this._replayEntries=i}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(s){this._errors.set(t.eventId,s)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,s){const{messageIndex:i,sessionId:r,eventId:o,timestamp:a}=t,c=await s.groupSessionDecryptions.get(e,r,i);if(c&&c.eventId!==o){const l=c.timestamp<a?o:c.eventId;throw this._results.delete(o),new B("MEGOLM_REPLAYED_INDEX",event,{messageIndex:i,badEventId:l,otherEventId:c.eventId})}c||s.groupSessionDecryptions.set(e,r,i,{eventId:o,timestamp:a})}}function ti(n,e){if(n)for(const[t,s]of n.entries())e.set(t,s)}class Fl{constructor(e,t,s){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=s}async decrypt(){try{const e=this._initialErrors,t=new Map,s=[];return await Promise.all(this._sessionDecryptions.map(async i=>{const r=await i.decryptAll();ti(r.errors,e),ti(r.results,t),s.push(...r.replayEntries)})),new Pl(this._roomId,t,e,s)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class Ol{constructor(e,t,s){this.sessionId=e,this.messageIndex=t,this.event=s}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class Kl{constructor(e,t,s,i){this.key=e,this.events=t,this.olmWorker=s,this.keyLoader=i,this.decryptionRequests=s?[]:void 0}async decryptAll(){const e=[],t=new Map;let s;return await this.keyLoader.useKey(this.key,async i=>{for(const r of this.events)try{const o=r.content.ciphertext;let a;if(this.olmWorker){const d=this.olmWorker.megolmDecrypt(i,o);this.decryptionRequests.push(d),a=await d.response()}else a=i.decrypt(o);const{plaintext:c}=a;let h;try{h=JSON.parse(c)}catch(d){throw new B("PLAINTEXT_NOT_JSON",r,{plaintext:c,err:d})}if(h.room_id!==this.key.roomId)throw new B("MEGOLM_WRONG_ROOM",r,{encryptedRoomId:h.room_id,eventRoomId:this.key.roomId});e.push(new Ol(this.key.sessionId,a.message_index,r));const l=new Un(h,this.key.senderKey,this.key.claimedEd25519Key,r);t.set(r.event_id,l)}catch(o){if(o.name==="AbortError")return;s||(s=new Map),s.set(r.event_id,o)}}),{results:t,errors:s,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function Ci(n){var e;return(e=n.content)==null?void 0:e.sender_key}function Ri(n){var e;return(e=n.content)==null?void 0:e.session_id}function Ll(n){var e;return(e=n.content)==null?void 0:e.ciphertext}function Bl(n){return typeof Ci(n)=="string"&&typeof Ri(n)=="string"&&typeof Ll(n)=="string"}class $l{constructor(){this.events=[]}get senderKey(){return Ci(this.events[0])}get sessionId(){return Ri(this.events[0])}}function si(n){return Si(n,e=>`${Ci(e)}|${Ri(e)}`,()=>new $l,(e,t)=>e.events.push(t))}class Fn{isForSession(e,t,s){return this.roomId===e&&this.senderKey===t&&this.sessionId===s}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function On(n,e){return n.first_known_index()<e.first_known_index()}class Ei extends Fn{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let s;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(r,o)=>{s=r.pickle(o)},t),this.isBetter===!1)return!1;s||(s=await e.useKey(this,(r,o)=>r.pickle(o)));const i={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:s,backup:this.backupStatus,source:this.keySource,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(i),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,s){if(this.isBetter!==void 0)return this.isBetter;let i=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!i){const r=await Bn(this.roomId,this.senderKey,this.sessionId,s);r&&(r.hasSession?i=r:r.eventIds&&(this._eventIds=r.eventIds))}if(i){const r=i;await e.useKey(this,async o=>{await e.useKey(r,(a,c)=>{this.isBetter=On(o,a),r.isBetter=!this.isBetter,this.isBetter&&t&&t(o,c)})})}else this.isBetter=!0;return this.isBetter}get backupStatus(){return Ps.NotBackedUp}}class jl extends Ei{constructor(e){super(),this._decryptionResult=e}get roomId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){var e;return(e=this._decryptionResult.event.content)==null?void 0:e.session_key}get serializationType(){return"create"}get keySource(){return ss.DeviceMessage}loadInto(e){e.create(this.serializationKey)}}class ql extends Ei{constructor(e,t,s){super(),this._roomId=e,this.outboundSession=t,this.identityKeys=s,this.isBetter=!0,this._sessionKey=this.outboundSession.session_key()}get roomId(){return this._roomId}get senderKey(){return this.identityKeys.curve25519}get sessionId(){return this.outboundSession.session_id()}get claimedEd25519Key(){return this.identityKeys.ed25519}get serializationKey(){return this._sessionKey}get serializationType(){return"create"}get keySource(){return ss.Outbound}loadInto(e){e.create(this.serializationKey)}}class Hl extends Ei{constructor(e,t,s){super(),this._roomId=e,this._sessionId=t,this._backupInfo=s}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){var e;return(e=this._backupInfo.sender_claimed_keys)==null?void 0:e.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}get keySource(){return ss.Backup}loadInto(e){e.import_session(this.serializationKey)}get backupStatus(){return Ps.BackedUp}}class Kn extends Fn{constructor(e){super(),this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function Wl(n){var s;const e=(s=n.event.content)==null?void 0:s.session_key,t=new jl(n);if(typeof t.roomId=="string"&&typeof t.sessionId=="string"&&typeof t.senderKey=="string"&&typeof e=="string")return t}function Ln(n,e,t){var o;const s=t.session_key,i=t.sender_key,r=(o=t.sender_claimed_keys)==null?void 0:o.ed25519;if(typeof n=="string"&&typeof e=="string"&&typeof i=="string"&&typeof s=="string"&&typeof r=="string")return new Hl(n,e,t)}async function Bn(n,e,t,s){const i=await s.inboundGroupSessions.get(n,e,t);if(i)return new Kn(i)}class Gl{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,s,i,r){let o=await r.inboundGroupSessions.get(e,t,s);if(!(o!=null&&o.session)){if(o){const a=new Set(o.eventIds);for(const c of i)a.add(c);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:s,eventIds:i};r.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);if(r&&!r.session)return r.eventIds}async hasSession(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);return typeof(r==null?void 0:r.session)=="string"}async prepareDecryptAll(e,t,s,i){const r=new Map,o=[];for(const h of t)Bl(h)?o.push(h):r.set(h.event_id,new B("MEGOLM_INVALID_EVENT",h));const a=si(o),c=[];return await Promise.all(Array.from(a.values()).map(async h=>{const l=await this.getRoomKey(e,h.senderKey,h.sessionId,s,i);if(l)c.push(new Kl(l,h.events,this.olmWorker,this.keyLoader));else for(const d of h.events)r.set(d.event_id,new B("MEGOLM_NO_SESSION",d))})),new Fl(e,c,r)}async getRoomKey(e,t,s,i,r){if(i){const c=i.find(h=>h.isForSession(e,t,s));if(c&&await c.checkBetterThanKeyInStorage(this.keyLoader,r))return c}const o=this.keyLoader.getCachedKey(e,t,s);if(o)return o;const a=await Bn(e,t,s,r);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){var i,r;const s=[];for(const o of e)((i=o.event)==null?void 0:i.type)!=="m.room_key"||((r=o.event.content)==null?void 0:r.algorithm)!==ye||t.wrap("room_key",a=>{const c=Wl(o);c?(a.set("roomId",c.roomId),a.set("id",c.sessionId),s.push(c)):(a.logLevel=a.level.Warn,a.set("invalid",!0))},t.level.Detail);return s}roomKeyFromBackup(e,t,s){return Ln(e,t,s)}dispose(){this.keyLoader.dispose()}}class zl extends In{constructor(e,t,s){super(s),this.pickleKey=t,this.olm=e}getCachedKey(e,t,s){const i=this.findCachedKeyIndex(e,t,s);if(i!==-1)return this._getByIndexAndMoveUp(i).key}async useKey(e,t){const s=await this.allocateOperation(e);try{return await t(s.session,this.pickleKey)}finally{this.releaseOperation(s)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){const s=this._getByIndexAndMoveUp(t);return s.isForKey(e)?(s.refCount+=1,s):(s.refCount=1,s.key=e,e.loadInto(s.session,this.pickleKey),s)}else{const s=new this.olm.InboundGroupSession;e.loadInto(s,this.pickleKey);const i=new Jl(e,s);return this._set(i),i}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,s){return this._entries.reduce((i,r,o,a)=>{const c=i===-1?void 0:a[i];return r.isBest===!0&&r.isForSameSession(e,t,s)&&(!c||r.isBetter(c))?o:i},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,s,i,r)=>{const o=t===-1?void 0:r[t];return s.refCount===0&&s.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!s.isBetter(o))?i:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}}class Jl{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,s){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===s}isBetter(e){return On(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}const Yl="m.megolm_backup.v1.curve25519-aes-sha2";class Ti{constructor(e,t){this.encryption=e,this.decryption=t}static fromAuthData(e,t,s){const i=e.public_key,r=new s.PkDecryption,o=new s.PkEncryption;try{const a=r.init_with_private_key(t);if(a!==i)throw new Error(`Bad backup key, public key does not match. Calculated ${a} but expected ${i}`);o.set_recipient_key(a)}catch(a){throw r.free(),o.free(),a}return new Ti(o,r)}decryptRoomKey(e){const t=this.decryption.decrypt(e.ephemeral,e.mac,e.ciphertext);return JSON.parse(t)}encryptRoomKey(e,t){const s={algorithm:ye,sender_key:e.senderKey,sender_claimed_keys:{ed25519:e.claimedEd25519Key},forwarding_curve25519_key_chain:[],session_key:t};return this.encryption.encrypt(JSON.stringify(s))}dispose(){var e,t;(e=this.decryption)==null||e.free(),this.decryption=void 0,(t=this.encryption)==null||t.free(),this.encryption=void 0}}const Ql=200;class Xl{constructor(e,t){this.info=e,this.crypto=t}}class Zl extends Fe{constructor(e,t,s,i,r,o=1e4){super(),this.hsApi=e,this.olm=t,this.keyLoader=s,this.storage=i,this.platform=r,this.maxDelay=o,this._stopped=!1,this._needsNewKey=!1,this._hasBackedUpAllKeys=!1,this.backupConfigDeferred=new at,this.backupConfigDeferred=new at}get hasStopped(){return this._stopped}get error(){return this._error}get version(){var e,t;return(t=(e=this.backupConfigDeferred.value)==null?void 0:e.info)==null?void 0:t.version}get needsNewKey(){return this._needsNewKey}get hasBackedUpAllKeys(){return this._hasBackedUpAllKeys}get operationInProgress(){return this._operationInProgress}async getRoomKey(e,t,s){if(this.needsNewKey)return;const i=await this.backupConfigDeferred.promise;if(!i)return;const r=await this.hsApi.roomKeyForRoomAndSession(i.info.version,e,t,{log:s}).response();if(!r.session_data)return;const o=i.crypto.decryptRoomKey(r.session_data);if((o==null?void 0:o.algorithm)===ye)return Ln(e,t,o);o!=null&&o.algorithm&&s.set("unknown algorithm",o.algorithm)}markAllForBackup(e){return e.inboundGroupSessions.markAllAsNotBackedUp()}async load(e,t){const s=await e.readSecret("m.megolm_backup.v1");return s?(this.privateKey=new Uint8Array(this.platform.encoding.base64.decode(s)),!0):(this.backupConfigDeferred.resolve(void 0),!1)}async start(e){await e.wrap("KeyBackup.start",async t=>{if(this.privateKey&&!this.backupInfoRequest){let s;try{this.backupInfoRequest=this.hsApi.roomKeysVersion(void 0,{log:t}),s=await this.backupInfoRequest.response()}catch(i){if(i.name==="AbortError"){t.set("aborted",!0);return}else throw i}finally{this.backupInfoRequest=void 0}if(s.algorithm===Yl){const i=Ti.fromAuthData(s.auth_data,this.privateKey,this.olm);this.backupConfigDeferred.resolve(new Xl(s,i)),this.emit("change")}else this.backupConfigDeferred.resolve(void 0),t.log({l:"Unknown backup algorithm",algorithm:s.algorithm});this.privateKey=void 0}this.flush(t)})}flush(e){this._operationInProgress||e.wrapDetached("flush key backup",async t=>{if(this._needsNewKey){t.set("needsNewKey",this._needsNewKey);return}this._stopped=!1,this._error=void 0,this._hasBackedUpAllKeys=!1;const s=this._runFlushOperation(t);this._operationInProgress=s,this.emit("change");try{await s.result,this._hasBackedUpAllKeys=!0}catch(i){this._stopped=!0,i.name==="HomeServerError"&&(i.errcode==="M_WRONG_ROOM_KEYS_VERSION"||i.errcode==="M_NOT_FOUND")?(t.set("wrong_version",!0),this._needsNewKey=!0):(i.name!=="AbortError"||i.name==="StorageError"&&i.errcode==="AbortError")&&(this._error=i),t.catch(i)}this._operationInProgress=void 0,this.emit("change")})}_runFlushOperation(e){return new jr(async(t,s)=>{const i=await this.backupConfigDeferred.promise;if(!i)return;let r=0,o=0;for(;;){const a=this.platform.random()*this.maxDelay,c=this.platform.clock.createTimeout(a);t(c),await c.elapsed();const h=await this.storage.readTxn([C.inboundGroupSessions]);t(h),r=o+await h.inboundGroupSessions.countNonBackedUpSessions(),s(new lr(r,o));const l=(await h.inboundGroupSessions.getFirstNonBackedUpSessions(Ql)).map(p=>new Kn(p));if(l.length===0){e.set("total",r);return}const d=await this.encodeKeysForBackup(l,i.crypto),u=this.hsApi.uploadRoomKeysToBackup(i.info.version,d,{log:e});t(u),await u.response(),await this.markKeysAsBackedUp(l,t),o+=l.length,s(new lr(r,o))}})}async encodeKeysForBackup(e,t){const s={rooms:{}},i=s.rooms;for(const r of e){let o=i[r.roomId];o||(o=i[r.roomId]={sessions:{}}),o.sessions[r.sessionId]=await this.encodeRoomKey(r,t)}return s}async markKeysAsBackedUp(e,t){const s=await this.storage.readWriteTxn([C.inboundGroupSessions]);t(s);try{await Promise.all(e.map(i=>s.inboundGroupSessions.markAsBackedUp(i.roomId,i.senderKey,i.sessionId)))}catch(i){throw s.abort(),i}await s.complete()}async encodeRoomKey(e,t){return await this.keyLoader.useKey(e,s=>{const i=s.first_known_index(),r=s.export_session(i);return{first_message_index:i,forwarded_count:0,is_verified:!1,session_data:t.encryptRoomKey(e,r)}})}dispose(){var e,t,s;(e=this.backupInfoRequest)==null||e.abort(),(s=(t=this.backupConfigDeferred.value)==null?void 0:t.crypto)==null||s.dispose()}}class lr{constructor(e,t){this.total=e,this.finished=t}}class ed{constructor({pickleKey:e,olm:t,account:s,keyLoader:i,storage:r,now:o,ownDeviceId:a}){this._pickleKey=e,this._olm=t,this._account=s,this._keyLoader=i,this._storage=r,this._now=o,this._ownDeviceId=a}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let s=await t.outboundGroupSessions.get(e);if(s){const i=new this._olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,s.session),this._createRoomKeyMessage(i,e)}finally{i.free()}}}createWithheldMessage(e,t,s){return{algorithm:e.algorithm,code:t,reason:s,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let s=new this._olm.OutboundGroupSession;try{const i=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let r;try{let o=await i.outboundGroupSessions.get(e);r=await this._readOrCreateSession(s,o,e,t,i),r&&this._writeSession(this._now(),s,e,i)}catch(o){throw i.abort(),o}return await i.complete(),r}finally{s.free()}}async _readOrCreateSession(e,t,s,i,r){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,i)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const o=this._createRoomKeyMessage(e,s);return await new ql(s,e,this._account.identityKeys).write(this._keyLoader,r),o}}_writeSession(e,t,s,i){i.outboundGroupSessions.set({roomId:s,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,s,i){let r=new this._olm.OutboundGroupSession;try{const o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let a,c;try{let h=await o.outboundGroupSessions.get(e);a=await this._readOrCreateSession(r,h,e,i,o),c=this._encryptContent(e,r,t,s);const l=a?this._now():h.createdAt;this._writeSession(l,r,e,o)}catch(h){throw o.abort(),h}return await o.complete(),new td(c,a)}finally{r&&r.free()}}_needsToRotate(e,t,s){let i=6048e5;Number.isSafeInteger(s==null?void 0:s.rotation_period_ms)&&(i=s==null?void 0:s.rotation_period_ms);let r=100;if(Number.isSafeInteger(s==null?void 0:s.rotation_period_msgs)&&(r=s==null?void 0:s.rotation_period_msgs),this._now()>t+i||e.message_index()>=r)return!0}_encryptContent(e,t,s,i){const r=JSON.stringify({room_id:e,type:s,content:i}),o=t.encrypt(r);return{algorithm:ye,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:ye,chain_index:e.message_index()}}}class td{constructor(e,t){this.content=e,this.roomKeyMessage=t}}const dr="m.room.encrypted",ur="m.room.history_visibility",sd=60*1e3;class id{constructor({room:e,deviceTracker:t,olmEncryption:s,megolmEncryption:i,megolmDecryption:r,encryptionParams:o,storage:a,keyBackup:c,notifyMissingMegolmSession:h,clock:l}){this._room=e,this._deviceTracker=t,this._olmEncryption=s,this._megolmEncryption=i,this._megolmDecryption=r,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._keyBackup=c,this._notifyMissingMegolmSession=h,this._clock=l,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._historyVisibility=void 0,this._disposed=!1}enableKeyBackup(e){this._keyBackup&&!!e||(this._keyBackup=e)}async restoreMissingSessionsFromBackup(e,t){const s=e.filter(l=>l.isEncrypted&&!l.isDecrypted&&l.event).map(l=>l.event),i=si(s),r=Array.from(i.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(r.map(async l=>this._megolmDecryption.hasSession(this._room.id,l.senderKey,l.sessionId,o))),c=r.filter((l,d)=>!a[d]);if(c.length)for(var h=c.length-1;h>=0;h--){const l=c[h];await t.wrap("session",d=>this._requestMissingSessionFromBackup(l.senderKey,l.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeSync(e,t,s,i){let r=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility,s);const o=[],a=[];if(await _t(e,h=>{var l;if(h.state_key===""&&h.type===ur){const d=(l=h==null?void 0:h.content)==null?void 0:l.history_visibility;if(d!==r)return i.wrap({l:"history_visibility changed",from:r,to:d},async u=>{r=d;const p=await this._deviceTracker.writeHistoryVisibility(this._room,r,s,u);o.push(...p.added),a.push(...p.removed)})}}),t.size){const h=await this._deviceTracker.writeMemberChanges(this._room,t,r,s);o.push(...h.added),a.push(...h.removed)}a.length&&(i.log({l:"discardOutboundSession",leftUsers:a}),this._megolmEncryption.discardOutboundSession(this._room.id,s));let c=!1;return o.length&&(c=await this._addShareRoomKeyOperationForMembers(o,s,i)),{shouldFlush:c,historyVisibility:r}}afterSync({historyVisibility:e}){this._historyVisibility=e}async _loadHistoryVisibilityIfNeeded(e,t=void 0){var s,i;if(!e){t||(t=await this._storage.readTxn([this._storage.storeNames.roomState]));const r=await t.roomState.get(this._room.id,ur,"");if(r)return(i=(s=r.event)==null?void 0:s.content)==null?void 0:i.history_visibility}return e}async prepareDecryptAll(e,t,s,i){var c,h,l;const r=new Map,o=[];for(const d of e)d.redacted_because||((c=d.unsigned)==null?void 0:c.redacted_because)||(((h=d.content)==null?void 0:h.algorithm)!==ye&&r.set(d.event_id,new Error("Unsupported algorithm: "+((l=d.content)==null?void 0:l.algorithm))),o.push(d));const a=await this._megolmDecryption.prepareDecryptAll(this._room.id,o,t,i);return new rd(a,r,s,this,e)}async _processDecryptionResults(e,t,s,i,r,o){const a=e.filter(h=>{const l=s.get(h.event_id);return(l==null?void 0:l.code)==="MEGOLM_NO_SESSION"});if(!a.length)return;const c=si(a);i===$e.Sync&&await Promise.all(Array.from(c.values()).map(async h=>{const l=h.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,h.senderKey,h.sessionId,l,r)})),this._keyBackup&&o.wrapDetached("check key backup",async h=>{if(h.set("source",i),h.set("events",a.length),h.set("sessions",c.size),i===$e.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const l=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(c).map(async([d,u])=>{await this._megolmDecryption.hasSession(this._room.id,u.senderKey,u.sessionId,l)&&c.delete(d)}))}await Promise.all(Array.from(c.values()).map(l=>h.wrap("session",d=>this._requestMissingSessionFromBackup(l.senderKey,l.sessionId,d))))})}async _verifyDecryptionResults(e,t){await Promise.all(e.map(async s=>{let i=this._senderDeviceCache.get(s.senderCurve25519Key);i||(i=await this._deviceTracker.getDeviceByCurve25519Key(s.senderCurve25519Key,t),this._senderDeviceCache.set(s.senderCurve25519Key,i)),i&&s.setDevice(i)}))}async _fetchKeyAndVerifyDecryptionResults(e,t,s){const i=e.filter(r=>r.isVerificationUnknown);return i.length?s.wrap("fetch unverified senders",async r=>{const o=Array.from(i.reduce((l,d)=>l.add(d.encryptedEvent.sender),new Set));r.set("senders",o),await this._deviceTracker.devicesForUsers(o,t,r);const a=await this._storage.readTxn([this._storage.storeNames.deviceKeys]);await this._verifyDecryptionResults(i,a);const h=i.filter(l=>!l.isVerificationUnknown).reduce((l,d)=>(l.set(d.encryptedEvent.event_id,d),l),new Map);return new ii(h,new Map,this)}):new ii(new Map,new Map,this)}async _requestMissingSessionFromBackup(e,t,s){if(!this._keyBackup){s.set("enabled",!1),this._notifyMissingMegolmSession();return}s.set("id",t),s.set("senderKey",e);try{const i=await this._keyBackup.getRoomKey(this._room.id,t,s);if(i){if(i.senderKey!==e){s.set("wrong_sender_key",i.senderKey),s.logLevel=s.level.Warn;return}let r=!1,o;const a=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{r=await this._megolmDecryption.writeRoomKey(i,a),s.set("isBetter",r),r&&(o=i.eventIds)}catch(c){throw a.abort(),c}await a.complete(),r&&await s.wrap("retryDecryption",c=>this._room.notifyRoomKey(i,o||[],c))}}catch(i){i.name==="HomeServerError"&&i.errcode==="M_NOT_FOUND"?(s.error=i,s.logLevel=s.level.Error):s.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){var s;if(!(((s=this._lastKeyPreShareTime)==null?void 0:s.measure())<sd)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{var r;const i=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);i&&((r=this._keyBackup)==null||r.flush(t),await t.wrap("share key",o=>this._shareNewRoomKey(i,e,o)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,s,i){var o;this._keySharePromise&&(i.set("waitForRunningKeyShare",!0),await this._keySharePromise);const r=await i.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return r.roomKeyMessage&&((o=this._keyBackup)==null||o.flush(i),await i.wrap("share key",a=>this._shareNewRoomKey(r.roomKeyMessage,s,a))),{type:dr,content:r.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,s){this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,s);const i=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,s),r=Array.from(i.reduce((c,h)=>c.add(h.user_id),new Set));let o=await this._storage.readWriteTxn([this._storage.storeNames.operations]),a;try{a=this._writeRoomKeyShareOperation(e,r,o)}catch(c){throw o.abort(),c}await this._processShareRoomKeyOperation(a,t,s)}async _addShareRoomKeyOperationForMembers(e,t,s){const i=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return i?(s.log({l:"share key for new members",userIds:e,id:i.session_id,chain_index:i.chain_index}),this._writeRoomKeyShareOperation(i,e,t),!0):!1}async flushPendingRoomKeyShares(e,t,s){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(const i of t)i.type==="share_room_key"&&await s.wrap("operation",r=>this._processShareRoomKeyOperation(i,e,r))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,s){const r={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return s.operations.add(r),r}async _processShareRoomKeyOperation(e,t,s){s.set("id",e.id),this._historyVisibility=await this._loadHistoryVisibilityIfNeeded(this._historyVisibility),await this._deviceTracker.trackRoom(this._room,this._historyVisibility,s);const i=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,s),r=await s.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,i,t,a)),o=i.filter(a=>!r.some(c=>c.device===a));await s.wrap("send",a=>this._sendMessagesToDevices(dr,r,t,a)),o.length&&await s.wrap("missingDevices",async a=>{a.set("devices",o.map(l=>l.device_id));const c=e.userIds.filter(l=>o.some(d=>d.user_id===l));a.set("unsentUserIds",c),e.userIds=c,await this._updateOperationsStore(l=>l.update(e));const h=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",h,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(s){throw t.abort(),s}await t.complete()}async _sendSharedMessageToDevices(e,t,s,i,r){const o=vt(s,h=>h.user_id),a={messages:Array.from(o.entries()).reduce((h,[l,d])=>(h[l]=d.reduce((u,p)=>(u[p.device_id]=t,u),{}),h),{})},c=Q();await i.sendToDevice(e,a,c,{log:r}).response()}async _sendMessagesToDevices(e,t,s,i){i.set("messages",t.length);const r=Jt(t),o=Q();await s.sendToDevice(e,r,o,{log:i}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(s=>{var i,r;if(s.isEncrypted&&!s.isDecrypted){const{event:o}=s;if(o){const a=(i=o.content)==null?void 0:i.sender_key,c=(r=o.content)==null?void 0:r.session_id;return t.some(h=>a===h.senderKey&&c===h.sessionId)}}return!1})}dispose(){this._disposed=!0}}class rd{constructor(e,t,s,i,r){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async decrypt(){return new nd(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class nd{constructor(e,t,s,i,r){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async write(e,t){const{results:s,errors:i}=await this._megolmDecryptionChanges.write(e);return ti(this._extraErrors,i),await this._roomEncryption._processDecryptionResults(this._events,s,i,this._source,e,t),new ii(s,i,this._roomEncryption)}}class ii{constructor(e,t,s){this.results=e,this.errors=t,this._roomEncryption=s}applyToEntries(e,t=void 0){for(const s of e){const i=this.results.get(s.id);if(i)s.setDecryptionResult(i),t==null||t(s);else{const r=this.errors.get(s.id);r&&(s.setDecryptionError(r),t==null||t(s))}}}verifyKnownSenders(e){return this._roomEncryption._verifyDecryptionResults(Array.from(this.results.values()),e)}get hasUnverifiedSenders(){for(const e of this.results.values())if(e.isVerificationUnknown)return!0;return!1}fetchAndVerifyRemainingSenders(e,t){return this._roomEncryption._fetchKeyAndVerifyDecryptionResults(Array.from(this.results.values()),e,t)}}class od{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new xn,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}}function $n(n,e,t=!1){for(const[s,i]of Object.entries(e)){if(n[s]instanceof Object&&i){$n(n[s],i);continue}if(i!=null||!t){n[s]=i;continue}}return n}/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var ri=(n=>(n.Video="video",n.Audio="audio",n))(ri||{});function qe(n){return n==null?void 0:n.getAudioTracks()[0]}function Re(n){return n==null?void 0:n.getVideoTracks()[0]}function ni(n,e,t){return t.wrap("mute",s=>{s.set("cameraMuted",e.camera),s.set("microphoneMuted",e.microphone);const i=qe(n.userMedia);if(i){const o=!e.microphone;s.set("microphone enabled",o),i.enabled=o}const r=Re(n.userMedia);if(r){const o=!e.camera;s.set("camera enabled",o),r.enabled=o}})}class bt{constructor(e=!1,t=!1,s=!1,i=!1){this.isMicrophoneMuted=e,this.isCameraMuted=t,this.hasMicrophoneTrack=s,this.hasCameraTrack=i}updateTrackInfo(e){this.hasMicrophoneTrack=!!qe(e),this.hasCameraTrack=!!Re(e)}get microphone(){return!this.hasMicrophoneTrack||this.isMicrophoneMuted}get camera(){return!this.hasCameraTrack||this.isCameraMuted}toggleCamera(){return new bt(this.microphone,!this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}toggleMicrophone(){return new bt(!this.microphone,this.camera,this.hasMicrophoneTrack,this.hasCameraTrack)}equals(e){return this.microphone===e.microphone&&this.camera===e.camera}}const Ye="call",Hs=3600*1e3;var S=(n=>(n.GroupCall="org.matrix.msc3401.call",n.GroupCallMember="org.matrix.msc3401.call.member",n.Invite="m.call.invite",n.Candidates="m.call.candidates",n.Answer="m.call.answer",n.Hangup="m.call.hangup",n.Reject="m.call.reject",n.SelectAnswer="m.call.select_answer",n.Negotiate="m.call.negotiate",n.SDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",n.SDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",n.Replaces="m.call.replaces",n.AssertedIdentity="m.call.asserted_identity",n.AssertedIdentityPrefix="org.matrix.call.asserted_identity",n))(S||{});const me="org.matrix.msc3077.sdp_stream_metadata";var Le=(n=>(n.Usermedia="m.usermedia",n.Screenshare="m.screenshare",n))(Le||{}),T=(n=>(n.UserHangup="user_hangup",n.LocalOfferFailed="local_offer_failed",n.NoUserMedia="no_user_media",n.UnknownDevices="unknown_devices",n.SendInvite="send_invite",n.CreateAnswer="create_answer",n.SendAnswer="send_answer",n.SetRemoteDescription="set_remote_description",n.SetLocalDescription="set_local_description",n.AnsweredElsewhere="answered_elsewhere",n.IceFailed="ice_failed",n.InviteTimeout="invite_timeout",n.Replaced="replaced",n.SignallingFailed="signalling_timeout",n.UserBusy="user_busy",n.Transfered="transferred",n.NewSession="new_session",n))(T||{}),Qt=(n=>(n.Ring="m.ring",n.Prompt="m.prompt",n.Room="m.room",n))(Qt||{}),Is=(n=>(n.Video="m.video",n.Voice="m.voice",n))(Is||{}),oi=(n=>(n[n.InviteGlare=0]="InviteGlare",n[n.Handle=1]="Handle",n[n.Ignore=2]="Ignore",n))(oi||{});class ad{constructor(e,t){this.userMedia=e,this.screenShare=t}}class cd{constructor(e,t,s){this.callId=e,this.options=t,this.logItem=s,this._state=b.Fledgling,this.candidateSendQueue=[],this.remoteCandidateBuffer=new Map,this.disposables=new Et,this.statePromiseMap=new Map,this._remoteTrackToStreamId=new Map,this._remoteStreams=new Map,this.makingOffer=!1,this.ignoreOffer=!1,this.sentEndOfCandidates=!1,this._remoteMuteSettings=new bt,this.onIceConnectionStateChange=async(r,o)=>{var c,h;if(this._state===b.Ended)return;let a=!1;if(r=="connected")(c=this.iceDisconnectedTimeout)==null||c.abort(),this.iceDisconnectedTimeout=void 0,this.setState(b.Connected,o);else if(r=="failed")a=!0,(h=this.iceDisconnectedTimeout)==null||h.abort(),this.iceDisconnectedTimeout=void 0,await this._hangup(T.IceFailed,o);else if(r=="disconnected"){a=!0,this.iceDisconnectedTimeout=this.options.createTimeout(30*1e3);try{await this.iceDisconnectedTimeout.elapsed(),await this._hangup(T.IceFailed,o)}catch(l){if(!(l instanceof he))throw l}}if(a){const l=await this.peerConnection.getStats(),d={};l.forEach((u,p)=>{d[p]=u}),o.set("peerConnectionStats",d)}},s.log({l:"create PeerCall",id:e}),this._remoteMedia=new ad,this.peerConnection=t.webRTC.createPeerConnection(this.options.forceTURN,[this.options.turnServer.get()],0),this.disposables.track(this.options.turnServer.subscribe(r=>{this.logItem.log({l:"updating turn server",turnServer:r}),this.peerConnection.setConfiguration({iceServers:[r]})}));const i=(r,o,a)=>{const c=l=>{this.options.errorBoundary.try(()=>o(l))};this.peerConnection.addEventListener(r,c);const h=()=>{this.peerConnection.removeEventListener(r,c)};this.disposables.track(h)};i("iceconnectionstatechange",async()=>{const r=this.peerConnection.iceConnectionState;await s.wrap({l:"onIceConnectionStateChange",status:r},async o=>{await this.onIceConnectionStateChange(r,o)})}),i("icecandidate",async r=>{await s.wrap("onLocalIceCandidate",async o=>{r.candidate&&await this.handleLocalIceCandidate(r.candidate,o)})}),i("icegatheringstatechange",async()=>{const r=this.peerConnection.iceGatheringState;await s.wrap({l:"onIceGatheringStateChange",status:r},async o=>{await this.handleIceGatheringState(r,o)})}),i("track",r=>{s.wrap("onRemoteTrack",o=>{this.onRemoteTrack(r.track,r.streams,o)})}),i("datachannel",r=>{s.wrap("onRemoteDataChannel",o=>{this._dataChannel=r.channel,this.options.emitUpdate(this,void 0,o)})}),i("negotiationneeded",()=>{var a,c;const r=this.peerConnection.signalingState,o=()=>s.wrap({l:"onNegotiationNeeded",signalingState:r},h=>this.handleNegotiation(h));this.responsePromiseChain=(c=(a=this.responsePromiseChain)==null?void 0:a.then(o))!=null?c:o(),this.responsePromiseChain.catch(h=>this.options.errorBoundary.reportError(h))})}get dataChannel(){return this._dataChannel}get state(){return this._state}get hangupReason(){return this._hangupReason}get remoteMedia(){return this._remoteMedia}get remoteMuteSettings(){return this._remoteMuteSettings}call(e,t,s){return s.wrap("call",async i=>{var r;this._state===b.Fledgling&&(i.set("signalingState",this.peerConnection.signalingState),this.direction=Kt.Outbound,this.setState(b.CreateOffer,i),this.localMuteSettings=t,await this.updateLocalMedia(e,i),(r=this.localMedia)!=null&&r.dataChannelOptions&&(this._dataChannel=this.peerConnection.createDataChannel("channel",this.localMedia.dataChannelOptions)),await this.waitForState([b.InviteSent,b.CreateAnswer]))})}answer(e,t,s){return s.wrap("answer",async i=>{if(this._state!==b.Ringing)return;this.setState(b.CreateAnswer,i),this.localMuteSettings=t,await this.updateLocalMedia(e,i);let r;try{r=await this.peerConnection.createAnswer()}catch(o){await i.wrap("Failed to create answer",a=>{a.catch(o),this.terminate(J.Local,T.CreateAnswer,a)});return}try{await this.peerConnection.setLocalDescription(r),this.setState(b.Connecting,i)}catch(o){await i.wrap("Error setting local description!",a=>{a.catch(o),this.terminate(J.Local,T.SetLocalDescription,a)});return}try{await this.delay(200)}catch{return}await this.sendAnswer(i)})}setMedia(e,t){return t.wrap("setMedia",async s=>{s.set("userMedia_audio",!!qe(e.userMedia)),s.set("userMedia_video",!!Re(e.userMedia)),s.set("screenShare_video",!!Re(e.screenShare)),s.set("datachannel",!!e.dataChannelOptions),await this.updateLocalMedia(e,s);const i={call_id:this.callId,version:1,[me]:this.getSDPMetadata()};await this.sendSignallingMessage({type:S.SDPStreamMetadataChangedPrefix,content:i},s)})}setMuted(e,t){return t.wrap("setMuted",async s=>{if(this.localMuteSettings=e,s.set("cameraMuted",e.camera),s.set("microphoneMuted",e.microphone),this.localMedia){ni(this.localMedia,e,s);const i={call_id:this.callId,version:1,[me]:this.getSDPMetadata()};await this.sendSignallingMessage({type:S.SDPStreamMetadataChangedPrefix,content:i},s)}})}hangup(e,t){return t.wrap("hangup",s=>this._hangup(e,s))}async _hangup(e,t){this._state===b.Ended||this._state===b.Ending||(this.setState(b.Ending,t),await this.sendHangupWithCallId(this.callId,e,t),this.terminate(J.Local,e,t))}getMessageAction(e){const t=this.callId===e.content.call_id;return e.type===S.Invite&&!t?0:t?1:2}handleIncomingSignallingMessage(e,t,s){let i;return s.wrap({l:"receive signalling message",type:e.type,callId:e.content.call_id,payload:e.content},async r=>{var o;if(i=r,this.getMessageAction(e)!==1){r.set("wrongCallId",!0);return}switch(e.type){case S.Invite:await this.handleFirstInvite(e.content,t,r);break;case S.Answer:await this.handleAnswer(e.content,t,r);break;case S.Negotiate:await this.onNegotiateReceived(e.content,r);break;case S.Candidates:await this.handleRemoteIceCandidates(e.content,t,r);break;case S.SDPStreamMetadataChanged:case S.SDPStreamMetadataChangedPrefix:this.updateRemoteSDPStreamMetadata(e.content[me],r);break;case S.Hangup:r.set("reason",e.content.reason),this.terminate(J.Remote,(o=e.content.reason)!=null?o:T.UserHangup,r);break;default:r.log(`Unknown event type for call: ${e.type}`);break}}),i}sendHangupWithCallId(e,t,s){const i={call_id:e,version:1};return t&&(i.reason=t),this.sendSignallingMessage({type:S.Hangup,content:i},s)}async handleNegotiation(e){this.makingOffer=!0;try{try{await this.peerConnection.setLocalDescription()}catch(s){e.log("Error setting local description!").catch(s),this.terminate(J.Local,T.SetLocalDescription,e);return}if(this.peerConnection.iceGatheringState==="gathering")try{await this.delay(200)}catch{return}if(this._state===b.Ended)return;const t=this.peerConnection.localDescription;if(e.set("includedCandidates",this.candidateSendQueue.length),this.candidateSendQueue=[],this._state===b.CreateOffer){const s={call_id:this.callId,offer:t,[me]:this.getSDPMetadata(),version:1,lifetime:Dt};await this.sendSignallingMessage({type:S.Invite,content:s},e),this.setState(b.InviteSent,e)}else if(this._state===b.Connected||this._state===b.Connecting){const s={call_id:this.callId,description:t,[me]:this.getSDPMetadata(),version:1,lifetime:Dt};await this.sendSignallingMessage({type:S.Negotiate,content:s},e)}}finally{this.makingOffer=!1}if(this.sendCandidateQueue(e),this._state===b.InviteSent){const t=this.logItem.child("invite timeout");e.refDetached(t),await t.run(async s=>{try{await this.delay(Dt)}catch{return}this._state===b.InviteSent&&await this._hangup(T.InviteTimeout,s)})}}handleInviteGlare(e,t,s){if(e.type!==S.Invite)return{shouldReplace:!1};const{content:i}=e,r=i.call_id,o=this.callId>r;let a;return s.wrap("handling call glare",async c=>{a=c,o?(c.log("Glare detected: answering incoming call "+r+" and canceling outgoing call "),this._state!==b.Fledgling&&this._state!==b.CreateOffer&&await this.sendHangupWithCallId(this.callId,T.Replaced,c),this.close(T.Replaced,c),this.dispose()):(c.log("Glare detected: rejecting incoming call "+r+" and keeping outgoing call "),await this.sendHangupWithCallId(r,T.Replaced,c))}),{shouldReplace:o,log:a}}handleHangupReceived(e,t){this.terminate(J.Remote,e.reason||T.UserHangup,t)}async handleFirstInvite(e,t,s){this._state!==b.Fledgling||this.opponentPartyId!==void 0||await this.handleInvite(e,t,s)}async handleInvite(e,t,s){var r;this.opponentPartyId=t,this.direction=Kt.Inbound;const i=e[me];i?this.updateRemoteSDPStreamMetadata(i,s):s.log("Call did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.offer),await this.addBufferedIceCandidates(s)}catch(o){await s.wrap("Call failed to set remote description",async a=>(a.catch(o),this.terminate(J.Local,T.SetRemoteDescription,a)));return}if(this.peerConnection.getReceivers().length===0){await s.wrap("Call no remote stream or no tracks after setting remote description!",async o=>this.terminate(J.Local,T.SetRemoteDescription,o));return}this.setState(b.Ringing,s);try{await this.delay((r=e.lifetime)!=null?r:Dt)}catch{return}this._state===b.Ringing&&(s.log("Invite has expired. Hanging up."),this.hangupParty=J.Remote,this.setState(b.Ended,s),this.peerConnection.signalingState!="closed"&&this.peerConnection.close())}async handleAnswer(e,t,s){if(this._state===b.Ended){s.log("Ignoring answer because call has ended");return}if(this.opponentPartyId!==void 0){s.log(`Ignoring answer: we already have an answer/reject from ${this.opponentPartyId}`);return}this.opponentPartyId=t,await this.addBufferedIceCandidates(s),this.setState(b.Connecting,s);const i=e[me];i?this.updateRemoteSDPStreamMetadata(i,s):s.log("Did not get any SDPStreamMetadata! Can not send/receive multiple streams");try{await this.peerConnection.setRemoteDescription(e.answer)}catch(r){await s.wrap("Failed to set remote description",o=>{o.catch(r),this.terminate(J.Local,T.SetRemoteDescription,o)});return}}async handleIceGatheringState(e,t){if(e==="complete"&&!this.sentEndOfCandidates){const s={candidate:""};await this.queueCandidate(s,t),this.sentEndOfCandidates=!0}}async handleLocalIceCandidate(e,t){t.set("sdpMid",e.sdpMid),t.set("candidate",e.candidate),this._state!==b.Ended&&(e.candidate!==""||!this.sentEndOfCandidates)&&(await this.queueCandidate(e,t),e.candidate===""&&(this.sentEndOfCandidates=!0))}async handleRemoteIceCandidates(e,t,s){if(this.state===b.Ended){s.log("Ignoring remote ICE candidate because call has ended");return}const i=e.candidates;if(!i){s.log("Ignoring candidates event with no candidates!");return}const r=e.version===0?null:t||null;if(this.opponentPartyId===void 0){s.log(`Buffering ${i.length} candidates until we pick an opponent`);const o=this.remoteCandidateBuffer.get(r)||[];o.push(...i),this.remoteCandidateBuffer.set(r,o);return}if(this.opponentPartyId!==t){s.log(`Ignoring candidates from party ID ${t}: we have chosen party ID ${this.opponentPartyId}`);return}await this.addIceCandidates(i,s)}async onNegotiateReceived(e,t){const s=e.description;if(!s||!s.sdp||!s.type){t.log("Ignoring invalid m.call.negotiate event");return}const i=this.direction===Kt.Inbound,r=s.type==="offer"&&(this.makingOffer||this.peerConnection.signalingState!=="stable");if(this.ignoreOffer=!i&&r,this.ignoreOffer){t.log("Ignoring colliding negotiate event because we're impolite");return}const o=e[me];o?this.updateRemoteSDPStreamMetadata(o,t):t.log("Received negotiation event without SDPStreamMetadata!");try{if(await this.peerConnection.setRemoteDescription(s),s.type==="offer"){await this.peerConnection.setLocalDescription();const a={call_id:this.callId,description:this.peerConnection.localDescription,[me]:this.getSDPMetadata(),version:1,lifetime:Dt};await this.sendSignallingMessage({type:S.Negotiate,content:a},t)}}catch(a){t.log("Failed to complete negotiation").catch(a)}}async sendAnswer(e){const t=this.peerConnection.localDescription,s={call_id:this.callId,version:1,answer:{sdp:t.sdp,type:t.type},[me]:this.getSDPMetadata()};e.log(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{await this.sendSignallingMessage({type:S.Answer,content:s},e)}catch(i){throw this.terminate(J.Local,T.SendAnswer,e),i}this.sendCandidateQueue(e)}async queueCandidate(e,t){var i;if(this.candidateSendQueue.push(e),this._state===b.Ringing)return;this.flushCandidatesLog=(i=this.flushCandidatesLog)!=null?i:this.logItem.child("flush candidate queue"),t.refDetached(this.flushCandidatesLog);const{flushCandidatesLog:s}=this;try{await this.delay(this.direction===Kt.Inbound?500:2e3)}catch{return}this.sendCandidateQueue(s),this.flushCandidatesLog=void 0}async sendCandidateQueue(e){if(this.candidateSendQueue.length===0||this._state===b.Ended)return;const t=this.candidateSendQueue;return this.candidateSendQueue=[],e.wrap({l:"send candidates",size:t.length},async s=>{try{await this.sendSignallingMessage({type:S.Candidates,content:{call_id:this.callId,version:1,candidates:t}},s),await this.sendCandidateQueue(s)}catch(i){s.catch(i),this.terminate(J.Local,T.SignallingFailed,s)}})}updateRemoteSDPStreamMetadata(e,t){this.remoteSDPStreamMetadata=$n(this.remoteSDPStreamMetadata||{},e,!0),this.updateRemoteMedia(t)}async addBufferedIceCandidates(e){if(this.remoteCandidateBuffer&&this.opponentPartyId){const t=this.remoteCandidateBuffer.get(this.opponentPartyId);t&&(e.log(`Adding ${t.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(t,e)),this.remoteCandidateBuffer=void 0}}async addIceCandidates(e,t){for(const s of e){let i;(s.sdpMid===null||s.sdpMid===void 0)&&(s.sdpMLineIndex===null||s.sdpMLineIndex===void 0)?i=t.log("Got remote end-of-ICE candidates"):i=t.log(`Adding remote ICE ${s.sdpMid} candidate: ${s.candidate}`);try{await this.peerConnection.addIceCandidate(s)}catch(r){this.ignoreOffer||i.catch(r)}}}setState(e,t){if(e!==this._state){t.log({l:"change state",status:e,oldState:this._state}),this._state,this._state=e;let s=this.statePromiseMap.get(e);s&&(s.resolve(),this.statePromiseMap.delete(e)),this.options.emitUpdate(this,void 0,t)}}waitForState(e){return Promise.race(e.map(t=>{let s=this.statePromiseMap.get(t);if(!s){let i;const r=new Promise(o=>{i=o});s={resolve:i,promise:r},this.statePromiseMap.set(t,s)}return s.promise}))}terminate(e,t,s){this._state!==b.Ended&&(this.hangupParty=e,this._hangupReason=t,this.setState(b.Ended,s),this.localMedia=void 0,this.peerConnection&&this.peerConnection.signalingState!=="closed"&&this.peerConnection.close())}getSDPMetadata(){var t,s,i,r,o,a;const e={};if((t=this.localMedia)!=null&&t.userMedia){const c=this.localMedia.userMedia.id;e[c]={purpose:Le.Usermedia,audio_muted:(i=(s=this.localMuteSettings)==null?void 0:s.microphone)!=null?i:!1,video_muted:(o=(r=this.localMuteSettings)==null?void 0:r.camera)!=null?o:!1}}if((a=this.localMedia)!=null&&a.screenShare){const c=this.localMedia.screenShare.id;e[c]={purpose:Le.Screenshare}}return e}findReceiverForStream(e,t){return this.peerConnection.getReceivers().find(s=>s.track.kind===e&&this._remoteTrackToStreamId.get(s.track.id)===t)}findTransceiverForTrack(e){return this.peerConnection.getTransceivers().find(t=>{var s;return((s=t.sender.track)==null?void 0:s.id)===e.id})}onRemoteTrack(e,t,s){if(s.set("kind",e.kind),s.set("id",e.id),s.set("streams",t.map(r=>r.id)),t.length===0){s.log({l:`ignoring ${e.kind} streamless track`,id:e.id});return}const i=t[0];if(this._remoteTrackToStreamId.set(e.id,i.id),!this._remoteStreams.has(i.id)){const r=a=>{this.logItem.wrap({l:"removetrack",id:a.track.id},c=>{const h=this._remoteTrackToStreamId.get(a.track.id);if(h){this._remoteTrackToStreamId.delete(a.track.id);const l=this._remoteStreams.get(h);l&&l.stream.getTracks().length===0&&(this.disposables.disposeTracked(o),this._remoteStreams.delete(i.id),this.updateRemoteMedia(c))}})};i.addEventListener("removetrack",r);const o=()=>{i.removeEventListener("removetrack",r)};this.disposables.track(o),this._remoteStreams.set(i.id,{disposeListener:o,stream:i})}this.updateRemoteMedia(s)}updateRemoteMedia(e){e.wrap("reevaluating remote media",t=>{var s,i;if(this._remoteMedia.userMedia=void 0,this._remoteMedia.screenShare=void 0,this.remoteSDPStreamMetadata)for(const r of this._remoteStreams.values()){const{stream:o}=r,a=this.remoteSDPStreamMetadata[o.id];if(a)if(a.purpose===Le.Usermedia){this._remoteMedia.userMedia=o;const c=this.findReceiverForStream(ri.Audio,o.id);c&&(c.track.enabled=!a.audio_muted);const h=this.findReceiverForStream(ri.Video,o.id);h&&(h.track.enabled=!a.video_muted),this._remoteMuteSettings=new bt((s=a.audio_muted)!=null?s:!1,(i=a.video_muted)!=null?i:!1,!!(c!=null&&c.track),!!(h!=null&&h.track)),t.log({l:"setting userMedia",micMuted:this._remoteMuteSettings.microphone,cameraMuted:this._remoteMuteSettings.camera})}else a.purpose===Le.Screenshare&&(this._remoteMedia.screenShare=o,t.log("setting screenShare"));else t.log({l:"no metadata yet for stream, ignoring for now",id:o.id})}this.options.emitUpdate(this,void 0,t)})}updateLocalMedia(e,t){return t.wrap("updateLocalMedia",async s=>{var o,a;const i=this.peerConnection.getSenders(),r=async(c,h,l)=>{const d=async(u,p)=>{const m=i.find(y=>y.track===u),_=c!=null?c:h;if(_!==h&&(u&&(_.removeTrack(u),u.stop()),p&&_.addTrack(p)),p&&m)try{await s.wrap(`attempting to replace ${l} ${p.kind} track`,y=>m.replaceTrack(p));return}catch{}m&&s.wrap(`removing ${l} ${m.track.kind} track`,y=>{this.peerConnection.removeTrack(m)}),p&&s.wrap(`adding ${l} ${p.kind} track`,y=>{const M=this.peerConnection.addTrack(p,_);this.options.webRTC.prepareSenderForPurpose(this.peerConnection,M,l)})};!c&&!h||(await d(qe(c),qe(h)),await d(Re(c),Re(h)))};await r((o=this.localMedia)==null?void 0:o.userMedia,e==null?void 0:e.userMedia,Le.Usermedia),await r((a=this.localMedia)==null?void 0:a.screenShare,e==null?void 0:e.screenShare,Le.Screenshare),this.localMedia||(this.localMedia=e)})}async delay(e){const t=this.disposables.track(this.options.createTimeout(e));try{await t.elapsed()}finally{this.disposables.untrack(t)}}sendSignallingMessage(e,t){return t.wrap({l:"send",id:e.type},async s=>this.options.sendSignallingMessage(e,s))}dispose(){var e;this.disposables.dispose(),(e=this.iceDisconnectedTimeout)==null||e.abort(),this.peerConnection.close(),this.options.emitUpdate=(t,s,i)=>{i.log("emitting update from PeerCall after disposal",this.logItem.level.Error),console.trace("emitting update from PeerCall after disposal")}}close(e,t){e===void 0&&(e=T.UserHangup),this.terminate(J.Local,e,t)}}var J=(n=>(n.Local="local",n.Remote="remote",n))(J||{}),b=(n=>(n.Fledgling="fledgling",n.CreateOffer="create_offer",n.InviteSent="invite_sent",n.CreateAnswer="create_answer",n.Connecting="connecting",n.Connected="connected",n.Ringing="ringing",n.Ending="ending",n.Ended="ended",n))(b||{}),Kt=(n=>(n.Inbound="inbound",n.Outbound="outbound",n))(Kt||{});const Dt=6e4;function hd(n){return n===S.Invite||n===S.Candidates||n===S.Answer||n===S.Hangup||n===S.SDPStreamMetadataChanged||n===S.SDPStreamMetadataChangedPrefix||n===S.Negotiate}class jn{constructor(e){this.errorCallback=e}try(e,t){try{let s=e();return s instanceof Promise&&(s=s.catch(i=>(this._error=i,this.reportError(i),t))),s}catch(s){return this._error=s,this.reportError(s),t}}reportError(e){try{this.errorCallback(e)}catch(t){console.error("error in ErrorBoundary callback",t)}}get error(){return this._error}}const ld=[T.UserHangup,T.AnsweredElsewhere,T.Replaced,T.UserBusy,T.Transfered,T.NewSession];class dd{constructor(e,t,s,i){this.localMedia=e,this.localMuteSettings=t,this.turnServer=s,this.logItem=i,this.retryCount=0,this.queuedSignallingMessages=[],this.outboundSeqCounter=0}get canDequeueNextSignallingMessage(){if(this.queuedSignallingMessages.length===0)return!1;const t=this.queuedSignallingMessages[0].content.seq;return this.lastIgnoredSeqNr!==void 0&&t===this.lastIgnoredSeqNr+1?!0:this.lastProcessedSeqNr===void 0?t===0:t<=this.lastProcessedSeqNr+1}dispose(){var e;(e=this.peerCall)==null||e.dispose(),this.localMedia.dispose(),this.logItem.finish()}}class ud{constructor(e,t,s,i){this.member=e,this.callDeviceMembership=t,this.options=s,this.errorBoundary=new jn(r=>{this.options.emitUpdate(this,"error"),this.connection&&this.connection.logItem.log("error at boundary").catch(r)}),this.emitUpdateFromPeerCall=async(r,o,a)=>{const c=this.connection;if(r.state===b.Ringing)c.logItem.wrap("ringing, answer peercall",h=>(a.refDetached(h),r.answer(c.localMedia,c.localMuteSettings,h)));else if(r.state===b.Ended){const h=r.hangupReason;if(r.dispose(),c.peerCall=void 0,h&&!ld.includes(h)){c.retryCount+=1;const{retryCount:l}=c;await c.logItem.wrap({l:"retry connection",retryCount:l},async d=>{if(a.refDetached(d),l<=3)await this.callIfNeeded(d);else{const u=await this.disconnect(!1);u&&d.refDetached(u)}})}}this.options.emitUpdate(this,o)},this.sendSignallingMessage=async(r,o)=>{const a=r;a.content.seq=this.connection.outboundSeqCounter++,a.content.conf_id=this.options.confId,a.content.device_id=this.options.ownDeviceId,a.content.party_id=this.options.ownDeviceId,a.content.sender_session_id=this.options.sessionId,a.content.dest_session_id=this.sessionId;let c,h=r.type;const l=await this.options.encryptDeviceMessage(this.member.userId,this.deviceId,a,o);l?(c=Jt(l),h="m.room.encrypted"):c=Jt([{content:a.content,device:this}]),o.set("payload",a.content),await this.options.hsApi.sendToDevice(h,c,Q(),{log:o}).response()},this._renewExpireTimeout(i)}get error(){return this.errorBoundary.error}get usesFoci(){const e=this.callDeviceMembership["m.foci.active"];return Array.isArray(e)&&e.length>0}_renewExpireTimeout(e){var i;(i=this.expireTimeout)==null||i.dispose(),this.expireTimeout=void 0;const t=Ns(this.callDeviceMembership);if(typeof t!="number")return;const s=Math.max(0,t-this.options.clock.now());e==null||e.set("expiresIn",s),this.expireTimeout=this.options.clock.createTimeout(s+10),this.expireTimeout.elapsed().then(()=>{this.options.emitUpdate(this,"isExpired")},r=>{})}get logItem(){var e;return(e=this.connection)==null?void 0:e.logItem}get remoteMedia(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.remoteMedia}get isExpired(){return!this.isConnected&&ai(this.callDeviceMembership,this.options.clock.now())}get remoteMuteSettings(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.remoteMuteSettings}get isConnected(){var e,t;return((t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.state)===b.Connected}get userId(){return this.member.userId}get deviceId(){return this.callDeviceMembership.device_id}get user_id(){return this.userId}get device_id(){return this.deviceId}get sessionId(){return this.callDeviceMembership.session_id}get dataChannel(){var e,t;return(t=(e=this.connection)==null?void 0:e.peerCall)==null?void 0:t.dataChannel}connect(e,t,s,i){return this.errorBoundary.try(async()=>{if(this.connection)return;const r=new dd(e.clone(),t,s,i);this.connection=r;let o;return await r.logItem.wrap("connect",async a=>{o=a,await this.callIfNeeded(a)}),o})}callIfNeeded(e){return e.wrap("callIfNeeded",async t=>{let s;if(this.member.userId===this.options.ownUserId?s=this.deviceId>this.options.ownDeviceId:s=this.member.userId>this.options.ownUserId,s){const i=this.connection;i.peerCall=this._createPeerCall(Ts("c")),await i.peerCall.call(i.localMedia,i.localMuteSettings,t)}else t.set("wait_for_invite",!0)})}disconnect(e){return this.errorBoundary.try(async()=>{const{connection:t}=this;if(!t)return;let s;return await t.logItem.wrap("disconnect",async i=>{s=i,e&&t.peerCall&&await t.peerCall.hangup(T.UserHangup,i)}),t.dispose(),this.connection=void 0,s})}updateCallInfo(e,t){this.errorBoundary.try(()=>{this.callDeviceMembership=e,this._renewExpireTimeout(t),this.connection&&this.connection.logItem.refDetached(t)})}updateRoomMember(e){this.member=e,this.options.emitUpdate(this)}handleDeviceMessage(e,t){this.errorBoundary.try(()=>{var s;t.wrap({l:"Member.handleDeviceMessage",type:e.type,seq:(s=e.content)==null?void 0:s.seq},i=>{const{connection:r}=this;if(r){const o=e.content.dest_session_id;if(o!==this.options.sessionId){const h=r.logItem.log({l:"ignoring to_device event with wrong session_id",destSessionId:o,type:e.type});i.refDetached(h);return}if(r.peerCall&&r.peerCall.getMessageAction(e)===oi.InviteGlare){const{shouldReplace:l,log:d}=r.peerCall.handleInviteGlare(e,this.deviceId,r.logItem);d&&d.refDetached(d),l&&(r.peerCall.dispose(),r.peerCall=void 0)}e.type===S.Invite&&!r.peerCall&&(r.peerCall=this._createPeerCall(e.content.call_id));const a=Te(r.queuedSignallingMessages,e,(h,l)=>h.content.seq-l.content.seq);r.queuedSignallingMessages.splice(a,0,e);let c=!1;r.peerCall&&(c=this.dequeueSignallingMessages(r,r.peerCall,e,i)),c||i.refDetached(r.logItem.log({l:"queued message",type:e.type,seq:e.content.seq,idx:a}))}else t.log({l:"member not connected",userId:this.userId,deviceId:this.deviceId})})})}dequeueSignallingMessages(e,t,s,i){let r=!1;for(;e.canDequeueNextSignallingMessage;){const o=e.queuedSignallingMessages.shift(),a=o===s;r=r||a,i.wrap(a?"process message":"dequeue message",c=>{var d;const h=(d=o.content)==null?void 0:d.seq;if(c.set("seq",h),c.set("type",o.type),t.getMessageAction(o)===oi.Handle){const u=t.handleIncomingSignallingMessage(o,this.deviceId,e.logItem);c.refDetached(u),e.lastProcessedSeqNr=h}else c.set("ignored",!0),e.lastIgnoredSeqNr=h})}return r}async setMedia(e,t){return this.errorBoundary.try(async()=>{var i;const{connection:s}=this;s&&(s.localMedia=e.replaceClone(s.localMedia,t),await((i=s.peerCall)==null?void 0:i.setMedia(s.localMedia,s.logItem)))})}async setMuted(e){return this.errorBoundary.try(async()=>{var s;const{connection:t}=this;t&&(t.localMuteSettings=e,await((s=t.peerCall)==null?void 0:s.setMuted(e,t.logItem)))})}_createPeerCall(e){const t=this.connection;return new cd(e,Object.assign({},this.options,{errorBoundary:this.errorBoundary,emitUpdate:this.emitUpdateFromPeerCall,sendSignallingMessage:this.sendSignallingMessage,turnServer:t.turnServer}),t.logItem)}dispose(){var e,t;(e=this.connection)==null||e.dispose(),this.connection=void 0,(t=this.expireTimeout)==null||t.dispose(),this.expireTimeout=void 0,this.options.emitUpdate=()=>{}}}function Ns(n){const e=n.expires_ts;if(Number.isSafeInteger(e))return e}function ai(n,e,t=0){const s=Ns(n);return typeof s=="number"?s+t<=e:!0}function ut(n,e){return JSON.stringify(n)+","+JSON.stringify(e)}function mr(n,e){return n.startsWith(JSON.stringify(e)+",")}function md(n){return JSON.parse(`[${n}]`)[1]}class pd{constructor(e,t,s,i,r,o){this.logItem=e,this.membersLogItem=t,this.localMedia=s,this.localPreviewMedia=i,this.localMuteSettings=r,this.turnServer=o}dispose(){var e;this.localMedia.dispose(),this.localPreviewMedia.dispose(),this.logItem.finish(),(e=this.renewMembershipTimeout)==null||e.dispose()}}class Ws extends Fe{constructor(e,t,s,i,r,o,a){super(),this.id=e,this.isLoadedFromStorage=t,this.startTime=i,this.callContent=r,this.roomId=o,this.options=a,this._members=new Ae,this.bufferedDeviceMessages=new Map,this.errorBoundary=new jn(c=>{this.emitChange(),this.joinedData&&(this.joinedData.logItem.log("error at boundary").catch(c),console.error(c))}),this._state=s?"fledgling":"created",this._memberOptions=Object.assign({},a,{confId:this.id,emitUpdate:c=>{var l;const h=ut(c.userId,c.deviceId);if(c.isExpired&&!c.isConnected){const d=this.options.logger.log({l:"removing expired member from call",memberKey:h,callId:this.id});(l=c.logItem)==null||l.refDetached(d),c.dispose(),this._members.remove(h)}else this._members.update(h)},encryptDeviceMessage:(c,h,l,d)=>this.options.encryptDeviceMessage(this.roomId,c,h,l,d)})}get localMedia(){var e;return(e=this.joinedData)==null?void 0:e.localMedia}get localPreviewMedia(){var e;return(e=this.joinedData)==null?void 0:e.localPreviewMedia}get members(){return this._members}get isTerminated(){var e;return!!((e=this.callContent)!=null&&e["m.terminated"])}get usesFoci(){for(const e of this._members.values())if(e.usesFoci)return!0;return!1}get duration(){if(typeof this.startTime=="number")return this.options.clock.now()-this.startTime}get isRinging(){return this._state==="created"&&this.intent==="m.ring"&&!this.isMember(this.options.ownUserId)}get name(){var e;return(e=this.callContent)==null?void 0:e["m.name"]}get intent(){var e;return(e=this.callContent)==null?void 0:e["m.intent"]}get type(){var e;return(e=this.callContent)==null?void 0:e["m.type"]}get logItem(){var e;return(e=this.joinedData)==null?void 0:e.logItem}get error(){return this.errorBoundary.error}join(e,t){return this.options.logger.wrapOrRun(t,"Call.join",async s=>{if(this._state!=="created"||this.joinedData||this.usesFoci){e.dispose();return}const i=this.options.logger.child({l:"Call.connection",t:Ye,id:this.id,ownSessionId:this.options.sessionId}),r=await this.options.turnServerSource.getSettings(i),o=i.child("member connections"),a=new bt;a.updateTrackInfo(e.userMedia);const c=e.asPreview(),h=new pd(i,o,e,c,a,r);this.joinedData=h,await h.logItem.wrap("join",async l=>{s.refDetached(l),this._state="joining",this.emitChange(),await l.wrap("update member state",async d=>{const u=await this._createMemberPayload(!0);d.set("payload",u),await this.options.hsApi.sendState(this.roomId,S.GroupCallMember,this.options.ownUserId,u,{log:d}).response(),this.emitChange()});for(const d of this._members.values())this.connectToMember(d,h,l)})})}async setMedia(e){var t;if((this._state==="joining"||this._state==="joined")&&this.joinedData){const s=this.joinedData.localMedia;this.joinedData.localMedia=e,(t=this.joinedData.localPreviewMedia)==null||t.dispose(),this.joinedData.localPreviewMedia=e.asPreview(),this.joinedData.localMuteSettings.updateTrackInfo(e.userMedia),this.emitChange(),await Promise.all(Array.from(this._members.values()).map(i=>i.setMedia(e,s))),s==null||s.dispose()}}async setMuted(e){const{joinedData:t}=this;if(!t)return;const s=t.localMuteSettings;e.updateTrackInfo(t.localMedia.userMedia),t.localMuteSettings=e,s.equals(e)||(this.localPreviewMedia&&ni(this.localPreviewMedia,e,this.joinedData.logItem),this.localMedia&&ni(this.localMedia,e,this.joinedData.logItem),await Promise.all(Array.from(this._members.values()).map(i=>i.setMuted(t.localMuteSettings))),this.emitChange())}get muteSettings(){var e;return(e=this.joinedData)==null?void 0:e.localMuteSettings}get hasJoined(){return this._state==="joining"||this._state==="joined"}async leave(e){await this.options.logger.wrapOrRun(e,"Call.leave",async t=>{var i;const{joinedData:s}=this;if(!!s)try{(i=s.renewMembershipTimeout)==null||i.dispose(),s.renewMembershipTimeout=void 0;const r=await this._createMemberPayload(!1);r?(await this.options.hsApi.sendState(this.roomId,S.GroupCallMember,this.options.ownUserId,r,{log:t}).response(),(this.intent===Qt.Ring||this.intent===Qt.Prompt)&&this._members.size===0&&await this.terminate(t)):t.set("already_left",!0)}finally{if(!this.disconnect(t))throw this.errorBoundary.error}})}terminate(e){return this.options.logger.wrapOrRun(e,{l:"terminate call",t:Ye},async t=>{if(this._state==="fledgling")return;await this.options.hsApi.sendState(this.roomId,S.GroupCall,this.id,Object.assign({},this.callContent,{"m.terminated":!0}),{log:t}).response()})}create(e,t){return t.wrap({l:"create call",t:Ye},async s=>{if(this._state!=="fledgling")return;this._state="creating",this.emitChange(),this.callContent=Object.assign({"m.type":e},this.callContent),await this.options.hsApi.sendState(this.roomId,S.GroupCall,this.id,this.callContent,{log:s}).response(),this._state="created",this.emitChange()})}updateCallEvent(e,t){this.errorBoundary.try(()=>{t.wrap({l:"update call",t:Ye,id:this.id},s=>{typeof this.startTime!="number"&&(this.startTime=e.origin_server_ts),this.callContent=e.content,this._state==="creating"&&(this._state="created"),s.set("status",this._state),this.emitChange()})})}updateRoomMembers(e){this.errorBoundary.try(()=>{for(const t of e.values()){const{member:s}=t;for(const i of this._members.values())i.userId===s.userId&&i.updateRoomMember(s)}})}updateMembership(e,t,s,i){this.errorBoundary.try(async()=>{await i.wrap({l:"update call membership",t:Ye,id:this.id,userId:e},async r=>{const o=this.options.clock.now(),a=s["m.devices"],c=this.getDeviceIdsForUserId(e);for(const l of a){const d=l.device_id,u=ut(e,d);e===this.options.ownUserId&&d===this.options.ownDeviceId?r.wrap("update own membership",p=>{this.hasJoined&&(this.joinedData&&this.joinedData.logItem.refDetached(p),this._setupRenewMembershipTimeout(l,p)),this._state==="joining"&&(p.set("joined",!0),this._state="joined",this.emitChange())}):await r.wrap({l:"update device membership",id:u,sessionId:l.session_id},async p=>{if(ai(l,o)){p.set("expired",!0);const y=this._members.get(u);y?(y.dispose(),this._members.remove(u),p.set("removed",!0)):p.discard();return}let m=this._members.get(u);const _=m&&m.sessionId!==l.session_id;if(m&&!_)p.set("update",!0),m.updateCallInfo(l,p);else{if(m&&_){p.set("removedSessionId",m.sessionId);const y=await m.disconnect(!1);y&&p.refDetached(y),m.dispose(),this._members.remove(u),m=void 0}p.set("add",!0),m=new ud(t,l,this._memberOptions,p),this._members.add(u,m),this.joinedData&&this.connectToMember(m,this.joinedData,p)}this.flushPendingIncomingDeviceMessages(m,p)})}const h=new Set(a.map(l=>l.device_id));for(const l of c)h.has(l)||this.removeMemberDevice(e,l,r);e===this.options.ownUserId&&!h.has(this.options.ownDeviceId)&&this.removeOwnDevice(r)})})}removeMembership(e,t){this.errorBoundary.try(()=>{const s=this.getDeviceIdsForUserId(e);t.wrap({l:"remove call member",t:Ye,id:this.id,userId:e},i=>{for(const r of s)this.removeMemberDevice(e,r,i);e===this.options.ownUserId&&this.removeOwnDevice(i)})})}flushPendingIncomingDeviceMessages(e,t){const s=ut(e.userId,e.deviceId),i=this.bufferedDeviceMessages.get(s);if(i){for(const r of i)r.content.sender_session_id===e.sessionId&&(e.handleDeviceMessage(r,t),i.delete(r));i.size===0&&this.bufferedDeviceMessages.delete(s)}}getDeviceIdsForUserId(e){return Array.from(this._members.keys()).filter(t=>mr(t,e)).map(t=>md(t))}isMember(e){return Array.from(this._members.keys()).some(t=>mr(t,e))}removeOwnDevice(e){e.wrap("remove own membership",t=>{this.disconnect(t)})}disconnect(e){return this.errorBoundary.try(async()=>{var t;if(this.hasJoined){for(const s of this._members.values()){const i=await s.disconnect(!0);i&&e.refDetached(i)}this._state="created"}(t=this.joinedData)==null||t.dispose(),this.joinedData=void 0,this.emitChange()},!1)||!0}async removeMemberDevice(e,t,s){const i=ut(e,t);await s.wrap({l:"remove device member",id:i},async r=>{const o=this._members.get(i);if(o){r.set("leave",!0);const a=await o.disconnect(!1);a&&r.refDetached(a),o.dispose(),this._members.remove(i)}})}handleDeviceMessage(e,t,s,i){this.errorBoundary.try(()=>{const r=ut(t,s);let o=this._members.get(r);if(o&&e.content.sender_session_id===o.sessionId)o.handleDeviceMessage(e,i);else{i.log({l:"call: buffering to_device message, member not found",t:Ye,id:this.id,userId:t,deviceId:s,sessionId:e.content.sender_session_id,type:e.type});let a=this.bufferedDeviceMessages.get(r);a||(a=new Set,this.bufferedDeviceMessages.set(r,a)),a.add(e)}})}async _createMemberPayload(e){var h,l;const{storage:t}=this.options,i=await(await t.readTxn([t.storeNames.roomState])).roomState.get(this.roomId,S.GroupCallMember,this.options.ownUserId),r=(l=(h=i==null?void 0:i.event)==null?void 0:h.content)!=null?l:{["m.calls"]:[]};let o=r["m.calls"],a=o.find(d=>d["m.call_id"]===this.id);a||(a={["m.call_id"]:this.id,["m.devices"]:[]},o.push(a));const c=this.options.clock.now();return a["m.devices"]=a["m.devices"].filter(d=>!(d.device_id===this.options.ownDeviceId||Ns(d)===void 0||ai(d,c,Hs))),e&&a["m.devices"].push({device_id:this.options.ownDeviceId,session_id:this.options.sessionId,expires_ts:c+Hs,feeds:[{purpose:"m.usermedia"}]}),r["m.calls"]=o.filter(d=>d["m.devices"].length!==0),r}async connectToMember(e,t,s){const i=ut(e.userId,e.deviceId),r=t.membersLogItem.child({l:"member",id:i,sessionId:e.sessionId});await s.wrap({l:"connect",id:i},async o=>{const a=await e.connect(t.localMedia,t.localMuteSettings,t.turnServer,r);a&&o.refDetached(a)})}emitChange(){this.emit("change"),this.options.emitUpdate(this)}_setupRenewMembershipTimeout(e,t){var c;const{joinedData:s}=this;if(!s)return;(c=s.renewMembershipTimeout)==null||c.dispose(),s.renewMembershipTimeout=void 0;const i=Ns(e);if(typeof i!="number")return;const r=i-this.options.clock.now(),o=Math.max(1e4,Math.ceil((.2+this.options.random()*.8)*(.08333*Hs))),a=Math.max(0,r-o);t.set("expiresIn",r),t.set("renewIn",a),s.renewMembershipTimeout=this.options.clock.createTimeout(a),s.renewMembershipTimeout.elapsed().then(()=>{s.logItem.wrap("renew membership",async h=>{const l=await this._createMemberPayload(!0);h.set("payload",l),await this.options.hsApi.sendState(this.roomId,S.GroupCallMember,this.options.ownUserId,l,{log:h}).response()})},()=>{})}dispose(){var e;(e=this.joinedData)==null||e.dispose();for(const t of this._members.values())t.dispose()}}const pr=5*60,_d={urls:["stun:turn.matrix.org"],username:"",credential:""};class gd{constructor(e,t,s=_d){this.hsApi=e,this.clock=t,this.defaultSettings=s,this.isPolling=!1}getSettings(e){return e.wrap("get turn server",async t=>{if(!this.isPolling){const s=await this.doRequest(t),i=s?_r(s):this.defaultSettings;t.set("iceServer",i),this.currentObservable?this.currentObservable.set(i):this.currentObservable=new Wt(i,()=>{this.stopPollLoop()},()=>{var r;this.runLoop((r=s==null?void 0:s.ttl)!=null?r:pr)})}return this.currentObservable})}async runLoop(e){let t=e;for(this.isPolling=!0;this.isPolling;)try{this.pollTimeout=this.clock.createTimeout(t*1e3),await this.pollTimeout.elapsed(),this.pollTimeout=void 0;const s=await this.doRequest(void 0);if(s){const i=_r(s);fd(this.currentObservable,i)&&this.currentObservable.set(i),s.ttl>0?t=s.ttl:this.stopPollLoop()}else t=pr}catch(s){s.name}}async doRequest(e){try{return this.pollRequest=this.hsApi.getTurnServer({log:e}),await this.pollRequest.response()}catch(t){if(t.name==="HomeServerError")return;throw t}finally{this.pollRequest=void 0}}stopPollLoop(){var e,t;this.isPolling=!1,this.currentObservable=void 0,(e=this.pollTimeout)==null||e.dispose(),this.pollTimeout=void 0,(t=this.pollRequest)==null||t.abort(),this.pollRequest=void 0}dispose(){this.stopPollLoop()}}function fd(n,e){const t=n.get();if(!t)return!0;const s=Array.isArray(t.urls)?t.urls:[t.urls],i=Array.isArray(e.urls)?e.urls:[e.urls];return!(s.length===i.length&&!i.some(o=>!s.includes(o)))||e.username!==t.username||e.credential!==t.credential}function _r(n){return{urls:n.uris,username:n.username,credential:n.password,credentialType:"password"}}function yd(n,e){return JSON.stringify(n)+","+JSON.stringify(e)}class wd{constructor(e){this.options=e,this._calls=new Ae,this.roomMemberToCallIds=new Map,this.sessionId=Ts("s"),this.groupCallOptions=Object.assign({},this.options,{turnServerSource:new gd(this.options.hsApi,this.options.clock),emitUpdate:(t,s)=>this._calls.update(t.id,s),createTimeout:this.options.clock.createTimeout,sessionId:this.sessionId})}loadCalls(e,t){return this.options.logger.wrapOrRun(t,"CallHandler.loadCalls",async s=>{e||(e=Qt.Ring),s.set("intent",e);const i=await this._getLoadTxn(),r=await i.calls.getByIntent(e);await this._loadCallEntries(r,i,s)})}loadCallsForRoom(e,t,s){return this.options.logger.wrapOrRun(s,"CallHandler.loadCallsForRoom",async i=>{i.set("intent",e),i.set("roomId",t);const r=await this._getLoadTxn(),o=await r.calls.getByIntentAndRoom(e,t);await this._loadCallEntries(o,r,i)})}async _getLoadTxn(){const e=this.options.storage.storeNames;return await this.options.storage.readTxn([e.calls,e.roomState])}async _loadCallEntries(e,t,s){s.set("entries",e.length),await Promise.all(e.map(async r=>{if(this._calls.get(r.callId))return;const o=await t.roomState.get(r.roomId,S.GroupCall,r.callId);if(o){const a=new Ws(o.event.state_key,!0,!1,r.timestamp,o.event.content,o.roomId,this.groupCallOptions);this._calls.set(a.id,a)}}));const i=Array.from(new Set(e.map(r=>r.roomId)));await Promise.all(i.map(async r=>{const o=await t.roomState.getAllForType(r,S.GroupCallMember);await Promise.all(o.map(async a=>{const c=a.event.sender,h=await t.roomState.get(r,ee,c);let l;h&&(l=R.fromMemberEvent(h.event)),l||(l=R.fromUserId(r,c,"join")),this.handleCallMemberEvent(a.event,l,r,s)}))})),s.set("newSize",this._calls.size)}createCall(e,t,s,i,r){return this.options.logger.wrapOrRun(r,"CallHandler.createCall",async o=>{i||(i=Qt.Ring);const a=new Ws(Ts("conf-"),!1,!0,void 0,{"m.name":s,"m.intent":i},e,this.groupCallOptions);this._calls.set(a.id,a);try{await a.create(t,o);const c=await this.options.storage.readWriteTxn([this.options.storage.storeNames.calls]);c.calls.add({intent:a.intent,callId:a.id,timestamp:this.options.clock.now(),roomId:e}),await c.complete()}catch(c){throw this._calls.remove(a.id),c}return a})}get calls(){return this._calls}async handleRoomState(e,t,s,i,r){if(t.type===S.GroupCall&&this.handleCallEvent(t,e.id,i,r),t.type===S.GroupCallMember){let o=await s.lookupMemberAtEvent(t.sender,t,i);o||(o=R.fromUserId(e.id,t.sender,"join")),this.handleCallMemberEvent(t,o,e.id,r)}}updateRoomMembers(e,t){for(const s of this._calls.values())s.roomId===e.id&&s.updateRoomMembers(t)}handlesDeviceMessageEventType(e){return hd(e)}handleDeviceMessage(e,t,s,i){const r=this._calls.get(e.content.conf_id);r==null||r.handleDeviceMessage(e,t,s,i)}handleCallEvent(e,t,s,i){const r=e.state_key;let o=this._calls.get(r);o?(o.updateCallEvent(e,i),o.isTerminated&&(o.disconnect(i),this._calls.remove(o.id),s.calls.remove(o.intent,t,o.id))):e.content["m.terminated"]||(o=new Ws(e.state_key,!1,!1,e.origin_server_ts,e.content,t,this.groupCallOptions),this._calls.set(o.id,o),s.calls.add({intent:o.intent,callId:o.id,timestamp:e.origin_server_ts,roomId:t}))}handleCallMemberEvent(e,t,s,i){var l;const r=e.state_key,o=yd(s,r),a=(l=e.content["m.calls"])!=null?l:[];for(const d of a){const u=d["m.call_id"],p=this._calls.get(u);p==null||p.updateMembership(r,t,d,i)}const c=new Set(a.map(d=>d["m.call_id"]));let h=this.roomMemberToCallIds.get(o);if(h){for(const d of h)if(!c.has(d)){const u=this._calls.get(d);u==null||u.removeMembership(r,i)}}c.size===0?this.roomMemberToCallIds.delete(o):this.roomMemberToCallIds.set(o,c)}dispose(){this.groupCallOptions.turnServerSource.dispose();for(const e of this._calls.values())e.dispose()}}class vd extends Us{async handleRoomState(e,t,s,i,r){const o=[];for(let a of this._handlers)o.push(a.handleRoomState(e,t,s,i,r));await Promise.all(o)}updateRoomMembers(e,t){for(let s of this._handlers)s.updateRoomMembers(e,t)}}var ci=(n=>(n[n.Calls=1]="Calls",n[n.CrossSigning=2]="CrossSigning",n))(ci||{});class ft{constructor(e=0){this.flags=e}withFeature(e){return new ft(this.flags|e)}withoutFeature(e){return new ft(this.flags^e)}isFeatureEnabled(e){return(this.flags&e)!==0}get calls(){return this.isFeatureEnabled(1)}get crossSigning(){return this.isFeatureEnabled(2)}static async load(e){const t=await e.getInt("enabled_features")||0;return new ft(t)}async store(e){await e.setInt("enabled_features",this.flags)}}const Qe="DEFAULT_KEY",Ut="pusher";class bd{constructor({storage:e,hsApi:t,sessionInfo:s,olm:i,olmWorker:r,platform:o,mediaRepository:a,features:c}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._features=c,this._syncInfo=null,this._sessionInfo=s,this._rooms=new Ae,this._roomUpdateCallback=(h,l)=>this._rooms.update(h.id,l),this._activeArchivedRooms=new Map,this._invites=new Ae,this._inviteUpdateCallback=(h,l)=>this._invites.update(h.id,l),this._roomsBeingCreatedUpdateCallback=(h,l)=>{h.isCancelled?this._roomsBeingCreated.remove(h.id):this._roomsBeingCreated.update(h.id,l)},this._roomsBeingCreated=new Ae,this._user=new Dh(s.userId),this._roomStateHandler=new vd,c.calls&&this._setupCallHandler(),this._deviceMessageHandler=new hl({storage:e,callHandler:this._callHandler}),this._olm=i,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._keyLoader=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=r,this._keyBackup=new Ee(void 0),this._crossSigning=new Ee(void 0),this._observedRoomStatus=new Map,i&&(this._olmUtil=new i.Utility,this._deviceTracker=new Zc({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:s.userId,ownDeviceId:s.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsKeyBackup=new Ee(!1),this._secretFetcher=new gl,this._secretSharing=null,this._secretStorage=null}get fingerprintKey(){var e;return(e=this._e2eeAccount)==null?void 0:e.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}get callHandler(){return this._callHandler}get features(){return this._features}_setupCallHandler(){this._callHandler=new wd({clock:this._platform.clock,random:this._platform.random,hsApi:this._hsApi,encryptDeviceMessage:async(e,t,s,i,r)=>{if(!this._deviceTracker||!this._olmEncryption){r.set("encryption_disabled",!0);return}const o=await r.wrap("get device key",async a=>{const c=this._deviceTracker.deviceForId(t,s,this._hsApi,a);return c||a.set("not_found",!0),c});if(o)return await this._olmEncryption.encrypt(i.type,i.content,[o],this._hsApi,r)},storage:this._storage,webRTC:this._platform.webRTC,ownDeviceId:this._sessionInfo.deviceId,ownUserId:this._sessionInfo.userId,logger:this._platform.logger,forceTURN:!1}),this.observeRoomState(this._callHandler)}async _setupEncryption(){const e=new od,t=new Al(this._e2eeAccount,Qe,this._platform.clock.now,this._user.id,this._olm,e);this._olmEncryption=new Dl(this._e2eeAccount,Qe,this._olm,this._storage,this._platform.clock.now,this._user.id,this._olmUtil,e),this._keyLoader=new zl(this._olm,Qe,20),this._megolmEncryption=new ed({account:this._e2eeAccount,pickleKey:Qe,olm:this._olm,storage:this._storage,keyLoader:this._keyLoader,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId}),this._megolmDecryption=new Gl(this._keyLoader,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption}),this._secretSharing=new fl({hsApi:this._hsApi,storage:this._storage,deviceMessageHandler:this._deviceMessageHandler,deviceTracker:this._deviceTracker,ourUserId:this.userId,olmEncryption:this._olmEncryption,crypto:this._platform.crypto,encoding:this._platform.encoding,crossSigning:this._crossSigning,logger:this._platform.logger}),await this._secretSharing.load(),this._secretFetcher.setSecretSharing(this._secretSharing)}_createRoomEncryption(e,t){var s;if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==ye?null:new id({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,keyBackup:(s=this._keyBackup)==null?void 0:s.get(),encryptionParams:t,notifyMissingMegolmSession:()=>{this._keyBackup.get()||this.needsKeyBackup.set(!0)},clock:this._platform.clock})}enableSecretStorage(e,t,s=void 0){return this._platform.logger.wrapOrRun(s,"enable secret storage",async i=>{var o,a;if(!this._olm)throw new Error("olm required");this._keyBackup.get()&&(this._keyBackup.get().dispose(),this._keyBackup.set(void 0));const r=await kl(e,t,this._storage,this._platform,this._olm);if(await this._tryLoadSecretStorage(r,i))return await this._writeSSSSKey(r,i),await((o=this._keyBackup.get())==null?void 0:o.start(i)),await((a=this._crossSigning.get())==null?void 0:a.start(i)),r;throw new Error("Could not read key backup with the given key")})}async _writeSSSSKey(e,t){const s=this._keyBackup.get();if(!s)return;const i=s.version,r=await this._storage.readWriteTxn([this._storage.storeNames.session,this._storage.storeNames.inboundGroupSessions]);try{const o=await bl(e,i,r);if(t.set("previousBackupVersion",o),t.set("backupVersion",i),!!o&&o!==i){const a=await s.markAllForBackup(r);t.set("amountMarkedForBackup",a)}}catch(o){throw r.abort(),o}await r.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{Il(e)}catch(s){throw e.abort(),s}if(await e.complete(),this._keyBackup.get()){for(const s of this._rooms.values())s.isEncrypted&&s.enableKeyBackup(void 0);this._keyBackup.get().dispose(),this._keyBackup.set(void 0)}const t=this._crossSigning.get();t&&(t.dispose(),this._crossSigning.set(void 0))}_tryLoadSecretStorage(e,t){return t.wrap("enable secret storage",async s=>{const i=new vl({key:e,platform:this._platform,storage:this._storage}),r=await i.hasValidKeyForAnyAccountData();return s.set("isValid",r),r&&(this._secretStorage=i,await this._loadSecretStorageServices(i,s),this._secretFetcher.setSecretStorage(i)),r})}async _loadSecretStorageServices(e,t){try{await t.wrap("enable key backup",async s=>{const i=new Zl(this._hsApi,this._olm,this._keyLoader,this._storage,this._platform);if(await i.load(e,s)){for(const r of this._rooms.values())r.isEncrypted&&r.enableKeyBackup(i);return this._keyBackup.set(i),!0}else s.set("no_backup",!0)})}catch(s){t.catch(s)}}get keyBackup(){return this._keyBackup}get crossSigning(){return this._crossSigning}get secretSharing(){return this._secretSharing}get secretFetcher(){return this._secretFetcher}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),await this._setupEncryption()),this._sessionInfo.isReadOnly||(await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t))),await this._createCrossSigning())}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await st.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:Qe,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return st.create({hsApi:this._hsApi,olm:this._olm,pickleKey:Qe,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async s=>{const i=await this._createNewAccount("temp-device-id");try{const r=await Rl(i,this._hsApi,e,"Dehydrated device",s);return s.set("deviceId",r),r}finally{i.dispose()}})}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents,this._storage.storeNames.accountData,this._storage.storeNames.crossSigningKeys]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await st.load({hsApi:this._hsApi,olm:this._olm,pickleKey:Qe,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption());const s=await this._getPendingEventsByRoom(t),i=await t.invites.getAll(),r=Promise.all(i.map(async c=>{const h=this.createInvite(c.roomId);e.wrap("invite",l=>h.load(c,l)),this._invites.add(h.id,h)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async c=>{const h=this.createJoinedRoom(c.roomId,s.get(c.roomId));await e.wrap("room",l=>h.load(c,t,l)),this._rooms.add(h.id,h)}));await Promise.all([r,a]);for(const[c,h]of this.invites){const l=this.rooms.get(c);l&&l.setInvite(h)}if(this._olm&&this._e2eeAccount){const c=await Sl(t);c&&await this._tryLoadSecretStorage(c,e)}this._e2eeAccount&&await this._createCrossSigning()}async _createCrossSigning(){this._features.crossSigning&&this._platform.logger.run("enable cross-signing",async e=>{const t=new zc({storage:this._storage,secretFetcher:this._secretFetcher,platform:this._platform,olm:this._olm,olmUtil:this._olmUtil,deviceTracker:this._deviceTracker,deviceMessageHandler:this._deviceMessageHandler,hsApi:this._hsApi,ownUserId:this.userId,e2eeAccount:this._e2eeAccount,deviceId:this.deviceId});await t.load(e),this._crossSigning.set(t)})}dispose(){var e,t,s,i,r,o;(e=this._olmWorker)==null||e.dispose(),this._olmWorker=void 0,(t=this._keyBackup.get())==null||t.dispose(),this._keyBackup.set(void 0),(s=this._megolmDecryption)==null||s.dispose(),this._megolmDecryption=void 0,(i=this._e2eeAccount)==null||i.dispose(),this._e2eeAccount=void 0,(r=this._callHandler)==null||r.dispose(),this._callHandler=void 0,(o=this._crossSigning.get())==null||o.dispose();for(const a of this._rooms.values())a.dispose();this._rooms=void 0}async start(e,t,s){var a,c;if(e){const h=await this._storage.readWriteTxn([this._storage.storeNames.session]);h.session.set("serverVersions",e),await h.complete()}t&&await s.wrap("SSSSKeyFromDehydratedDeviceKey",async h=>{const l=await Ml(t.key,this._storage,this._platform);l&&await this._tryLoadSecretStorage(l,h)&&(h.set("success",!0),await this._writeSSSSKey(l))}),await((a=this._keyBackup.get())==null?void 0:a.start(s)),await((c=this._crossSigning.get())==null?void 0:c.start(s));const r=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),o=vt(r,h=>h.scope);for(const h of this._rooms.values()){let l;const d=o.get(h.id);d&&(l=vt(d,u=>u.type)),h.start(l,s)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((s,i)=>{const r=s.get(i.roomId);return r?r.push(i):s.set(i.roomId,[i]),s},new Map)}get rooms(){return this._rooms}findDirectMessageForUserId(e){for(const[,t]of this._rooms)if(t.isDirectMessageForUserId(e))return t;for(const[,t]of this._invites)if(t.isDirectMessageForUserId(e))return t}createJoinedRoom(e,t){return new Zh({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform,roomStateHandler:this._roomStateHandler})}_createArchivedRoom(e){const t=new el({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new cl({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}get roomsBeingCreated(){return this._roomsBeingCreated}async createRoom(e){let t;return await this._platform.logger.run("create room",async s=>{const i=`local-${Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER)}`;t=new al(i,e,this._roomsBeingCreatedUpdateCallback,this._mediaRepository,this._platform,s),this._roomsBeingCreated.set(i,t);const r=[t.create(this._hsApi,s)];e.loadProfiles!==!1&&r.push(t.loadProfiles(this._hsApi,s)),await Promise.all(r),t.roomId&&(this.rooms.get(t.roomId)&&this._tryReplaceRoomBeingCreated(t.roomId,s),await t.adjustDirectMessageMapIfNeeded(this._user,this._storage,this._hsApi,s))}),t}async obtainSyncLock(e){var s;const t=(s=e.to_device)==null?void 0:s.events;if(Array.isArray(t)&&t.length)return await this._deviceMessageHandler.obtainSyncLock(t)}async prepareSync(e,t,s,i){var o;const r=(o=e.to_device)==null?void 0:o.events;if(Array.isArray(r)&&r.length)return await i.wrap("deviceMsgs",a=>this._deviceMessageHandler.prepareSync(r,t,s,a))}async writeSync(e,t,s,i,r){const o={syncInfo:null,e2eeAccountChanges:null,hasNewRoomKeys:!1,deviceMessageDecryptionResults:null,changedDevices:null},a=e.next_batch;if(a!==this.syncToken){const d={token:a,filterId:t};i.session.set("sync",d),o.syncInfo=d}const c=e.device_one_time_keys_count;this._e2eeAccount&&c&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(c,i,r));const h=e.device_lists;if(this._deviceTracker&&Array.isArray(h==null?void 0:h.changed)&&h.changed.length&&(await r.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(h.changed,i,d)),o.changedDevices=h.changed),s){const{hasNewRoomKeys:d,decryptionResults:u}=await r.wrap("deviceMsgs",p=>this._deviceMessageHandler.writeSync(s,i,p));o.hasNewRoomKeys=d,o.deviceMessageDecryptionResults=u}const l=e.account_data;if(Array.isArray(l==null?void 0:l.events))for(const d of l.events)typeof d.type=="string"&&i.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,s){var i,r,o;this._e2eeAccount&&!t&&!this._sessionInfo.isReadOnly&&await this._e2eeAccount.generateOTKsIfNeeded(this._storage,s)&&await s.wrap("uploadKeys",c=>this._e2eeAccount.uploadKeys(this._storage,!1,c)),e.hasNewRoomKeys&&((i=this._keyBackup.get())==null||i.flush(s)),e.deviceMessageDecryptionResults&&await this._deviceMessageHandler.afterSyncCompleted(e.deviceMessageDecryptionResults,this._deviceTracker,this._hsApi,s),(r=e.changedDevices)!=null&&r.includes(this.userId)&&((o=this._secretSharing)==null||o.checkSecretValidity())}_tryReplaceRoomBeingCreated(e,t){for(const[,s]of this._roomsBeingCreated)if(s.roomId===e){const i=this._observedRoomStatus.get(s.id);i&&(t.log("replacing room being created").set("localId",s.id).set("roomId",s.roomId),i.set(i.get()|V.Replaced)),s.dispose(),this._roomsBeingCreated.remove(s.id);return}}async applyRoomCollectionChangesAfterSync(e,t,s,i){var r,o;for(const a of t)a.shouldAdd?(this._rooms.add(a.id,a.room),this._tryReplaceRoomBeingCreated(a.id,i)):a.shouldRemove&&this._rooms.remove(a.id);for(const a of e)a.shouldAdd?this._invites.add(a.id,a.invite):a.shouldRemove&&this._invites.remove(a.id);if(this._observedRoomStatus.size!==0){for(const a of s)a.shouldAdd&&((r=this._observedRoomStatus.get(a.id))==null||r.set(V.Archived));for(const a of t)a.shouldAdd&&((o=this._observedRoomStatus.get(a.id))==null||o.set(V.Joined));for(const a of e){const c=this._observedRoomStatus.get(a.id);if(c){const h=c.get()|V.Invited;if(a.shouldAdd)c.set(h);else if(a.shouldRemove){const l=h^V.Invited;c.set(l)}}}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set((t.get()|V.Archived)^V.Archived)}get syncToken(){var e;return(e=this._syncInfo)==null?void 0:e.token}get syncFilterId(){var e;return(e=this._syncInfo)==null?void 0:e.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{const t=Ze.createDefaultPayload(this._sessionInfo.id),s=await this._platform.notificationService.enablePush(Ze,t);if(!s)return e.set("no_pusher",!0),!1;await s.enable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.set(Ut,s.serialize()),await i.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();const s=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Ut);if(!s)return!0;await new Ze(s).disable(this._hsApi,e);const r=await this._storage.readWriteTxn([this._storage.storeNames.session]);return r.session.remove(Ut),await r.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Ut):!1}async checkPusherEnabledOnHomeserver(){const t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(Ut);if(!t)return!1;const s=new Ze(t),i=await this._hsApi.getPushers().response();return((i==null?void 0:i.pushers)||[]).map(o=>new Ze(o)).some(o=>o.equals(s))}async getRoomStatus(e){if(!!this._roomsBeingCreated.get(e))return V.BeingCreated;if(!!this._rooms.get(e))return V.Joined;{const i=!!this._invites.get(e),o=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return i&&o?V.Invited|V.Archived:i?V.Invited:o?V.Archived:V.None}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){let s;t=new Wt(s,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t),s=await this.getRoomStatus(e),t.get()===void 0&&t.set(s)}return t}observeRoomState(e){return this._roomStateHandler.subscribe(e)}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async s=>{s.set("id",e);const i=this._activeArchivedRooms.get(e);if(i)return i.retain(),i;const r=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await r.archivedRoomSummary.get(e);if(o){const a=this._createArchivedRoom(e);return await a.load(o,r,s),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async s=>(await this._hsApi.joinIdOrAlias(e,{log:s}).response()).room_id)}updateAccessToken(e){this._hsApi.updateAccessToken(e)}}class Sd{constructor({username:e,password:t,homeserver:s}){this._username=e,this._password=t,this.homeserver=s}async login(e,t,s){return await e.passwordLogin(this._username,this._password,t,{log:s}).response()}}class Id{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,s){return await e.tokenLogin(this._loginToken,Q(),t,{log:s}).response()}}class kd{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${encodeURIComponent(e)}`}}class Ai{constructor(e,t){this._session=e,this._params=t}setNextStage(e){this._nextStage=e}get nextStage(){return this._nextStage}}class Md extends Ai{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.dummy"}}class Cd extends Ai{generateAuthenticationData(){return{session:this._session,type:this.type}}get type(){return"m.login.terms"}get privacyPolicy(){var e;return(e=this._params)==null?void 0:e.policies.privacy_policy}get termsOfService(){var e;return(e=this._params)==null?void 0:e.policies.terms_of_service}}class Rd extends Ai{constructor(e,t,s){super(e,t),this._type=s}generateAuthenticationData(){if(!this._token)throw new Error("No token provided for TokenAuth");return{session:this._session,type:this._type,token:this._token}}setToken(e){this._token=e}get type(){return this._type}}class Ed{constructor(e,t,s,i){this.homeserver=e,this._hsApi=t,this._accountDetails=s,this._flowSelector=i!=null?i:r=>r[0]}async start(){const e=await this._hsApi.register(this._accountDetails.username,this._accountDetails.password,this._accountDetails.initialDeviceDisplayName,void 0,this._accountDetails.inhibitLogin).response();return this.parseStagesFromResponse(e)}async submitStage(e){const t=e.generateAuthenticationData(),{username:s,password:i,initialDeviceDisplayName:r,inhibitLogin:o}=this._accountDetails,a=this._hsApi.register(s,i,r,t,o),c=await a.response(),h=await a.responseCode(),l={...c,status:h};return this.parseRegistrationResponse(l,e)}parseStagesFromResponse(e){const{session:t,params:s}=e,i=this._flowSelector(e.flows);if(!i)throw new Error("flowSelector did not return any flow!");let r,o;for(const a of i.stages){const c=this._createRegistrationStage(a,t,s);r?(o.setNextStage(c),o=c):(r=c,o=c)}return r}async parseRegistrationResponse(e,t){var s;switch(e.status){case 200:this._registerResponse=e;return;case 401:if((s=e.completed)!=null&&s.includes(t.type))return t.nextStage;throw new Error("This stage could not be completed!")}}_createRegistrationStage(e,t,s){switch(e){case"m.login.dummy":return new Md(t,s==null?void 0:s[e]);case"m.login.terms":return new Cd(t,s==null?void 0:s[e]);case"org.matrix.msc3231.login.registration_token":case"m.login.registration_token":return new Rd(t,s==null?void 0:s[e],e);default:throw new Error(`Unknown stage: ${e}`)}}get authData(){if(this._registerResponse)return{accessToken:this._registerResponse.access_token,homeserver:this.homeserver,userId:this._registerResponse.user_id,deviceId:this._registerResponse.device_id}}}const k=Mt("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),Ne=Mt("Connection","Credentials","Unknown");class Fs{constructor(e,t=new ft(0)){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new Ee(k.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=e.loadOlm(),this._workerPromise=e.loadOlmWorker(),this._accountSetup=void 0,this._features=t}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===k.NotLoading&&(this._status.set(k.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{const s=await this._platform.sessionInfoStorage.get(e);if(!s)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(s,null,t),t.set("status",this._status.get())}catch(s){t.catch(s),this._error=s,this._status.set(k.Error)}}))}_parseLoginOptions(e,t){const s=e.flows,i={homeserver:t};for(const r of s)r.type==="m.login.password"?i.password=(o,a)=>new Sd({homeserver:t,username:o,password:a}):r.type==="m.login.sso"&&s.find(o=>o.type==="m.login.token")?i.sso=new kd(t):r.type==="m.login.token"&&(i.token=o=>new Id({homeserver:t,loginToken:o}));return i}queryLogin(e){return new jr(async t=>{e=await xo(e,(r,o)=>t(this._platform.request(r,o)));const s=new Xe({homeserver:e,request:this._platform.request}),i=await t(s.getLoginFlows()).response();return this._parseLoginOptions(i,e)})}async startRegistration(e,t,s,i,r){const o=this._platform.request,a=new Xe({homeserver:e,request:o});return new Ed(e,a,{username:t,password:s,initialDeviceDisplayName:i},r)}async startWithAuthData({accessToken:e,deviceId:t,userId:s,homeserver:i,isReadOnly:r=!1}){await this._platform.logger.run("startWithAuthData",async o=>{r&&o.set("isReadonly (Disabled OTK Upload)",!0),await this._createSessionAfterAuth({accessToken:e,deviceId:t,userId:s,homeserver:i},!0,r,o)})}async startWithLogin(e,{inspectAccountSetup:t}={}){const s=this._status.get();s!==k.LoginFailed&&s!==k.NotLoading&&s!==k.Error||(this._resetStatus(),await this._platform.logger.run("login",async i=>{this._status.set(k.Login);let r;try{const o=this._platform.request,a=new Xe({homeserver:e.homeserver,request:o}),c=await e.login(a,"Hydrogen",i);r={deviceId:c.device_id,userId:c.user_id,homeserver:e.homeserver,accessToken:c.access_token}}catch(o){this._error=o,o.name==="HomeServerError"?(o.errcode==="M_FORBIDDEN"?this._loginFailure=Ne.Credentials:this._loginFailure=Ne.Unknown,i.set("loginFailure",this._loginFailure),this._status.set(k.LoginFailed)):o.name==="ConnectionError"?(this._loginFailure=Ne.Connection,this._status.set(k.LoginFailed)):this._status.set(k.Error);return}await this._createSessionAfterAuth(r,t,!1,i)}))}async _createSessionAfterAuth({deviceId:e,userId:t,accessToken:s,homeserver:i},r,o,a){const c=this.createNewSessionId(),h=this._platform.clock.now(),l={id:c,deviceId:e,userId:t,homeServer:i,homeserver:i,accessToken:s,lastUsed:h,isReadOnly:o};let d;r&&(d=await this._inspectAccountAfterLogin(l,a),d&&(l.deviceId=d.deviceId)),await this._platform.sessionInfoStorage.add(l);try{await this._loadSessionInfo(l,d,a),a.set("status",this._status.get())}catch(u){a.catch(u),d==null||d.dispose(),this._error=u,this._status.set(k.Error)}}async _loadSessionInfo(e,t,s){s.set("appVersion",this._platform.version);const i=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(k.Loading),this._reconnector=new la({onlineStatus:this._platform.onlineStatus,retryDelay:new Jr(i.createTimeout),createMeasure:i.createMeasure});const r=new Xe({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,s);const o={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer,isReadOnly:e.isReadOnly},a=await this._olmPromise;let c=null;this._workerPromise&&(c=await this._workerPromise),this._requestScheduler=new _a({hsApi:r,clock:i}),this._requestScheduler.start();const h=await r.versions({timeout:1e4,log:s}).response(),l=new ma({homeserver:e.homeServer,platform:this._platform,serverVersions:h.versions});if(this._platform.updateService.updateAuthData({accessToken:e.accessToken,homeserver:e.homeServer}),this._session=new bd({storage:this._storage,sessionInfo:o,hsApi:this._requestScheduler.hsApi,olm:a,olmWorker:c,mediaRepository:l,platform:this._platform,features:this._features}),await this._session.load(s),t?(await s.wrap("dehydrateIdentity",d=>this._session.dehydrateIdentity(t,d)),await this._session.setupDehydratedDevice(t.key,s)):this._session.hasIdentity||(this._status.set(k.SessionSetup),await s.wrap("createIdentity",d=>this._session.createIdentity(d))),this._sync=new ya({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(d=>{d===pt.Online&&this._platform.logger.runDetached("reconnect",async u=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const p=t;t=void 0,await u.wrap("session start",m=>this._session.start(this._reconnector.lastVersionsResponse,p,m))})}),await s.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(k.Ready),!this._sessionStartedByReconnector)){if(this._isDisposed)return;const d=t;t=void 0,await s.wrap("session start",u=>this._session.start(h,d,u))}}async updateAccessToken(e){if(!this._session)throw Error("No session loaded, cannot update access token");this._session.updateAccessToken(e),this._platform.updateService.updateAuthData({accessToken:e}),await this._platform.sessionInfoStorage.updateAccessToken(this._sessionId,e)}async _waitForFirstSync(){this._sync.start(),this._status.set(k.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>{var t;return e===A.Stopped?((t=this._sync.error)==null?void 0:t.name)!=="ConnectionError":e===A.Syncing});try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===A.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async s=>{var a;this._status.set(k.QueryAccount);const i=new Xe({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),r=await this._olmPromise;let o;try{o=await Cl(i,r,this._platform,s)}catch(c){if(c.name==="HomeServerError")s.set("not_supported",!0);else throw c}if(o){let c;const h=new Promise(d=>c=d);this._accountSetup=new Td(o,c),this._status.set(k.AccountSetup),await h;const l=(a=this._accountSetup)==null?void 0:a._dehydratedDevice;return this._accountSetup=null,l}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}startLogout(e){return this._platform.logger.run("logout",async t=>{this._sessionId=e,t.set("id",this._sessionId);const s=await this._platform.sessionInfoStorage.get(this._sessionId);if(!s)throw new Error(`Could not find session for id ${this._sessionId}`);try{await new Xe({homeserver:s.homeServer,accessToken:s.accessToken,request:this._platform.request}).logout({log:t}).response()}catch{}await this.deleteSession(t)})}startForcedLogout(e){return this._platform.logger.run("forced-logout",async t=>{this._sessionId=e,t.set("id",this._sessionId),await this.deleteSession(t)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(k.NotLoading),this._error=null,this._loginFailure=null}}class Td{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class v extends Fe{constructor(e){super(),this._isDisposed=!1,this._options=e}childOptions(e){return Object.assign({},this._options,e)}get options(){return this._options}getOption(e){return this._options[e]}observeNavigation(e,t){const i=this.navigation.observe(e).subscribe(r=>{t(r,e)});this.track(i)}track(e){return this.disposables||(this.disposables=new Et),this.disposables.track(e)}untrack(e){if(this.disposables)return this.disposables.untrack(e)}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){if(this.disposables)return this.disposables.disposeTracked(e)}i18n(e,...t){let s="";for(let i=0;i<e.length;++i)s=s+e[i],i<t.length&&(s=s+t[i]);return s}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlRouter(){return this._options.urlRouter}get features(){return this._options.features}get navigation(){return this._options.navigation}get timeFormatter(){return this._options.platform.timeFormatter}}function W(n){let e=n.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=n.charAt(1)),e.toUpperCase()}function Ad(n){let e=0,t,s;if(n.length===0)return e;for(t=0;t<n.length;t++)s=n.charCodeAt(t),e=(e<<5)-e+s,e|=0;return Math.abs(e)}function G(n){return Ad(n)%8+1}function te(n,e,t,s){if(n){const i=e*t.devicePixelRatio;return s.mxcUrlThumbnail(n,i,i,"crop")}}const gr=["roomBeingCreated","invite","room"];class Vi extends v{constructor(e){super(e),this._isOpen=!1,this._hidden=!1}get hidden(){return this._hidden}set hidden(e){e!==this._hidden&&(this._hidden=e,this.emitChange("hidden"))}close(){this._isOpen&&(this._isOpen=!1,this.emitChange("isOpen"))}open(){this._isOpen||(this._isOpen=!0,this.emitChange("isOpen"))}get isOpen(){return this._isOpen}compare(e){return e.kind!==this.kind?gr.indexOf(this.kind)-gr.indexOf(e.kind):0}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this._avatarSource.avatarColorId)}avatarUrl(e){return te(this._avatarSource.avatarUrl,e,this.platform,this._avatarSource.mediaRepository)}get avatarTitle(){return this.name}}class Vd extends Vi{constructor(e){super(e);const{room:t}=e;this._room=t,this._url=this.urlRouter.openRoomActionUrl(this._room.id)}get kind(){return"room"}get url(){return this._url}compare(e){const t=super.compare(e);if(t!==0)return t;const s=this._room,i=e._room;if(s.isLowPriority!==i.isLowPriority)return s.isLowPriority?1:-1;const r=s.lastMessageTimestamp,o=i.lastMessageTimestamp,a=Number.isSafeInteger(r),c=Number.isSafeInteger(o);if(a!==c)return c?1:-1;const h=o-r;if(h===0||!c||!a){const l=this.name.localeCompare(e.name);return l===0?this._room.id.localeCompare(e._room.id):l}return h}get isUnread(){return this._room.isUnread}get name(){return this._room.name||this.i18n`Empty Room`}get badgeCount(){return this._room.notificationCount}get isHighlighted(){return this._room.highlightCount!==0}get _avatarSource(){return this._room}}function hi(n,e){return n===e?0:n<e?-1:1}class xd extends Vi{constructor(e){super(e);const{invite:t}=e;this._invite=t,this._url=this.urlRouter.openRoomActionUrl(this._invite.id)}get busy(){return this._invite.accepting||this._invite.rejecting}get kind(){return"invite"}get url(){return this._url}get name(){return this._invite.name}get isHighlighted(){return!0}get isUnread(){return!0}get badgeCount(){return this.i18n`!`}get _avatarSource(){return this._invite}compare(e){const t=super.compare(e);if(t!==0)return t;const s=e._invite.timestamp-this._invite.timestamp;return s!==0?s:hi(this._invite.id,e._invite.id)}}class Nd extends Vi{constructor(e){super(e);const{roomBeingCreated:t}=e;this._roomBeingCreated=t,this._url=this.urlRouter.openRoomActionUrl(this._roomBeingCreated.id)}get busy(){return!this._roomBeingCreated.error}get kind(){return"roomBeingCreated"}get isHighlighted(){return!this.busy}get badgeCount(){return!this.busy&&this.i18n`Failed`}get url(){return this._url}get name(){return this._roomBeingCreated.name}get _avatarSource(){return this._roomBeingCreated}compare(e){const t=super.compare(e);if(t!==0)return t;const s=hi(this.name,e.name);return s===0?hi(this._roomBeingCreated.id,e._roomBeingCreated.id):s}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:super.avatarUrl(e)}}class Dd{constructor(e){this._parts=e.split(" ").map(t=>t.toLowerCase().trim())}matches(e){const t=e.name.toLowerCase();return this._parts.every(s=>t.includes(s))}}class Ud{constructor(e){this._observables=new Map,this._allowsChild=e,this._path=new Me([],e),this._pathObservable=new Ee(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,...t){const s=this.path.with(new se(e,...t));s&&this.applyPath(s)}applyPath(e){const t=this._path;this._path=e;for(let s=t.segments.length-1;s>=0;s-=1){const i=t.segments[s];if(!this._path.get(i.type)){const r=this._observables.get(i.type);r==null||r.emitIfChanged()}}for(const s of this._path.segments){const i=this._observables.get(s.type);i==null||i.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new Fd(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,s;for(s=0;s<e.length;s+=1){if(!this._allowsChild(t,e[s]))return new Me(e.slice(0,s),this._allowsChild);t=e[s]}return new Me(e,this._allowsChild)}segment(e,...t){return new se(e,...t)}}function Pd(n,e){if(n===e)return!0;if(Array.isArray(n)&&Array.isArray(e)){const t=Math.max(n.length,e.length);for(let s=0;s<t;s+=1)if(n[s]!==e[s])return!1;return!0}return!1}class se{constructor(e,...t){this.type=e,this.value=t[0]===void 0?!0:t[0]}}class Me{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new Me(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const s=this._segments.slice(0,t+1);return s.push(e),new Me(s,this._allowsChild)}t-=1}while(t>=-1)}until(e){const t=this._segments.findIndex(s=>s.type===e);return t!==-1?new Me(this._segments.slice(0,t+1),this._allowsChild):new Me([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){const t=this._segments.findIndex(s=>s.type===e.type);if(t!==-1){const s=this._segments[t-1];if(this._allowsChild(s,e)){const i=this._segments[t+1];if(!i||this._allowsChild(e,i)){const r=this._segments.slice();return r[t]=e,new Me(r,this._allowsChild)}}}}get segments(){return this._segments}}class Fd extends we{constructor(e,t){var s;super(),this._navigation=e,this._type=t,this._lastSetValue=(s=e.path.get(t))==null?void 0:s.value}get(){const t=this._navigation.path.get(this._type);return t==null?void 0:t.value}emitIfChanged(){const e=this.get();Pd(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class Od{constructor(e,t,s,i){this._isApplyingUrl=!1,this._history=e,this._navigation=t,this._parseUrlPath=s,this._stringifyPath=i,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){var s;const t=(s=this._urlAsNavPath(this._history.getLastSessionUrl()||"").get("session"))==null?void 0:s.value;if(typeof t=="string")return t}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription&&(this._subscription=this._subscription()),this._pathSubscription&&(this._pathSubscription=this._pathSubscription())}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastSessionUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(const s of e)if(t=t.with(s),!t)return;return this.urlForPath(t)}urlForSegment(e,...t){return this.urlForSegments([this._navigation.segment(e,...t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${encodeURIComponent(e)}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.href}normalizeUrl(){const e=new URL(window.location.href);e.searchParams.delete("loginToken"),this._history.replaceUrlSilently(e.toString())}}function Kd(){return new Ud(Bd)}function Ld({history:n,navigation:e}){return new Od(n,e,jd,qd)}function Bd(n,e){const{type:t}=e;switch(n==null?void 0:n.type){case void 0:return t==="login"||t==="session"||t==="sso"||t==="logout";case"session":return t==="room"||t==="rooms"||t==="settings"||t==="create-room"||t==="join-room"||t==="device-verification";case"rooms":return t==="room"||t==="empty-grid-tile";case"room":return t==="lightbox"||t==="right-panel";case"right-panel":return t==="details"||t==="members"||t==="member"||t==="verification"||t==="invite";case"logout":return t==="forced";default:return!1}}function $d(n,e,t){if(n.value.includes(e))return n;{const s=t.get("empty-grid-tile"),i=t.get("room");let r=0;s?r=s.value:i&&(r=n.value.indexOf(i.value));const o=n.value.slice();return o[r]=e,new se("rooms",o)}}function fr(n,e,...t){n.push(new se("right-panel")),n.push(new se(e,...t))}function li(n,e){const t=n.path.segments,s=t.findIndex(r=>r.type==="right-panel");let i=e;return s!==-1&&(i=e.until("room"),i=i.with(t[s]),i=i.with(t[s+1])),i}function jd(n,e,t){const s=n.substring(1).split("/"),i=s[Symbol.iterator](),r=[];let o;for(;!(o=i.next()).done;){const a=o.value;if(a==="rooms"){const c=i.next().value;if(c===void 0)break;const h=c.split(",").map(u=>decodeURIComponent(u));r.push(new se(a,h));const l=parseInt(i.next().value||"0",10),d=h[l];d?r.push(new se("room",d)):r.push(new se("empty-grid-tile",l))}else if(a==="open-room"){let c=i.next().value;if(!c)break;c=decodeURIComponent(c);const h=e.get("rooms");if(h&&r.push($d(h,c,e)),r.push(new se("room",c)),s.findIndex(u=>u==="open-room")>=s.length-2){const u=e.segments,p=u.findIndex(m=>m.type==="right-panel");p!==-1&&r.push(...u.slice(p))}}else if(a==="last-session"){let c=e.get("session");typeof(c==null?void 0:c.value)!="string"&&t&&(c=new se("session",t)),c&&r.push(c)}else if(a==="details"||a==="members"||a==="verification"||a==="invite")fr(r,a);else if(a==="member"){let c=i.next().value;if(!c)break;c=decodeURIComponent(c),fr(r,a,c)}else if(a.includes("loginToken")){const c=a.split("=").pop();r.push(new se("sso",c))}else{let c=i.next().value;c&&(c=decodeURIComponent(c)),r.push(new se(a,c))}}return r}function qd(n){let e="",t;for(const s of n.segments){const i=Hd(s.value);switch(s.type){case"rooms":e+=`/rooms/${i}`;break;case"empty-grid-tile":e+=`/${i}`;break;case"room":(t==null?void 0:t.type)==="rooms"?e+=`/${t.value.indexOf(s.value)}`:e+=`/${s.type}/${i}`;break;case"right-panel":case"sso":continue;default:e+=`/${s.type}`,i&&(e+=`/${i}`)}t=s}return e}function Hd(n){return n===!0?"":Array.isArray(n)?n.map(e=>encodeURIComponent(e)).join(","):encodeURIComponent(n)}class Wd extends v{constructor(e){super(e);const{session:t}=e;this._tileViewModelsMap=this._mapTileViewModels(t.roomsBeingCreated,t.invites,t.rooms),this._tileViewModelsFilterMap=new Xo(this._tileViewModelsMap),this._tileViewModels=this._tileViewModelsFilterMap.sortValues((s,i)=>s.compare(i)),this._currentTileVM=null,this._setupNavigation(),this._closeUrl=this.urlRouter.urlForSegment("session"),this._settingsUrl=this.urlRouter.urlForSegment("settings")}_mapTileViewModels(e,t,s){return t.join(e,s).mapValues((r,o)=>{var h;let a;return r.isBeingCreated?a=new Nd(this.childOptions({roomBeingCreated:r,emitChange:o})):r.isInvite?a=new xd(this.childOptions({invite:r,emitChange:o})):a=new Vd(this.childOptions({room:r,emitChange:o})),((h=this.navigation.path.get("room"))==null?void 0:h.value)===r.id&&(a.open(),this._updateCurrentVM(a)),a})}_updateCurrentVM(e){var t;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=e}get closeUrl(){return this._closeUrl}get settingsUrl(){return this._settingsUrl}showCreateRoomView(){this.navigation.push("create-room")}showJoinRoomView(){this.navigation.push("join-room")}_setupNavigation(){const e=this.navigation.observe("room");this.track(e.subscribe(s=>this._open(s)));const t=this.navigation.observe("rooms");this.gridEnabled=!!t.get(),this.track(t.subscribe(s=>{const i=this.gridEnabled^!!s;this.gridEnabled=!!s,i&&this.emitChange("gridEnabled")}))}_open(e){var t,s;(t=this._currentTileVM)==null||t.close(),this._currentTileVM=null,e&&(this._currentTileVM=this._tileViewModelsMap.get(e),(s=this._currentTileVM)==null||s.open())}toggleGrid(){const e=this.navigation.path.get("room");let t=this.navigation.path.until("session");this.gridEnabled?e&&(t=t.with(e),t=li(this.navigation,t)):e?(t=t.with(this.navigation.segment("rooms",[e.value])),t=t.with(e),t=li(this.navigation,t)):(t=t.with(this.navigation.segment("rooms",[])),t=t.with(this.navigation.segment("empty-grid-tile",0))),this.navigation.applyPath(t)}get tileViewModels(){return this._tileViewModels}clearFilter(){this._tileViewModelsFilterMap.setApply(null),this._tileViewModelsFilterMap.applyOnce((e,t)=>t.hidden=!1)}setFilter(e){if(e=e.trim(),e.length===0)return this.clearFilter(),!1;{const t=!this._tileViewModelsFilterMap.hasApply(),s=new Dd(e);return this._tileViewModelsFilterMap.setApply((i,r)=>{r.hidden=!s.matches(r)}),t}}}var O=(n=>(n.Message="message",n.MessageStatus="message-status",n.Announcement="announcement",n.File="file",n.Gap="gap",n.Image="image",n.Location="location",n.MissingAttachment="missing-attachment",n.Redacted="redacted",n.Video="video",n.DateHeader="date-header",n.Call="call",n.Verification="verification",n))(O||{});class X{constructor(e,t,s,i){this._remove=e,this._update=t,this._replace=s,this._updateParams=i}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new X(!0,!1,!1,null)}static Update(e){return new X(!1,!0,!1,e)}static Nothing(){return new X(!1,!1,!1,null)}static Replace(e){return new X(!1,!1,!0,e)}}class Gd extends Ct{constructor(e,t){super(),this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileOptions=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_createTile(e){const t=this._tileOptions.tileClassForEntry(e,this._tileOptions);if(t)return new t(e,this._tileOptions)}_emitSpontanousUpdate(e,t){const s=e.lowerEntry,i=this._findTileIdx(s);this.emitUpdate(i,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._silent=!0,this._tiles=[];let e=null;for(let s of this._entries)(!e||!e.tryIncludeEntry(s))&&(e=this._createTile(s),e&&this._tiles.push(e));let t=null;for(let s of this._tiles)t&&t.updateNextSibling(s),s.updatePreviousSibling(t),t=s;t&&t.updateNextSibling(null);for(let s=0;s<this._tiles.length;s+=1){const i=this._tiles[s];i.needsDateSeparator&&(this._addTileAt(s,i.createDateSeparator(),!0),s+=1)}for(const s of this._tiles)s.setUpdateEmit(this._emitSpontanousUpdate);this._silent=!1}_findTileIdx(e){return Te(this._tiles,e,(t,s)=>-s.compareEntry(t))}_findTileAtIdx(e,t){const s=this._getTileAtIdx(t);if(s&&s.compareEntry(e)===0)return s}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const s=this._findTileIdx(t),i=this._getTileAtIdx(s-1);if(i&&i.tryIncludeEntry(t)){this.emitUpdate(s-1,i);return}const r=this._getTileAtIdx(s);if(r&&r.tryIncludeEntry(t)){this.emitUpdate(s,r);return}const o=this._createTile(t);o&&(this._addTileAt(s,o),this._evaluateDateHeaderAtIdx(s))}_evaluateDateHeaderAtIdx(e){for(let t=0;t<3;t+=1){const s=e+t;if(s>=this._tiles.length)break;const i=this._tiles[s],r=s>0?this._tiles[s-1]:void 0,o=(r==null?void 0:r.shape)===O.DateHeader;i.needsDateSeparator&&!o?(e+=1,this._addTileAt(s,i.createDateSeparator())):!i.needsDateSeparator&&o&&this._removeTile(s-1,r)}}_addTileAt(e,t,s=!1){const i=e>0?this._tiles[e-1]:void 0,r=this._tiles[e];i==null||i.updateNextSibling(t),t.updatePreviousSibling(i),t.updateNextSibling(r),r==null||r.updatePreviousSibling(t),this._tiles.splice(e,0,t),s||this.emitAdd(e,t),t.setUpdateEmit(this._emitSpontanousUpdate)}onUpdate(e,t,s){if(!this._tiles)return;const i=this._findTileIdx(t),r=this._findTileAtIdx(t,i);if(r){const o=r.updateEntry(t,s);if(o.shouldReplace){const a=this._createTile(t);a?(this._replaceTile(i,r,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(i,r)}o.shouldRemove&&this._removeTile(i,r),o.shouldUpdate&&this.emitUpdate(i,r,o.updateParams)}}_replaceTile(e,t,s,i){t.dispose();const r=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=s,r==null||r.updateNextSibling(s),s.updatePreviousSibling(r),s.updateNextSibling(o),o==null||o.updatePreviousSibling(s),this.emitUpdate(e,s,i)}_removeTile(e,t){const s=this._getTileAtIdx(e-1),i=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),s==null||s.updateNextSibling(i),i==null||i.updatePreviousSibling(s),s&&s.shape===O.DateHeader&&(!i||!i.needsDateSeparator)&&this._removeTile(e-1,s)}onRemove(e,t){const s=this._findTileIdx(t),i=this._findTileAtIdx(t,s);i&&(i.removeEntry(t)?this._removeTile(s,i):this.emitUpdate(s,i))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=Te(this._tiles,e,(i,r)=>i.compare(r)),s=this._tiles[t];return(s==null?void 0:s.compare(e))===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class zd extends v{constructor(e){super(e);const{timeline:t,tileOptions:s}=e;this._timeline=this.track(t),this._tiles=new Gd(t.entries,s),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let s;if(e&&t){this._startTile=e,this._endTile=t;const i=this._tiles.getTileIndex(this._startTile),r=this._tiles.getTileIndex(this._endTile);for(const o of this._tiles.sliceIterator(i,r+1))o.notifyVisible();s=i<10,this._setShowJumpDown(r<this._tiles.length-1)}else s=!0,this._setShowJumpDown(!1);s&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(i=>{this._topLoadingPromise=null,i||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class Jd extends v{constructor(e){super(e.options),this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){var s;(new Boolean(e)!==new Boolean(this._replyVM)||!((s=this._replyVM)!=null&&s.id.equals(e.asEventKey())))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e)),this._replyVM.notifyVisible()),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}async function Yd(n,e,t,s){const i=new Map;n.text&&i.set("text",n.text),i.set("user_agent",n.userAgent),i.set("app",n.app),i.set("version",n.version),n.label&&i.set("label",n.label),i.set("file",{name:"logs.json",blob:e});const r=new Map;r.set("Accept","application/json");const o=s(t,{method:"POST",body:i,headers:r});let a;try{a=await o.response()}catch(l){throw new Error(`Could not submit logs to ${t}, got error ${l.message}`)}const{status:c,body:h}=a;if(c<200||c>=300)throw new Error(`Could not submit logs to ${t}, got status code ${c} with body ${h}`)}async function qn(n,e){const{bugReportEndpointUrl:t}=e.config;if(!t)throw new Error("no server configured to submit logs");const i=e.logger.reporters.find(o=>!!o.export);if(!i)throw new Error("No logger that can export configured");const r=await i.export();await Yd({app:"hydrogen",userAgent:e.description,version:e.version,text:`Submit logs from settings for user ${n.userId} on device ${n.deviceId}`},r.asBlob(),t,e.request)}class Qd extends v{get message(){return this.error.message}get error(){return this.getOption("error")}close(){this.getOption("onClose")()}async submitLogs(){try{return await qn(this.getOption("session"),this.platform),!0}catch{return!1}}}class le extends v{get errorViewModel(){return this._errorViewModel}reportError(e){var t;((t=this._errorViewModel)==null?void 0:t.error)!==e&&(this.disposeTracked(this._errorViewModel),this._errorViewModel=this.track(new Qd(this.childOptions({error:e,onClose:()=>{this._errorViewModel=this.disposeTracked(this._errorViewModel),this.emitChange("errorViewModel")}}))),this.emitChange("errorViewModel"))}logAndCatch(e,t,s=void 0){try{let i=this.logger.run(e,t);return i instanceof Promise&&(i=i.catch(r=>(this.reportError(r),s))),i}catch(i){return this.reportError(i),s}}}class yr extends le{constructor(e){super(e);const t=new Uo(this.call,"change");this.track(t.subscribe(()=>this.onUpdate()));const s=new na("self",t).mapValues((r,o)=>new Xd(this.childOptions({call:r,emitChange:o})),()=>{}),i=this.call.members.filterValues(r=>r.isConnected).mapValues((r,o)=>new xi(this.childOptions({member:r,emitChange:o,mediaRepository:this.getOption("room").mediaRepository})),(r,o)=>o==null?void 0:o.onUpdate());this.memberViewModels=i.join(s).sortValues((r,o)=>r.compare(o)),this.track(this.memberViewModels.subscribe({onRemove:()=>{this.emitChange()},onAdd:()=>{this.emitChange()},onUpdate:()=>{},onReset:()=>{},onMove:()=>{}}))}get isCameraMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.camera)!=null?t:!0}get isMicrophoneMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.microphone)!=null?t:!0}get memberCount(){return this.memberViewModels.length}get name(){return this.call.name}get id(){return this.call.id}get call(){return this.getOption("call")}onUpdate(){this.call.error&&this.reportError(this.call.error)}async hangup(){this.logAndCatch("CallViewModel.hangup",async e=>{this.call.hasJoined&&await this.call.leave(e)})}async toggleCamera(){this.logAndCatch("Call.toggleCamera",async e=>{const{localMedia:t,muteSettings:s}=this.call;if(s&&t){if(s.camera&&!Re(t.userMedia)){const i=await this.platform.mediaDevices.getMediaTracks(!s.microphone,!0);await this.call.setMedia(t.withUserMedia(i))}else await this.call.setMuted(s.toggleCamera());this.emitChange()}})}async toggleMicrophone(){this.logAndCatch("Call.toggleMicrophone",async e=>{const{localMedia:t,muteSettings:s}=this.call;if(s&&t){if(s.microphone&&!qe(t.userMedia)){const i=await this.platform.mediaDevices.getMediaTracks(!0,!s.camera);await this.call.setMedia(t.withUserMedia(i))}else await this.call.setMuted(s.toggleMicrophone());this.emitChange()}})}}class Xd extends le{constructor(e){super(e),this.init()}async init(){const e=this.getOption("room");this.memberObservable=await e.observeMember(e.user.id),this.track(this.memberObservable.subscribe(()=>{this.emitChange(void 0)}))}get errorViewModel(){}get stream(){var e;return(e=this.call.localPreviewMedia)==null?void 0:e.userMedia}get call(){return this.getOption("call")}get isCameraMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.camera)!=null?t:!0}get isMicrophoneMuted(){var e,t;return(t=(e=this.call.muteSettings)==null?void 0:e.microphone)!=null?t:!0}get avatarLetter(){var t;const e=(t=this.memberObservable)==null?void 0:t.get();return e?W(e.name):this.getOption("room").user.id}get avatarColorNumber(){return G(this.getOption("room").user.id)}avatarUrl(e){var s;const t=(s=this.memberObservable)==null?void 0:s.get();if(t)return te(t.avatarUrl,e,this.platform,this.getOption("room").mediaRepository)}get avatarTitle(){var t;const e=(t=this.memberObservable)==null?void 0:t.get();return e?e.name:this.getOption("room").user.id}compare(e){return-1}}class xi extends le{get stream(){var e;return(e=this.member.remoteMedia)==null?void 0:e.userMedia}get member(){return this.getOption("member")}get isCameraMuted(){var e,t;return(t=(e=this.member.remoteMuteSettings)==null?void 0:e.camera)!=null?t:!0}get isMicrophoneMuted(){var e,t;return(t=(e=this.member.remoteMuteSettings)==null?void 0:e.microphone)!=null?t:!0}get avatarLetter(){return W(this.member.member.name)}get avatarColorNumber(){return G(this.member.userId)}avatarUrl(e){const{avatarUrl:t}=this.member.member,s=this.getOption("mediaRepository");return te(t,e,this.platform,s)}get avatarTitle(){return this.member.member.name}onUpdate(){this.mapMemberSyncErrorIfNeeded()}mapMemberSyncErrorIfNeeded(){this.member.error&&this.reportError(this.member.error)}compare(e){if(e instanceof xi){const t=this.member.member.userId,s=e.member.member.userId;return t===s?0:t<s?-1:1}else return-e.compare(this)}}function qt(n){return{w:n.width,h:n.height,mimetype:n.blob.mimeType,size:n.blob.size}}class Ce{constructor(e,t,s){this.userMedia=e,this.screenShare=t,this.dataChannelOptions=s}withUserMedia(e){var t;return new Ce(e,(t=this.screenShare)==null?void 0:t.clone(),this.dataChannelOptions)}withScreenShare(e){var t;return new Ce((t=this.userMedia)==null?void 0:t.clone(),e,this.dataChannelOptions)}withDataChannel(e){var t,s;return new Ce((t=this.userMedia)==null?void 0:t.clone(),(s=this.screenShare)==null?void 0:s.clone(),e)}asPreview(){const e=this.clone(),t=e.userMedia;if(t&&t.getVideoTracks().length>0){const s=qe(t);s&&(s.stop(),t.removeTrack(s))}return e}replaceClone(e,t){const s=(i,r,o)=>(i==null?void 0:i.id)===(o==null?void 0:o.id)?r:o==null?void 0:o.clone();return new Ce(s(t==null?void 0:t.userMedia,e==null?void 0:e.userMedia,this.userMedia),s(t==null?void 0:t.screenShare,e==null?void 0:e.screenShare,this.screenShare),this.dataChannelOptions)}clone(){var e,t;return new Ce((e=this.userMedia)==null?void 0:e.clone(),(t=this.screenShare)==null?void 0:t.clone(),this.dataChannelOptions)}dispose(){var e,t,s;(e=qe(this.userMedia))==null||e.stop(),(t=Re(this.userMedia))==null||t.stop(),(s=Re(this.screenShare))==null||s.stop()}}class Zd extends v{constructor(e,t){super(t),this._firstTileInDay=e}setUpdateEmit(e){this._emitUpdate=e}get upperEntry(){return this.refEntry}get lowerEntry(){return this.refEntry}get refEntry(){return this._firstTileInDay.lowerEntry}compare(e){return this.compareEntry(e.upperEntry)}get relativeDate(){return this._dateString||(this._dateString=this.timeFormatter.formatRelativeDate(new Date(this.refEntry.timestamp))),this._dateString}get machineReadableDate(){return this._machineReadableString||(this._machineReadableString=this.timeFormatter.formatMachineReadableDate(new Date(this.refEntry.timestamp))),this._machineReadableString}get shape(){return O.DateHeader}get needsDateSeparator(){return!1}createDateSeparator(){}compareEntry(e){const t=this.refEntry.compare(e);return t===0?-1:t}updateEntry(e,t){return X.Nothing()}removeEntry(e){return!1}tryIncludeEntry(){return!1}get comparisonIsNotCommutative(){return!0}updatePreviousSibling(e){this._firstTileInDay.updatePreviousSibling(e)}updateNextSibling(e){var s;if(!e)return;this._firstTileInDay=e;const t=this._dateString;this._dateString=void 0,this._machineReadableString=void 0,t&&t!==this.relativeDate&&((s=this._emitUpdate)==null||s.call(this,this,"relativeDate"))}notifyVisible(){}dispose(){}}class ct extends le{constructor(e,t){super(t),this._needsDateSeparator=!1,this._entry=e,this._date=this._entry.timestamp?new Date(this._entry.timestamp):void 0}get isContinuation(){return!1}get needsDateSeparator(){return this._needsDateSeparator}createDateSeparator(){return new Zd(this,this.childOptions({}))}_updateDateSeparator(e){e&&e._date&&this._date?this._needsDateSeparator=e._date.getFullYear()!==this._date.getFullYear()||e._date.getMonth()!==this._date.getMonth()||e._date.getDate()!==this._date.getDate():this._needsDateSeparator=!!this._date}get id(){return this._entry.asEventKey()}get eventId(){return this._entry.id}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==E.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}async abortSending(){var e;await((e=this._entry.pendingEvent)==null?void 0:e.abort())}setUpdateEmit(e){this._emitUpdate=e}emitChange(e){this._emitUpdate&&this._emitUpdate(this,e),super.emitChange(e)}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}get comparisonIsNotCommutative(){return!1}compare(e){return e.comparisonIsNotCommutative?-e.compare(this):this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const s=this.shape==="redacted";return!e.isGap&&e.isRedacted!==s?X.Replace("shape"):(this._entry=e,X.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(e){(e==null?void 0:e.shape)!==O.DateHeader&&this._updateDateSeparator(e)}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(void 0),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this.options.roomVM}get _timeline(){return this.options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this.options.timeline.me}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}}class eu extends ct{constructor(e,t){super(e,t),this._loading=!1,this._waitingForConnection=!1,this._isAtTop=!0,this._siblingChanged=!1}get needsDateSeparator(){return!1}async fill(e=!1){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(t){return t instanceof Ve?(await this._waitForReconnection(),e?!1:await this.fill(!0)):(this.reportError(t),!1)}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){if(this.errorViewModel)return;let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?X.Nothing():X.Remove()}async _waitForReconnection(){this._waitingForConnection=!0,this.emitUpdate("status"),await this.options.client.reconnector.connectionStatus.waitFor(e=>e===pt.Online).promise,this._waitingForConnection=!1,this.emitUpdate("status")}get shape(){return"gap"}get isLoading(){return this._loading}get showSpinner(){return this.isLoading||this._waitingForConnection}get status(){const e=this._entry.prev_batch?"previous":"next";return this._waitingForConnection?"Waiting for connection\u2026":this.errorViewModel?`Could not load ${e} messages`:this.isLoading?"Loading more messages\u2026":"Gave up loading more messages"}}class tu{constructor(e){this._parentTile=e,this._map=new Ae,this._reactions=this._map.sortValues((t,s)=>t._compare(s))}update(e,t){if(e){for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],r=this._map.get(s);r?r._tryUpdate(i)&&this._map.update(s):this._map.add(s,new wr(s,i,null,this._parentTile))}}if(t)for(const[s,i]of t.entries()){const r=this._map.get(s);r?(r._tryUpdatePending(i),this._map.update(s)):this._map.add(s,new wr(s,null,i,this._parentTile))}for(const s of this._map.keys()){const i=t==null?void 0:t.has(s),r=e==null?void 0:e.hasOwnProperty(s);!r&&!i?this._map.remove(s):r?i||this._map.get(s)._tryUpdatePending(null)&&this._map.update(s):this._map.get(s)._tryUpdate(null)&&this._map.update(s)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class wr{constructor(e,t,s,i){this._key=e,this._annotation=t,this._pending=s,this._parentTile=i,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,i=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||i?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){var e,t;return(((e=this._pending)==null?void 0:e.count)||0)+(((t=this._annotation)==null?void 0:t.count)||0)}get isPending(){return this._pending!==null}get isActive(){var e;return((e=this._annotation)==null?void 0:e.me)||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}class We extends ct{constructor(e,t){super(e,t),this._isContinuation=!1,this._reactions=null,this._replyTile=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions(),this._updateReplyTileIfNeeded(void 0)}notifyVisible(){var e;super.notifyVisible(),(e=this._replyTile)==null||e.notifyVisible()}get _mediaRepository(){return this._room.mediaRepository}get permaLink(){return`https://matrix.to/#/${encodeURIComponent(this._room.id)}/${encodeURIComponent(this._entry.id)}`}copyPermalink(){this.platform.copyPlaintext(this.permaLink)}get senderProfileLink(){return`https://matrix.to/#/${encodeURIComponent(this.sender)}`}get memberPanelLink(){return`${this.urlRouter.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return G(this._entry.sender)}avatarUrl(e){return te(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return W(this.sender)}get avatarTitle(){return this.sender}get time(){return this._date&&this.timeFormatter.formatTime(this._date)}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}get isReply(){return this._entry.isReply}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof We&&e.sender===this.sender){const s=this._entry.timestamp,i=e._entry.timestamp;t=s-i<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){const s=super.updateEntry(e,t);return s.shouldUpdate&&this._updateReactions(),this._updateReplyTileIfNeeded(t),s}_updateReplyTileIfNeeded(e){var s,i;const t=this._entry.contextEntry;if(t){const r=(s=this._replyTile)==null?void 0:s.updateEntry(t,e);if((r==null?void 0:r.shouldReplace)||!this._replyTile){this.disposeTracked(this._replyTile);const o=this._options.tileClassForEntry,a=o(t,this._options);a&&(this._replyTile=new a(t,this._options))}r!=null&&r.shouldUpdate&&((i=this._replyTile)==null||i.emitChange())}}startReply(){this._roomVM.startReply(this._entry)}createReplyContent(e,t){return this._entry.createReplyContent(e,t)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async s=>{var r,o;if(!this.canReact){s.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){s.set("already_reacted",!0);return}const i=(o=(r=this._entry.pendingAnnotations)==null?void 0:r.get(e))==null?void 0:o.redactionEntry;i&&!i.pendingEvent.hasStartedSending?(s.set("abort_redaction",!0),await i.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,s)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async s=>{var r,o;if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){s.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){s.set("not_yet_reacted",!0);return}let i=(o=(r=this._entry.pendingAnnotations)==null?void 0:r.get(e))==null?void 0:o.annotationEntry;i||(i=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),i?await this._room.sendRedaction(i.id,null,s):s.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async s=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,s):await this.react(e,s)})}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new tu(this)),this._reactions.update(e,t))}get replyTile(){return this._entry.contextEventId?this._replyTile:null}}const su="(?:https|http|ftp):\\/\\/",Hn="[^\\s.,?!)]",vr="[a-zA-Z0-9:.\\[\\]-]",iu=`${vr}*(?=${vr})${Hn}`,ru=`(?:[\\/#](?:[^\\s]*${Hn})?)`,nu=`${su}${iu}${ru}?`,ou=new RegExp(nu,"gi");function Wn(n,e){const t=n.matchAll(ou);let s=0;for(let r of t){const o=n.slice(s,r.index);e(o,!1),e(r[0],!0);const a=r[0].length;s=r.index+a}const i=n.slice(s);e(i,!1)}function au(n){const e=[],t=n.split(`
`),s=(i,r)=>{r?e.push(new di(i,[new St(i)])):e.push(new St(i))};for(let i=0;i<t.length;i+=1){const r=t[i];r.length&&Wn(r,s),i>=t.length-1||e.push(new Gn)}return new Ni(n,e)}function cu(n){return new Ni(n,[new St(n)])}class hu{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class br{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class lu{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class du{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class uu{get type(){return"rule"}}class Gn{get type(){return"newline"}}class ys{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class mu{constructor(e,t,s,i,r){this.src=e,this.width=t,this.height=s,this.alt=i,this.title=r}get type(){return"image"}}class pu{constructor(e,t,s){this.id=e,this.href=t,this.children=s}get type(){return"pill"}get avatarColorNumber(){return G(this.id)}get avatarInitials(){return W(this.id)}}class di{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class St{constructor(e){this.text=e}get type(){return"text"}}function _u(n){return n.type==="format"&&n.format==="blockquote"}class Ni{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&_u(this.parts[t]);t++);this.parts.splice(t,0,new St(e))}}const Lt=Mt("Plain","Html");class zn extends We{constructor(e,t){super(e,t),this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return cu(e)}_getBodyFormat(){return Lt.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const gu=["EM","STRONG","CODE","DEL","SPAN"],fu=["DIV","BLOCKQUOTE"],yu=["https","http","ftp","mailto","magnet"].map(n=>`${n}://`),wu="https://matrix.to",Sr=`${wu}/#/`;class vu{constructor(e,t){this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(Sr))return null;const t=e.substring(Sr.length);return t[0]==="@"?t:null}parseLink(e,t){const s=this.result.getAttributeValue(e,"href"),i=s==null?void 0:s.toLowerCase();if(!i||!yu.some(o=>i.startsWith(o)))return new ys("span",t);const r=this.parsePillLink(s);return r?new pu(r,s,t):new di(s,t)}parseList(e){const t=this.result;let s=null;t.getNodeElementName(e)==="OL"&&(s=parseInt(t.getAttributeValue(e,"start"))||1);const i=[];for(const r of t.getChildNodes(e)){if(t.getNodeElementName(r)!=="LI")continue;const o=this.parseAnyNodes(t.getChildNodes(r));i.push(o)}return new lu(s,i)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let s;for(const o of t.getChildNodes(e)){s=o;break}let i=null;if(!this._ensureElement(s,"CODE"))return new br(i,this.result.getNodeText(e));const r=t.getAttributeValue(s,"class")||"";for(const o of r.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){i=o.substring(9);break}return new br(i,this.result.getNodeText(s))}parseImage(e){const t=this.result,s=t.getAttributeValue(e,"src")||"",i=this.mediaRepository.mxcUrl(s);if(!i)return null;const r=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),c=t.getAttributeValue(e,"title");return new mu(i,r,o,a,c)}parseTableRow(e,t){const s=[];for(const i of this.result.getChildNodes(e)){if(!this._ensureElement(i,t))continue;const r=this.result.getChildNodes(i),o=this.parseInlineNodes(r);s.push(o)}return s}parseTableHead(e){let t=null;for(const s of this.result.getChildNodes(e)){t=s;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const s of this.result.getChildNodes(e))!this._ensureElement(s,"TR")||t.push(this.parseTableRow(s,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let s,i;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(s=this.parseTableHead(t[0]),i=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(s=null,i=this.parseTableBody(t[0])),new du(s,i)}parseInlineElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"A":{const r=this.parseInlineNodes(i);return this.parseLink(e,r)}case"BR":return new Gn;default:{if(!gu.includes(s))return null;const r=this.parseInlineNodes(i);return new ys(s,r)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const r=this.parseInlineNodes(i);return new hu(parseInt(s[1]),r)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new uu;case"IMG":return this.parseImage(e);case"P":{const r=this.parseInlineNodes(i);return new ys(s,r)}case"TABLE":return this.parseTable(e);default:{if(!fu.includes(s))return null;const r=this.parseAnyNodes(i);return new ys(s,r)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;const s=(i,r)=>{r?t.push(new di(i,[new St(i)])):t.push(new St(i))};return Wn(this.result.getNodeText(e),s),!0}_isAllowedNode(e){return!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseInlineNodes(this.result.getChildNodes(s),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const i=this.parseInlineNode(s)||this.parseBlockNode(s);if(i){t.push(i);continue}this._isAllowedNode(s)&&this._parseAnyNodes(this.result.getChildNodes(s),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}function bu(n,e,t){const s=n.parseHTML(t),r=new vu(s,e).parseAnyNodes(s.rootNodes);return new Ni(t,r)}class Su extends zn{_getContentString(e){var t;return((t=this._getContent())==null?void 0:t[e])||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===Lt.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){var e;return((e=this._getContent())==null?void 0:e.format)==="org.matrix.custom.html"?Lt.Html:Lt.Plain}_parseBody(e,t){var i;let s;return t===Lt.Html?s=bu(this.platform,this._mediaRepository,e):s=au(e),((i=this._getContent())==null?void 0:i.msgtype)==="m.emote"&&s.insertEmote(`* ${this.displayName} `),s}}class Ir extends We{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})…`:this.i18n`This message is being deleted…`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}const Iu=300,ku=400;class Jn extends We{constructor(e,t){super(e,t),this._decryptedThumbnail=null,this._decryptedFile=null,this._isVisible=!1,this._error=null,this._downloading=!1,this._downloadError=null}async downloadMedia(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("status");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s==null||s.dispose(),this._downloading=!1}this.emitChange("status")}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===E.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get status(){const{pendingEvent:e}=this._entry;switch(e==null?void 0:e.status){case E.Waiting:return this.i18n`Waiting…`;case E.EncryptingAttachments:case E.Encrypting:return this.i18n`Encrypting…`;case E.UploadingAttachments:return this.i18n`Uploading…`;case E.Sending:return this.i18n`Sending…`;case E.Error:return this.i18n`Error: ${e.error.message}`;default:return this._downloadError?"Download failed":this._downloading?this.i18n`Downloading…`:""}}get thumbnailUrl(){var e,t;if(!this._isVisible)return"";if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const s=(e=this._getContent().info)==null?void 0:e.thumbnail_url;if(s)return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}if(this._entry.isPending){const s=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return s&&s.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const s=(t=this._getContent())==null?void 0:t.url;if(typeof s=="string")return this._mediaRepository.mxcUrlThumbnail(s,this.width,this.height,"scale")}}return""}notifyVisible(){super.notifyVisible(),this._isVisible=!0,this.emitChange("thumbnailUrl"),this.isPending||this._tryLoadEncryptedThumbnail()}get width(){var t;const e=(t=this._getContent())==null?void 0:t.info;return Math.round((e==null?void 0:e.w)*this._scaleFactor())}get height(){var t;const e=(t=this._getContent())==null?void 0:t.info;return Math.round((e==null?void 0:e.h)*this._scaleFactor())}get mimeType(){var t;const e=(t=this._getContent())==null?void 0:t.info;return e==null?void 0:e.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){var e;try{const t=(e=this._getContent().info)==null?void 0:e.thumbnail_file,s=this._getContent().file;t?(this._decryptedThumbnail=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl")):s&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(s),this.emitChange("thumbnailUrl"))}catch(t){this._error=t,this.emitChange("error")}}_scaleFactor(){var i;const e=(i=this._getContent())==null?void 0:i.info,t=Iu/(e==null?void 0:e.h),s=ku/(e==null?void 0:e.w);return Math.min(s,t,1)}_isMainResourceImage(){return!0}}class Mu extends Jn{constructor(e,t){super(e,t),this._lightboxUrl=this.urlRouter.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class Cu extends Jn{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){var t;if(this._decryptedFile)return this._decryptedFile.url;const e=(t=this._getContent())==null?void 0:t.url;return typeof e=="string"?this._mediaRepository.mxcUrl(e):""}get shape(){return"video"}_isMainResourceImage(){return!1}}function Ru(n,e=2){if(Number.isSafeInteger(n)){const t=Math.min(3,Math.floor(Math.log(n)/Math.log(1024))),s=Math.round(n/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${s} bytes`;case 1:return`${s} KB`;case 2:return`${s} MB`;case 3:return`${s} GB`}}return""}class Eu extends We{constructor(e,t){super(e,t),this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(i){this._downloadError=i}finally{s==null||s.dispose(),this._downloading=!1}this.emitChange("label")}get label(){var s;if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const t=this._getContent().body;if(this._entry.isPending){const{pendingEvent:i}=this._entry;switch(i==null?void 0:i.status){case E.Waiting:return this.i18n`Waiting to send ${t}…`;case E.EncryptingAttachments:case E.Encrypting:return this.i18n`Encrypting ${t}…`;case E.UploadingAttachments:{const r=Math.round(i.attachmentsSentBytes/i.attachmentsTotalBytes*100);return this.i18n`Uploading ${t}: ${r}%`}case E.Sending:case E.Sent:return this.i18n`Sending ${t}…`;case E.Error:return this.i18n`Error: could not send ${t}: ${i.error.message}`;default:return`Unknown send status for ${t}`}}else{const i=Ru((s=this._getContent().info)==null?void 0:s.size);return this._downloading?this.i18n`Downloading ${t} (${i})…`:this.i18n`Download ${t} (${i})`}}get shape(){return"file"}}class Tu extends We{get shape(){return"location"}get mapsLink(){try{const e=new URL(this._getContent().geo_uri);if(e.protocol!=="geo:")return"";const[t,...s]=e.pathname.split(";"),[i,r]=t.split(","),o=parseFloat(i),a=parseFloat(r);let c;for(const h of s){const[l,d]=h.split("=");l==="u"&&(c=parseFloat(d))}if(this.platform.isIOS)return`http://maps.apple.com/?ll=${o},${a}`;{let h=`geo:${o},${a}`;return c&&(h=h+`;u=${c}`),h}}catch{return""}}get label(){return this.i18n`${this.displayName} sent their location`}}class Au extends ct{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e==null?void 0:e.name}"`}}class Vu extends ct{get shape(){return"announcement"}get announcement(){var h,l;const{sender:e,content:t,prevContent:s,stateKey:i}=this._entry,r=this._entry.displayName||e,o=e===i?r:((h=this._entry.content)==null?void 0:h.displayname)||i,a=t&&t.membership,c=s&&s.membership;if(c==="join"&&a==="join"){if(t.avatar_url!==s.avatar_url)return`${r} changed their avatar`;if(t.displayname!==s.displayname)return t.displayname?`${(l=s.displayname)!=null?l:i} changed their name to ${t.displayname}`:`${i} removed their name (${s.displayname})`}else{if(a==="join")return`${o} joined the room`;if(a==="invite")return`${o} was invited to the room by ${r}`;if(c==="invite"){if(a==="join")return`${o} accepted the invitation to join the room`;if(a==="leave")return`${o} declined the invitation to join the room`}else if(a==="leave"){if(i===e)return`${o} left the room`;{const d=t.reason;return`${o} was kicked from the room by ${r}${d?`: ${d}`:""}`}}else if(a==="ban")return`${o} was banned from the room by ${r}`}return`${e} membership changed to ${t.membership}`}}class xu extends zn{updateEntry(e,t){const s=super.updateEntry(e,t);return e.eventType!=="m.room.encrypted"?X.Replace("shape"):s}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e==null?void 0:e.code;let s;return t==="MEGOLM_NO_SESSION"?s=this.i18n`The sender hasn't sent us the key for this message yet.`:s=(e==null?void 0:e.message)||this.i18n`Could not decrypt message because of unknown reason.`,s}}class Nu extends ct{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class Du extends We{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}class Uu extends ct{constructor(e,t){super(e,t);const s=this.getOption("session").callHandler.calls;this._callSubscription=void 0,this._memberSizeSubscription=void 0;const i=s.get(this._entry.stateKey);i&&!i.isTerminated&&(this._call=i,this.memberViewModels=this._setupMembersList(this._call),this._callSubscription=this.track(this._call.disposableOn("change",()=>{this._onCallUpdate()})),this._memberSizeSubscription=this.track(this._call.members.observeSize().subscribe(()=>{this.emitChange("memberCount")})),this._onCallUpdate())}_onCallUpdate(){this._call.isTerminated?(this._durationInterval=this.disposeTracked(this._durationInterval),this._callSubscription=this.disposeTracked(this._callSubscription),this._call=void 0):this._durationInterval||(this._durationInterval=this.track(this.platform.clock.createInterval(()=>{this.emitChange("duration")},1e3))),this.emitChange()}_setupMembersList(e){return e.members.mapValues((t,s)=>new Pu(this.childOptions({member:t,emitChange:s,mediaRepository:this.getOption("room").mediaRepository}))).sortValues((t,s)=>t.userId.localeCompare(s.userId))}get memberCount(){return this._call?this._call.members.size:0}get confId(){return this._entry.stateKey}get duration(){return this._call&&this._call.duration?this.timeFormatter.formatDuration(this._call.duration):""}get shape(){return"call"}get canJoin(){return this._call&&!this._call.hasJoined&&!this._call.usesFoci}get canLeave(){return this._call&&this._call.hasJoined}get title(){return this._call?this.type===Is.Video?`${this.displayName} started a video call`:`${this.displayName} started a voice call`:this.type===Is.Video?"Video call ended":"Voice call ended"}get typeLabel(){return this._call&&this._call.usesFoci?"This call uses a stream-forwarding unit, which isn't supported yet, so you can't join this call.":this.type===Is.Video?"Video call":"Voice call"}get type(){return this._entry.event.content["m.type"]}async join(){await this.logAndCatch("CallTile.join",async e=>{if(this.canJoin){const t=await this.platform.mediaDevices.getMediaTracks(!1,!0),s=new Ce().withUserMedia(t);await this._call.join(s,e)}})}async leave(){await this.logAndCatch("CallTile.leave",async e=>{this.canLeave&&await this._call.leave(e)})}}class Pu extends v{get _member(){return this.getOption("member")}get userId(){return this._member.userId}get avatarLetter(){return W(this._member.member.name)}get avatarColorNumber(){return G(this._member.userId)}avatarUrl(e){const{avatarUrl:t}=this._member.member,s=this.getOption("mediaRepository");return te(t,e,this.platform,s)}get avatarTitle(){return this._member.member.name}}var Bt=(n=>(n[n.Ready=0]="Ready",n[n.InProgress=1]="InProgress",n[n.Completed=2]="Completed",n[n.Cancelled=3]="Cancelled",n))(Bt||{});class Fu extends ct{constructor(e,t){super(e,t),this.status=0,this.request=new vs(this.lowerEntry),this.updateStatusFromAvailableContextForEntries()}get shape(){return O.Verification}get description(){return this.i18n`${this.sender} wants to verify`}accept(){this.getOption("session").crossSigning.get().receivedSASVerifications.set(this.eventId,this.request),this.openVerificationPanel(this.eventId)}async reject(){await this.logAndCatch("VerificationTile.reject",async e=>{const t=this.getOption("session").crossSigning.get();await this.request.reject(t,this._room,e)})}openVerificationPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment("verification",e)),this.navigation.applyPath(t)}updateEntry(e,t){return t==="context-added"?this.updateStatusFromAvailableContextForEntries()?X.Update(t):X.Nothing():super.updateEntry(e,t)}updateStatusFromAvailableContextForEntries(){var t;let e=!1;for(const s of(t=this.lowerEntry.contextForEntries)!=null?t:[])switch(s.eventType){case w.Cancel:return this.status=3,this.isCancelledByUs=s.sender===this.getOption("session").userId,!0;case w.Done:return this.status=2,!0;default:this.status=1,e=!0}return e}}function Ou(n,e){if(n.isGap)return eu;if(n.isPending&&n.pendingEvent.isMissingAttachments)return Du;if(n.eventType)switch(n.eventType){case"m.room.message":{if(n.isRedacted)return Ir;const t=n.content;switch(t&&t.msgtype){case"m.text":case"m.notice":case"m.emote":return Su;case"m.image":return Mu;case"m.video":return Cu;case"m.file":return Eu;case"m.location":return Tu;case"m.key.verification.request":const i=!e.session.features.crossSigning,r=e.session.userId;return i||n.sender===r?void 0:Fu;default:return}}case"m.room.name":return Au;case"m.room.member":return Vu;case"m.room.encrypted":return n.isRedacted?Ir:xu;case"m.room.encryption":return Nu;case"org.matrix.msc3401.call":return e.features.calls&&n.stateKey&&!n.prevContent?Uu:void 0;default:return}}async function Yn(n,e){var t,s,i,r;try{const o=await e.joinRoom(n);return await(await e.observeRoomStatus(o)).waitFor(c=>c===V.Joined),o}catch(o){throw((t=o.statusCode)!=null?t:o.status)===400?new Error(`'${n}' is not a legal room ID or alias`):((s=o.statusCode)!=null?s:o.status)===404||((i=o.statusCode)!=null?i:o.status)===502||o.message=="Internal Server eor"?new Error(`Room '${n}' could not be found`):((r=o.statusCode)!=null?r:o.status)===403?new Error(`You are not invited to join '${n}'`):o}}class kr extends le{constructor(e){var i;super(e);const{room:t,tileClassForEntry:s}=e;this._sendReadReceipt=(i=e.sendReadReceipt)!=null?i:!0,this._room=t,this._timelineVM=null,this._tileClassForEntry=s!=null?s:Ou,this._tileOptions=void 0,this._onRoomChange=this._onRoomChange.bind(this),this._composerVM=null,t.isArchived?this._composerVM=this.track(new Lu(this.childOptions({archivedRoom:t}))):this._recreateComposerOnPowerLevelChange(),this._clearUnreadTimout=null,this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._setupCallViewModel()}_setupCallViewModel(){if(!this.features.calls)return;const e=this.getOption("session").callHandler.calls;this._callObservable=new Oo(e.filterValues(s=>s.roomId===this._room.id&&s.hasJoined)),this._callViewModel=void 0,this.track(this._callObservable.subscribe(s=>{s&&this._callViewModel&&s.id===this._callViewModel.id||(this._callViewModel=this.disposeTracked(this._callViewModel),s&&(this._callViewModel=this.track(new yr(this.childOptions({call:s,room:this._room})))),this.emitChange("callViewModel"))}));const t=this._callObservable.get();t&&(this._callViewModel=this.track(new yr(this.childOptions({call:t,room:this._room}))))}async load(){await this.logAndCatch("RoomViewModel.load",async e=>{this._room.on("change",this._onRoomChange);const t=await this._room.openTimeline(e);this.track(()=>t.release()),this._tileOptions=this.childOptions({session:this.getOption("session"),roomVM:this,timeline:t,tileClassForEntry:this._tileClassForEntry}),this._timelineVM=this.track(new zd(this.childOptions({tileOptions:this._tileOptions,timeline:t}))),this.emitChange("timelineViewModel"),await this._clearUnreadAfterDelay(e)})}async _recreateComposerOnPowerLevelChange(){const e=await this._room.observePowerLevels(),t=()=>e.get().canSendType("m.room.message");let s=t();const i=r=>{this._composerVM=this.disposeTracked(this._composerVM),r?this._composerVM=this.track(new Jd(this)):this._composerVM=this.track(new Bu(this.childOptions())),this.emitChange("powerLevelObservable")};this.track(e.subscribe(()=>{const r=t();s!==r&&(i(r),s=r)})),i(s)}async _clearUnreadAfterDelay(e){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(e,this._sendReadReceipt),this._clearUnreadTimout=null}catch(t){if(t.name==="AbortError")e.set("clearUnreadCancelled",!0);else throw t}}}focus(){this.logAndCatch("RoomViewModel.focus",async e=>{this._clearUnreadAfterDelay(e)})}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){var e;(e=this._composerVM)==null||e.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this._room.avatarColorId)}avatarUrl(e){return te(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){if(this._tileOptions){const t=this._tileOptions.tileClassForEntry(e,this._tileOptions);if(t)return new t(e,this._tileOptions)}}_sendMessage(e,t){return this.logAndCatch("RoomViewModel.sendMessage",async s=>{let i=!1;if(!this._room.isArchived&&e){let r="m.text";if(e.startsWith("//"))e=e.substring(1).trim();else if(e.startsWith("/")){const a=await this._processCommand(e);r=a.msgtype,e=a.message}let o;t?(s.set("replyingTo",t.eventId),o=await t.createReplyContent(r,e)):o={msgtype:r,body:e},await this._room.sendEvent("m.room.message",o,void 0,s),i=!0}return s.set("success",i),i},!1)}async _processCommandJoin(e){try{const t=this._options.client.session,s=await Yn(e,t);this.navigation.push("room",s)}catch(t){this.reportError(t)}}async _processCommand(e){let t;const[s,...i]=e.substring(1).split(" ");switch(s){case"me":e=i.join(" "),t="m.emote";break;case"join":if(i.length===1){const r=i[0];await this._processCommandJoin(r)}else this.reportError(new Error("join syntax: /join <room-id>"));break;case"invite":if(i.length===1){const r=i[0];await this._room.inviteUser(r)}else this.reportError(new Error("invite syntax: /invite <user-id>"));break;case"shrug":e="\xAF\\_(\u30C4)_/\xAF "+i.join(" "),t="m.text";break;case"tableflip":e="(\u256F\xB0\u25A1\xB0\uFF09\u256F\uFE35 \u253B\u2501\u253B "+i.join(" "),t="m.text";break;case"unflip":e="\u252C\u2500\u2500\u252C \u30CE( \u309C-\u309C\u30CE) "+i.join(" "),t="m.text";break;case"lenny":e="( \u0361\xB0 \u035C\u0296 \u0361\xB0) "+i.join(" "),t="m.text";break;default:this.reportError(new Error(`no command name "${s}". To send the message instead of executing, please type "/${e}"`)),e=void 0}return{msgtype:t,message:e}}_pickAndSendFile(){return this.logAndCatch("RoomViewModel.sendFile",async e=>{const t=await this.platform.openFile();if(!t){e.set("cancelled",!0);return}return this._sendFile(t,e)})}async _sendFile(e,t){const s={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",s,{url:this._room.createAttachment(e.blob,e.name)},t)}_pickAndSendVideo(){return this.logAndCatch("RoomViewModel.sendVideo",async e=>{if(!this.platform.hasReadPixelPermission())throw new Error("Please allow canvas image data access, so we can scale your images down.");const t=await this.platform.openFile("video/*");if(!t)return;if(!t.blob.mimeType.startsWith("video/"))return this._sendFile(t,e);let s;try{s=await this.platform.loadVideo(t.blob)}catch(h){throw h instanceof window.MediaError&&h.code===4?new Error(`this browser does not support videos of type ${t==null?void 0:t.blob.mimeType}.`):h}const i={body:t.name,msgtype:"m.video",info:Ku(s)},r={url:this._room.createAttachment(s.blob,t.name)},a=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(s.maxDimension,800),c=await s.scale(a);i.info.thumbnail_info=qt(c),r["info.thumbnail_url"]=this._room.createAttachment(c.blob,t.name),await this._room.sendEvent("m.room.message",i,r,e)})}async _pickAndSendPicture(){this.logAndCatch("RoomViewModel.sendPicture",async e=>{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}const t=await this.platform.openFile("image/*");if(!t){e.set("cancelled",!0);return}if(!t.blob.mimeType.startsWith("image/"))return this._sendFile(t,e);let s=await this.platform.loadImage(t.blob);const i=await this.platform.settingsStorage.getInt("sentImageSizeLimit");if(i&&s.maxDimension>i){const a=await s.scale(i);s.dispose(),s=a}const r={body:t.name,msgtype:"m.image",info:qt(s)},o={url:this._room.createAttachment(s.blob,t.name)};if(s.maxDimension>600){const a=await s.scale(400);r.info.thumbnail_info=qt(a),o["info.thumbnail_url"]=this._room.createAttachment(a.blob,t.name)}await this._room.sendEvent("m.room.message",r,o,e)})}get room(){return this._room}get composerViewModel(){return this._composerVM}get callViewModel(){return this._callViewModel}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}startCall(){return this.logAndCatch("RoomViewModel.startCall",async e=>{if(!this.features.calls){e.set("feature_disbled",!0);return}e.set("roomId",this._room.id);let t;try{const r=await this.platform.mediaDevices.getMediaTracks(!1,!0);t=new Ce().withUserMedia(r)}catch(r){throw new Error(`Could not get local audio and/or video stream: ${r.message}`)}const s=this.getOption("session");let i;try{i=await s.callHandler.createCall(this._room.id,"m.video","A call "+Math.round(this.platform.random()*100),void 0,e)}catch(r){throw new Error(`Could not create call: ${r.message}`)}try{await i.join(t,e)}catch(r){throw new Error(`Could not join call: ${r.message}`)}})}}function Ku(n){const e=qt(n);return e.duration=n.duration,e}class Lu extends v{constructor(e){super(e),this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"disabled"}}class Bu extends v{get description(){return this.i18n`You do not have the powerlevel necessary to send messages`}get kind(){return"disabled"}}class $u extends v{constructor(e){super(e);const{roomIdOrAlias:t,session:s}=e;this._session=s,this.roomIdOrAlias=t,this._error=null,this._busy=!1,this._closeUrl=this.urlRouter.urlUntilSegment("session")}get closeUrl(){return this._closeUrl}get error(){var e;return(e=this._error)==null?void 0:e.message}async join(){this._busy=!0,this.emitChange("busy");try{const e=await this._session.joinRoom(this.roomIdOrAlias);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}get busy(){return this._busy}get kind(){return"unknown"}}class ju extends v{constructor(e){super(e);const{invite:t,mediaRepository:s}=e;this._invite=t,this._mediaRepository=s,this._onInviteChange=this._onInviteChange.bind(this),this._error=null,this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._invite.on("change",this._onInviteChange),this._inviter=null,this._invite.inviter&&(this._inviter=new qu(this._invite.inviter,s,this.platform)),this._roomDescription=this._createRoomDescription()}get kind(){return"invite"}get closeUrl(){return this._closeUrl}get name(){return this._invite.name}get id(){return this._invite.id}get isEncrypted(){return this._invite.isEncrypted}get isDirectMessage(){return this._invite.isDirectMessage}get inviter(){return this._inviter}get busy(){return this._invite.accepting||this._invite.rejecting}get error(){return this._error?`Something went wrong: ${this._error.message}`:""}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this._invite.avatarColorId)}avatarUrl(e){return te(this._invite.avatarUrl,e,this.platform,this._mediaRepository)}_createRoomDescription(){const e=[];return this._invite.isPublic?e.push("Public room"):e.push("Private room"),this._invite.canonicalAlias&&e.push(this._invite.canonicalAlias),e.join(" \u2022 ")}get roomDescription(){return this._roomDescription}get avatarTitle(){return this.name}focus(){}async accept(){try{await this._invite.accept()}catch(e){this._error=e,this.emitChange("error")}}async reject(){try{await this._invite.reject()}catch(e){this._error=e,this.emitChange("error")}}_onInviteChange(){this.emitChange()}dispose(){super.dispose(),this._invite.off("change",this._onInviteChange)}}class qu{constructor(e,t,s){this._member=e,this._mediaRepository=t,this._platform=s}get id(){return this._member.userId}get name(){return this._member.name}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this._member.userId)}avatarUrl(e){return te(this._member.avatarUrl,e,this._platform,this._mediaRepository)}get avatarTitle(){return this.name}}class Hu extends v{constructor(e){super(e);const{roomBeingCreated:t,mediaRepository:s}=e;this._roomBeingCreated=t,this._mediaRepository=s,this._onRoomChange=this._onRoomChange.bind(this),this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._roomBeingCreated.on("change",this._onRoomChange)}get kind(){return"roomBeingCreated"}get closeUrl(){return this._closeUrl}get name(){return this._roomBeingCreated.name}get id(){return this._roomBeingCreated.id}get isEncrypted(){return this._roomBeingCreated.isEncrypted}get error(){const{error:e}=this._roomBeingCreated;return e?e.name==="ConnectionError"?this.i18n`You seem to be offline`:e.message:""}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this._roomBeingCreated.avatarColorId)}get avatarTitle(){return this.name}avatarUrl(e){var t;return(t=this._roomBeingCreated.avatarBlobUrl)!=null?t:te(this._roomBeingCreated.avatarUrl,e,this.platform,this._mediaRepository)}focus(){}_onRoomChange(){this.emitChange()}cancel(){this._roomBeingCreated.cancel(),this.navigation.applyPath(this.navigation.path.until("session"))}dispose(){super.dispose(),this._roomBeingCreated.off("change",this._onRoomChange)}}class Wu extends v{constructor(e){super(e),this._eventId=e.eventId,this._unencryptedImageUrl=null,this._decryptedImage=null,this._closeUrl=this.urlRouter.urlUntilSegment("room"),this._date=null,this._subscribeToEvent(e.room,e.eventId)}_subscribeToEvent(e,t){const s=e.observeEvent(t);this.track(s.subscribe(i=>{this._loadEvent(e,i)})),this._loadEvent(e,s.get())}async _loadEvent(e,t){if(!t)return;const{mediaRepository:s}=e;this._eventEntry=t;const{content:i}=this._eventEntry;this._date=this._eventEntry.timestamp?new Date(this._eventEntry.timestamp):null,i.url?(this._unencryptedImageUrl=s.mxcUrl(i.url),this.emitChange("imageUrl")):i.file&&(this._decryptedImage=this.track(await s.downloadEncryptedFile(i.file)),this.emitChange("imageUrl"))}get imageWidth(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.w}get imageHeight(){var e,t,s;return(s=(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.info)==null?void 0:s.h}get name(){var e,t;return(t=(e=this._eventEntry)==null?void 0:e.content)==null?void 0:t.body}get sender(){var e;return(e=this._eventEntry)==null?void 0:e.displayName}get imageUrl(){return this._decryptedImage?this._decryptedImage.url:this._unencryptedImageUrl?this._unencryptedImageUrl:""}get date(){return this._date&&this._date.toLocaleDateString({},{weekday:"long",year:"numeric",month:"long",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get closeUrl(){return this._closeUrl}close(){this.platform.history.pushUrl(this.closeUrl)}}const j=Mt("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");class Gu extends v{constructor(e){super(e);const{sync:t,reconnector:s,session:i}=e;this._sync=t,this._reconnector=s,this._status=this._calculateState(s.connectionStatus.get(),t.status.get()),this._session=i,this._setupKeyBackupUrl=this.urlRouter.urlForSegment("settings"),this._dismissSecretStorage=!1}start(){const e=()=>this._updateStatus();this.track(this._sync.status.subscribe(e)),this.track(this._reconnector.connectionStatus.subscribe(e)),this.track(this._session.needsKeyBackup.subscribe(()=>{this.emitChange()}))}get setupKeyBackupUrl(){return this._setupKeyBackupUrl}get isShown(){return this._session.needsKeyBackup.get()&&!this._dismissSecretStorage||this._status!==j.Syncing}get statusLabel(){switch(this._status){case j.Disconnected:{const e=Math.round(this._reconnector.retryIn/1e3);return this.i18n`Disconnected, trying to reconnect in ${e}s…`}case j.Connecting:return this.i18n`Trying to reconnect now…`;case j.FirstSync:return this.i18n`Catching up with your conversations…`;case j.SyncError:return this.i18n`Sync failed because of ${this._sync.error}`}return this._session.needsKeyBackup.get()?this.i18n`Set up session backup to decrypt older messages.`:""}get isWaiting(){switch(this._status){case j.Connecting:case j.FirstSync:return!0;default:return!1}}_updateStatus(){const e=this._calculateState(this._reconnector.connectionStatus.get(),this._sync.status.get());e!==this._status&&(e===j.Disconnected?this._retryTimer=this.track(this.clock.createInterval(()=>{this.emitChange("statusLabel")},1e3)):this._retryTimer=this.disposeTracked(this._retryTimer),this._status=e,this.emitChange())}_calculateState(e,t){if(e!==pt.Online)switch(e){case pt.Reconnecting:return j.Connecting;case pt.Waiting:return j.Disconnected}else if(t!==A.Syncing)switch(t){case A.InitialSync:case A.CatchupSync:return j.FirstSync;case A.Stopped:return j.SyncError}else return j.Syncing}get isConnectNowShown(){return this._status===j.Disconnected}get isSecretStorageShown(){return this._status===j.Syncing&&this._session.needsKeyBackup.get()&&!this._dismissSecretStorage}get canDismiss(){return this.isSecretStorageShown}dismiss(){this.isSecretStorageShown&&(this._dismissSecretStorage=!0,this.emitChange())}connectNow(){this.isConnectNowShown&&this._reconnector.tryNow()}}function Mr(n){return n.map((e,t)=>{if(!n.slice(0,t).includes(e))return e})}class zu extends v{constructor(e){super(e),this._width=e.width,this._height=e.height,this._createRoomViewModelObservable=e.createRoomViewModelObservable,this._selectedIndex=0,this._viewModelsObservables=[],this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("empty-grid-tile");this.track(e.subscribe(s=>{typeof s=="number"&&this._setFocusIndex(s)})),typeof e.get()=="number"&&(this._selectedIndex=e.get());const t=this.navigation.observe("room");this.track(t.subscribe(s=>{s&&this._setFocusRoom(s)}))}roomViewModelAt(e){var t;return(t=this._viewModelsObservables[e])==null?void 0:t.get()}get focusIndex(){return this._selectedIndex}get width(){return this._width}get height(){return this._height}_switchToRoom(e){let t=this.navigation.path.until("rooms");t=t.with(this.navigation.segment("room",e)),t=li(this.navigation,t),this.navigation.applyPath(t)}focusTile(e){if(e===this._selectedIndex)return;const t=this._viewModelsObservables[e];t?this._switchToRoom(t.id):this.navigation.push("empty-grid-tile",e)}initializeRoomIdsAndTransferVM(e,t){e=Mr(e);let s=!1;if(t){const r=e.indexOf(t.id);r!==-1&&(this._viewModelsObservables[r]=this.track(t),t.subscribe(o=>this._refreshRoomViewModel(o)),s=!0)}this.setRoomIds(e);const i=this.navigation.path.get("room");if(i){const r=this._viewModelsObservables.findIndex(o=>o&&o.id===i.value);r!==-1&&(this._selectedIndex=r)}return s}setRoomIds(e){e=Mr(e);let t=!1;const s=this._height*this._width;for(let i=0;i<s;i+=1){const r=e[i],o=this._viewModelsObservables[i];if(!o&&r||o&&o.id!==r){if(o&&(this._viewModelsObservables[i]=this.disposeTracked(o)),r){const a=this._createRoomViewModelObservable(r);this._viewModelsObservables[i]=this.track(a),a.subscribe(c=>this._refreshRoomViewModel(c)),a.initialize()}t=!0}}return t&&this.emitChange(),t}_refreshRoomViewModel(e){this.emitChange(),e==null||e.focus()}releaseRoomViewModel(e){const t=this._viewModelsObservables.findIndex(s=>s&&s.id===e);if(t!==-1){const s=this._viewModelsObservables[t];return this.untrack(s),s.unsubscribeAll(),this._viewModelsObservables[t]=null,s}}_setFocusIndex(e){var s;if(e===this._selectedIndex||e>=this._width*this._height)return;this._selectedIndex=e;const t=this._viewModelsObservables[this._selectedIndex];(s=t==null?void 0:t.get())==null||s.focus(),this.emitChange("focusIndex")}_setFocusRoom(e){const t=this._viewModelsObservables.findIndex(s=>(s==null?void 0:s.id)===e);t>=0&&this._setFocusIndex(t)}}var ae=(n=>(n[n.Enabled=0]="Enabled",n[n.SetupWithPassphrase=1]="SetupWithPassphrase",n[n.SetupWithRecoveryKey=2]="SetupWithRecoveryKey",n[n.Pending=3]="Pending",n[n.NewVersionAvailable=4]="NewVersionAvailable",n))(ae||{}),ks=(n=>(n[n.Writing=0]="Writing",n[n.Stopped=1]="Stopped",n[n.Done=2]="Done",n[n.Pending=3]="Pending",n))(ks||{});class Ju extends v{constructor(e){super(e),this._error=void 0,this._isBusy=!1,this._dehydratedDeviceId=void 0,this._status=3,this._backupOperationSubscription=void 0,this._keyBackupSubscription=void 0,this._progress=void 0,this._setupKeyType=pe.RecoveryKey;const t=s=>{s&&!this._keyBackupSubscription?this._keyBackupSubscription=this.track(this._session.keyBackup.get().disposableOn("change",()=>{this._onKeyBackupChange()})):!s&&this._keyBackupSubscription&&(this._keyBackupSubscription=this.disposeTracked(this._keyBackupSubscription)),this._onKeyBackupChange()};this.track(this._session.keyBackup.subscribe(t)),this.track(this._session.crossSigning.subscribe(()=>{this.emitChange("crossSigning")})),t(this._keyBackup)}get _session(){return this.getOption("session")}get _keyBackup(){return this._session.keyBackup.get()}get _crossSigning(){return this._session.crossSigning.get()}_onKeyBackupChange(){const e=this._keyBackup;if(e){const{operationInProgress:t}=e;t&&!this._backupOperationSubscription?this._backupOperationSubscription=this.track(t.disposableOn("change",()=>{this._progress=t.progress,this.emitChange("backupPercentage")})):this._backupOperationSubscription&&!t&&(this._backupOperationSubscription=this.disposeTracked(this._backupOperationSubscription),this._progress=void 0)}this.emitChange("status")}get status(){const e=this._keyBackup;if(e)return e.needsNewKey?4:e.version===void 0?3:e.needsNewKey?4:0;switch(this._setupKeyType){case pe.RecoveryKey:return 2;case pe.Passphrase:return 1}}get decryptAction(){return this.i18n`Set up`}get purpose(){return this.i18n`set up key backup`}offerDehydratedDeviceSetup(){return!0}get dehydratedDeviceId(){return this._dehydratedDeviceId}get isBusy(){return this._isBusy}get backupVersion(){var e,t;return(t=(e=this._keyBackup)==null?void 0:e.version)!=null?t:""}get isMasterKeyTrusted(){var e,t;return(t=(e=this._crossSigning)==null?void 0:e.isMasterKeyTrusted)!=null?t:!1}get canSignOwnDevice(){return!!this._crossSigning}async _signOwnDevice(){const e=this._crossSigning;e&&await this.logger.run("KeyBackupViewModel.signOwnDevice",async t=>{await e.signOwnDevice(t)})}navigateToVerification(){this.navigation.push("device-verification",!0)}get backupWriteStatus(){const e=this._keyBackup;return!e||e.version===void 0?3:e.hasStopped?1:e.operationInProgress?0:e.hasBackedUpAllKeys?2:3}get backupError(){var e,t;return(t=(e=this._keyBackup)==null?void 0:e.error)==null?void 0:t.message}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._setupKeyType=pe.Passphrase,this.emitChange("status")}showKeySetup(){this._setupKeyType=pe.RecoveryKey,this.emitChange("status")}async _enterCredentials(e,t,s){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const i=await this._session.enableSecretStorage(e,t);s&&(this._dehydratedDeviceId=await this._session.setupDehydratedDevice(i)),await this._signOwnDevice()}catch(i){console.error(i),this._error=i,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange()}}enterSecurityPhrase(e,t){return this._enterCredentials(pe.Passphrase,e,t)}enterSecurityKey(e,t){return this._enterCredentials(pe.RecoveryKey,e,t)}async disable(){try{this._isBusy=!0,this.emitChange("isBusy"),await this._session.disableSecretStorage()}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange()}}get isBackingUp(){var e;return((e=this._keyBackup)==null?void 0:e.operationInProgress)!==void 0}get backupPercentage(){return this._progress?Math.round(this._progress.finished/this._progress.total*100):0}get backupInProgressLabel(){return this._progress?this.i18n`${this._progress.finished} of ${this._progress.total}`:this.i18n`…`}cancelBackup(){var e,t;(t=(e=this._keyBackup)==null?void 0:e.operationInProgress)==null||t.abort()}startBackup(){this.logger.run("KeyBackupViewModel.startBackup",e=>{var t;(t=this._keyBackup)==null||t.flush(e)})}}class Yu extends v{constructor(e){super(e),this.featureViewModels=[new Cr(this.childOptions({name:this.i18n`Audio/video calls`,description:this.i18n`Allows starting and participating in A/V calls compatible with Element Call (MSC3401). Look for the start call option in the room menu ((...) in the right corner) to start a call.`,feature:ci.Calls})),new Cr(this.childOptions({name:this.i18n`Cross-Signing`,description:this.i18n`Allows verifying the identity of people you chat with. This feature is still evolving constantly, expect things to break.`,feature:ci.CrossSigning}))]}}class Cr extends v{get enabled(){return this.features.isFeatureEnabled(this.getOption("feature"))}async enableFeature(e){let t;e?t=this.features.withFeature(this.getOption("feature")):t=this.features.withoutFeature(this.getOption("feature")),await t.store(this.platform.settingsStorage),this.platform.restart()}get id(){return`${this.getOption("feature")}`}get name(){return this.getOption("name")}get description(){return this.getOption("description")}}class Qu{constructor(){this.supported=null,this.enabled=!1,this.updating=!1,this.enabledOnServer=null,this.serverError=null}}function Xu(n){const t=Math.ceil(n.length/4);let s="";for(let i=0;i<t;i+=1)s+=(s.length?" ":"")+n.slice(i*4,(i+1)*4);return s}class Zu extends v{constructor(e){super(e),this._updateService=e.updateService;const{client:t}=e;this._client=t,this._keyBackupViewModel=this.track(new Ju(this.childOptions({session:this._session}))),this._closeUrl=this.urlRouter.urlUntilSegment("session"),this._estimate=null,this.sentImageSizeLimit=null,this.minSentImageSizeLimit=400,this.maxSentImageSizeLimit=4e3,this.pushNotifications=new Qu,this._activeTheme=void 0,this._logsFeedbackMessage=void 0,this._featuresViewModel=new Yu(this.childOptions())}get _session(){return this._client.session}async logout(){this.navigation.push("logout",this._client.sessionId)}setSentImageSizeLimit(e){e>this.maxSentImageSizeLimit||e<this.minSentImageSizeLimit?(this.sentImageSizeLimit=null,this.platform.settingsStorage.remove("sentImageSizeLimit")):(this.sentImageSizeLimit=Math.round(e),this.platform.settingsStorage.setInt("sentImageSizeLimit",e)),this.emitChange("sentImageSizeLimit")}async load(){this._estimate=await this.platform.estimateStorageUsage(),this.sentImageSizeLimit=await this.platform.settingsStorage.getInt("sentImageSizeLimit"),this.pushNotifications.supported=await this.platform.notificationService.supportsPush(),this.pushNotifications.enabled=await this._session.arePushNotificationsEnabled(),this._activeTheme=await this.platform.themeLoader.getActiveTheme(),this.emitChange("")}get closeUrl(){return this._closeUrl}get fingerprintKey(){const e=this._session.fingerprintKey;return e?Xu(e):null}get deviceId(){return this._session.deviceId}get userId(){return this._session.userId}get version(){const{updateService:e}=this.platform;return e?`${e.version} (${e.buildHash})`:this.i18n`development version`}checkForUpdate(){var e;(e=this.platform.updateService)==null||e.checkForUpdate()}get showUpdateButton(){return!!this.platform.updateService}get keyBackupViewModel(){return this._keyBackupViewModel}get featuresViewModel(){return this._featuresViewModel}get storageQuota(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.quota)}get storageUsage(){var e;return this._formatBytes((e=this._estimate)==null?void 0:e.usage)}get themeMapping(){return this.platform.themeLoader.themeMapping}get activeTheme(){return this._activeTheme}_formatBytes(e){return typeof e=="number"?Math.round(e/(1024*1024)).toFixed(1)+" MB":this.i18n`unknown`}async exportLogs(){const e=await this.exportLogsBlob();this.platform.saveFileAs(e,`hydrogen-logs-${this.platform.clock.now()}.json`)}async exportLogsBlob(){return(await this.logger.reporters.find(s=>typeof s.export=="function").export()).asBlob()}get canSendLogsToServer(){return!!this.platform.config.bugReportEndpointUrl}get logsServer(){const{bugReportEndpointUrl:e}=this.platform.config;try{if(e)return new URL(e).hostname}catch{}return""}async sendLogsToServer(){this._logsFeedbackMessage=this.i18n`Sending logs…`;try{await qn(this._session,this.platform),this._logsFeedbackMessage=this.i18n`Logs sent succesfully!`}catch(e){this._logsFeedbackMessage=e.message,this.emitChange()}}get logsFeedbackMessage(){return this._logsFeedbackMessage}async togglePushNotifications(){this.pushNotifications.updating=!0,this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null,this.emitChange("pushNotifications.updating");try{await this._session.enablePushNotifications(!this.pushNotifications.enabled)&&(this.pushNotifications.enabled=!this.pushNotifications.enabled,this.pushNotifications.enabled&&this.platform.notificationService.showNotification(this.i18n`Push notifications are now enabled`))}finally{this.pushNotifications.updating=!1,this.emitChange("pushNotifications.updating")}}async checkPushEnabledOnServer(){this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null;try{this.pushNotifications.enabledOnServer=await this._session.checkPusherEnabledOnHomeserver(),this.emitChange("pushNotifications.enabledOnServer")}catch(e){this.pushNotifications.serverError=e,this.emitChange("pushNotifications.serverError")}}changeThemeOption(e,t){this.platform.themeLoader.setTheme(e,t),this.emitChange("themeOption")}}class em extends v{constructor(e){super(e);const{session:t}=e;this._session=t,this._name=void 0,this._topic=void 0,this._roomAlias=void 0,this._isPublic=!1,this._isEncrypted=!0,this._isAdvancedShown=!1,this._isFederationDisabled=!1,this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0,this._closeUrl=this.urlRouter.urlUntilSegment("session")}get isPublic(){return this._isPublic}get isEncrypted(){return this._isEncrypted}get canCreate(){return!!this._name}avatarUrl(){return this._avatarScaledBlob.url}get avatarTitle(){return this._name}get avatarLetter(){return""}get avatarColorNumber(){return 0}get hasAvatar(){return!!this._avatarScaledBlob}get isFederationDisabled(){return this._isFederationDisabled}get isAdvancedShown(){return this._isAdvancedShown}get closeUrl(){return this._closeUrl}setName(e){this._name=e,this.emitChange("canCreate")}setRoomAlias(e){this._roomAlias=e}setTopic(e){this._topic=e}setPublic(e){this._isPublic=e,this.emitChange("isPublic")}setEncrypted(e){this._isEncrypted=e,this.emitChange("isEncrypted")}setFederationDisabled(e){this._isFederationDisabled=e,this.emitChange("isFederationDisabled")}toggleAdvancedShown(){this._isAdvancedShown=!this._isAdvancedShown,this.emitChange("isAdvancedShown")}create(){var s,i;let e;this._avatarScaledBlob&&(e={info:this._avatarInfo,name:this._avatarFileName,blob:this._avatarScaledBlob});const t=this._session.createRoom({type:this.isPublic?Z.Public:Z.Private,name:(s=this._name)!=null?s:void 0,topic:(i=this._topic)!=null?i:void 0,isEncrypted:!this.isPublic&&this._isEncrypted,isFederationDisabled:this._isFederationDisabled,alias:this.isPublic?tm(this._roomAlias):void 0,avatar:e});this.navigation.push("room",t.id)}async selectAvatar(){if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}this._avatarScaledBlob&&this._avatarScaledBlob.dispose(),this._avatarScaledBlob=void 0,this._avatarFileName=void 0,this._avatarInfo=void 0;const e=await this.platform.openFile("image/*");if(!e||!e.blob.mimeType.startsWith("image/")){this.emitChange("hasAvatar");return}let t=await this.platform.loadImage(e.blob);const s=800;if(t.maxDimension>s){const i=await t.scale(s);t.dispose(),t=i}this._avatarScaledBlob=t.blob,this._avatarInfo=qt(t),this._avatarFileName=e.name,this.emitChange("hasAvatar")}}function tm(n){n.startsWith("#")&&(n=n.substr(1));const e=n.indexOf(":");return e!==-1&&(n=n.substr(0,e)),n}class sm extends v{constructor(e){super(e),this._joinInProgress=!1,this._session=e.session,this._closeUrl=this.urlRouter.urlUntilSegment("session")}get closeUrl(){return this._closeUrl}async join(e){this._error=void 0,this._joinInProgress=!0,this.emitChange("joinInProgress");try{const t=await Yn(e,this._session);this.navigation.push("room",t)}catch(t){this._error=t,this._joinInProgress=!1,this.emitChange("error")}}get joinInProgress(){return this._joinInProgress}get status(){if(this._error)return this._error.message;if(this._joinInProgress)return"Joining room"}}class im extends v{async cancel(){await this.options.sas.abort()}get title(){const e=this.getOption("sas").isCrossSigningAnotherUser?"Waiting for the other user to accept the verification request":"Waiting for any of your device to accept the verification request";return this.i18n`${e}`}get description(){const e=this.getOption("sas").isCrossSigningAnotherUser?"Ask the other user to accept the request from their client!":"Accept the request from the device you wish to verify!";return this.i18n`${e}`}get kind(){return"waiting-for-user"}}class Qn extends le{dismiss(){if(this.getOption("sas").isCrossSigningAnotherUser){const e=this.navigation.path.until("room");this.navigation.applyPath(e)}else this.navigation.push("settings",!0)}}class rm extends Qn{get cancelCode(){return this.options.cancellation.code}get isCancelledByUs(){return this.options.cancellation.cancelledByUs}get kind(){return"verification-cancelled"}get title(){return this.isCancelledByUs?this.i18n`You cancelled the verification!`:this.getOption("sas").isCrossSigningAnotherUser?this.i18n`The other user cancelled the verification!`:this.i18n`The other device cancelled the verification!`}get description(){var a;const e={[f.InvalidMessage]:"Your other device sent an invalid message.",[f.KeyMismatch]:"The key could not be verified.",[f.TimedOut]:"The verification process timed out.",[f.UnexpectedMessage]:"Your other device sent an unexpected message.",[f.UnknownMethod]:"Your other device is using an unknown method for verification.",[f.UnknownTransaction]:"Your other device sent a message with an unknown transaction id.",[f.UserMismatch]:"The expected user did not match the user verified.",[f.MismatchedCommitment]:"The hash commitment does not match.",[f.MismatchedSAS]:"The emoji/decimal did not match."},t={[f.UserCancelled]:"Your other device cancelled the verification!",[f.InvalidMessage]:"Invalid message sent to the other device.",[f.KeyMismatch]:"The other device could not verify our keys",[f.TimedOut]:"The verification process timed out.",[f.UnexpectedMessage]:"Unexpected message sent to the other device.",[f.UnknownMethod]:"Your other device does not understand the method you chose",[f.UnknownTransaction]:"Your other device rejected our message.",[f.UserMismatch]:"The expected user did not match the user verified.",[f.MismatchedCommitment]:"Your other device was not able to verify the hash commitment",[f.MismatchedSAS]:"The emoji/decimal did not match."},s={[f.InvalidMessage]:"The other user sent an invalid message.",[f.KeyMismatch]:"The key could not be verified.",[f.TimedOut]:"The verification process timed out.",[f.UnexpectedMessage]:"The other user sent an unexpected message.",[f.UnknownMethod]:"The other user is using an unknown method for verification.",[f.UnknownTransaction]:"The other user sent a message with an unknown transaction id.",[f.UserMismatch]:"The expected user did not match the user verified.",[f.MismatchedCommitment]:"The hash commitment does not match.",[f.MismatchedSAS]:"The emoji/decimal did not match."},i={[f.UserCancelled]:"The other user cancelled the verification!",[f.InvalidMessage]:"Invalid message sent to the other user.",[f.KeyMismatch]:"The other user could not verify our keys",[f.TimedOut]:"The verification process timed out.",[f.UnexpectedMessage]:"Unexpected message sent to the other user.",[f.UnknownMethod]:"The other user does not understand the method you chose",[f.UnknownTransaction]:"The other user rejected our message.",[f.UserMismatch]:"The expected user did not match the user verified.",[f.MismatchedCommitment]:"The other user was not able to verify the hash commitment",[f.MismatchedSAS]:"The emoji/decimal did not match."};let r;this.getOption("sas").isCrossSigningAnotherUser?r=this.isCancelledByUs?s:i:r=this.isCancelledByUs?e:t;const o=(a=r[this.cancelCode])!=null?a:"";return this.i18n`${o}`}}class nm extends le{constructor(){super(...arguments),this.hasProceeded=!1}async proceed(){await this.logAndCatch("SelectMethodViewModel.proceed",async e=>{await this.options.stage.selectEmojiMethod(e),this.hasProceeded=!0,this.emitChange("hasProceeded")})}async cancel(){await this.logAndCatch("SelectMethodViewModel.cancel",async()=>{await this.options.sas.abort()})}get deviceName(){return this.options.stage.otherDeviceName}get otherUserId(){return this.getOption("sas").otherUserId}get kind(){return"select-method"}get isCrossSigningAnotherUser(){return this.getOption("sas").isCrossSigningAnotherUser}}class om extends le{constructor(){super(...arguments),this._isWaiting=!1}async setEmojiMatch(e){await this.logAndCatch("VerifyEmojisViewModel.setEmojiMatch",async()=>{await this.options.stage.setEmojiMatch(e),this._isWaiting=!0,this.emitChange("isWaiting")})}get emojis(){return this.options.stage.emoji}get kind(){return"verify-emojis"}get isWaiting(){return this._isWaiting}}class am extends Qn{get otherDeviceId(){return this.options.deviceId}get otherUsername(){return this.getOption("sas").otherUserId}get kind(){return"verification-completed"}get verificationSuccessfulMessage(){return this.getOption("sas").isCrossSigningAnotherUser?this.i18n`You successfully verified user ${this.otherUsername}`:this.i18n`You successfully verified device ${this.otherDeviceId}`}}class cm extends v{gotoSettings(){this.navigation.push("settings",!0)}get kind(){return"keys-missing"}}const Rr=["m.cross_signing.master","m.cross_signing.self_signing","m.cross_signing.user_signing"];class Xn extends le{constructor(e){super(e),this.start(e)}async start(e){var i,r;const t=e.room;let s;s=(r=(i=e.request)!=null?i:e.userId)!=null?r:this.getOption("session").userId,await this.startVerification(s,t)}async startVerification(e,t){await this.logAndCatch("DeviceVerificationViewModel.startVerification",async s=>{const r=await this.getOption("session").crossSigning.waitFor(o=>!!o).promise;if(this.sas=r.startVerification(e,t,s),!this.sas)throw new Error("CrossSigning.startVerification did not return a sas object!");if(!!await this.performPreVerificationChecks(r,e,s))return this.addEventListeners(),typeof e=="string"&&this.updateCurrentStageViewModel(new im(this.childOptions({sas:this.sas}))),this.sas.isCrossSigningAnotherUser?r.signUser(this.sas,s):r.signDevice(this.sas,s)})}async performPreVerificationChecks(e,t,s){return await s.wrap("DeviceVerificationViewModel.performPreVerificationChecks",async i=>{const r=await e.areWeVerified(s),a=(typeof t=="string"?t:t.sender)===this.getOption("session").userId;if(this._needsToRequestSecret=a&&!r,this._needsToRequestSecret)return!0;const c=this.getOption("session"),h=Rr.map(d=>c.secretFetcher.getSecret(d)),l=await Promise.all(h);for(const d of l)if(!d)return this.updateCurrentStageViewModel(new cm(this.childOptions({}))),!1;return!0})}addEventListeners(){this.track(this.sas.disposableOn("SelectVerificationStage",e=>{this.updateCurrentStageViewModel(new nm(this.childOptions({sas:this.sas,stage:e})))})),this.track(this.sas.disposableOn("EmojiGenerated",e=>{this.updateCurrentStageViewModel(new om(this.childOptions({stage:e})))})),this.track(this.sas.disposableOn("VerificationCancelled",e=>{this.updateCurrentStageViewModel(new rm(this.childOptions({cancellation:e,sas:this.sas})))})),this.track(this.sas.disposableOn("VerificationCompleted",e=>{this.updateCurrentStageViewModel(new am(this.childOptions({deviceId:e,sas:this.sas}))),this.requestSecrets()}))}async requestSecrets(){await this.platform.logger.run("DeviceVerificationViewModel.requestSecrets",async e=>{if(this._needsToRequestSecret){const t=this.getOption("session").secretSharing,s=Rr.map(a=>t.requestSecret(a,e)),r=(await Promise.all(s)).map(a=>a.waitForResponse());await Promise.all(r),this.getOption("session").crossSigning.get().start(e)}})}updateCurrentStageViewModel(e){this._currentStageViewModel=this.disposeTracked(this._currentStageViewModel),this._currentStageViewModel=this.track(e),this.emitChange("currentStageViewModel")}dispose(){this.sas&&!this.sas.finished&&this.sas.abort().catch(e=>{console.error(e)}),super.dispose()}get currentStageViewModel(){return this._currentStageViewModel}get type(){return"verification"}get isHappeningInRoom(){return!!this.navigation.path.get("room")}}class Er extends Ee{constructor(e,t){super(null),this._statusSubscription=null,this._sessionViewModel=e,this.id=t}async initialize(){const{session:e}=this._sessionViewModel._client,t=await e.observeRoomStatus(this.id);this.set(await this._statusToViewModel(t.get())),this._statusSubscription=t.subscribe(async s=>{var i;(i=this.get())==null||i.dispose(),this.set(await this._statusToViewModel(s))})}async _statusToViewModel(e){if(e&V.Replaced)if(e&V.BeingCreated){const{session:t}=this._sessionViewModel._client,s=t.roomsBeingCreated.get(this.id);this._sessionViewModel.notifyRoomReplaced(s.id,s.roomId)}else throw new Error("Don't know how to replace a room with this status: "+(e^V.Replaced));else return e&V.BeingCreated?this._sessionViewModel._createRoomBeingCreatedViewModel(this.id):e&V.Invited?this._sessionViewModel._createInviteViewModel(this.id):e&V.Joined?this._sessionViewModel._createRoomViewModelInstance(this.id):e&V.Archived?await this._sessionViewModel._createArchivedRoomViewModel(this.id):this._sessionViewModel._createUnknownRoomViewModel(this.id)}dispose(){var e;this._statusSubscription&&(this._statusSubscription=this._statusSubscription()),this.unsubscribeAll(),(e=this.get())==null||e.dispose()}}class hm extends v{constructor(e){super(e),this._room=e.room,this._onRoomChange=this._onRoomChange.bind(this),this._room.on("change",this._onRoomChange)}get type(){return"room-details"}get shouldShowBackButton(){return!1}get previousSegmentName(){return!1}get roomId(){return this._room.id}get canonicalAlias(){return this._room.canonicalAlias}get name(){return this._room.name}get isEncrypted(){return!!this._room.isEncrypted}get memberCount(){return this._room.joinedMemberCount}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this._room.avatarColorId)}avatarUrl(e){return te(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}_onRoomChange(){this.emitChange()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange)}openPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}class lm extends v{constructor(e){super(e),this._member=this._options.member,this._mediaRepository=e.mediaRepository,this._previousName=null,this._nameChanged=!0}get name(){return`${this._member.name}${this._disambiguationPart}`}get _disambiguationPart(){return this._disambiguate?` (${this.userId})`:""}get userId(){return this._member.userId}get previousName(){return this._previousName}get nameChanged(){return this._nameChanged}get detailsUrl(){const e=this.navigation.path.get("room").value;return`${this.urlRouter.openRoomActionUrl(e)}/member/${encodeURIComponent(this._member.userId)}`}_updatePreviousName(e){const t=this._member.name;t!==e?(this._previousName=t,this._nameChanged=!0):this._nameChanged=!1}setDisambiguation(e){this._disambiguate=e,this.emitChange()}updateFrom(e){this._updatePreviousName(e.name),this._member=e}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this.userId)}avatarUrl(e){return te(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}}function dm(n){const e=new Intl.Collator,t=s=>s.charAt(0)==="@"?s.slice(1):s;return function(i,r){const o=n.getUserLevel(i.userId),a=n.getUserLevel(r.userId);if(o!==a)return a-o;const c=t(i.name),h=t(r.name);return e.compare(c,h)}}class um{constructor(){this._map=new Map}_unDisambiguate(e,t){const s=t.indexOf(e);if(s!==-1){const[i]=t.splice(s,1);i.setDisambiguation(!1)}}_handlePreviousName(e){const t=e.previousName;if(typeof t!="string")return;const s=this._map.get(t);if(Array.isArray(s)){if(this._unDisambiguate(e,s),s.length===1){const i=s[0];i.setDisambiguation(!1),this._map.set(t,i)}}else this._map.delete(t)}_updateMap(e){const t=e.name,s=this._map.get(t);if(s){if(Array.isArray(s))return s.findIndex(i=>i.userId===e.userId)!==-1?void 0:(s.push(e),s);if(e.userId!==s.userId){const i=[s,e];return this._map.set(t,i),i}}else this._map.set(t,e)}disambiguate(e){if(!e.nameChanged)return;this._handlePreviousName(e);const t=this._updateMap(e);t==null||t.forEach(s=>s.setDisambiguation(!0))}}class mm extends v{constructor(e){super(e);const t=e.members,s=e.powerLevelsObservable;this.track(s.subscribe(()=>{}));const i=s.get();this.memberTileViewModels=this._mapTileViewModels(t.members.filterValues(r=>r.membership==="join")).sortValues(dm(i)),this.nameDisambiguator=new um,this.mediaRepository=e.mediaRepository}get type(){return"member-list"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"details"}_mapTileViewModels(e){const t=(i,r)=>{const o=this.mediaRepository,a=new lm(this.childOptions({member:i,emitChange:r,mediaRepository:o}));return this.nameDisambiguator.disambiguate(a),a},s=(i,r,o)=>{r.updateFrom(o),this.nameDisambiguator.disambiguate(r)};return e.mapValues(t,s)}openInvitePanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("invite",!0)),this.navigation.applyPath(e)}}class pm extends v{constructor(e){super(e),this._observableMember=e.observableMember,this._mediaRepository=e.mediaRepository,this._member=this._observableMember.get(),this._isEncrypted=e.isEncrypted,this._powerLevelsObservable=e.powerLevelsObservable,this._session=e.session,this.track(this._powerLevelsObservable.subscribe(()=>this._onPowerLevelsChange())),this.track(this._observableMember.subscribe(()=>this._onMemberChange())),this._userTrust=void 0,this._userTrustSubscription=void 0,this.features.crossSigning&&this.track(this._session.crossSigning.subscribe(()=>{this._onCrossSigningChange()})),this._onCrossSigningChange()}get name(){return this._member.name}get userId(){return this._member.userId}get canVerifyUser(){return this._member.userId!==this._session.userId}get trustDescription(){var e;switch((e=this._userTrust)==null?void 0:e.get()){case ne.Trusted:return this.i18n`You have verified this user. This user has verified all of their sessions.`;case ne.UserNotSigned:return this.i18n`You have not verified this user.`;case ne.UserSignatureMismatch:return this.i18n`You appear to have signed this user, but the signature is invalid.`;case ne.UserDeviceNotSigned:return this.i18n`You have verified this user, but they have one or more unverified sessions.`;case ne.UserDeviceSignatureMismatch:return this.i18n`This user has a session signature that is invalid.`;case ne.UserSetupError:return this.i18n`This user hasn't set up cross-signing correctly`;case ne.OwnSetupError:return this.i18n`Cross-signing wasn't set up correctly on your side.`;case void 0:default:return this.i18n`Please wait…`}}get trustShieldColor(){var e;if(!this._isEncrypted)return"";switch((e=this._userTrust)==null?void 0:e.get()){case void 0:case ne.OwnSetupError:return"";case ne.Trusted:return"green";case ne.UserNotSigned:return"black";default:return"red"}}get type(){return"member-details"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get role(){return this.powerLevel>=100?this.i18n`Admin`:this.powerLevel>=50?this.i18n`Moderator`:this.powerLevel===0?this.i18n`Default`:this.i18n`Custom (${this.powerLevel})`}_onMemberChange(){this._member=this._observableMember.get(),this.emitChange("member")}_onPowerLevelsChange(){this.emitChange("role")}async signUser(){const e=this._session.crossSigning.get();e&&await this.logger.run("MemberDetailsViewModel.signUser",async t=>{await e.signUser(this.userId,t)})}async verifyUser(){await this.logger.run("MemberDetailsViewModel.verifyUser",async()=>{const e=this._session.findDirectMessageForUserId(this.userId);let t=e==null?void 0:e.id;t||(t=(await this._session.createRoom({type:Z.DirectMessage,invites:[this.userId]})).roomId),await(await this._session.observeRoomStatus(t)).waitFor(r=>r===V.Joined).promise;let i=this.navigation.path.until("session");i=i.with(this.navigation.segment("room",t)),i=i.with(this.navigation.segment("right-panel",!0)),i=i.with(this.navigation.segment("verification",this.userId)),this.navigation.applyPath(i)})}get avatarLetter(){return W(this.name)}get avatarColorNumber(){return G(this.userId)}avatarUrl(e){return te(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}get isEncrypted(){return this._isEncrypted}get powerLevel(){var e;return(e=this._powerLevelsObservable.get())==null?void 0:e.getUserLevel(this._member.userId)}get linkToUser(){return`https://matrix.to/#/${encodeURIComponent(this._member.userId)}`}async openDirectMessage(){const e=this._session.findDirectMessageForUserId(this.userId);let t=e==null?void 0:e.id;t||(t=(await this._session.createRoom({type:Z.DirectMessage,invites:[this.userId]})).id),this.navigation.push("room",t)}_onCrossSigningChange(){const e=this._session.crossSigning.get();this._userTrustSubscription=this.disposeTracked(this._userTrustSubscription),this._userTrust=void 0,e&&this.logger.run("MemberDetailsViewModel.observeUserTrust",t=>{this._userTrust=e.observeUserTrust(this.userId,t),this._userTrustSubscription=this.track(this._userTrust.subscribe(()=>{this.emitChange("trustShieldColor")}))}),this.emitChange("trustShieldColor")}}class _m extends le{constructor(e){super(e)}get type(){return"invite"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get roomName(){return this.getOption("room").name}async invite(e){await this.logAndCatch("InvitePanelViewModel.invite",async()=>{await this.getOption("room").inviteUser(e);const s=this.navigation.path.until("room");this.navigation.applyPath(s)})}}class gm extends v{constructor(e){super(e),this._room=e.room,this._session=e.session,this._members=null,this._setupNavigation()}get activeViewModel(){return this._activeViewModel}async _getMemberListArguments(){this._members||(this._members=await this._room.loadMemberList(),this.track(()=>this._members.release()));const e=this._room,t=await this._room.observePowerLevels();return{members:this._members,powerLevelsObservable:t,mediaRepository:e.mediaRepository}}async _getMemberDetailsArguments(){const t=this.navigation.path.get("member").value,s=await this._room.observeMember(t);if(!s)return!1;const i=this._room.isEncrypted,r=await this._room.observePowerLevels();return{observableMember:s,isEncrypted:i,powerLevelsObservable:r,mediaRepository:this._room.mediaRepository,session:this._session}}_setupNavigation(){this._hookUpdaterToSegment("details",hm,()=>({room:this._room})),this._hookUpdaterToSegment("invite",_m,()=>({room:this._room})),this._hookUpdaterToSegment("members",mm,()=>this._getMemberListArguments()),this._hookUpdaterToSegment("member",pm,()=>this._getMemberDetailsArguments(),()=>{const e=`${this.urlRouter.urlUntilSegment("room")}/members`;this.urlRouter.pushUrl(e)}),this._hookUpdaterToSegment("verification",Xn,()=>{var s,i;const e={session:this._session,room:this._room},t=this.navigation.path.get("verification").value;if(typeof t=="string"){const r=(i=(s=this._session)==null?void 0:s.crossSigning.get())==null?void 0:i.receivedSASVerifications.get(t);Object.assign(e,r?{request:r}:{userId:t})}return e})}async _hookUpdaterToSegment(e,t,s,i){const r=this.navigation.observe(e),o=await this._setupUpdater(e,t,s,i);this.track(r.subscribe(o))}async _setupUpdater(e,t,s,i){const r=async(o=!1)=>{var c;if(this._activeViewModel instanceof t)return;if(o||(this._activeViewModel=this.disposeTracked(this._activeViewModel)),!!((c=this.navigation.path.get(e))!=null&&c.value)){const h=await s();if(!h&&i){i();return}this._activeViewModel=this.track(new t(this.childOptions(h)))}this.emitChange("activeViewModel")};return await r(!0),r}closePanel(){const e=this.navigation.path.until("room");this.navigation.applyPath(e)}showPreviousPanel(){const e=this.activeViewModel.previousSegmentName;if(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}}class Zn extends le{constructor(e){super(e)}dismiss(){this.getOption("dismiss")()}}class fm extends Zn{constructor(e){super(e),this.track(this.call.members.observeSize().subscribe(()=>{this.emitChange("memberCount")})),this.track(this.navigation.observe("room").subscribe(t=>{t===this.call.roomId&&this.dismiss()}))}get kind(){return"calls"}async join(){await this.logAndCatch("CallToastNotificationViewModel.join",async e=>{const t=await this.platform.mediaDevices.getMediaTracks(!1,!0),s=new Ce().withUserMedia(t);await this.call.join(s,e);const i=this.urlRouter.openRoomActionUrl(this.call.roomId);this.urlRouter.pushUrl(i)})}get call(){return this.getOption("call")}get room(){return this.getOption("room")}get roomName(){return this.room.name}get memberCount(){return this.call.members.size}get avatarLetter(){return W(this.roomName)}get avatarColorNumber(){return G(this.room.avatarColorId)}avatarUrl(e){return te(this.room.avatarUrl,e,this.platform,this.room.mediaRepository)}get avatarTitle(){return this.roomName}}class ym extends v{constructor(e){super(e),this.toastViewModels=new ui;const t=this.getOption("session");if(this.features.calls){const s=t.callHandler.calls;this.track(s.subscribe(this))}}async onAdd(e,t){if(this._shouldShowNotification(t)){const s=await this._findRoomForCall(t),i=()=>{const r=this.toastViewModels.array.findIndex(o=>o.call===t);r!==-1&&this.toastViewModels.remove(r)};this.toastViewModels.append(new fm(this.childOptions({call:t,room:s,dismiss:i})))}}onRemove(e,t){const s=this.toastViewModels.array.findIndex(i=>i.call===t);s!==-1&&this.toastViewModels.remove(s)}onUpdate(e,t){const s=this.toastViewModels.array.findIndex(i=>i.call===t);s!==-1&&this.toastViewModels.update(s,this.toastViewModels.at(s))}onReset(){for(let e=0;e<this.toastViewModels.length;++e)this.toastViewModels.remove(e)}async _findRoomForCall(e){const t=e.roomId,s=this.getOption("session"),i=s.rooms;return await(await s.observeRoomStatus(t)).waitFor(a=>a===V.Joined).promise,i.get(t)}_shouldShowNotification(e){var s;const t=(s=this.navigation.path.get("room"))==null?void 0:s.value;return!e.isLoadedFromStorage&&e.roomId!==t&&!e.usesFoci}}class wm extends Zn{constructor(e){super(e)}get kind(){return"verification"}get request(){return this.getOption("request")}get otherDeviceId(){return this.request.deviceId}accept(){this.navigation.push("device-verification",this.request.id),this.dismiss()}}class vm extends v{constructor(e){super(e),this.toastViewModels=new ui,this.subscribeToSASRequests()}async subscribeToSASRequests(){await this.getOption("session").crossSigning.waitFor(t=>!!t).promise;const e=this.getOption("session").crossSigning.get();this.track(e.receivedSASVerifications.subscribe(this))}async onAdd(e,t){if(t.sender!==this.getOption("session").userId)return;const s=()=>{const i=this.toastViewModels.array.findIndex(r=>r.request.id===t.id);i!==-1&&this.toastViewModels.remove(i)};this.toastViewModels.append(this.track(new wm(this.childOptions({request:t,dismiss:s}))))}onRemove(e,t){const s=this.toastViewModels.array.findIndex(i=>i.request.id===t.id);s!==-1&&this.toastViewModels.remove(s)}onUpdate(e,t){const s=this.toastViewModels.array.findIndex(i=>i.request.id===t.id);s!==-1&&this.toastViewModels.update(s,this.toastViewModels.at(s))}onReset(){for(let e=0;e<this.toastViewModels.length;++e)this.toastViewModels.remove(e)}}class bm extends v{constructor(e){super(e);const t=this.getOption("session"),s=[];this.features.calls&&s.push(this.track(new ym(this.childOptions({session:t})))),this.features.crossSigning&&s.push(this.track(new vm(this.childOptions({session:t}))));const i=s.map(r=>r.toastViewModels);i.length!==0&&(this.toastViewModels=new Hr(...i))}}class Sm extends v{constructor(e){super(e);const{client:t}=e;this._client=this.track(t),this._sessionStatusViewModel=this.track(new Gu(this.childOptions({sync:t.sync,reconnector:t.reconnector,session:t.session}))),this._leftPanelViewModel=this.track(new Wd(this.childOptions({session:this._client.session}))),this._settingsViewModel=null,this._roomViewModelObservable=null,this._gridViewModel=null,this._createRoomViewModel=null,this._joinRoomViewModel=null,this._verificationViewModel=null,this._toastCollectionViewModel=this.track(new bm(this.childOptions({session:this._client.session}))),this._setupNavigation(),this._setupForcedLogoutOnAccessTokenInvalidation()}_setupNavigation(){const e=this.navigation.observe("rooms");this.track(e.subscribe(c=>{this._updateGrid(c)})),e.get()&&this._updateGrid(e.get());const t=this.navigation.observe("room");this.track(t.subscribe(c=>{this._gridViewModel||this._updateRoom(c),this._updateRightPanel()})),this._gridViewModel||this._updateRoom(t.get());const s=this.navigation.observe("settings");this.track(s.subscribe(c=>{this._updateSettings(c)})),this._updateSettings(s.get());const i=this.navigation.observe("create-room");this.track(i.subscribe(c=>{this._updateCreateRoom(c)})),this._updateCreateRoom(i.get());const r=this.navigation.observe("join-room");if(this.track(r.subscribe(c=>{this._updateJoinRoom(c)})),this._updateJoinRoom(r.get()),this.features.crossSigning){const c=this.navigation.observe("device-verification");this.track(c.subscribe(h=>{this._updateVerification(h)})),this._updateVerification(c.get())}const o=this.navigation.observe("lightbox");this.track(o.subscribe(c=>{this._updateLightbox(c)})),this._updateLightbox(o.get());const a=this.navigation.observe("right-panel");this.track(a.subscribe(()=>this._updateRightPanel())),this._updateRightPanel()}_setupForcedLogoutOnAccessTokenInvalidation(){this.track(this._client.sync.status.subscribe(e=>{if(e===A.Stopped){const t=this._client.sync.error;if((t==null?void 0:t.errcode)==="M_UNKNOWN_TOKEN"){const s=[this.navigation.segment("logout",this.id),this.navigation.segment("forced",!0)],i=this.navigation.pathFrom(s);this.navigation.applyPath(i)}}}))}get id(){return this._client.sessionId}start(){this._sessionStatusViewModel.start(),this.features.calls&&(this._client.session.callHandler.loadCalls("m.ring"),this._client.session.callHandler.loadCalls("m.prompt"))}get activeMiddleViewModel(){var e;return((e=this._roomViewModelObservable)==null?void 0:e.get())||this._gridViewModel||this._settingsViewModel||this._createRoomViewModel||this._joinRoomViewModel||this._verificationViewModel}get roomGridViewModel(){return this._gridViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get sessionStatusViewModel(){return this._sessionStatusViewModel}get settingsViewModel(){return this._settingsViewModel}get currentRoomViewModel(){var e;return(e=this._roomViewModelObservable)==null?void 0:e.get()}get rightPanelViewModel(){return this._rightPanelViewModel}get createRoomViewModel(){return this._createRoomViewModel}get joinRoomViewModel(){return this._joinRoomViewModel}get verificationViewModel(){return this._verificationViewModel}get toastCollectionViewModel(){return this._toastCollectionViewModel}_updateGrid(e){var i;const t=!(this._gridViewModel&&e),s=this.navigation.path.get("room");if(e)this._gridViewModel?this._gridViewModel.setRoomIds(e):(this._gridViewModel=this.track(new zu(this.childOptions({width:3,height:2,createRoomViewModelObservable:r=>new Er(this,r)}))),(i=this._roomViewModelObservable)==null||i.unsubscribeAll(),this._gridViewModel.initializeRoomIdsAndTransferVM(e,this._roomViewModelObservable)?this._roomViewModelObservable=this.untrack(this._roomViewModelObservable):this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)));else if(this._gridViewModel&&!e){if(s){const r=this._gridViewModel.releaseRoomViewModel(s.value);r&&(this._roomViewModelObservable=this.track(r),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}))}this._gridViewModel=this.disposeTracked(this._gridViewModel)}t&&this.emitChange("activeMiddleViewModel")}_createRoomViewModelInstance(e){const t=this._client.session.rooms.get(e);if(t){const s=new kr(this.childOptions({room:t,session:this._client.session}));return s.load(),s}return null}_createUnknownRoomViewModel(e){return new $u(this.childOptions({roomIdOrAlias:e,session:this._client.session}))}async _createArchivedRoomViewModel(e){const t=await this._client.session.loadArchivedRoom(e);if(t){const s=new kr(this.childOptions({room:t,session:this._client.session}));return s.load(),s}return null}_createInviteViewModel(e){const t=this._client.session.invites.get(e);return t?new ju(this.childOptions({invite:t,mediaRepository:this._client.session.mediaRepository})):null}_createRoomBeingCreatedViewModel(e){const t=this._client.session.roomsBeingCreated.get(e);return t?new Hu(this.childOptions({roomBeingCreated:t,mediaRepository:this._client.session.mediaRepository})):null}_updateRoom(e){var s;if(((s=this._roomViewModelObservable)==null?void 0:s.id)===e)return;if(this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)),!e){this.emitChange("activeMiddleViewModel");return}const t=new Er(this,e);this._roomViewModelObservable=this.track(t),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}),t.initialize()}_updateSettings(e){this._settingsViewModel&&(this._settingsViewModel=this.disposeTracked(this._settingsViewModel)),e&&(this._settingsViewModel=this.track(new Zu(this.childOptions({client:this._client}))),this._settingsViewModel.load()),this.emitChange("activeMiddleViewModel")}_updateCreateRoom(e){this._createRoomViewModel&&(this._createRoomViewModel=this.disposeTracked(this._createRoomViewModel)),e&&(this._createRoomViewModel=this.track(new em(this.childOptions({session:this._client.session})))),this.emitChange("activeMiddleViewModel")}_updateJoinRoom(e){this._joinRoomViewModel&&(this._joinRoomViewModel=this.disposeTracked(this._joinRoomViewModel)),e&&(this._joinRoomViewModel=this.track(new sm(this.childOptions({session:this._client.session})))),this.emitChange("activeMiddleViewModel")}_updateVerification(e){var t;if(this._verificationViewModel&&(this._verificationViewModel=this.disposeTracked(this._verificationViewModel)),e){const s=(t=this._client.session.crossSigning.get())==null?void 0:t.receivedSASVerifications.get(e);this._verificationViewModel=this.track(new Xn(this.childOptions({session:this._client.session,request:s})))}this.emitChange("activeMiddleViewModel")}_updateLightbox(e){if(this._lightboxViewModel&&(this._lightboxViewModel=this.disposeTracked(this._lightboxViewModel)),e){const t=this._roomFromNavigation();this._lightboxViewModel=this.track(new Wu(this.childOptions({eventId:e,room:t})))}this.emitChange("lightboxViewModel")}get lightboxViewModel(){return this._lightboxViewModel}_roomFromNavigation(){var s;const e=(s=this.navigation.path.get("room"))==null?void 0:s.value;return this._client.session.rooms.get(e)}_updateRightPanel(){var t;if(this._rightPanelViewModel=this.disposeTracked(this._rightPanelViewModel),!!((t=this.navigation.path.get("right-panel"))!=null&&t.value)){const s=this._roomFromNavigation();this._rightPanelViewModel=this.track(new gm(this.childOptions({room:s,session:this._client.session})))}this.emitChange("rightPanelViewModel")}notifyRoomReplaced(e,t){this.navigation.push("room",t)}}class Im extends v{constructor(e){super(e),this._accountSetup=e.accountSetup,this._dehydratedDevice=void 0,this._decryptDehydratedDeviceViewModel=void 0,this._accountSetup.encryptedDehydratedDevice&&(this._decryptDehydratedDeviceViewModel=new km(this,t=>{this._dehydratedDevice=t,this._decryptDehydratedDeviceViewModel=void 0,this.emitChange("deviceDecrypted")}))}get decryptDehydratedDeviceViewModel(){return this._decryptDehydratedDeviceViewModel}get deviceDecrypted(){return!!this._dehydratedDevice}get dehydratedDeviceId(){return this._accountSetup.encryptedDehydratedDevice.deviceId}finish(){this._accountSetup.finish(this._dehydratedDevice)}}class km extends v{constructor(e,t){super(e.options),this._accountSetupViewModel=e,this._isBusy=!1,this._status=ae.SetupWithRecoveryKey,this._error=void 0,this._decryptedCallback=t}get decryptAction(){return this.i18n`Restore`}get purpose(){return this.i18n`claim your dehydrated device`}get offerDehydratedDeviceSetup(){return!1}get dehydratedDeviceId(){var e;return(e=this._accountSetupViewModel._dehydratedDevice)==null?void 0:e.deviceId}get isBusy(){return this._isBusy}get backupVersion(){return 0}get status(){return this._status}get error(){var e;return(e=this._error)==null?void 0:e.message}showPhraseSetup(){this._status===ae.SetupWithRecoveryKey&&(this._status=ae.SetupWithPassphrase,this.emitChange("status"))}showKeySetup(){this._status===ae.SetupWithPassphrase&&(this._status=ae.SetupWithRecoveryKey,this.emitChange("status"))}async _enterCredentials(e,t){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const{encryptedDehydratedDevice:s}=this._accountSetupViewModel._accountSetup,i=await s.decrypt(e,t);this._decryptedCallback(i)}catch(s){console.error(s),this._error=s,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange("")}}enterSecurityPhrase(e){this._enterCredentials(pe.Passphrase,e)}enterSecurityKey(e){this._enterCredentials(pe.RecoveryKey,e)}disable(){}}class eo extends v{constructor(e){super(e);const{client:t,ready:s,homeserver:i,deleteSessionOnCancel:r}=e;this._client=t,this._ready=s,this._homeserver=i,this._deleteSessionOnCancel=r,this._loading=!1,this._error=null,this.backUrl=this.urlRouter.urlForSegment("session",!0),this._accountSetupViewModel=void 0}async start(){if(!this._loading)try{this._loading=!0,this.emitChange("loading"),this._waitHandle=this._client.loadStatus.waitFor(s=>(s===k.AccountSetup?this._accountSetupViewModel=new Im(this.childOptions({accountSetup:this._client.accountSetup})):this._accountSetupViewModel=void 0,this.emitChange("loadLabel"),s===k.FirstSync&&this._client.sync.status.get()===A.CatchupSync||s===k.LoginFailed||s===k.Error||s===k.Ready));try{await this._waitHandle.promise}catch{return}const e=this._client.loadStatus.get(),t=this._client.loadError;if(e===k.FirstSync||e===k.Ready){const s=this._client;this._client=null,this._ready(s)}t&&console.error("session load error",t.stack)}catch(e){this._error=e,console.error("error thrown during session load",e.stack)}finally{this._loading=!1,this.emitChange("loading")}}dispose(){this._client&&(this._client.dispose(),this._client=null),this._waitHandle&&(this._waitHandle.dispose(),this._waitHandle=null)}get loading(){const e=this._client;return e&&e.loadStatus.get()===k.AccountSetup?!1:this._loading}get loadLabel(){const e=this._client,t=this._getError();if(t||e&&e.loadStatus.get()===k.Error)return`Something went wrong: ${t&&t.message}.`;if(e)switch(e.loadStatus.get()){case k.QueryAccount:return"Querying account encryption setup\u2026";case k.AccountSetup:return"";case k.SessionSetup:return"Setting up your encryption keys\u2026";case k.Loading:return"Loading your conversations\u2026";case k.FirstSync:return"Getting your conversations from the server\u2026";default:return this._client.loadStatus.get()}return"Preparing\u2026"}_getError(){var e;return this._error||((e=this._client)==null?void 0:e.loadError)}get hasError(){return!!this._getError()}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async logout(){await this._client.startLogout(this.navigation.path.get("session").value),this.navigation.push("session",!0)}get accountSetupViewModel(){return this._accountSetupViewModel}}class Mm extends v{constructor(e){super(e),this._isBusy=!1,this._errorMessage="";const{loginOptions:t,attemptLogin:s}=e;this._loginOptions=t,this._attemptLogin=s}get isBusy(){return this._isBusy}get errorMessage(){return this._errorMessage}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async login(e,t){this._errorMessage="",this.emitChange("errorMessage");const s=await this._attemptLogin(this._loginOptions.password(e,t));let i="";switch(s){case Ne.Credentials:i=this.i18n`Your username and/or password don't seem to be correct.`;break;case Ne.Connection:i=this.i18n`Can't connect to ${this._loginOptions.homeserver}.`;break;case Ne.Unknown:i=this.i18n`Something went wrong while checking your login and password.`;break}i&&this._showError(i)}}class Cm extends v{constructor(e){super(e),this._isBusy=!1,this._sso=e.loginOptions.sso,this._isBusy=!1}get isBusy(){return this._isBusy}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}async startSSOLogin(){await this.platform.settingsStorage.setString("sso_ongoing_login_homeserver",this._sso.homeserver);const e=this._sso.createSSORedirectURL(this.urlRouter.createSSOCallbackURL());this.platform.openUrl(e)}}class Rm extends v{constructor(e){super(e),this._errorMessage="";const{loginToken:t,client:s,attemptLogin:i}=e;this._loginToken=t,this._client=s,this._attemptLogin=i,this._errorMessage="",this.performSSOLoginCompletion()}get errorMessage(){return this._errorMessage}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async performSSOLoginCompletion(){if(!this._loginToken)return;const e=await this.platform.settingsStorage.getString("sso_ongoing_login_homeserver");let t;try{t=await this._client.queryLogin(e).result}catch(r){this._showError(r.message);return}if(!t.token){this.navigation.push("session");return}const s=await this._attemptLogin(t.token(this._loginToken));let i="";switch(s){case Ne.Credentials:i=this.i18n`Your login token is invalid.`;break;case Ne.Connection:i=this.i18n`Can't connect to ${e}.`;break;case Ne.Unknown:i=this.i18n`Something went wrong while checking your login token.`;break}i&&this._showError(i)}}class Em extends v{constructor(e){super(e),this._hideHomeserver=!1,this._isBusy=!1,this._errorMessage="";const{ready:t,defaultHomeserver:s,loginToken:i}=e;this._ready=t,this._loginToken=i,this._client=new Fs(this.platform,this.features),this._homeserver=s,this._initViewModels()}get passwordLoginViewModel(){return this._passwordLoginViewModel}get startSSOLoginViewModel(){return this._startSSOLoginViewModel}get completeSSOLoginViewModel(){return this._completeSSOLoginViewModel}get homeserver(){return this._homeserver}get resolvedHomeserver(){var e;return(e=this._loginOptions)==null?void 0:e.homeserver}get errorMessage(){return this._errorMessage}get showHomeserver(){return!this._hideHomeserver}get loadViewModel(){return this._loadViewModel}get isBusy(){return this._isBusy}get isFetchingLoginOptions(){return!!this._abortQueryOperation}goBack(){this.navigation.push("session")}_initViewModels(){this._loginToken?(this._hideHomeserver=!0,this._completeSSOLoginViewModel=this.track(new Rm(this.childOptions({client:this._client,attemptLogin:e=>this.attemptLogin(e),loginToken:this._loginToken}))),this.emitChange("completeSSOLoginViewModel")):this.queryHomeserver()}_showPasswordLogin(){this._passwordLoginViewModel=this.track(new Mm(this.childOptions({loginOptions:this._loginOptions,attemptLogin:e=>this.attemptLogin(e)}))),this.emitChange("passwordLoginViewModel")}_showSSOLogin(){this._startSSOLoginViewModel=this.track(new Cm(this.childOptions({loginOptions:this._loginOptions}))),this.emitChange("startSSOLoginViewModel")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}_setBusy(e){var t,s;this._isBusy=e,(t=this._passwordLoginViewModel)==null||t.setBusy(e),(s=this._startSSOLoginViewModel)==null||s.setBusy(e),this.emitChange("isBusy")}async attemptLogin(e){this._setBusy(!0),this._client.startWithLogin(e,{inspectAccountSetup:!0});const t=this._client.loadStatus;return await t.waitFor(r=>r!==k.Login).promise,this._setBusy(!1),t.get()===k.LoginFailed?this._client.loginFailure:(this._hideHomeserver=!0,this.emitChange("hideHomeserver"),this._disposeViewModels(),this._createLoadViewModel(),null)}_createLoadViewModel(){this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription),this._loadViewModel=this.disposeTracked(this._loadViewModel),this._loadViewModel=this.track(new eo(this.childOptions({ready:e=>{this._client=null,this._ready(e)},client:this._client,homeserver:this._homeserver}))),this._loadViewModel.start(),this.emitChange("loadViewModel"),this._loadViewModelSubscription=this.track(this._loadViewModel.disposableOn("change",()=>{this._loadViewModel.loading||(this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription)),this._setBusy(!1)}))}_disposeViewModels(){this._startSSOLoginViewModel=this.disposeTracked(this._startSSOLoginViewModel),this._passwordLoginViewModel=this.disposeTracked(this._passwordLoginViewModel),this._completeSSOLoginViewModel=this.disposeTracked(this._completeSSOLoginViewModel),this.emitChange("disposeViewModels")}async setHomeserver(e){this._homeserver=e,this._loginOptions=void 0,this._queriedHomeserver=void 0,this._showError(""),this._disposeViewModels(),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("loginViewModels"),this.disposeTracked(this._abortHomeserverQueryTimeout);const t=this.clock.createTimeout(1e3);this._abortHomeserverQueryTimeout=this.track(()=>t.abort());try{await t.elapsed()}catch(s){if(s.name==="AbortError")return;throw s}this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this.queryHomeserver()}async queryHomeserver(){if(!(this._homeserver===this._queriedHomeserver||this._homeserver==="")){this._queriedHomeserver=this._homeserver,this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation);try{const e=this._client.queryLogin(this._homeserver);this._abortQueryOperation=this.track(()=>e.abort()),this.emitChange("isFetchingLoginOptions"),this._loginOptions=await e.result,this.emitChange("resolvedHomeserver")}catch(e){if(e.name==="AbortError")return;this._loginOptions=void 0}finally{this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("isFetchingLoginOptions")}this._loginOptions?(this._loginOptions.sso&&this._showSSOLogin(),this._loginOptions.password&&this._showPasswordLogin(),!this._loginOptions.sso&&!this._loginOptions.password&&this._showError("This homeserver supports neither SSO nor password based login flows")):this._showError(`Could not query login methods supported by ${this.homeserver}`)}}dispose(){super.dispose(),this._client&&this._client.deleteSession()}}class Tm extends v{constructor(e){super(e),this._sessionId=e.sessionId,this._busy=!1,this._showConfirm=!0,this._error=void 0}get showConfirm(){return this._showConfirm}get busy(){return this._busy}get cancelUrl(){return this.urlRouter.urlForSegment("session",!0)}async logout(){this._busy=!0,this._showConfirm=!1,this.emitChange("busy");try{await new Fs(this.platform).startLogout(this._sessionId),this.navigation.push("session",!0)}catch(e){this._error=e,this._busy=!1,this.emitChange("busy")}}get status(){return this._error?this.i18n`Could not log out of device: ${this._error.message}`:this.i18n`Logging out… Please don't close the app.`}}class Am extends v{constructor(e){super(e),this._showStatus=!1,this._showSpinner=!1,this._sessionId=e.sessionId,this._logoutPromise=this.forceLogout()}async forceLogout(){try{await new Fs(this.platform).startForcedLogout(this._sessionId)}catch(e){this._error=e,this._showSpinner=!1,this._showStatus=!0,this.emitChange("error")}}async proceed(){this._showSpinner=!0,this._showStatus=!0,this.emitChange("showStatus"),await this._logoutPromise,this._error||this.navigation.push("login",!0)}get status(){return this._error?this.i18n`Could not log out of device: ${this._error.message}`:this.i18n`Logging out… Please don't close the app.`}get showStatus(){return this._showStatus}get showSpinner(){return this._showSpinner}}class Vm extends v{constructor(e,t){super(e),this._pickerVM=t,this._sessionInfo=e.sessionInfo,this._isDeleting=!1,this._isClearing=!1,this._error=null,this._exportDataUrl=null}get error(){return this._error&&this._error.message}get id(){return this._sessionInfo.id}get openUrl(){return this.urlRouter.urlForSegment("session",this.id)}get label(){const{userId:e,comment:t}=this._sessionInfo;return t?`${e} (${t})`:e}get sessionInfo(){return this._sessionInfo}get exportDataUrl(){return this._exportDataUrl}get avatarColorNumber(){return G(this._sessionInfo.userId)}get avatarInitials(){return W(this._sessionInfo.userId)}}class xm extends v{constructor(e){super(e),this._sessions=new mi((t,s)=>t.id.localeCompare(s.id)),this._loadViewModel=null,this._error=null}async load(){const e=await this.platform.sessionInfoStorage.getAll();this._sessions.setManyUnsorted(e.map(t=>new Vm(this.childOptions({sessionInfo:t}),this)))}get loadViewModel(){return this._loadViewModel}get sessions(){return this._sessions}get cancelUrl(){return this.urlRouter.urlForSegment("login")}}class Nm extends v{constructor(e){super(e),this._error=null,this._sessionPickerViewModel=null,this._sessionLoadViewModel=null,this._loginViewModel=null,this._logoutViewModel=null,this._forcedLogoutViewModel=null,this._sessionViewModel=null,this._pendingClient=null}async load(){this.track(this.navigation.observe("login").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("session").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("sso").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("logout").subscribe(()=>this._applyNavigation())),this._applyNavigation(!0)}async _applyNavigation(e){var a,c,h,l;const t=this.navigation.path.get("login"),s=(a=this.navigation.path.get("logout"))==null?void 0:a.value,i=(c=this.navigation.path.get("forced"))==null?void 0:c.value,r=(h=this.navigation.path.get("session"))==null?void 0:h.value,o=(l=this.navigation.path.get("sso"))==null?void 0:l.value;if(t)this.activeSection!=="login"&&this._showLogin();else if(s&&i)this.activeSection!=="forced-logout"&&this._showForcedLogout(s);else if(s)this.activeSection!=="logout"&&this._showLogout(s);else if(r===!0)this.activeSection!=="picker"&&this._showPicker();else if(r){if(!this._sessionViewModel||this._sessionViewModel.id!==r)if(this._pendingClient&&this._pendingClient.sessionId===r){const d=this._pendingClient;this._pendingClient=null,this._showSession(d)}else this._pendingClient&&(this._pendingClient.dispose(),this._pendingClient=null),this._showSessionLoader(r)}else if(o)this.urlRouter.normalizeUrl(),this.activeSection!=="login"&&this._showLogin(o);else try{if(!(e&&this.urlRouter.tryRestoreLastUrl())){const d=await this.platform.sessionInfoStorage.getAll();d.length===0?this.navigation.push("login"):d.length===1?this.navigation.push("session",d[0].id):this.navigation.push("session")}}catch(d){this._setSection(()=>this._error=d)}}async _showPicker(){this._setSection(()=>{this._sessionPickerViewModel=new xm(this.childOptions())});try{await this._sessionPickerViewModel.load()}catch(e){this._setSection(()=>this._error=e)}}_showLogin(e){this._setSection(()=>{this._loginViewModel=new Em(this.childOptions({defaultHomeserver:this.platform.config.defaultHomeServer,ready:t=>{this._pendingClient=t,this.navigation.push("session",t.sessionId)},loginToken:e}))})}_showLogout(e){this._setSection(()=>{this._logoutViewModel=new Tm(this.childOptions({sessionId:e}))})}_showForcedLogout(e){this._setSection(()=>{this._forcedLogoutViewModel=new Am(this.childOptions({sessionId:e}))})}_showSession(e){this._setSection(()=>{this._sessionViewModel=new Sm(this.childOptions({client:e})),this._sessionViewModel.start()})}_showSessionLoader(e){const t=new Fs(this.platform,this.features);t.startWithExistingSession(e),this._setSection(()=>{this._sessionLoadViewModel=new eo(this.childOptions({client:t,ready:s=>this._showSession(s)})),this._sessionLoadViewModel.start()})}get activeSection(){return this._error?"error":this._sessionViewModel?"session":this._loginViewModel?"login":this._logoutViewModel?"logout":this._forcedLogoutViewModel?"forced-logout":this._sessionPickerViewModel?"picker":this._sessionLoadViewModel?"loading":"redirecting"}_setSection(e){this._error=null,this._sessionPickerViewModel=this.disposeTracked(this._sessionPickerViewModel),this._sessionLoadViewModel=this.disposeTracked(this._sessionLoadViewModel),this._loginViewModel=this.disposeTracked(this._loginViewModel),this._logoutViewModel=this.disposeTracked(this._logoutViewModel),this._forcedLogoutViewModel=this.disposeTracked(this._forcedLogoutViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._sessionPickerViewModel&&this.track(this._sessionPickerViewModel),this._sessionLoadViewModel&&this.track(this._sessionLoadViewModel),this._loginViewModel&&this.track(this._loginViewModel),this._logoutViewModel&&this.track(this._logoutViewModel),this._forcedLogoutViewModel&&this.track(this._forcedLogoutViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}get error(){return this._error}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}get logoutViewModel(){return this._logoutViewModel}get forcedLogoutViewModel(){return this._forcedLogoutViewModel}get sessionPickerViewModel(){return this._sessionPickerViewModel}get sessionLoadViewModel(){return this._sessionLoadViewModel}}async function Dm(n){try{await n.init();const e=await ft.load(n.settingsStorage),t=Kd();n.setNavigation(t);const s=Ld({navigation:t,history:n.history});s.attach();const i=new Nm({platform:n,urlRouter:s,navigation:t,features:e});await i.load(),n.createAndMountRootView(i)}catch(e){console.error(`${e.message}:
${e.stack}`)}}function Um(n,e,t,s){const i=n(e);let r=!1;return i.elapsed().then(()=>{r=!0,t.abort()},()=>{}),s.then(o=>(i.abort(),o),o=>{throw i.abort(),o.name==="AbortError"&&r?new Ve(`Request timed out after ${e}ms`,!0):o})}function to(n,e=Math.random){return n.includes("?")?n=n+"&":n=n+"?",n+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}function so(n){var t;const e=new FormData;for(const[s,i]of n)((t=i.blob)==null?void 0:t.nativeBlob)&&i.name?e.set(s,i.blob.nativeBlob,i.name):e.set(s,i);return e}class Pm{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function Fm(n,{method:e,headers:t,timeout:s,format:i,uploadProgress:r}){const o=new XMLHttpRequest;if(r&&o.upload.addEventListener("progress",a=>r(a.loaded)),o.open(e,n),i==="buffer"&&(o.responseType="arraybuffer"),t)for(const[a,c]of t.entries())try{o.setRequestHeader(a,c)}catch(h){console.info(`Could not set ${a} header: ${h.message}`)}return s&&(o.timeout=s),o}function Om(n,e,t){return new Promise((s,i)=>{n.addEventListener("load",()=>s(n)),n.addEventListener("abort",()=>i(new he)),n.addEventListener("error",()=>i(new Ve(`Error ${e} ${t}`))),n.addEventListener("timeout",()=>i(new Ve(`Timeout ${e} ${t}`,!0)))})}function io(n,e){let{cache:t,format:s,body:i,method:r}=e;t||(n=to(n));const o=Fm(n,e),a=Om(o,r,n).then(c=>{const{status:h}=c;let l=null;return s==="buffer"?l=c.response:c.getResponseHeader("Content-Type")==="application/json"&&(l=JSON.parse(c.responseText)),{status:h,body:l}});return i!=null&&i.nativeBlob&&(i=i.nativeBlob),i instanceof Map&&(i=so(i)),o.send(i||null),new Pm(a,o)}class Tr{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const s=new Promise((i,r)=>{this._controller={abort(){const o=new Error("fetch request aborted");o.name="AbortError",r(o)}}});this.promise=Promise.race([e,s])}}abort(){this._controller.abort()}response(){return this.promise}}function Km(n,e){return function(s,i){if(e!=null&&e.haltRequests)return new Tr(new Promise(()=>{}),{});if(i!=null&&i.uploadProgress)return io(s,i);let{method:r,headers:o,body:a,timeout:c,format:h,cache:l=!1}=i;const d=typeof AbortController=="function"?new AbortController:null;a!=null&&a.nativeBlob&&(a=a.nativeBlob),a instanceof Map&&(a=so(a));let u={method:r,body:a};if(d&&(u=Object.assign(u,{signal:d.signal})),l||(s=to(s)),u=Object.assign(u,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const _=new Headers;for(const[y,M]of o.entries())_.append(y,M);u.headers=_}const p=fetch(s,u).then(async _=>{const{status:y}=_;let M;try{h==="json"?M=await _.json():h==="buffer"?M=await _.arrayBuffer():h==="text"&&(M=await _.text())}catch(N){if(!(N.name==="SyntaxError"&&y>=400))throw N}return{status:y,body:M}},_=>{throw _.name==="AbortError"?new he:_ instanceof TypeError?new Ve(`${r} ${s}: ${_.message}`):_}),m=new Tr(p,d);return c&&(m.promise=Um(n,c,m,m.promise)),m}}class Lm{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateAccessToken(e,t){const s=await this.getAll(),i=s.find(r=>r.id===e);if(!i)throw Error("No session found");i.accessToken=t,localStorage.setItem(this._name,JSON.stringify(s))}async updateLastUsed(e,t){const s=await this.getAll(),i=s.find(r=>r.id===e);i&&(i.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(s)))}async get(e){const t=await this.getAll();if(t)return t.find(s=>s.id===e)}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(s=>s.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}}class Bm{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?parseInt(s,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?s==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class $m{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}class jm{encodeUnpadded(e){const t=$t.encode(e),s=t.indexOf("=");return s!==-1?t.substr(0,s):t}encode(e){return $t.encode(e)}decode(e){return $t.decode(e)}}class qm{encode(e){return Fi.encode(e)}decode(e){return Fi.decode(e)}}class Hm{constructor(){this.utf8=new $m,this.base64=new jm,this.base58=new qm}}class Wm{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const s=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:s})}async createAccountAndOTKs(e,t){let s;window.msCrypto&&(s=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);const i=await this._workerPool.send({type:"olm_create_account_otks",randomValues:s,otkAmount:t}).response();e.unpickle("",i)}async createOutboundOlmSession(e,t,s,i){const r=e.pickle("");let o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:r,theirIdentityKey:s,theirOneTimeKey:i,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}}class Gm{constructor(e){var t;this.options=e,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this.options.platform.clock.createInterval(()=>this._tryFlush(),(t=this.options.flushInterval)!=null?t:60*1e3)}setLogger(e){this.logger=e}reportItem(e,t,s){const i=this.prepareItemForQueue(e,t,s);i&&this._queuedItems.push(i)}async export(){const e=await this._openDB();try{const s=e.transaction(["logs"],"readonly").objectStore("logs"),i=await Xa(s.openCursor(),()=>!1),r=this.getSerializedOpenItems(),o=i.concat(this._queuedItems).concat(r);return new zm(o,this,this.options.platform)}finally{try{e.close()}catch{}}}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){var t;const e=await this._openDB();try{const s=e.transaction(["logs"],"readwrite"),i=s.objectStore("logs"),r=this._queuedItems.length;for(const c of this._queuedItems)i.add(c);const o=await H(i.count()),a=(t=this.options.limit)!=null?t:3e3;if(o>a){let c=o-a+Math.round(.1*a);await K(i.openCursor(),(h,l,d)=>(d.delete(),c-=1,{done:c===0}))}await zt(s),this._queuedItems.splice(0,r)}catch(s){console.error("Could not flush logs",s)}finally{try{e.close()}catch{}}}_finishAllAndFlush(){this.logger&&(this.logger.log({l:"pagehide, closing logs",t:"navigation"}),this.logger.forceFinish()),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this.options.name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return wi(this.options.name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}prepareItemForQueue(e,t,s){let i=e.serialize(t,void 0,s);if(i)return this.options.serializedTransformer&&(i=this.options.serializedTransformer(i)),{json:JSON.stringify(i)}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this.options.name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async removeItems(e){const t=await this._openDB();try{const s=t.transaction(["logs"],"readwrite"),i=s.objectStore("logs");for(const r of e)if(typeof r.id=="number")i.delete(r.id);else{const o=this._queuedItems.indexOf(r);o===-1&&this._queuedItems.splice(o,1)}await zt(s)}finally{try{t.close()}catch{}}}getSerializedOpenItems(){const e=[];if(!this.logger)return e;const t=new Cs;for(const s of this.logger.getOpenRootItems()){const i=this.prepareItemForQueue(s,t,!1);i&&e.push(i)}return e}}class zm{constructor(e,t,s){this._items=e,this._logger=t,this._platform=s}get count(){return this._items.length}removeFromStore(){return this._logger.removeItems(this._items)}asBlob(){const e=this.toJSON(),t=this._platform.encoding.utf8.encode(e);return this._platform.createBlob(t,"application/json")}toJSON(){var s;const e={formatVersion:1,appVersion:(s=this._platform.updateService)==null?void 0:s.version,platform:this._platform.description,items:this._items.map(i=>JSON.parse(i.json))};return JSON.stringify(e)}}class Jm{reportItem(e){no(e)}setLogger(e){this.logger=e}printOpenItems(){if(!!this.logger)for(const e of this.logger.getOpenRootItems())this.reportItem(e)}}const Ym=["l","id"];function Qm(n){return Object.entries(n).filter(([e])=>!Ym.includes(e)).reduce((e,[t,s])=>(e=e||{},e[t]=s,e),null)}function ro(n){if(n.error)return!0;if(n.children){for(const e of n.children)if(ro(e))return!0}return!1}function no(n){const e=`${Xm(n)} (@${n.start}ms, duration: ${n.duration}ms)`,t=Qm(n.values),s=n.children||t;if(s?(ro(n)?console.group(e):console.groupCollapsed(e),n.error&&console.error(n.error)):n.error?console.error(n.error):console.log(e),t&&console.table(t),n.children)for(const i of n.children)no(i);s&&console.groupEnd()}function Xm(n){return n.values.t==="network"?`${n.values.method} ${n.values.url}`:n.values.l&&typeof n.values.id!="undefined"?`${n.values.l} ${n.values.id}`:n.values.l&&typeof n.values.status!="undefined"?`${n.values.l} (${n.values.status})`:n.values.l&&typeof n.values.type!="undefined"?`${n.values.l} (${n.values.type})`:n.values.l&&n.error?`${n.values.l} failed`:typeof n.values.ref!="undefined"?`ref ${n.values.ref}`:n.values.l||n.values.type}class yt{constructor(e,t,s,i){this._discard=!1,this._logger=s,this.start=s._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=i}discard(){this._discard=!0}runDetached(e,t,s,i){return this._logger.runDetached(e,t,s,i)}wrapDetached(e,t,s,i){this.refDetached(this.runDetached(e,t,s,i))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,s,i){return this.child(e,s,i).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,s)=>{const i=s.durationOfType(e);return t+(i!=null?i:0)},0):0}log(e,t){const s=this.child(e,t);return s.end=s.start,s}set(e,t){if(typeof e=="object"){const s=e;Object.assign(this._values,s)}else this._values[e]=t;return this}serialize(e,t,s){if(this._discard)return;if(this._filterCreator)try{e=this._filterCreator(new Cs(e),this)}catch(o){console.error("Error creating log filter",o)}let i=null;if(this._children&&(i=this._children.reduce((o,a)=>{const c=a.serialize(e,this.start,!1);return c&&(o===null&&(o=[]),o.push(c)),o},null)),e&&!e.filter(this,i))return;const r={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(r.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),s&&(r.f=!0),i&&(r.c=i),r}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then(s=>(this.finish(),s),s=>{throw this.catch(s)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}forceFinish(){this.finish()}get level(){return ie}catch(e){return this.error=e,this.logLevel=ie.Error,this.finish(),e}child(e,t,s){this.end&&console.trace(`log item ${this.values.l} finished, additional log ${JSON.stringify(e)} will likely not be recorded`),t||(t=this.logLevel||ie.Info);const i=new yt(e,t,this._logger,s);return this._children||(this._children=[]),this._children.push(i),i}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class Zm{constructor({platform:e}){this._openItems=new Set,this.reporters=[],this._platform=e}log(e,t=ie.Info){const s=new yt(e,t,this);return s.end=s.start,this._persistItem(s,void 0,!1),s}child(e,t=ie.Info,s){const i=new ep(e,t,this,s);return this._openItems.add(i),i}wrapOrRun(e,t,s,i,r){return e?e.wrap(t,s,i,r):this.run(t,s,i,r)}runDetached(e,t,s,i){s||(s=ie.Info);const r=new yt(e,s,this);return this._run(r,t,s,!1,i),r}run(e,t,s,i){s===void 0&&(s=ie.Info);const r=new yt(e,s,this);return this._run(r,t,s,!0,i)}_run(e,t,s,i,r){this._openItems.add(e);const o=()=>{let a=new Cs;if(r)try{a=r(a,e)}catch(c){console.error("Error while creating log filter",c)}else a=a.minLevel(s);try{this._persistItem(e,a,!1)}catch(c){console.error("Could not persist log item",c)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(c=>(o(),c),c=>{if(o(),i)throw c}),i)return a}else if(o(),i)return a}catch(a){if(o(),i)throw a}}addReporter(e){e.setLogger(this),this.reporters.push(e)}getOpenRootItems(){return this._openItems}forceFinish(){for(const e of this._openItems){e.forceFinish();try{this._persistItem(e,new Cs,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}_removeItemFromOpenList(e){this._openItems.delete(e)}_persistItem(e,t,s){for(var i=0;i<this.reporters.length;i+=1)this.reporters[i].reportItem(e,t,s)}get level(){return ie}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class ep extends yt{finish(){super.finish(),this._logger._persistItem(this,void 0,!1),this._logger._removeItemFromOpenList(this)}forceFinish(){super.finish()}}function oo(n){return typeof n!="object"||"nodeType"in n||Array.isArray(n)}function It(n,e){return Object.entries(n).reduce((t,[s,i])=>(typeof i=="function"&&(i=i(e)),i?t+(t.length?" ":"")+s:t),"")}function wt(n,e,t){e==="className"&&(e="class"),t===!1?n.removeAttribute(e):(t===!0&&(t=e),n.setAttribute(e,t))}function tp(n,e,t){return ao(Di,n,e,t)}function ao(n,e,t,s){t&&oo(t)&&(s=t,t=void 0);const i=document.createElementNS(n,e);if(t)for(let[r,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&r==="className"?It(o,void 0):!1),wt(i,r,o);if(s){Array.isArray(s)||(s=[s]);for(let r of s)typeof r=="string"&&(r=De(r)),i.appendChild(r)}return i}function De(n){return document.createTextNode(n)}const Di="http://www.w3.org/1999/xhtml",sp="http://www.w3.org/2000/svg",co={[Di]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","header","main","footer","dialog","article","aside","del","blockquote","details","summary","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","select","option","optgroup","label","form","progress","output","video","style"],[sp]:["svg","g","path","circle","ellipse","rect","use"]},I={};for(const[n,e]of Object.entries(co))for(const t of e)I[t]=function(s,i){return ao(n,t,s,i)};function Xt(n,e){let t;try{t=n.mount(e)}catch(s){console.error(s),t=ip(s)}return t}function ip(n){const e=new Error().stack;let t=null;return e&&(t=e.split(`
`)[1]),I.div([I.h2("Something went wrong\u2026"),I.h3(n.message),I.p(`This occurred while running ${t}.`),I.pre(n.stack)])}function Ar(n,e,t){if(e===n.childElementCount)n.appendChild(t);else{const i=n.children[e];n.insertBefore(t,i)}}function rp(n){n.innerHTML=""}function Ui(n){return async e=>{var t,s;(t=e.target)==null||t.setAttribute("disabled","disabled"),await n(e),(s=e.target)==null||s.removeAttribute("disabled")}}class Ge{constructor({list:e,onItemClick:t,className:s,tagName:i="ul",parentProvidesUpdates:r=!0},o){this._onItemClick=t,this._list=e,this._className=s,this._tagName=i,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:r}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=tp(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const s=Array.prototype.indexOf.call(this._root.childNodes,t),i=this._childInstances[s];i&&this._onItemClick(i,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const s=this._childCreator(t);this._childInstances.push(s),e.appendChild(Xt(s,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,s){this.moveChild(e,t)}onUpdate(e,t,s){this.updateChild(e,t,s)}addChild(e,t){const s=this._childCreator(t);this._childInstances.splice(e,0,s),Ar(this._root,e,Xt(s,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[s]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,s),s.root().remove(),Ar(this._root,t,s.root())}updateChild(e,t,s){if(this._childInstances){const i=this._childInstances[e];i&&i.update(t,s)}}recreateItem(e,t){if(this._childInstances){const s=this._childCreator(t);if(!s)this.onRemove(e,t);else{const[i]=this._childInstances.splice(e,1,s);this._root.replaceChild(s.mount(this._mountArgs),i.root()),i.unmount()}}}getChildInstanceByIndex(e){var t;return(t=this._childInstances)==null?void 0:t[e]}}class ho{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){var e;typeof((e=this._value)==null?void 0:e.on)=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function np(n){for(const e of Object.values(n))if(typeof e=="function")return!0;return!1}class g extends ho{constructor(){super(...arguments),this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.addEventListener(t,s,i)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.removeEventListener(t,s,i)}mount(e){const t=new lo(this);try{this._root=this.render(t,this._value)}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const s of this._bindings)s()}_addEventListener(e,t,s,i=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:s,useCapture:i})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const s of this._subViews)s.update(e,t)}}class lo{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,s,i=!1){this._templateView._addEventListener(e,t,s,i)}_addAttributeBinding(e,t,s){let i;const r=()=>{const o=s(this._value);i!==o&&(i=o,wt(e,t,o))};this._addBinding(r),r()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",s=>It(t,s))}_addTextBinding(e){const t=e(this._value)+"",s=De(t);let i=t;const r=()=>{const o=e(this._value)+"";i!==o&&(i=o,s.textContent=o)};return this._addBinding(r),s}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[s,i]of Object.entries(t))if(typeof i=="object"){if(s!=="className"||i===null)continue;np(i)?this._addClassNamesBinding(e,i):wt(e,s,It(i,this._value))}else if(this._isEventHandler(s,i)){const r=s.substr(2,1).toLowerCase()+s.substr(3),o=i;this._templateView._addEventListener(e,r,o)}else typeof i=="function"?this._addAttributeBinding(e,s,i):wt(e,s,i)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let s of t)typeof s=="function"?s=this._addTextBinding(s):typeof s=="string"&&(s=De(s)),e.appendChild(s)}_addReplaceNodeBinding(e,t){let s=e(this._value),i=t(null);const r=()=>{const o=e(this._value);if(s!==o){s=o;const a=t(i);i.parentNode&&i.parentNode.replaceChild(a,i),i=a}};return this._addBinding(r),i}el(e,t,s){return this.elNS(Di,e,t,s)}elNS(e,t,s,i){let r;s&&(oo(s)?i=s:r=s);const o=document.createElementNS(e,t);return r&&this._setNodeAttributes(o,r),i&&this._setNodeChildren(o,i),o}view(e,t){return this._templateView.addSubView(e),Xt(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,s=>{if(s&&s.nodeType!==Node.COMMENT_NODE){const r=this._templateView._subViews;if(r){const o=r.findIndex(a=>a.root()===s);if(o!==-1){const[a]=r.splice(o,1);a.unmount()}}}const i=t(e(this._value));return i?this.view(i):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,s=>new Zt(this._value,(i,r)=>{const o=t(s,i,r);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(s=>!!e(s),s=>s?t(this._value):null)}if(e,t){return this.ifView(e,s=>new Zt(s,t))}mapSideEffect(e,t){let s=e(this._value);const i=()=>{const r=e(this._value);s!==r&&(t(r,s,this._value),s=r)};this._addBinding(i),t(s,void 0,this._value)}}for(const[n,e]of Object.entries(co))for(const t of e)lo.prototype[t]=function(s,i){return this.elNS(n,t,s,i)};class Zt extends g{constructor(e,t){super(e),this._render=t}render(e,t){return this._render(e,t)}}function et(n,e,t=void 0){const s=!!n.avatarUrl(e);let i=It({avatar:!0,[`size-${e}`]:!0,[`usercolor${n.avatarColorNumber}`]:!s});t&&(i+=` ${t}`);const r=s?uo(n,e):De(n.avatarLetter),o=I.div({className:i,title:n.avatarTitle,"data-testid":"avatar"},[r]);return s&&(wt(o,"data-avatar-letter",n.avatarLetter),wt(o,"data-avatar-color",n.avatarColorNumber)),o}function uo(n,e){const t=e.toString();return I.img({src:n.avatarUrl(e),width:t,height:t,title:n.avatarTitle})}function op(n){const e=n.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function Vr(n){if(!op(n))return;const e=n.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);const s=e.getAttribute("data-avatar-letter");e.textContent=s}class ve extends ho{constructor(e,t){super(e),this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=et(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const s=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(uo(e,this._size),this._root.firstChild),this._root.classList.remove(s)):(this._root.textContent=e.avatarLetter,this._root.classList.add(s))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const s=this._root.firstChild;s.tagName==="IMG"&&s.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}let Pt;function $(n,e=void 0){Pt===void 0&&(Pt=document.querySelector(".hydrogen"));const t=Object.assign({spinner:!0},e);return Pt!=null&&Pt.classList.contains("legacy")?n.div({className:t},[n.div(),n.div(),n.div(),n.div()]):n.svg({className:t,viewBox:"0 0 100 100"},n.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class ap extends g{render(e,t){const s={active:i=>i.isOpen,hidden:i=>i.hidden};return e.li({className:s},[e.a({href:t.url},[e.view(new ve(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:i=>i.isUnread}},i=>i.name),e.map(i=>i.busy,i=>i?$(e):e.div({className:{badge:!0,highlighted:r=>r.isHighlighted,hidden:r=>!r.badgeCount}},r=>r.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}class F extends g{static option(e,t){return new cp(e,t)}constructor(e){super(),this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}}class cp{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}class Os{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=I.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=hp(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,s=this._popup.clientHeight,i=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>i.bottom||e.left>i.right||e.bottom<i.top||e.right<i.left)return!1;if(i.bottom>=e.bottom+s)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(i.top<=e.top-s)this._popup.style.top=`${e.top-s-this._verticalPadding}px`;else return!1;if(i.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(i.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}function hp(n){let e=n;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){const s=window.getComputedStyle(e).getPropertyValue("overflow-y");if(s==="auto"||s==="scroll")return e}while(e!==document.body)}class lp extends g{render(e,t){const s=()=>{i.value="",i.blur(),r.blur(),t.clear()},i=e.input({type:"text",placeholder:t==null?void 0:t.label,"aria-label":t==null?void 0:t.label,autocomplete:t==null?void 0:t.autocomplete,enterkeyhint:"search",name:t==null?void 0:t.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&s()},onFocus:()=>i.select()}),r=e.button({onClick:s,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[i,r])}}class dp extends g{constructor(e){super(e),this._createMenuPopup=null}render(e,t){const s=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,i=e.view(new Ge({className:"RoomList",list:t.tileViewModels},o=>new ap(o))),r=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new lp({i18n:t.i18n,label:t.i18n`Filter rooms…`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(i.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:s,"aria-label":s}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`}),e.button({className:"button-utility create","aria-label":t.i18n`Create room`,onClick:o=>this._toggleCreateMenu(o)})]);return e.div({className:"LeftPanel"},[r,i])}_toggleCreateMenu(e){if(this._createMenuPopup&&this._createMenuPopup.isOpen)this._createMenuPopup.close();else{const t=this.value,s=[];s.push(F.option(t.i18n`Create Room`,()=>t.showCreateRoomView())),s.push(F.option(t.i18n`Join Room`,()=>t.showJoinRoomView())),this._createMenuPopup=new Os(new F(s)),this._createMenuPopup.trackInTemplateView(this),this._createMenuPopup.showRelativeTo(e.target,10)}}}function xr(n){return n.offsetTop+n.clientHeight}function Nr(n,e,t=n.children.length-1){for(var s=t;s>=0;s--)if(n.children[s].offsetTop<e)return s;return 0}class up extends g{constructor(e,t){super(e),this.viewClassForTile=t,this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new mp(t.tiles,()=>this.restoreScrollPosition(),this.viewClassForTile);const s=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:i=>!i.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(s)),s}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,s=e.clientHeight-t.clientHeight;if(s>0){t.style.setProperty("margin-top",`${s}px`);const i=this.value.tiles.length;this.updateVisibleRange(0,i-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const i=xr(this.anchoredNode);if(i!==this.anchoredBottom){const r=i-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,r):e.scrollTop=e.scrollTop+r,this.anchoredBottom=i}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:s,scrollTop:i,clientHeight:r}=e;let o;if(this.stickToBottom=Math.abs(s-(i+r))<1,this.stickToBottom)o=this.value.tiles.length-1;else{const c=i+r,h=Nr(t,c);this.anchoredNode=t.childNodes[h],this.anchoredBottom=xr(this.anchoredNode),o=h}let a=Nr(t,i,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){const s=this.tilesView.getChildInstanceByIndex(e),i=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(s==null?void 0:s.value,i==null?void 0:i.value)}}class mp extends Ge{constructor(e,t,s){super({list:e,onItemClick:(i,r)=>i.onClick(r)},i=>{const r=s(i);return new r(i,s)}),this.viewClassForTile=s,this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,s){if(s==="shape"){const i=this.viewClassForTile(t),r=this.getChildInstanceByIndex(e);if(!i||!(r instanceof i)){super.recreateItem(e,t);return}}super.onUpdate(e,t,s),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,s){super.onMove(e,t,s),this.onChanged()}}class pp extends g{render(e,t){return e.div({className:"TimelineLoadingView"},[$(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages…`:t.i18n`Loading messages…`)])}}class _p extends g{constructor(e,t){super(e),this._viewClassForTile=t,this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({onKeydown:r=>this._onKeyDown(r),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:r=>r.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const s=e.map(r=>r.replyViewModel,(r,o)=>{const a=r&&this._viewClassForTile(r);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(r,this._viewClassForTile,{interactive:!1},"div"))]):null}),i=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:r=>this._toggleAttachmentMenu(r)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:r=>r.canSend}},[s,i])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(s){t(),console.error(s)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new Os(new F([F.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),F.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),F.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}}class gp extends g{render(e){return e.div({className:"DisabledComposerView"},e.h3(t=>t.description))}}class ht extends g{constructor(e,t={inline:!1}){super(e),this.options=t}render(e,t){const s=e.button({className:"ErrorView_submit",onClick:Ui(async r=>{r.stopPropagation(),await t.submitLogs()?alert("Logs submitted!"):alert("Could not submit logs")})},"Submit logs"),i=e.button({className:"ErrorView_close",onClick:r=>{r.stopPropagation(),t.close()},title:"Dismiss error"});return e.div({className:{ErrorView:!0,ErrorView_inline:this.options.inline,ErrorView_block:!this.options.inline}},[e.p({className:"ErrorView_message"},t.message),s,i])}}class fp extends g{render(e,t){const s=e.view(new Ge({className:"CallView_members",list:t.memberViewModels},i=>new yp(i)));return this.bindMembersCssClasses(e,s),e.div({class:"CallView"},[s,e.div({class:"CallView_buttons"},[e.button({className:{CallView_mutedMicrophone:i=>i.isMicrophoneMuted,CallView_unmutedMicrophone:i=>!i.isMicrophoneMuted},onClick:Gs(()=>t.toggleMicrophone())}),e.button({className:{CallView_mutedCamera:i=>i.isCameraMuted,CallView_unmutedCamera:i=>!i.isCameraMuted},onClick:Gs(()=>t.toggleCamera())}),e.button({className:"CallView_hangup",onClick:Gs(()=>t.hangup())})]),e.if(i=>!!i.errorViewModel,i=>i.div({className:"CallView_error"},i.view(new ht(t.errorViewModel))))])}bindMembersCssClasses(e,t){if(e.mapSideEffect(s=>s.memberCount,s=>{t.classList.forEach((i,r,o)=>{i.startsWith("size")&&o.remove(i)}),t.classList.add(`size${s}`)}),typeof ResizeObserver=="function"){const s=(i,r)=>{r?t.classList.add(i):t.classList.remove(i)};this.resizeObserver=new ResizeObserver(()=>{const i=t.clientWidth/t.clientHeight,r=i<.5,o=!r&&i<1.8,a=!r&&!o;s("tall",r),s("square",o),s("wide",a)}),this.resizeObserver.observe(t)}}unmount(){this.resizeObserver&&(this.resizeObserver.unobserve(this.root().querySelector(".CallView_members")),this.resizeObserver=void 0),super.unmount()}}class yp extends g{render(e,t){const s=e.video({autoplay:!0,disablePictureInPicture:!0,className:{hidden:i=>i.isCameraMuted}});return e.mapSideEffect(i=>i.stream,i=>{s.srcObject=i}),e.div({className:"StreamView"},[s,e.div({className:{StreamView_avatar:!0,hidden:i=>!i.isCameraMuted}},e.view(new ve(t,96),{parentProvidesUpdates:!0})),e.div({className:{StreamView_muteStatus:!0,hidden:i=>!i.isCameraMuted&&!i.isMicrophoneMuted,microphoneMuted:i=>i.isMicrophoneMuted&&!i.isCameraMuted,cameraMuted:i=>i.isCameraMuted}}),e.if(i=>!!i.errorViewModel,i=>i.div({className:"StreamView_error"},i.view(new ht(t.errorViewModel))))])}update(e,t){super.update(e),this.updateSubViews(e,t)}}function Gs(n){return async e=>{var t,s;(t=e.target)==null||t.setAttribute("disabled","disabled"),await n(e),(s=e.target)==null||s.removeAttribute("disabled")}}class mo extends g{constructor(e,t){super(e),this._viewClassForTile=t,this._optionsPopup=null}render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new ve(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:s=>this._toggleOptionsMenu(s)})]),e.div({className:"RoomView_body"},[e.if(s=>s.errorViewModel,s=>s.div({className:"RoomView_error"},s.view(new ht(t.errorViewModel)))),e.mapView(s=>s.callViewModel,s=>s?new fp(s):null),e.mapView(s=>s.timelineViewModel,s=>s?new up(s,this._viewClassForTile):new pp(t)),e.mapView(s=>s.composerViewModel,s=>{switch(s==null?void 0:s.kind){case"composer":return new _p(t.composerViewModel,this._viewClassForTile);case"disabled":return new gp(t.composerViewModel)}})])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,s=[];if(s.push(F.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.features.calls&&s.push(F.option(t.i18n`Start call`,()=>t.startCall())),t.canLeave&&s.push(F.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&s.push(F.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&s.push(F.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!s.length)return;this._optionsPopup=new Os(new F(s)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class wp extends g{render(e,t){return e.main({className:"UnknownRoomView middle"},[e.div({className:"UnknownRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room join`}),e.h2("Join room")]),e.div({className:"UnknownRoomView_body centered-column"},[e.div({className:"UnknownRoomView_container"},[e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:s=>s.busy},t.i18n`Join room`),e.if(s=>s.error,s=>s.p({className:"error"},t.error))])])])}}class kt{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(I,e):this.render(I,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class po extends kt{constructor(e="Loading"){super(e,(t,s)=>t.div({className:"LoadingView"},[$(t),s]))}}class _o extends g{render(e,t){return e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new ve(t,32)),e.div({className:"room-description"},[e.h2(s=>s.name)])]),e.div({className:"RoomView_body"},[e.mapView(s=>s.error,s=>s?new vp(t):new po(t.i18n`Setting up the room…`))])])}}class vp extends g{render(e,t){return e.div({className:"RoomBeingCreated_error centered-column"},[e.h3(t.i18n`Could not create the room, something went wrong:`),e.div({className:"RoomView_error form-group"},t.error),e.div({className:"button-row"},e.button({className:"button-action primary destructive",onClick:()=>t.cancel()},t.i18n`Cancel`))])}}class go extends g{render(e,t){var r;let s=[];t.isDirectMessage&&s.push(et(t,128,"InviteView_dmAvatar"));let i;return t.isDirectMessage?i=[e.strong(t.name),` (${(r=t.inviter)==null?void 0:r.id}) wants to chat with you.`]:t.inviter?i=[et(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:i="You were invited to join.",s.push(e.p({className:"InviteView_inviter"},i)),t.isDirectMessage||s.push(e.div({className:"InviteView_roomProfile"},[et(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),et(t,32),e.div({className:"room-description"},[e.h2(o=>o.name)])]),e.if(o=>o.error,o=>o.div({className:"RoomView_error"},a=>a.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...s,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:o=>o.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:o=>o.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class bp extends g{render(e,t){const s=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),i=e.div({role:"img","aria-label":c=>c.name,title:c=>c.name,className:{picture:!0,hidden:c=>!c.imageUrl},style:c=>`background-image: url('${c.imageUrl}'); max-width: ${c.imageWidth}px; max-height: ${c.imageHeight}px;`}),r=e.div({className:{loading:!0,hidden:c=>!!c.imageUrl}},[$(e),e.div(t.i18n`Loading image…`)]),o=e.div({className:"details"},[e.strong(c=>c.name),e.br(),"uploaded by ",e.strong(c=>c.sender),c=>` at ${c.time} on ${c.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:c=>this.clickToClose(c),onKeydown:c=>this.closeOnEscKey(c)},[i,r,o,s]);return Sp(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}}function Sp(n,e){const t=Ip(e),s=t[0],i=t[t.length-1];n.addEventListener(e,"keydown",r=>{r.key==="Tab"&&(r.shiftKey?document.activeElement===s&&(i.focus(),r.preventDefault()):document.activeElement===i&&(s.focus(),r.preventDefault()))},!0),Promise.resolve().then(()=>{s.focus()})}function Ip(n){return n.querySelectorAll("a[href], button, textarea, input, select")}class kp extends g{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:s=>!s.isShown}},[$(e,{hidden:s=>!s.isWaiting}),e.p(s=>s.statusLabel),e.if(s=>s.isConnectNowShown,s=>s.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(s=>s.isSecretStorageShown,s=>s.a({href:t.setupKeyBackupUrl},"Go to settings")),e.if(s=>s.canDismiss,s=>s.div({className:"end"},s.button({className:"dismiss",onClick:()=>t.dismiss()})))])}}class Mp extends g{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=[];for(let i=0;i<t.height*t.width;i+=1)s.push(e.div({onClick:()=>t.focusTile(i),onFocusin:()=>t.focusTile(i),className:{container:!0,[`tile${i}`]:!0,focused:r=>r.focusIndex===i}},e.mapView(r=>r.roomViewModelAt(i),r=>r?r.kind==="roomBeingCreated"?new _o(r):r.kind==="invite"?new go(r):new mo(r,this._viewClassForTile):new kt(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return s.push(e.div({className:i=>`focus-ring tile${i.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},s)}}class fo extends g{render(e,t){return e.div([e.map(s=>s.status,(s,i,r)=>{switch(s){case ae.Enabled:return Cp(i,r);case ae.NewVersionAvailable:return Rp(i,r);case ae.SetupWithPassphrase:return Tp(i,r);case ae.SetupWithRecoveryKey:return Ep(i,r);case ae.Pending:return i.p(r.i18n`Waiting to go online…`)}}),e.map(s=>s.backupWriteStatus,(s,i,r)=>{switch(s){case ks.Writing:{const o=i.progress({min:0+"",max:100+"",value:a=>a.backupPercentage});return i.div(["Backup in progress ",o," ",a=>a.backupInProgressLabel])}case ks.Stopped:{let o;return r.backupError?o=`Backup has stopped because of an error: ${r.backupError}`:o="Backup has stopped",i.p([o," ",i.button({onClick:()=>r.startBackup()},"Backup now")])}case ks.Done:return i.p("All keys are backed up.");default:return}}),e.if(s=>s.isMasterKeyTrusted,s=>s.p("Cross-signing master key found and trusted.")),e.if(s=>s.canSignOwnDevice,s=>s.div([s.button({onClick:Ui(async()=>{t.navigateToVerification()})},"Verify by emoji")]))])}}function Cp(n,e){const t=[n.p([e.i18n`Key backup is enabled, using backup version ${e.backupVersion}. `,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(n.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),n.div(t)}function Rp(n,e){const t=[n.p([e.i18n`A new backup version has been created from another device. Disable key backup and enable it again with the new key.`,n.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return n.div(t)}function Ep(n,e){const t=n.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return n.div([n.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),wo(n),yo(n,e,e.i18n`Security key`,(s,i)=>e.enterSecurityKey(s,i)),n.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function Tp(n,e){const t=n.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return n.div([n.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),wo(n),yo(n,e,e.i18n`Security phrase`,(s,i)=>e.enterSecurityPhrase(s,i)),n.p([e.i18n`You can also `,t,e.i18n`.`])])}function yo(n,e,t,s){let i;const r=()=>s(o.value,(i==null?void 0:i.checked)||!1),o=n.input({type:"password",disabled:c=>c.isBusy,placeholder:t}),a=[n.p([o,n.button({disabled:c=>c.isBusy,onClick:r},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){i=n.input({type:"checkbox",id:"enable-dehydrated-device"});const c=n.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(n.p([i,n.label({for:i.id},[e.i18n`Back up my device as well (`,c,")"])]))}return n.div({className:"row"},[n.div({className:"label"},t),n.div({className:"content"},a)])}function wo(n){return n.if(e=>e.error!==void 0,(e,t)=>e.div([e.p({className:"error"},s=>s.i18n`Could not enable key backup: ${s.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}class Ap extends g{render(e,t){return e.div({className:"FeaturesView"},[e.p("Enable experimental features here that are still in development. These are not yet ready for primetime, so expect bugs."),e.ul(t.featureViewModels.map(s=>e.li(e.view(new Vp(s)))))])}}class Vp extends g{render(e,t){let s=`feature_${t.id}`;return e.div({className:"FeatureView"},[e.input({type:"checkbox",id:s,checked:i=>i.enabled,onChange:i=>t.enableFeature(i.target.checked)}),e.div({class:"FeatureView_container"},[e.h4(e.label({for:s},t.name)),e.p(t.description)])])}}class xp extends g{render(e,t){let s=t.version;t.showUpdateButton&&(s=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const i=(a,c,h,l="")=>a.div({className:`row ${l}`},[a.div({className:"label"},c),a.div({className:"content"},h)]),r=[];r.push(e.h3("Session"),i(e,t.i18n`User ID`,t.userId),i(e,t.i18n`Session ID`,t.deviceId,"code"),i(e,t.i18n`Session key`,t.fingerprintKey,"code"),i(e,"",e.button({onClick:()=>t.logout(),disabled:a=>a.isLoggingOut},t.i18n`Log out`))),r.push(e.h3("Key backup & security"),e.view(new fo(t.keyBackupViewModel))),r.push(e.h3("Notifications"),e.map(a=>a.pushNotifications.supported,(a,c)=>{if(a===null)return c.p(t.i18n`Loading…`);if(a){const h=d=>d.pushNotifications.enabled?d.i18n`Push notifications are enabled`:d.i18n`Push notifications are disabled`,l=d=>d.pushNotifications.enabled?d.i18n`Disable`:d.i18n`Enable`;return i(c,h,c.button({onClick:()=>t.togglePushNotifications(),disabled:d=>d.pushNotifications.updating},l))}else return c.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(a=>a.pushNotifications.supported&&a.pushNotifications.enabled,a=>a.div([a.p(["If you think push notifications are not being delivered, ",a.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),a.map(c=>c.pushNotifications.enabledOnServer,(c,h)=>{if(c===!0)return h.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(c===!1)return h.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),a.map(c=>c.pushNotifications.serverError,(c,h)=>{if(c)return h.p("Couldn't not check on server: "+c.message)})]))),r.push(e.h3("Preferences"),i(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t)),e.if(a=>a.activeTheme,(a,c)=>i(a,c.i18n`Use the following theme`,this._themeOptions(a,c))));const o=[];return t.canSendLogsToServer&&o.push(e.button({onClick:Ui(()=>t.sendLogsToServer())},`Submit logs to ${t.logsServer}`)),o.push(e.button({onClick:()=>t.exportLogs()},"Download logs")),r.push(e.h3("Experimental features"),e.view(new Ap(t.featuresViewModel))),r.push(e.h3("Application"),i(e,t.i18n`Version`,s),i(e,t.i18n`Storage usage`,a=>`${a.storageUsage} / ${a.storageQuota}`),i(e,t.i18n`Debug logs`,o),e.p({className:{hidden:a=>!a.logsFeedbackMessage}},a=>a.logsFeedbackMessage),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."]),e.p([])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},r)])}_imageCompressionRange(e,t){const i=Math.ceil(t.minSentImageSizeLimit/32)*32,r=(Math.floor(t.maxSentImageSizeLimit/32)+1)*32,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:32,min:i,max:r,value:a=>a.sentImageSizeLimit||r,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}_themeOptions(e,t){const{themeName:s,themeVariant:i}=t.activeTheme,r=[];for(const m of Object.keys(t.themeMapping))r.push(e.option({value:m,selected:m===s},m));const o=e.select({onChange:m=>{const _=m.target.value;if(!("id"in t.themeMapping[_])){const y=l.checked?"dark":u.checked?"light":"default";a(y);return}t.changeThemeOption(_)}},r),a=m=>{const _=o.options[o.selectedIndex].value;t.changeThemeOption(_,m)},c=i==="dark",h=i==="light",l=e.input({type:"radio",name:"radio-chooser",value:"dark",id:"dark",checked:c}),d=e.input({type:"radio",name:"radio-chooser",value:"default",id:"default",checked:!(c||h)}),u=e.input({type:"radio",name:"radio-chooser",value:"light",id:"light",checked:h}),p=e.form({className:{hidden:()=>{const m=o.options[o.selectedIndex].value;return"id"in t.themeMapping[m]}},onChange:m=>a(m.target.value)},[d,e.label({for:"default"},"Match system theme"),l,e.label({for:"dark"},"dark"),u,e.label({for:"light"},"light")]);return e.div({className:"theme-chooser"},[o,p])}}class Np extends g{render(e,t){return e.main({className:"CreateRoomView middle"},[e.div({className:"CreateRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room creation`}),e.h2("Create room")]),e.div({className:"CreateRoomView_body centered-column"},[e.form({className:"CreateRoomView_detailsForm form",onChange:s=>this.onFormChange(s),onSubmit:s=>this.onSubmit(s)},[e.div({className:"vertical-layout"},[e.button({type:"button",className:"CreateRoomView_selectAvatar",onClick:()=>t.selectAvatar()},e.mapView(s=>s.hasAvatar,s=>s?new ve(t,64):new kt(void 0,i=>i.div({className:"CreateRoomView_selectAvatarPlaceholder"})))),e.div({className:"stretch form-row text"},[e.label({for:"name"},t.i18n`Room name`),e.input({onInput:s=>t.setName(s.target.value),type:"text",name:"name",id:"name",placeholder:t.i18n`Enter a room name`})])]),e.div({className:"form-row text"},[e.label({for:"topic"},t.i18n`Topic (optional)`),e.textarea({onInput:s=>t.setTopic(s.target.value),name:"topic",id:"topic",placeholder:t.i18n`Topic`})]),e.div({className:"form-group"},[e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPrivate",value:"false",checked:!t.isPublic}),e.label({for:"isPrivate"},t.i18n`Private room, only upon invitation.`)]),e.div({className:"form-row check"},[e.input({type:"radio",name:"isPublic",id:"isPublic",value:"true",checked:t.isPublic}),e.label({for:"isPublic"},t.i18n`Public room, anyone can join`)])]),e.div({className:{"form-row check":!0,hidden:s=>s.isPublic}},[e.input({type:"checkbox",name:"isEncrypted",id:"isEncrypted",checked:t.isEncrypted}),e.label({for:"isEncrypted"},t.i18n`Enable end-to-end encryption`)]),e.div({className:{"form-row text":!0,hidden:s=>!s.isPublic}},[e.label({for:"roomAlias"},t.i18n`Room alias`),e.input({onInput:s=>t.setRoomAlias(s.target.value),type:"text",name:"roomAlias",id:"roomAlias",placeholder:t.i18n`Room alias (<alias>, or #<alias> or #<alias>:hs.tld`})]),e.div({className:"form-group"},[e.div(e.button({className:"link",type:"button",onClick:()=>t.toggleAdvancedShown()},s=>s.isAdvancedShown?s.i18n`Hide advanced settings`:s.i18n`Show advanced settings`)),e.div({className:{"form-row check":!0,hidden:s=>!s.isAdvancedShown}},[e.input({type:"checkbox",name:"isFederationDisabled",id:"isFederationDisabled",checked:t.isFederationDisabled}),e.label({for:"isFederationDisabled"},[t.i18n`Disable federation`,e.p({className:"form-row-description"},t.i18n`Can't be changed later. This will prevent people on other homeservers from joining the room. This is typically used when only people from your own organisation (if applicable) should be allowed in the room, and is otherwise not needed.`)])])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s=>!s.canCreate},t.i18n`Create room`)])])])])}onFormChange(e){switch(e.target.name){case"isEncrypted":this.value.setEncrypted(e.target.checked);break;case"isPublic":this.value.setPublic(e.currentTarget.isPublic.value==="true");break;case"isFederationDisabled":this.value.setFederationDisabled(e.target.checked);break}}onSubmit(e){e.preventDefault(),this.value.create()}}class Dp extends g{render(e,t){const s=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new ve(t,52)),e.mapView(i=>i.isEncrypted,i=>new Up(i))]),e.div({className:"RoomDetailsView_name"},[e.h2(i=>i.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},i=>i.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},s)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?I.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,s,i){const r=It({RoomDetailsView_label:!0,...s});return e.div({className:"RoomDetailsView_row"},[e.div({className:r},[t]),e.div({className:"RoomDetailsView_value"},i)])}_createRightPanelButtonRow(e,t,s,i,r){const o=It({RoomDetailsView_label:!0,...s});return e.button({className:"RoomDetailsView_row",onClick:r},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},i)])}}class Up extends g{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class Pp{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let s=0;for(s=0;s<this.start;s+=1)e.next();for(s=0;s<this.length;s+=1){const i=e.next();if(i.done)break;t(i.value,this.start+s)}}[Symbol.iterator](){return new Fp(this)}reverseIterable(){return new Op(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?it.Before:e<this.end?it.Inside:it.After}}var it=(n=>(n[n.Before=1]="Before",n[n.Inside=2]="Inside",n[n.After=3]="After",n))(it||{});class Fp{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class Op{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}function Kp(n,e){let t=0;for(;t<e;)if(t+=1,n.next().done)return!1;return!0}function ws(n,e){if(Kp(n,e)){const t=n.next();if(!t.done)return t.value}}var mt=(n=>(n[n.Move=0]="Move",n[n.Add=1]="Add",n[n.Remove=2]="Remove",n[n.RemoveAndAdd=3]="RemoveAndAdd",n[n.UpdateRange=4]="UpdateRange",n))(mt||{});class Ht extends Pp{constructor(e,t,s,i=t-e){super(e,t),this._totalLength=s,this._viewportItemCount=i}expand(e){if(this.length===0)return this;const t=Math.max(0,this.start-e),s=Math.min(this.totalLength,this.end+e);return new Ht(t,s,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,s,i){const r=Math.min(Math.max(0,Math.floor(i/t)),e),o=e-r,a=s!==0?Math.ceil(s/t):0,c=Math.min(a,o);return new Ht(r,r+c,e,a)}queryAdd(e,t,s){const i=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=i){const r=this.clampIndex(e,i),o=r===e?t:ws(s[Symbol.iterator](),r);return this.createAddResult(r,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const s=this.clampIndex(e);return this.createRemoveResult(s,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,s,i){const r=this.getIndexZone(e),o=this.getIndexZone(t);if(r===o){if(r===it.Before||r===it.After)return;if(r===it.Inside)return{type:0,fromIdx:e,toIdx:t}}else{const a=this.clampIndex(t),c=this.clampIndex(e),h=a===t?s:ws(i[Symbol.iterator](),a);return{type:3,removeIdx:c,addIdx:a,value:h}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const s=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:s,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const s=this.clampIndex(Number.MAX_SAFE_INTEGER),i=ws(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:i,addIdx:s,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){const s=this.deriveRange(-1,0,1),i=s.start,r=ws(t[Symbol.iterator](),i);return{type:3,removeIdx:e,value:r,addIdx:i,newRange:s}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,s=0){const i=this.start-s,r=this.totalLength+e,o=Math.min(Math.max(i,this.end-s+t),r);return new Ht(i,o,r,this.viewportItemCount)}}class Lp extends Ge{constructor({itemHeight:e,overflowItems:t=20,...s},i){super(s,i),this.itemHeight=e,this.overflowItems=t}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return Ht.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){rp(this._listElement);const t=document.createDocumentFragment(),s=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(s,i=>{const r=this._childCreator(i);this._childInstances.push(r),t.appendChild(Xt(r,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const s of e.reverseIterable())if(!t.containsIndex(s)){const i=s-e.start;this.removeChild(i)}t.forEachInIterator(this._list[Symbol.iterator](),(s,i)=>{if(!e.containsIndex(i)){const r=i-t.start;this.addChild(r,s)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,s=(e.totalLength-e.end)*this.itemHeight,i=this._listElement.style;i.paddingTop=`${t}px`,i.paddingBottom=`${s}px`}mount(){const e=super.mount();return this.scrollContainer=I.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const s=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(s)}onRemove(e,t){const s=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(s)}onMove(e,t,s){const i=this.renderRange.queryMove(e,t,s,this._list);i&&(i.type===mt.Move?this.moveChild(this.renderRange.toLocalIndex(i.fromIdx),this.renderRange.toLocalIndex(i.toIdx)):this.applyRemoveAddResult(i))}onUpdate(e,t,s){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,s)}applyRemoveAddResult(e){(e.type===mt.Remove||e.type===mt.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===mt.Add||e.type===mt.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class Bp extends g{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new ve(t,32)),e.div({className:"MemberTileView_name"},s=>s.name)]))}}class $p extends g{render(e,t){const s=new Lp({list:t.memberTileViewModels,className:"MemberListView__list",itemHeight:40},i=>new Bp(i));return e.div({className:"MemberListView"},[e.div({className:"MemberListView__invite-container"},[e.button({className:"MemberListView__invite-btn button-action primary",onClick:()=>t.openInvitePanel()},t.i18n`Invite to this room`)]),e.view(s)])}}class jp extends g{render(e,t){const s=[e.p(t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`)];return t.features.crossSigning&&s.push(e.div({className:"MemberDetailsView_shield_container"},[e.span({className:i=>`MemberDetailsView_shield_${i.trustShieldColor}`}),e.p({className:"MemberDetailsView_shield_description"},i=>i.trustDescription)])),e.div({className:"MemberDetailsView"},[e.view(new ve(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(i=>i.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,i=>i.role),this._createSection(e,t.i18n`Security`,s),this._createOptions(e,t)])}_createSection(e,t,s){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},s)])}_createOptions(e,t){const s=[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`),e.button({className:"text",onClick:()=>t.openDirectMessage()},t.i18n`Open direct message`)];if(t.features.crossSigning){t.canVerifyUser&&s.push(e.button({className:"text",onClick:()=>t.verifyUser()},t.i18n`Verify`));const i=()=>{confirm("You don't want to do this with any account but a test account. This will cross-sign this user without verifying their keys first. You won't be able to undo this apart from resetting your cross-signing keys.")&&t.signUser()};s.push(e.button({className:"text",onClick:i},t.i18n`Cross-sign user (DO NOT USE, TESTING ONLY)`))}return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},s)])}}class qp extends g{render(e,t){return e.div({className:"WaitingForOtherUserView"},[e.div({className:"WaitingForOtherUserView__heading"},[$(e),e.h2({className:"WaitingForOtherUserView__title"},t.title)]),e.p({className:"WaitingForOtherUserView__description"},t.description),e.div({className:"WaitingForOtherUserView__actions"},e.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>t.cancel()},"Cancel"))])}}class Hp extends g{render(e,t){return e.div({className:"VerificationCancelledView"},[e.h2({className:"VerificationCancelledView__title"},t.title),e.p({className:"VerificationCancelledView__description"},t.description),e.div({className:"VerificationCancelledView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.dismiss()},"Got it")])])}}class Wp extends g{render(e){return e.div({className:"SelectMethodView"},[e.map(t=>t.hasProceeded,(t,s,i)=>t?$(s):s.div([s.div({className:"SelectMethodView__heading"},[s.h2({className:"SelectMethodView__title"},this.getHeading(s,i))]),s.p({className:"SelectMethodView__description"},this.getSubheading(i)),s.div({className:"SelectMethodView__actions"},[s.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>i.cancel()},"Cancel"),s.button({className:{"button-action":!0,primary:!0},onclick:()=>i.proceed()},"Proceed")])]))])}getHeading(e,t){return t.isCrossSigningAnotherUser?[t.i18n`Verify user `,e.span({className:"SelectMethodView__name"},t.otherUserId),t.i18n` by comparing emojis?`]:[t.i18n`Verify device`,e.span({className:"SelectMethodView__name"},t.deviceName),t.i18n` by comparing emojis?`]}getSubheading(e){return e.isCrossSigningAnotherUser?e.i18n`You are about to verify user (${e.otherUserId}) by comparing emojis.`:e.i18n`You are about to verify your other device (${e.deviceName}) by comparing emojis.`}}class Gp extends g{render(e,t){const s=t.emojis.reduce((r,[o,a])=>{const c=e.div({className:"EmojiContainer"},[e.div({className:"EmojiContainer__emoji"},o),e.div({className:"EmojiContainer__name"},a)]);return r.push(c),r},[]),i=e.div({className:"EmojiCollection"},s);return e.div({className:"VerifyEmojisView"},[e.div({className:"VerifyEmojisView__heading"},[e.h2({className:"VerifyEmojisView__title"},t.i18n`Do the emojis match?`)]),e.p({className:"VerifyEmojisView__description"},t.i18n`Confirm the emoji below are displayed on both devices, in the same order:`),e.div({className:"VerifyEmojisView__emojis"},i),e.map(r=>r.isWaiting,(r,o,a)=>r?o.div({className:"VerifyEmojisView__waiting"},[$(o),o.span(a.i18n`Waiting for you to verify on your other device`)]):o.div({className:"VerifyEmojisView__actions"},[o.button({className:{"button-action":!0,primary:!0,destructive:!0},onclick:()=>a.setEmojiMatch(!1)},a.i18n`They don't match`),o.button({className:{"button-action":!0,primary:!0},onclick:()=>a.setEmojiMatch(!0)},a.i18n`They match`)]))])}}class zp extends g{render(e,t){return e.div({className:"VerificationCompleteView"},[e.div({className:"VerificationCompleteView__icon"}),e.div({className:"VerificationCompleteView__heading"},[e.h2({className:"VerificationCompleteView__title"},t.i18n`Verification completed successfully!`)]),e.p({className:"VerificationCompleteView__description"},t.verificationSuccessfulMessage),e.div({className:"VerificationCompleteView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.dismiss()},"Got it")])])}}class Jp extends g{render(e,t){return e.div({className:"MissingKeysView"},[e.h2({className:"MissingKeysView__heading"},t.i18n`Verification is currently not possible!`),e.p({className:"MissingKeysView__description"},t.i18n`Some keys needed for verification are missing. You can fix this by enabling key backup in settings.`),e.div({className:"MissingKeysView__actions"},[e.button({className:{"button-action":!0,primary:!0},onclick:()=>t.gotoSettings()},"Open Settings")])])}}class vo extends g{render(e,t){return e.div({className:{middle:!t.isHappeningInRoom,DeviceVerificationView:!0}},[e.mapView(s=>s.currentStageViewModel,s=>{switch(s==null?void 0:s.kind){case"waiting-for-user":return new qp(s);case"verification-cancelled":return new Hp(s);case"select-method":return new Wp(s);case"verify-emojis":return new Gp(s);case"verification-completed":return new zp(s);case"keys-missing":return new Jp(s);default:return new Zt(s,()=>$(e))}})])}}class Yp extends g{render(e,t){const s=e.input({className:"InvitePanelView__input",type:"text",placeholder:"Enter user-id of user",onkeydown:i=>{i.key==="Enter"&&t.invite(s.value)}});return e.div({className:"InvitePanelView"},[e.h3({className:"InvitePanelView__heading"},i=>i.i18n`Invite to ${i.roomName}`),e.div({className:"InvitePanelView__form"},[s,e.button({className:"InvitePanelView__btn button-action primary",onClick:()=>t.invite(s.value)},"Invite")]),e.div({className:"InvitePanelView__error"},[e.ifView(i=>!!i.errorViewModel,i=>new ht(i.errorViewModel))])])}}class Qp extends g{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new Xp(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e==null?void 0:e.type){case"room-details":return new Dp(e);case"member-list":return new $p(e);case"member-details":return new jp(e);case"invite":return new Yp(e);case"verification":return new vo(e);default:return new po}}}class Xp extends g{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:s=>!s.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class Zp extends Ge{constructor(e){const t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:s=>s.onClick()};super(t,s=>new e_(s))}}class e_ extends g{render(e,t){return e.button({className:{active:s=>s.isActive,pending:s=>s.isPending}},[t.key," ",s=>`${s.count}`])}onClick(){this.value.toggle()}}class Tt extends g{constructor(e,t,s,i="li"){super(e),this._menuPopup=null,this._tagName=i,this._viewClassForTile=t,this._renderFlags=s}get _interactive(){var e,t;return(t=(e=this._renderFlags)==null?void 0:e.interactive)!=null?t:!0}get _isReplyPreview(){var e;return(e=this._renderFlags)==null?void 0:e.reply}render(e,t){const s=[this.renderMessageBody(e,t)];this._interactive&&s.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));const i=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:o=>o.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation},"data-event-id":t.eventId},s);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)i.removeChild(i.querySelector(".Timeline_messageAvatar")),i.removeChild(i.querySelector(".Timeline_messageSender"));else if(!o&&!this._isReplyPreview){const c=I.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[et(t,30)]),h=I.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`,title:t.sender},t.displayName);i.insertBefore(c,i.firstChild),i.insertBefore(h,i.firstChild)}});let r=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!r?(r=new Zp(o),this.addSubView(r),i.appendChild(Xt(r))):!o&&r&&(i.removeChild(r.root()),r.unmount(),this.removeSubView(r),r=null)}),i}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const s=()=>this.root().classList.remove("menuOpen");this._menuPopup=new Os(new F(t),s),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&e.shape!=="redacted"&&!e.isPending&&(t.push(new t_(e)),t.push(F.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(F.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(F.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t.push(F.option(e.i18n`Copy matrix.to permalink`,()=>e.copyPermalink())),t}renderMessageBody(){}}class t_{constructor(e){this._vm=e}toDOM(e){const t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(i=>e.button({onClick:()=>this._vm.react(i)},i)),s=e.button({onClick:()=>{const i=prompt("Enter your reaction (emoji)");i&&this._vm.react(i)}},"\u2026");return e.li({className:"quick-reactions"},[...t,s])}}class s_ extends g{constructor(e,t){super(e),this._viewClassForTile=t}render(e,t){const s=this._viewClassForTile(t);if(!s)throw new Error(`Shape ${t.shape} is unrecognized.`);const i=new s(t,this._viewClassForTile,{reply:!0,interactive:!1});return e.div({className:"ReplyPreviewView"},e.blockquote([e.a({className:"link",target:"_blank",href:t.permaLink},"In reply to"),e.a({className:"pill",target:"_blank",href:t.senderProfileLink},[et(t,12,void 0),t.displayName]),e.br(),e.view(i)]))}}class i_ extends g{render(e){return e.blockquote({className:"ReplyPreviewView"},[e.div({className:"Timeline_messageBody statusMessage"},"This reply could not be found.")])}}class r_ extends Tt{renderMessageBody(e,t){const s=e.time({className:{hidden:!t.time}},t.time),i=e.div({className:{Timeline_messageBody:!0,statusMessage:o=>o.shape==="message-status"}},e.mapView(o=>o.replyTile,o=>this._isReplyPreview?null:t.isReply&&!o?new i_:o?new s_(o,this._viewClassForTile):null)),r=o=>(o==null?void 0:o.nodeType)!==Node.COMMENT_NODE&&o.className!=="ReplyPreviewView";return e.mapSideEffect(o=>o.body,o=>{for(;r(i.lastChild);)i.removeChild(i.lastChild);for(const a of o.parts)i.appendChild(bo(a));i.appendChild(s)}),i}}function n_(n){const e=n.items.map(s=>I.li(rt(s))),t=n.startOffset;return t?I.ol({start:t},e):I.ul(e)}function o_(n){const e={src:n.src};return n.width&&(e.width=n.width),n.height&&(e.height=n.height),n.alt&&(e.alt=n.alt),n.title&&(e.title=n.title),I.img(e)}function a_(n){const e=`avatar size-12 usercolor${n.avatarColorNumber}`,t=I.div({class:e},De(n.avatarInitials)),s=rt(n.children);return s.unshift(t),I.a({class:"pill",href:n.href,rel:"noopener",target:"_blank"},s)}function c_(n){const e=[];if(n.head){const s=n.head.map(i=>I.th(rt(i)));e.push(I.thead(I.tr(s)))}const t=[];for(const s of n.body){const i=s.map(r=>I.td(rt(r)));t.push(I.tr(i))}return e.push(I.tbody(t)),I.table(e)}const h_={header:n=>I["h"+Math.min(6,n.level)](rt(n.inlines)),codeblock:n=>I.pre(I.code(De(n.text))),table:n=>c_(n),code:n=>I.code(De(n.text)),text:n=>De(n.text),link:n=>I.a({href:n.url,className:"link",target:"_blank",rel:"noopener"},rt(n.inlines)),pill:a_,format:n=>I[n.format](rt(n.children)),rule:()=>I.hr(),list:n_,image:o_,newline:()=>I.br()};function bo(n){const e=h_[n.type];return e?e(n):De(`[unknown part type ${n.type}]`)}function rt(n){return Array.from(n,bo)}class So extends Tt{renderMessageBody(e,t){let i=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(i=`height: ${t.height}px`);const r=[e.div({className:"spacer",style:i}),this.renderMedia(e,t),e.time(t.time)],o=e.div({className:{status:!0,hidden:a=>!a.status}},a=>a.status);if(r.push(o),t.isPending){const a=e.progress({min:0,max:100,value:c=>c.uploadPercentage,className:{hidden:c=>!c.isUploading}});r.push(a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`,"data-testid":"media"},r),e.if(a=>a.error,a=>a.p({className:"error"},t.error))])}createMenuOptions(e){const t=super.createMenuOptions(e);if(!e.isPending){let s;switch(e.shape){case"image":s=e.i18n`Download image`;break;case"video":s=e.i18n`Download video`;break;default:s=e.i18n`Download media`;break}t.push(F.option(s,()=>e.downloadMedia()))}return t}}class l_ extends So{renderMedia(e,t){const s=e.img({src:i=>i.thumbnailUrl,alt:i=>i.label,title:i=>i.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending||!t.lightboxUrl?s:e.a({href:t.lightboxUrl},s)}}function Ds(n,e){return new Promise((t,s)=>{let i;const r=a=>{i(),s(a.target.error)},o=()=>{i(),t()};i=()=>{n.removeEventListener(e,o),n.removeEventListener("error",r)},n.addEventListener(e,o),n.addEventListener("error",r)})}async function d_(n){var e;try{if((e=navigator==null?void 0:navigator.clipboard)!=null&&e.writeText)return await navigator.clipboard.writeText(n),!0;{const t=document.createElement("textarea");t.value=n,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const s=document.getSelection();if(!s)return console.error("copyPlaintext: Unable to copy text to clipboard in fallback mode because `selection` was null/undefined"),!1;const i=document.createRange();i.selectNode(t),s.removeAllRanges(),s.addRange(i);const r=document.execCommand("copy");return s.removeAllRanges(),document.body.removeChild(t),r||console.error("copyPlaintext: Unable to copy text to clipboard in fallback mode because the `copy` command is unsupported or disabled"),r}}catch(t){console.error("copyPlaintext: Ran into an error",t)}return!1}class u_ extends So{renderMedia(e){const t=e.video({src:s=>s.videoUrl||`data:${s.mimeType},`,title:s=>s.label,controls:!0,preload:"none",poster:s=>s.thumbnailUrl,onPlay:this._onPlay.bind(this),style:s=>`max-width: ${s.width}px; max-height: ${s.height}px;${s.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const s=e.target;await t.loadVideo();const i=Ds(s,"loadeddata");s.load(),await i,s.play()}catch{}}_onError(e){const t=this.value,s=e.target,i=s.error;if(i instanceof window.MediaError&&i.code===4)if(!s.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(i)}}class m_ extends Tt{renderMessageBody(e,t){const s=[];return t.isPending?s.push(i=>i.label):s.push(e.button({className:"link",onClick:()=>t.download()},i=>i.label),e.time(t.time)),e.p({className:"Timeline_messageBody statusMessage"},s)}}class p_ extends Tt{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},[e.span(t.label),e.a({className:"Timeline_locationLink",href:t.mapsLink,target:"_blank",rel:"noopener"},t.i18n`Open in maps`),e.time(t.time)])}}class __ extends Tt{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class g_ extends g{constructor(e){super(e)}render(e,t){return e.li({className:"AnnouncementView","data-event-id":t.eventId},e.div(s=>s.announcement))}onClick(){}}class f_ extends Tt{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(F.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}}class y_ extends g{constructor(e){super(e)}render(e,t){const s={GapView:!0,isLoading:i=>i.isLoading,isAtTop:i=>i.isAtTop};return e.li({className:s},[e.div({class:"GapView_container"},[e.if(i=>i.showSpinner,i=>$(i)),e.span(i=>i.status)]),e.if(i=>!!i.errorViewModel,i=>i.view(new ht(t.errorViewModel,{inline:!0})))])}onClick(){}}class w_ extends g{render(e,t){return e.li({className:"CallTileView AnnouncementView"},e.div([e.if(s=>s.errorViewModel,s=>s.div({className:"CallTileView_error"},s.view(new ht(t.errorViewModel,{inline:!0})))),e.div([e.div({className:"CallTileView_title"},s=>s.title),e.div({className:"CallTileView_subtitle"},[t.typeLabel," \u2022 ",e.span({className:"CallTileView_memberCount"},s=>s.memberCount)]),e.view(new Ge({className:"CallTileView_members",tagName:"div",list:t.memberViewModels},s=>new ve(s,24))),e.div(s=>s.duration),e.div([e.button({className:"CallTileView_join button-action primary",hidden:s=>!s.canJoin},"Join"),e.button({className:"CallTileView_leave button-action primary destructive",hidden:s=>!s.canLeave},"Leave")])])]))}onClick(e){e.target.classList.contains("CallTileView_join")?this.value.join():e.target.classList.contains("CallTileView_leave")&&this.value.leave()}}class v_ extends g{render(e,t){return e.h2({className:"DateHeader"},e.time({dateTime:t.machineReadableDate},t.relativeDate))}onClick(){}}class b_ extends g{render(e,t){return e.div({className:"VerificationTileView"},e.mapView(s=>s.status,s=>{switch(s){case Bt.Ready:return new S_(t);case Bt.Cancelled:return new I_(t);case Bt.Completed:return new k_(t);case Bt.InProgress:return new M_(t)}}))}onClick(e){var t;(t=this._subViews)==null||t.forEach(s=>{var i;return(i=s.onClick)==null?void 0:i.call(s,e)})}}class S_ extends g{render(e,t){return e.div({className:"VerificationReadyTileView"},[e.div({className:"VerificationTileView__shield"}),e.div({className:"VerificationTileView__description"},[e.div(t.description)]),e.div({className:"VerificationTileView__actions"},[e.button({className:"VerificationTileView__accept button-action primary"},"Accept"),e.button({className:"VerificationTileView__reject button-action secondary"},"Reject")])])}onClick(e){e.target.classList.contains("VerificationTileView__accept")?this.value.accept():e.target.classList.contains("VerificationTileView__reject")&&this.value.reject()}}class I_ extends g{render(e,t){return e.div({className:"VerificationCancelledTileView"},[e.div({className:"VerificationTileView__description"},t.i18n`${t.isCancelledByUs?"You":t.sender} cancelled the verification!`)])}}class k_ extends g{render(e,t){return e.div({className:"VerificationCompletedTileView"},[e.div({className:"VerificationTileView__description"},[e.div({className:"VerificationTileView__shield"}),e.div(t.i18n`You verified ${t.sender}`)])])}}class M_ extends g{render(e,t){return e.div({className:"VerificationInProgressTileView"},[e.div({className:"VerificationTileView__description"},t.i18n`Verification in progress`),e.div({className:"VerificationTileView__actions"},[$(e)])])}}function Dr(n){switch(n.shape){case O.Gap:return y_;case O.Announcement:return g_;case O.Message:case O.MessageStatus:return r_;case O.Image:return l_;case O.Video:return u_;case O.File:return m_;case O.Location:return p_;case O.MissingAttachment:return __;case O.Redacted:return f_;case O.Call:return w_;case O.DateHeader:return v_;case O.Verification:return b_;default:throw new Error(`Tiles of shape "${n.shape}" are not supported, check the tileClassForEntry function in the view model`)}}class C_ extends g{render(e,t){const s=e.input({type:"text",name:"id",id:"id",placeholder:t.i18n`Enter a room id or alias`,disabled:i=>i.joinInProgress});return e.main({className:"JoinRoomView middle"},[e.div({className:"JoinRoomView_header middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Cancel room join`}),e.h2("Join room")]),e.div({className:"JoinRoomView_body centered-column"},[e.form({className:"JoinRoomView_detailsForm form",onSubmit:i=>this.onSubmit(i,s.value)},[e.div({className:"vertical-layout"},[e.div({className:"stretch form-row text"},[e.label({for:"id"},t.i18n`Room id`),s])]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:i=>i.joinInProgress},t.i18n`Join`)]),e.map(i=>i.status,(i,r)=>r.div({className:"JoinRoomView_status"},[$(r,{hidden:o=>!o.joinInProgress}),r.span(i)]))])])])}onSubmit(e,t){e.preventDefault(),this.value.join(t)}}class R_ extends g{render(e,t){return e.div({className:"CallToastNotificationView"},[e.div({className:"CallToastNotificationView__top"},[e.view(new ve(t,24)),e.span({className:"CallToastNotificationView__name"},s=>s.roomName),e.button({className:"button-action CallToastNotificationView__dismiss-btn",onClick:()=>t.dismiss()})]),e.div({className:"CallToastNotificationView__description"},[e.span(t.i18n`Video call started`)]),e.div({className:"CallToastNotificationView__info"},[e.span({className:"CallToastNotificationView__call-type"},t.i18n`Video`),e.span({className:"CallToastNotificationView__member-count"},s=>s.memberCount)]),e.div({className:"CallToastNotificationView__action"},[e.button({className:"button-action primary",onClick:()=>t.join()},t.i18n`Join`)]),e.if(s=>!!s.errorViewModel,s=>s.div({className:"CallView_error"},s.view(new ht(t.errorViewModel))))])}}class E_ extends g{render(e,t){return e.div({className:"VerificationToastNotificationView"},[e.div({className:"VerificationToastNotificationView__top"},[e.span({className:"VerificationToastNotificationView__title"},t.i18n`Device Verification`),e.button({className:"button-action VerificationToastNotificationView__dismiss-btn",onClick:()=>t.dismiss()})]),e.div({className:"VerificationToastNotificationView__description"},[e.span(t.i18n`Do you want to verify device ${t.otherDeviceId}?`)]),e.div({className:"VerificationToastNotificationView__action"},[e.button({className:"button-action primary destructive",onClick:()=>t.dismiss()},t.i18n`Ignore`),e.button({className:"button-action primary",onClick:()=>t.accept()},t.i18n`Accept`)])])}}function T_(n){switch(n.kind){case"calls":return new R_(n);case"verification":return new E_(n);default:throw new Error(`Cannot find view class for notification kind ${n.kind}`)}}class A_ extends g{render(e,t){return e.div({className:"ToastCollectionView"},[e.ifView(s=>!!s.toastViewModels,s=>new Ge({list:t.toastViewModels,parentProvidesUpdates:!1},i=>T_(i)))])}}class V_ extends g{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":s=>!!s.activeMiddleViewModel,"right-shown":s=>!!s.rightPanelViewModel}},[e.view(new A_(t.toastCollectionViewModel)),e.view(new kp(t.sessionStatusViewModel)),e.view(new dp(t.leftPanelViewModel)),e.mapView(s=>s.activeMiddleViewModel,()=>t.roomGridViewModel?new Mp(t.roomGridViewModel,Dr):t.settingsViewModel?new xp(t.settingsViewModel):t.createRoomViewModel?new Np(t.createRoomViewModel):t.joinRoomViewModel?new C_(t.joinRoomViewModel):t.verificationViewModel?new vo(t.verificationViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new go(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new mo(t.currentRoomViewModel,Dr):t.currentRoomViewModel.kind==="roomBeingCreated"?new _o(t.currentRoomViewModel):new wp(t.currentRoomViewModel):new kt(s=>s.div({className:"room-placeholder"},s.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(s=>s.lightboxViewModel,s=>s?new bp(s):null),e.mapView(s=>s.rightPanelViewModel,s=>s?new Qp(s):null)])}}function Io(n){return "2264057765"?n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web/releases/tag/v0.5.1"},`Hydrogen v0.5.1 (${"2264057765"}) on Github`):n.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class x_ extends g{render(e,t){const s=o=>!!o.isBusy,i=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:s}),r=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:s});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(i.value,r.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row text"},[e.label({for:"username"},t.i18n`Username`),i]),e.div({className:"form-row text"},[e.label({for:"password"},t.i18n`Password`),r]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s},t.i18n`Log In`)])])])}}class N_ extends g{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(s=>s.decryptDehydratedDeviceViewModel,s=>new fo(s.decryptDehydratedDeviceViewModel)),e.map(s=>s.deviceDecrypted,(s,i)=>s?i.p(t.i18n`That worked out, you're good to go!`):i.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},s=>s.deviceDecrypted?s.i18n`Continue`:s.i18n`Continue without restoring`)])])}}class Ks extends g{render(e){const t=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.exportLogs()},r.i18n`Export logs`)),s=e.if(i=>i.hasError,(i,r)=>i.button({onClick:()=>r.logout()},r.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[$(e,{hidden:i=>!i.loading}),e.p(i=>i.loadLabel),t,s]),e.ifView(i=>i.accountSetupViewModel,i=>new N_(i.accountSetupViewModel))])}}class D_ extends g{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,s)=>t.p({className:"error"},s.i18n(s.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new Ks(t):null)])}}class U_ extends g{render(e,t){const s=i=>i.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:s}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(i=>i.completeSSOLoginViewModel,i=>i?new D_(i):null),e.if(i=>i.showHomeserver,(i,r)=>i.div({className:"LoginView_sso form-row text"},[i.label({for:"homeserver"},r.i18n`Homeserver`),i.input({id:"homeserver",type:"text",placeholder:r.i18n`Your matrix homeserver`,value:r.homeserver,disabled:s,onInput:o=>r.setHomeserver(o.target.value),onChange:()=>r.queryHomeserver()}),i.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),i.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(i=>i.isFetchingLoginOptions,i=>i.div({className:"LoginView_query-spinner"},[$(i),i.p("Fetching available login options...")])),e.mapView(i=>i.passwordLoginViewModel,i=>i?new x_(i):null),e.if(i=>i.passwordLoginViewModel&&i.startSSOLoginViewModel,i=>i.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(i=>i.startSSOLoginViewModel,i=>i?new P_(i):null),e.mapView(i=>i.loadViewModel,i=>i?new Ks(i):null),e.p(Io(e))])}}class P_ extends g{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:s=>s.isBusy},t.i18n`Log in with SSO`))}}class F_ extends g{render(e,t){const s=new Zt(t,r=>r.div([r.p("Are you sure you want to log out?"),r.div({className:"button-row"},[r.a({className:"button-action",type:"submit",href:t.cancelUrl},["Cancel"]),r.button({className:"button-action primary destructive",type:"submit",onClick:()=>t.logout()},t.i18n`Log out`)])])),i=new Zt(t,r=>r.p({className:"status",hidden:o=>!o.showStatus},[$(r,{hidden:o=>!o.busy}),r.span(o=>o.status)]));return e.div({className:"LogoutScreen"},[e.div({className:"content"},[e.mapView(r=>r.showConfirm,r=>r?s:i)])])}}class O_ extends g{render(e){return e.div({className:"LogoutScreen"},[e.div({className:"content"},e.map(t=>t.showStatus,(t,s,i)=>t?s.p({className:"status"},[$(s,{hidden:r=>!r.showSpinner}),s.span(r=>r.status)]):s.div([s.p("Your access token is no longer valid! You can reauthenticate in the next screen."),s.div({className:"button-row"},[s.button({className:"button-action primary",type:"submit",onClick:()=>i.proceed()},i.i18n`Proceed`)])])))])}}class K_ extends g{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new Ks(t))]),e.div({className:{"button-row":!0,hidden:s=>s.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class L_ extends g{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},s=>s.avatarInitials),e.div({className:"user-id"},s=>s.label)])])}}class B_ extends g{render(e,t){const s=new Ge({list:t.sessions,parentProvidesUpdates:!1},i=>new L_(i));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(s),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(i=>i.loadViewModel,()=>new Ks(t.loadViewModel)),e.p(Io(e))])])}}class $_ extends g{render(e,t){return e.mapView(s=>s.activeSection,s=>{switch(s){case"error":return new kt(i=>i.div({className:"StatusView"},[i.h1("Something went wrong"),i.p(t.errorText)]));case"session":return new V_(t.sessionViewModel);case"login":return new U_(t.loginViewModel);case"logout":return new F_(t.logoutViewModel);case"forced-logout":return new O_(t.forcedLogoutViewModel);case"picker":return new B_(t.sessionPickerViewModel);case"redirecting":return new kt(i=>i.p("Redirecting..."));case"loading":return new K_(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}}class j_{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,s)=>{this._reject=s,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new he),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class q_{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class H_{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class W_{createMeasure(){return new H_}createTimeout(e){return new j_(e)}createInterval(e,t){return new q_(t,e)}now(){return Date.now()}}class G_{constructor(e){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this._sessionInfoStorage=e,this.haltRequests=!1,this._authData={}}setNavigation(e){this._navigation=e}updateAuthData(e){if(!e.accessToken&&!e.homeserver)throw new Error("updateAuthData argument must contain accessToken, homeserver or both!");this._authData={...this._authData,...e}}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}async _onMessage(e){const{data:t}=e,s=t.replyTo;if(s){const i=this._waitingForReply.get(s);i&&(this._waitingForReply.delete(s),i(t.payload))}if(t.type==="hasSessionOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:i})}else if(t.type==="hasRoomOpen"){const i=this._navigation.observe("session").get()===t.payload.sessionId,r=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:i&&r})}else if(t.type==="closeSession"){const{sessionId:i}=t.payload;this._closeSessionIfNeeded(i).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"?this._navigation.push("room",t.payload.roomId):t.type==="getAuthInfo"&&e.source.postMessage({replyTo:t.id,payload:this._authData})}_closeSessionIfNeeded(e){var s;const t=(s=this._navigation)==null?void 0:s.path.get("session");return e&&(t==null?void 0:t.value)===e?new Promise(i=>{const r=this._navigation.pathObservable.subscribe(o=>{const a=o.get("session");(!a||a.value!==e)&&(r(),i())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);(this.version==="develop"||confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`))&&(console.log("Service Worker has been updated!"),await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,r=new Promise(o=>{this._waitingForReply.set(i,o)});return s.postMessage({type:e,id:i,payload:t}),await r}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.5.1"}get buildHash(){return "2264057765"}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class z_{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){var i;const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());if(s!=null&&s.pushManager){const o=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),a=o.keys.p256dh,c={endpoint:o.endpoint,auth:o.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,a,c)}}async disablePush(){var t;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());if(e!=null&&e.pushManager){const s=await e.pushManager.getSubscription();s&&await s.unsubscribe()}}async isPushEnabled(){var t;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());return e!=null&&e.pushManager?!!await e.pushManager.getSubscription():!1}async supportsPush(){var t;if(!this._pushConfig)return!1;const e=await((t=this._serviceWorkerHandler)==null?void 0:t.getRegistration());return e&&"pushManager"in e}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){var i;if("Notification"in window){new Notification(e,{body:t});return}const s=await((i=this._serviceWorkerHandler)==null?void 0:i.getRegistration());s==null||s.showNotification(e,{body:t})}}class J_ extends we{constructor(){super(),this._lastSessionHash=void 0}handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){var e;this._lastSessionHash=(e=window.localStorage)==null?void 0:e.getItem("hydrogen_last_url_hash"),window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){var t;(t=window.localStorage)==null||t.setItem("hydrogen_last_url_hash",e)}getLastSessionUrl(){return this._lastSessionHash}}class Y_ extends we{constructor(){super(),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function q(n,e){return n instanceof Promise?n:new Promise((t,s)=>{n.oncomplete=i=>t(i.target.result),n.onerror=()=>s(new Error("Crypto error on "+e))})}class Q_{constructor(e){this._subtleCrypto=e}async verify(e,t,s,i){const r={name:"HMAC",hash:{name:nt(i)}},o=await q(this._subtleCrypto.importKey("raw",e,r,!1,["verify"]),"importKey");return await q(this._subtleCrypto.verify(r,o,t,s),"verify")}async compute(e,t,s){const i={name:"HMAC",hash:{name:nt(s)}},r=await q(this._subtleCrypto.importKey("raw",e,i,!1,["sign"]),"importKey"),o=await q(this._subtleCrypto.sign(i,r,t),"sign");return new Uint8Array(o)}}class X_{constructor(e,t,s){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=s}async pbkdf2(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const o=await q(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await q(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:s,iterations:t,hash:nt(i)},o,r),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,s,i,r);const o=await q(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await q(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:s,hash:nt(i)},o,r),"deriveBits");return new Uint8Array(a)}}class Z_{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){const o={name:"AES-CTR",counter:s,length:r};let a;try{const c=e||t,h=t?"jwk":"raw";a=await q(this._subtleCrypto.importKey(h,c,o,!1,["decrypt"]),"importKey")}catch(c){throw new Error(`Could not import key for AES-CTR decryption: ${c.message}`)}try{const c=await q(this._subtleCrypto.decrypt(o,a,i),"decrypt");return new Uint8Array(c)}catch(c){throw new Error(`Could not decrypt with AES-CTR: ${c.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){const r={name:"AES-CTR",counter:s,length:64};let o;const a=e||t,c=t?"jwk":"raw";try{o=await q(this._subtleCrypto.importKey(c,a,r,!1,["encrypt"]),"importKey")}catch(h){throw new Error(`Could not import key for AES-CTR encryption: ${h.message}`)}try{const h=await q(this._subtleCrypto.encrypt(r,o,i),"encrypt");return new Uint8Array(h)}catch(h){throw new Error(`Could not encrypt with AES-CTR: ${h.message}`)}}async generateKey(e,t=256){const s=await q(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return q(this._subtleCrypto.exportKey(e,s))}async generateIV(){return ko(this._crypto)}}function ko(n){const e=n.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let s=0;s<e.length;s+=1)t[s]=e[s];return t}function Ur(n){if(n.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${n.alg}`);if(!n.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(n.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${n.kty}`);const t=n.k.replace(/-/g,"+").replace(/_/g,"/");return $t.decode(t)}function eg(n){const e=$t.encode(n),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function tg(n){return eg(n).replace(/\+/g,"-").replace(/\//g,"_")}function sg(n){return{alg:"A256CTR",ext:!0,k:tg(n),key_ops:["encrypt","decrypt"],kty:"oct"}}class ig{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){if(r!==64)throw new Error(`Unsupported counter length: ${r}`);t&&(e=Ur(t));const o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(s)));return a.decrypt(new Uint8Array(i))}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){t&&(e=Ur(t));const r=this._aesjs;var o=new r.ModeOfOperation.ctr(new Uint8Array(e),new r.Counter(new Uint8Array(s)));return o.encrypt(new Uint8Array(i))}async generateKey(e,t=256){let s=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(s=sg(s)),s}async generateIV(){return ko(this._crypto)}}function nt(n){if(n!=="SHA-256"&&n!=="SHA-512")throw new Error(`Invalid hash name: ${n}`);return n}class rg{constructor(e){const t=window.crypto||window.msCrypto,s=t.subtle||t.webkitSubtle;this._subtleCrypto=s,!s.deriveBits&&(e==null?void 0:e.aesjs)?this.aes=new ig(e.aesjs,t):this.aes=new Z_(s,t),this.hmac=new Q_(s),this.derive=new X_(s,this,e)}async digest(e,t){return await q(this._subtleCrypto.digest(nt(e),t))}digestSize(e){switch(nt(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${nt(e)}`)}}}async function ng(){var n;if((n=navigator==null?void 0:navigator.storage)!=null&&n.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}else return{quota:null,usage:null}}class og{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class ag{constructor(e,t){this._promise=new Promise((s,i)=>{this._resolve=s,this._reject=i}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class cg{constructor(e,t){this._workers=[];for(let s=0;s<t;++s){const i=new og(new Worker(e));i.attach(this),this._workers[s]=i}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise((t,s)=>{this._init={resolve:t,reject:s}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){const t=e.data,s=this._requests.get(t.replyToId);if(s){if(s._worker.busy=!1,s._isNotDisposed){if(t.type==="success")s._resolve(t.payload);else if(t.type==="error"){const i=new Error(t.message);i.stack=t.stack,s._reject(i)}s._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;const t=this._getPendingRequest();if(t){const s=this._getFreeWorker();s&&(this._sendWith(t,s),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new ag(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),s=this._getFreeWorker();return s&&this._sendWith(t,s),t}sendAll(e){const t=this._workers.map(s=>{const i=this._enqueueRequest(Object.assign({},e));return this._sendWith(i,s),i.response()});return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new he),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}class es{static async fromBlob(e){const t=await Pr(e),{width:s,height:i}=t;return new es(e,s,i,t)}constructor(e,t,s,i){this.blob=e,this.width=t,this.height=s,this._domElement=i}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await Pr(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,s=Math.min(1,e/(t>=1?this.width:this.height)),i=Math.round(this.width*s),r=Math.round(this.height*s),o=document.createElement("canvas");o.width=i,o.height=r;const a=o.getContext("2d"),c=await this._getDomElement();a.drawImage(c,0,0,i,r);let h=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",l;if(o.toBlob)l=await new Promise(u=>o.toBlob(u,h));else if(o.msToBlob)h="image/png",l=o.msToBlob();else throw new Error("canvas can't be turned into blob");const d=ot.fromBlobUnsafe(l);return new es(d,i,r,null)}dispose(){this.blob.dispose()}}class Pi extends es{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){const t=await lg(e),{videoWidth:s,videoHeight:i}=t;return new Pi(e,s,i,t)}}function hg(){const n=document.createElement("canvas");n.width=1,n.height=1;const e=n.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);const s=e.getImageData(0,0,1,1).data;return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}async function Pr(n){const e=document.createElement("img"),t=Ds(e,"load");return e.src=n.url,await t,e}async function lg(n){const e=document.createElement("video");e.muted=!0;const t=Ds(e,"loadedmetadata");e.src=n.url,e.load(),await t;const s=Ds(e,"seeked");return await new Promise(i=>setTimeout(i,200)),e.currentTime=.1,await s,e}async function dg(n,e,t,s,i){let r=n.querySelector("iframe.downloadSandbox");if(!r){r=document.createElement("iframe"),r.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),r.setAttribute("src",e),r.className="hidden downloadSandbox",n.appendChild(r);let o;await new Promise((a,c)=>{o=()=>{r.removeEventListener("load",a),r.removeEventListener("error",c)},r.addEventListener("load",a),r.addEventListener("error",c)}),o()}if(i){const o=await t.readAsBuffer();r.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:s},"*")}else r.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:s},"*")}class ug{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const mg={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,FORBID_TAGS:["mx-reply"],KEEP_CONTENT:!1};function pg(n){const e=Ro.sanitize(n,mg),t=new DOMParser().parseFromString(`<!DOCTYPE html><html><body>${e}</body></html>`,"text/html").body;return new ug(t)}const _g=200,gg=-60,fg=8;class yg{constructor(e){this.mediaDevices=e}enumerate(){return this.mediaDevices.enumerateDevices()}async getMediaTracks(e,t){const s=await this.mediaDevices.getUserMedia(this.getUserMediaContraints(e,t));return s.addEventListener("removetrack",i=>{console.log(`removing track ${i.track.id} (${i.track.kind}) from stream ${s.id}`)}),s}async getScreenShareTrack(){return await this.mediaDevices.getDisplayMedia(this.getScreenshareContraints())}getUserMediaContraints(e,t){const s=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:typeof e!="boolean"?{ideal:e.deviceId}:void 0}:!1,video:t?{deviceId:typeof t!="boolean"?{ideal:t.deviceId}:void 0,width:s?{exact:640}:{ideal:640},height:s?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(){return{audio:!1,video:!0}}createVolumeMeasurer(e,t){return new wg(e,t)}}class wg{constructor(e,t){this.measuringVolumeActivity=!1,this.speakingThreshold=gg,this.speaking=!1,this.volumeLooper=()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let s=-1/0;for(let r=0;r<this.frequencyBinCount.length;r++)this.frequencyBinCount[r]>s&&(s=this.frequencyBinCount[r]);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(s),this.callback();let i=!1;for(let r=0;r<this.speakingVolumeSamples.length;r++)if(this.speakingVolumeSamples[r]>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.callback()),this.volumeLooperTimeout=setTimeout(this.volumeLooper,_g)},this.stream=e,this.callback=t,this.speakingVolumeSamples=new Array(fg).fill(-1/0),this.initVolumeMeasuring(),this.measureVolumeActivity(!0)}get isSpeaking(){return this.speaking}measureVolumeActivity(e){if(e){if(!this.audioContext||!this.analyser||!this.frequencyBinCount)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.callback()}initVolumeMeasuring(){const e=window.AudioContext||window.webkitAudioContext;if(!e)return;this.audioContext=new e,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}setSpeakingThreshold(e){this.speakingThreshold=e}stop(){var e;clearTimeout(this.volumeLooperTimeout),this.analyser.disconnect(),(e=this.audioContext)==null||e.close()}}class vg{createPeerConnection(e,t,s){const i=new RTCPeerConnection({iceTransportPolicy:e?"relay":void 0,iceServers:t,iceCandidatePoolSize:s});return new Proxy(i,{get(r,o,a){o==="close"&&console.trace("calling peerConnection.close");const c=r[o];return typeof c=="function"?c.bind(r):c}})}prepareSenderForPurpose(e,t,s){s===Le.Screenshare&&this.getRidOfRTXCodecs(e,t)}getRidOfRTXCodecs(e,t){var a,c,h,l,d,u;if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const s=(c=(a=RTCRtpReceiver.getCapabilities("video"))==null?void 0:a.codecs)!=null?c:[],r=[...(l=(h=RTCRtpSender.getCapabilities("video"))==null?void 0:h.codecs)!=null?l:[],...s];for(const p of r)if(p.mimeType==="video/rtx"){const m=r.indexOf(p);r.splice(m,1)}const o=e.getTransceivers().find(p=>p.sender===t);o&&(((d=o.sender.track)==null?void 0:d.kind)==="video"||((u=o.receiver.track)==null?void 0:u.kind)==="video")&&o.setCodecPreferences(r)}}var Be=(n=>(n[n.Dark=0]="Dark",n[n.Light=1]="Light",n))(Be||{});function bg(n,e,t){let s=n.replaceAll("#ff00ff",e);if(s=s.replaceAll("#00ffff",t),n===s)throw new Error("svg-colorizer made no color replacements! The input svg should only contain colors #ff00ff (primary, case-sensitive) and #00ffff (secondary, case-sensitive).");return s}class Sg{constructor(e,t,s,i){this._platform=e,this._iconVariables=t,this._resolvedVariables=s,this._manifestLocation=i}async toVariables(){const{parsedStructure:e,promises:t}=await this._fetchAndParseIcons();return await Promise.all(t),this._produceColoredIconVariables(e)}async _fetchAndParseIcons(){const e=[],t={};for(const[s,i]of Object.entries(this._iconVariables)){const r=new URL(`https://${i}`),o=r.hostname,a=new URL(o,new URL(this._manifestLocation,window.location.origin)),c=this._platform.request(a,{method:"GET",format:"text",cache:!0}).response();e.push(c);const h=r.searchParams;t[s]={svg:c,primary:h.get("primary"),secondary:h.get("secondary")}}return{parsedStructure:t,promises:e}}async _produceColoredIconVariables(e){let t={};for(const[s,{svg:i,primary:r,secondary:o}]of Object.entries(e)){const{body:a}=await i;if(!r)throw new Error(`Primary color variable ${r} not in list of variables!`);const c=this._resolvedVariables[r],h=this._resolvedVariables[o],l=bg(a,c,h),d=`url('data:image/svg+xml;utf8,${encodeURIComponent(l)}')`;t[s]=d}return t}}var Kr;const zs=(Kr=Br.exports.offColor)!=null?Kr:$r.offColor;function Fr(n,e,t,s){const i=parseInt(t);switch(s&&(e==="darker"?e="lighter":e==="lighter"&&(e="darker")),e){case"darker":return zs(n).darken(i/100).hex();case"lighter":return zs(n).lighten(i/100).hex();case"alpha":return zs(n).rgba(i/100)}}class Ig{constructor(e,t,s){this._aliases={},this._derivedAliases=[],this._baseVariables=e,this._variablesToDerive=t,this._isDark=s}toVariables(){var t;const e={};this._detectAliases();for(const s of this._variablesToDerive){const i=this._derive(s);i&&(e[s]=i)}for(const[s,i]of Object.entries(this._aliases))e[s]=(t=this._baseVariables[i])!=null?t:e[i];for(const s of this._derivedAliases){const i=this._deriveAlias(s,e);i&&(e[s]=i)}return e}_detectAliases(){const e=[];for(const t of this._variablesToDerive){const[s,i]=t.split("=");i?this._aliases[s]=i:e.push(t)}this._variablesToDerive=e}_derive(e){const t=/(.+)--(.+)-(.+)/,s=e.match(t);if(s){const[,i,r,o]=s,a=this._baseVariables[i];if(!a)if(this._aliases[i]){this._derivedAliases.push(e);return}else throw new Error(`Cannot find value for base variable "${i}"!`);return Fr(a,r,o,this._isDark)}}_deriveAlias(e,t){const s=/(.+)--(.+)-(.+)/,i=e.match(s);if(i){const[,r,o,a]=i,c=t[r];if(!c)throw new Error(`Cannot find value for alias "${r}" when trying to derive ${e}!`);return Fr(c,o,a,this._isDark)}}}var Lr;(Lr=Br.exports.offColor)!=null||$r.offColor;class kg{constructor(e,t){this._themeMapping={},this._preferredColorScheme=t,this._platform=e}async parse(e,t,s,i){await i.wrap("RuntimeThemeParser.parse",async()=>{var d;const{cssLocation:r,derivedVariables:o,icons:a}=this._getSourceData(t,s,i),c=e.name;if(!c)throw new Error("Theme name not found in manifest!");let h={},l={};for(const[u,p]of Object.entries((d=e.values)==null?void 0:d.variants))try{const m=`${e.id}-${u}`,{name:_,default:y,dark:M,variables:N}=p,z=new Ig(N,o,M).toVariables();Object.assign(N,z);const Ls=await new Sg(this._platform,a,N,s).toVariables();Object.assign(N,z,Ls);const rs=`${c} ${_}`;if(y){Object.assign(M?h:l,{variantName:_,id:m,cssLocation:r,variables:N});continue}this._themeMapping[rs]={cssLocation:r,id:m,variables:N}}catch(m){console.error(m);continue}if(h.id&&l.id){const u=this._preferredColorScheme===Be.Dark?h:l;this._themeMapping[c]={dark:h,light:l,default:u}}else{const u=h.id?h:l;this._themeMapping[`${c} ${u.variantName}`]={id:u.id,cssLocation:u.cssLocation}}})}_getSourceData(e,t,s){return s.wrap("getSourceData",()=>{var c,h,l;const i=(c=e.source)==null?void 0:c["runtime-asset"];if(!i)throw new Error(`Run-time asset not found in source section for theme at ${t}`);const r=new URL(i,new URL(t,window.location.origin)).href,o=(h=e.source)==null?void 0:h["derived-variables"];if(!o)throw new Error(`Derived variables not found in source section for theme at ${t}`);const a=(l=e.source)==null?void 0:l.icon;if(!a)throw new Error(`Icon mapping not found in source section for theme at ${t}`);return{cssLocation:r,derivedVariables:o,icons:a}})}get themeMapping(){return this._themeMapping}}class Mg{constructor(e){this._themeMapping={},this._preferredColorScheme=e}parse(e,t,s){s.wrap("BuiltThemeParser.parse",()=>{var c,h,l;const i=(c=e.source)==null?void 0:c["built-assets"],r=e.name;if(!r)throw new Error(`Theme name not found in manifest at ${t}`);let o={},a={};for(let[d,u]of Object.entries(i)){try{u=new URL(u,new URL(t,window.location.origin)).href}catch{continue}const p=(h=d.match(/.+-(.+)/))==null?void 0:h[1],m=(l=e.values)==null?void 0:l.variants[p];if(!m)throw new Error(`Variant ${p} is missing in manifest at ${t}`);const{name:_,default:y,dark:M}=m,N=`${r} ${_}`;if(y){const z=M?o:a;z.variantName=_,z.id=d,z.cssLocation=u;continue}this._themeMapping[N]={cssLocation:u,id:d}}if(o.id&&a.id){const d=this._preferredColorScheme===Be.Dark?o:a;this._themeMapping[r]={dark:o,light:a,default:d}}else{const d=o.id?o:a;this._themeMapping[`${r} ${d.variantName}`]={id:d.id,cssLocation:d.cssLocation}}})}get themeMapping(){return this._themeMapping}}class Cg{constructor(e){this._platform=e}async init(e,t){await this._platform.logger.wrapOrRun(t,"ThemeLoader.init",async s=>{let i=!0;const r=[],o=[],a=await Promise.all(e.map(d=>this._platform.request(d,{method:"GET",format:"json",cache:!0}).response())),c=new kg(this._platform,this.preferredColorScheme),h=new Mg(this.preferredColorScheme),l=[];for(let d=0;d<a.length;++d){const u=a[d],{status:p,body:m}=u;if(!(p>=200&&p<=299)){console.error(`Failed to load manifest at ${e[d]}, status: ${p}`),s.log({l:"Manifest fetch failed",location:e[d],status:p},ie.Error),r.push(e[d]);continue}i=!1;try{if(m.extends){const _=a.findIndex(z=>"value"in z&&z.value.body.id===m.extends);if(_===-1)throw new Error(`Base manifest for derived theme at ${e[d]} not found!`);const{body:y}=a[_].value,M=e[_],N=c.parse(m,y,M,s);l.push(N)}else h.parse(m,e[d],s)}catch(_){console.error(_),o.push(_.message)}}if(await Promise.all(l),this._themeMapping={...h.themeMapping,...c.themeMapping},i)throw new Error(`All configured theme manifests failed to load, the following were tried: ${r.join(", ")}`);if(Object.keys(this._themeMapping).length===0&&o.length)throw new Error(`Failed to parse theme manifests, the following errors were encountered: ${o.join(", ")}`);this._addDefaultThemeToMapping(s),s.log({l:"Preferred colorscheme",scheme:this.preferredColorScheme===Be.Dark?"dark":"light"}),s.log({l:"Result",themeMapping:this._themeMapping})})}async setTheme(e,t,s){await this._platform.logger.wrapOrRun(s,{l:"change theme",name:e,variant:t},async i=>{let r,o,a=this._themeMapping[e];if("id"in a)r=a.cssLocation,o=a.variables;else{if(!t)throw new Error("themeVariant is undefined!");r=a[t].cssLocation,o=a[t].variables}await this._platform.replaceStylesheet(r,i),o?(s==null||s.log({l:"Derived Theme",variables:o}),this._injectCSSVariables(o)):this._removePreviousCSSVariables(),this._platform.settingsStorage.setString("theme-name",e),t?this._platform.settingsStorage.setString("theme-variant",t):this._platform.settingsStorage.remove("theme-variant")})}_injectCSSVariables(e){const t=document.documentElement;for(const[s,i]of Object.entries(e))t.style.setProperty(`--${s}`,i);this._injectedVariables=e}_removePreviousCSSVariables(){if(!this._injectedVariables)return;const e=document.documentElement;for(const t of Object.keys(this._injectedVariables))e.style.removeProperty(`--${t}`);this._injectedVariables=void 0}get themeMapping(){return this._themeMapping}async getActiveTheme(){let e=await this._platform.settingsStorage.getString("theme-name"),t=await this._platform.settingsStorage.getString("theme-variant");return(!e||!this._themeMapping[e])&&(e="Default"in this._themeMapping?"Default":Object.keys(this._themeMapping)[0],this._themeMapping[e][t]||(t="default"in this._themeMapping[e]?"default":void 0)),{themeName:e,themeVariant:t}}getDefaultTheme(){var e,t;switch(this.preferredColorScheme){case Be.Dark:return(e=this._platform.config.defaultTheme)==null?void 0:e.dark;case Be.Light:return(t=this._platform.config.defaultTheme)==null?void 0:t.light}}_findThemeDetailsFromId(e){var t,s;for(const[i,r]of Object.entries(this._themeMapping)){if("id"in r&&r.id===e)return{themeName:i,themeData:r};if("light"in r&&((t=r.light)==null?void 0:t.id)===e)return{themeName:i,themeData:r.light};if("dark"in r&&((s=r.dark)==null?void 0:s.id)===e)return{themeName:i,themeData:r.dark}}}_addDefaultThemeToMapping(e){e.wrap("addDefaultThemeToMapping",t=>{const s=this.getDefaultTheme();if(s){const i=this._findThemeDetailsFromId(s);if(i){this._themeMapping.Default={id:"default",cssLocation:i.themeData.cssLocation};const r=i.themeData.variables;r&&(this._themeMapping.Default.variables=r)}}t.log({l:"Default Theme",theme:s})})}get preferredColorScheme(){if(window.matchMedia("(prefers-color-scheme: dark)").matches)return Be.Dark;if(window.matchMedia("(prefers-color-scheme: light)").matches)return Be.Light}}var Mo=(n=>(n[n.Minute=6e4]="Minute",n[n.Hours=36e5]="Hours",n[n.Day=864e5]="Day",n))(Mo||{});function Rg(n){let e=0,t=0,s=0;n>=864e5&&(e=Math.floor(n/864e5),n-=e*864e5),n>=36e5&&(t=Math.floor(n/36e5),n-=t*36e5),n>=6e4&&(s=Math.floor(n/6e4),n-=s*6e4);const i=Math.floor(n/1e3);let r="";return e&&(r=`${e}d `),(t||e)&&(r+=`${t}h `),(s||t||e)&&(r+=`${s}m `),r+=`${i}s`,r}class Eg{constructor(e){this.clock=e,this.todayMidnight=new Date,this.todayMidnight.setHours(0,0,0,0),this.relativeDayFormatter=new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}),this.weekdayFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long"}),this.currentYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",month:"long",day:"numeric"}),this.otherYearFormatter=new Intl.DateTimeFormat(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),this.timeFormatter=new Intl.DateTimeFormat(void 0,{hour:"numeric",minute:"2-digit"})}formatTime(e){return this.timeFormatter.format(e)}formatMachineReadableDate(e){return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}`}formatRelativeDate(e){let t=Math.floor((e.getTime()-this.todayMidnight.getTime())/Mo.Day);return t>=-1&&t<=1?Tg(this.relativeDayFormatter.format(t,"day")):t>-7&&t<0?this.weekdayFormatter.format(e):this.todayMidnight.getFullYear()===e.getFullYear()?this.currentYearFormatter.format(e):this.otherYearFormatter.format(e)}formatDuration(e){return Rg(e)}}function Tg(n){return n.slice(0,1).toLocaleUpperCase()+n.slice(1)}function Or(n){return new Promise(function(e,t){var s=document.createElement("script");s.setAttribute("src",n),s.onload=e,s.onerror=t,document.body.appendChild(s)})}async function Ag(n){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),n?(window.WebAssembly?(await Or(n.wasmBundle),await window.Olm.init({locateFile:()=>n.wasm})):(await Or(n.legacyBundle),await window.Olm.init()),window.Olm):null}function Vg(n){return n.startsWith("/")?n:new URL(n,document.location.href).pathname}async function xg(n){const e=new cg(n.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:Vg(n.olm.legacyBundle)}),new Wm(e)}function Ng(n){if(!window.visualViewport)return;const e=()=>{const t=n.querySelector(".SessionView");if(!t)return;const s=n.querySelector(".bottom-aligned-scroll");let i,r,o;s&&(i=s.scrollTop,r=s.offsetHeight);const a=t.offsetTop+t.offsetHeight-window.visualViewport.height;n.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),n.style.setProperty("--ios-viewport-top",a.toString()+"px"),s&&(o=s.offsetHeight,s.scrollTop=i+r-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}class Dg{constructor({container:e,assetPaths:t,config:s,configURL:i,logger:r,options:o=null,cryptoExtras:a=null}){this._container=e,this._assetPaths=t,this._config=s,this._configURL=i,this.settingsStorage=new Bm("hydrogen_setting_v1_"),this.clock=new W_,this.encoding=new Hm,this.random=Math.random,this.logger=r!=null?r:this._createLogger(o==null?void 0:o.development),this.history=new J_,this.onlineStatus=new Y_,this.timeFormatter=new Eg,this._serviceWorkerHandler=null,this.sessionInfoStorage=new Lm("hydrogen_sessions_v1"),t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new G_(this.sessionInfoStorage),this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=void 0,this._assetPaths.olm&&(this.crypto=new rg(a)),this.storageFactory=new Sh(this._serviceWorkerHandler),this.estimateStorageUsage=ng,typeof fetch=="function"?this.request=Km(this.clock.createTimeout,this._serviceWorkerHandler):this.request=io;const c=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=c;const h=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=h,this._disposables=new Et,this._olmPromise=void 0,this._workerPromise=void 0,this.mediaDevices=new yg(navigator.mediaDevices),this.webRTC=new vg,this._themeLoader=new Cg(this)}async init(){try{await this.logger.run("Platform init",async e=>{var t;if(!this._config){if(!this._configURL)throw new Error("Neither config nor configURL was provided!");const{status:s,body:i}=await this.request(this._configURL,{method:"GET",format:"json",cache:!0}).response();if(s===404)throw new Error(`Could not find ${this._configURL}. Did you copy over config.sample.json?`);if(s>=400)throw new Error(`Got status ${s} while trying to fetch ${this._configURL}`);this._config=i}if(this.notificationService=new z_(this._serviceWorkerHandler,this._config.push),this._themeLoader){const s=this.config.themeManifests;await((t=this._themeLoader)==null?void 0:t.init(s,e));const{themeName:i,themeVariant:r}=await this._themeLoader.getActiveTheme();e.log({l:"Active theme",name:i,variant:r}),await this._themeLoader.setTheme(i,r,e)}})}catch(e){throw this._container.innerText=e.message,e}}_createLogger(e){const t=new Zm({platform:this}),s=r=>{var o;return(o=r.e)!=null&&o.stack&&(r.e.stack=r.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),r},i=new Gm({name:"hydrogen_logs",platform:this,serializedTransformer:s});return t.addReporter(i),e&&t.addReporter(new Jm),t}get updateService(){return this._serviceWorkerHandler}loadOlm(){return this._olmPromise||(this._olmPromise=Ag(this._assetPaths.olm)),this._olmPromise}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return this._workerPromise||(this._workerPromise=xg(this._assetPaths)),this._workerPromise}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const s=Ng(this._container);s&&this._disposables.track(s)}this._container.addEventListener("error",Vr,!0),this._disposables.track(()=>this._container.removeEventListener("error",Vr,!0)),window.__hydrogenViewModel=e;const t=new $_(e);this._container.appendChild(t.mount())}setNavigation(e){var t;(t=this._serviceWorkerHandler)==null||t.setNavigation(e)}createBlob(e,t){return ot.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):dg(this._container,this._assetPaths.downloadSandbox,e,t,this.isIOS)}async copyPlaintext(e){return await d_(e)}restart(){document.location.reload()}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const s=new Promise(i=>{const r=()=>{t.removeEventListener("change",r,!0);const o=t.files[0];this._container.removeChild(t),o?i({name:o.name,blob:ot.fromBlobUnsafe(o)}):i()};t.addEventListener("change",r,!0)});return this._container.appendChild(t),t.click(),s}openUrl(e){location.href=e}parseHTML(e){return pg(e)}async loadImage(e){return es.fromBlob(e)}async loadVideo(e){return Pi.fromBlob(e)}hasReadPixelPermission(){return hg()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.5.1"}get themeLoader(){return this._themeLoader}async replaceStylesheet(e,t){const s=await this.logger.wrapOrRun(t,{l:"replaceStylesheet",location:e},async i=>{let r;const o=document.querySelector("head");document.querySelectorAll(".theme").forEach(h=>h.remove());const a=document.createElement("link");a.href=e,a.rel="stylesheet",a.type="text/css",a.className="theme";const c=new Promise(h=>{a.onerror=()=>{r=new Error(`Failed to load stylesheet from ${e}`),i.catch(r),h()},a.onload=()=>{h()}});return o.appendChild(a),await c,r});if(s)throw s}get description(){var e;return"web-"+((e=navigator.userAgent)!=null?e:"<unknown>")}dispose(){this._disposables.dispose()}}var Ug="./config.json",Pg="./assets/download-sandbox.62573e78.html",Fg="./assets/main.165de79c.js",Co={downloadSandbox:Pg,worker:Fg,olm:{wasm:Eo,legacyBundle:To,wasmBundle:Ao}};Co.serviceWorker="sw.js";const Og=new Dg({container:document.body,assetPaths:Co,configURL:Ug,options:{development:!1}});Dm(Og);
//# sourceMappingURL=index.c4591a29.js.map
